<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
    <meta charset="UTF-8"/>
    <link rel="manifest" href="/resource/manifest.json">
    <link rel="icon" type="image/x-icon" href="/resource/favicon.ico">
    <link rel="apple-touch-icon" href="/resource/favicon_192.png" sizes="192x192">
    <link rel="icon" href="/resource/favicon_512.png" sizes="512x512">
    <link rel="stylesheet" href="/static/common-styles.css?v=20250205">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è®¾å¤‡æ€»è§ˆ">
    <meta name="application-name" content="è®¾å¤‡æ€»è§ˆ">
    <title>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ - è®¾å¤‡æ€»è§ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        :root {
            --bg: #0b1020;
            --card: #0f162e;
            --bd: #1d2b4a;
            --text: #e6eefc;
            --muted: #9aa6bf;
            --good: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --primary: #3b82f6;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        @media (prefers-color-scheme: light) {
            :root[data-theme="auto"] {
                --bg: #f5f7fa;
                --card: #fff;
                --bd: #d6d9e0;
                --text: #111827;
                --muted: #64748b;
                --good: #16a34a;
                --bad: #dc2626;
                --warn: #ea580c;
                --primary: #2563eb;
                --shadow: 0 8px 18px rgba(0, 0, 0, .08);
            }
        }

        :root[data-theme="light"] {
            --bg: #f5f7fa;
            --card: #fff;
            --bd: #d6d9e0;
            --text: #111827;
            --muted: #64748b;
            --good: #16a34a;
            --bad: #dc2626;
            --warn: #ea580c;
            --primary: #2563eb;
            --shadow: 0 8px 18px rgba(0, 0, 0, .08);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            letter-spacing: .2px;
            transition: .3s;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
                font-size: 14px;
            }
        }

        .wrap {
            max-width: 1300px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 .logo {
            height: 28px;
            width: auto;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 20px;
                justify-content: center;
            }
        }

        .status {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .status {
                justify-content: center;
            }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 1px solid var(--bd);
            border-radius: 999px;
            color: var(--muted);
            background: var(--card);
            font-size: 14px;
            white-space: nowrap;
        }

        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 14px;
        }

        .section-head h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }

        .section-desc {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .device-card {
            background: var(--card);
            border-radius: var(--radius);
            border: 1px solid color-mix(in srgb, var(--bd) 80%, transparent);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all .2s ease;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            min-width: 0; /* é˜²æ­¢ grid ä¸­çš„å¡ç‰‡è¢«å†…å®¹æ’‘å¼€ */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        /* å¡ç‰‡å†…å®¹å®¹å™¨ï¼Œç¡®ä¿å†…å®¹åœ¨ä¸Šå±‚ */
        .device-card > * {
            position: relative;
            z-index: 1;
        }

        .device-card:hover:not(.device-card-danger) {
            border-color: color-mix(in srgb, var(--primary) 40%, var(--bd));
            box-shadow: 0 14px 32px rgba(37, 99, 235, 0.26);
            transform: translateY(-3px);
        }

        /* å±é™©çŠ¶æ€ï¼šçº¢è‰²è¾¹æ¡† */
        .device-card-danger {
            border: 3px solid var(--bad);
            box-shadow: 
                0 0 0 1px rgba(239, 68, 68, 0.4), 
                0 0 25px rgba(239, 68, 68, 0.5),
                var(--shadow);
            animation: dangerPulse 1.5s ease-in-out infinite;
        }
        
        /* å±é™©çŠ¶æ€ï¼šçº¢è‰²è·‘é©¬ç¯æ•ˆæœ */
        .device-card-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius);
            padding: 3px;
            background: linear-gradient(90deg, 
                transparent 0%,
                transparent 8%,
                rgba(239, 68, 68, 0.5) 15%,
                rgba(239, 68, 68, 1) 20%,
                rgba(255, 100, 100, 1) 25%,
                rgba(239, 68, 68, 1) 30%,
                rgba(239, 68, 68, 0.5) 35%,
                transparent 42%,
                transparent 58%,
                rgba(239, 68, 68, 0.5) 65%,
                rgba(239, 68, 68, 1) 70%,
                rgba(255, 100, 100, 1) 75%,
                rgba(239, 68, 68, 1) 80%,
                rgba(239, 68, 68, 0.5) 85%,
                transparent 92%,
                transparent 100%);
            background-size: 200% 100%;
            -webkit-mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            -webkit-mask-clip: content-box, border-box;
            -webkit-mask-composite: xor;
            mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            mask-clip: content-box, border-box;
            mask-composite: exclude;
            z-index: 0;
            animation: dangerMarquee 1.2s linear infinite;
            pointer-events: none;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: center;
        }

        .device-name {
            font-size: 18px;
            font-weight: 700;
        }

        .device-id {
            font-size: 12px;
            color: var(--muted);
        }

        .chip {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--bd) 70%, transparent);
            background: color-mix(in srgb, var(--card) 90%, transparent);
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
        }

        .chip-online {
            border-color: color-mix(in srgb, var(--good) 65%, transparent);
            color: var(--good);
            background: color-mix(in srgb, var(--good) 12%, transparent);
        }

        .chip-offline {
            border-color: color-mix(in srgb, var(--bad) 65%, transparent);
            color: var(--bad);
            background: color-mix(in srgb, var(--bad) 12%, transparent);
        }

        .device-realtime {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .realtime-metric {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid color-mix(in srgb, var(--bd) 70%, transparent);
            background: color-mix(in srgb, var(--card) 96%, transparent);
        }

        .metric-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .metric-unit {
            font-size: 12px;
            color: var(--muted);
        }

        .device-updated {
            font-size: 12px;
            color: var(--muted);
        }

        .device-alert {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 13px;
            background: color-mix(in srgb, var(--card) 94%, transparent);
            border: 1px dashed var(--bd);
            color: var(--muted);
        }

        .device-card-danger .device-alert {
            border-color: color-mix(in srgb, var(--bad) 70%, transparent);
            background: color-mix(in srgb, var(--bad) 12%, transparent);
            color: var(--bad);
        }

        /* çº¢è‰²è·‘é©¬ç¯åŠ¨ç”»ï¼ˆæ›´å¿«ï¼‰ */
        @keyframes dangerMarquee {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 0%;
            }
        }
        
        /* å±é™©çŠ¶æ€è„‰å†²åŠ¨ç”» */
        @keyframes dangerPulse {
            0%, 100% {
                box-shadow: 
                    0 0 0 1px rgba(239, 68, 68, 0.4), 
                    0 0 25px rgba(239, 68, 68, 0.5),
                    var(--shadow);
            }
            50% {
                box-shadow: 
                    0 0 0 2px rgba(239, 68, 68, 0.6), 
                    0 0 35px rgba(239, 68, 68, 0.7),
                    var(--shadow);
            }
        }

        .device-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
        }

        .tag {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--bd) 60%, transparent);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            font-size: 12px;
            max-width: 65%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .device-footer-cta {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .empty-tip {
            padding: 30px;
            text-align: center;
            color: var(--muted);
            border-radius: var(--radius);
            border: 1px dashed var(--bd);
            background: color-mix(in srgb, var(--card) 92%, transparent);
        }

        .device-select-content {
            max-width: 420px;
        }

        .device-select-hint {
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--muted);
        }

        .device-select-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 320px;
            overflow: auto;
        }

        .device-select-item {
            border: 1px solid var(--bd);
            border-radius: 12px;
            padding: 12px;
            background: color-mix(in srgb, var(--card) 96%, transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all .2s ease;
            color: var(--text);
        }

        .device-select-item:hover {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 12%, var(--card));
        }

        .device-select-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .device-select-name {
            font-weight: 600;
        }

        .device-select-id {
            font-size: 12px;
            color: var(--muted);
        }

        .device-select-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--bd) 70%, transparent);
            background: color-mix(in srgb, var(--card) 92%, transparent);
        }

        /* å¤ç”¨ index.html çš„å¼¹çª—/é®ç½©æ ·å¼ï¼Œç¡®ä¿å…¬å…±ç»„ä»¶é»˜è®¤éšè— */
        .overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .35);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .22s ease;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            width: min(1200px, 92vw);
            max-width: calc(100vw - 32px);
            max-height: calc(100vh - 32px);
            display: flex;
            flex-direction: column;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateY(8px) scale(.985);
            transition: transform .25s ease;
        }

        .overlay.show .modal {
            transform: translateY(0) scale(1);
        }

        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--bd);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        footer {
            margin-top: 10px;
            color: var(--muted);
            font-size: 12px;
            text-align: right;
        }

    </style>
</head>
<body>
<!-- å¯åŠ¨ç”»é¢ï¼ˆç”± common.js åŠ¨æ€ç”Ÿæˆï¼‰ -->
<div class="wrap">
    <header>
        <h1>
            <img src="/resource/logo.png" alt="logo" class="logo">
            <span>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</span>
        </h1>
        <div class="status">
            <span class="badge">åœ¨çº¿ï¼š<span id="onlineDeviceCount">0</span> å° / æ€»è®¾å¤‡ï¼š<span id="totalDeviceCount">0</span> å°</span>
            <div class="menu-wrapper">
                <div class="menu-btn" id="menuBtn">
                    <span>âš™ï¸ åŠŸèƒ½</span>
                    <span style="font-size: 10px; transition: transform .2s ease" id="menuArrow">â–¼</span>
                    <span class="menu-btn-badge" id="menuBtnBadge"></span>
                </div>
                <div class="menu-dropdown" id="menuDropdown">
                    <a href="/analysis.html" class="menu-item" title="æŸ¥çœ‹æ•°æ®ç»Ÿè®¡åˆ†æ">
                        <span>ğŸ“ˆ</span>
                        <span>æ•°æ®åˆ†æ</span>
                        <span class="ai-inside-badge">AI</span>
                    </a>
                    <div class="menu-item" id="messageCenterBtn" title="æŸ¥çœ‹è­¦å‘Šæ¶ˆæ¯ä¸­å¿ƒ">
                        <span>ğŸ””</span>
                        <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
                        <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                    </div>
                    <div class="menu-item" id="powerControlEntry" data-power-control-trigger title="çœç”µæ§åˆ¶">
                        <span>ğŸ”‹</span>
                        <span>çœç”µæ§åˆ¶</span>
                    </div>
                    <div class="menu-item" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜æ¨¡å¼">
                        <span>ğŸŒ™</span>
                        <span>ä¸»é¢˜åˆ‡æ¢</span>
                    </div>
                    <div class="menu-item" id="aboutBtn" title="å…³äºé¡¹ç›®">
                        <span>â„¹ï¸</span>
                        <span>å…³äºé¡¹ç›®</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="device-section">
        <div id="devices-container">
            <div class="empty-tip">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
        </div>
    </section>

    <footer>é™ˆé¹æ—­ Â· åŸºäº STM32 å’Œç‰©è”ç½‘çš„æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿè®¾è®¡ä¸å®ç° (<span data-latest-version>æœªçŸ¥ç‰ˆæœ¬</span>)</footer>
</div>

<!-- æ¶ˆæ¯ä¸­å¿ƒå¼¹çª— -->
<div id="messageCenterPanel" class="message-center-panel">
    <div class="message-center-header">
        <div class="message-center-title">
            <span>ğŸ””</span>
            <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
        </div>
        <button class="message-center-close" onclick="closeMessageCenter()" title="å…³é—­">Ã—</button>
    </div>
    <div class="message-center-filters">
        <div class="calendar-wrapper" id="calendarWrapper"></div>
        <select id="warningTypeFilter" class="message-filter-select">
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="T">æ¸©åº¦</option>
            <option value="H">æ¹¿åº¦</option>
            <option value="B">äº®åº¦</option>
            <option value="S">PPM</option>
            <option value="P">å¤§æ°”å‹</option>
        </select>
        <select id="warningStatusFilter" class="message-filter-select">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="0">æœªæ¢å¤</option>
            <option value="1">å·²æ¢å¤</option>
        </select>
        <button class="message-refresh-btn" onclick="loadWarningMessages()" title="åˆ·æ–°">ğŸ”„</button>
    </div>
    <div class="message-center-body" id="messageCenterBody">
        <div class="message-loading" id="messageLoading">åŠ è½½ä¸­...</div>
        <div class="message-empty" id="messageEmpty" style="display: none;">æš‚æ— è­¦å‘Šæ¶ˆæ¯</div>
        <div class="message-list" id="messageList"></div>
    </div>
</div>

<!-- è­¦å‘Šé€šçŸ¥å¼¹çª— -->
<div id="warningNotification" class="warning-notification" style="display: none;">
    <div class="warning-notification-content">
        <div class="warning-notification-icon">âš ï¸</div>
        <div class="warning-notification-text">
            <div class="warning-notification-title" id="warningNotificationTitle"></div>
            <div class="warning-notification-desc" id="warningNotificationDesc"></div>
        </div>
        <button class="warning-notification-close" onclick="closeWarningNotification()">Ã—</button>
    </div>
</div>

<!-- è®¾å¤‡é€‰æ‹©å¼¹çª— -->
<div id="deviceSelectModal" class="confirm-modal" aria-hidden="true">
    <div class="confirm-content device-select-content" role="dialog" aria-modal="true" aria-labelledby="deviceSelectTitle">
        <div class="confirm-icon">ğŸ“Ÿ</div>
        <div class="confirm-title" id="deviceSelectTitle">é€‰æ‹©è®¾å¤‡</div>
        <div class="device-select-hint" id="deviceSelectHint">è¯·é€‰æ‹©è¦è¿›è¡Œæ“ä½œçš„ç›®æ ‡è®¾å¤‡</div>
        <div class="device-select-list" id="deviceSelectList"></div>
        <div class="confirm-actions">
            <button class="confirm-btn confirm-btn-cancel" data-device-select-cancel>å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script src="/static/changelog-data.js?v=20250205"></script>
<script src="/static/common.js?v=20250205"></script>
<script>
(() => {
    const container = document.getElementById('devices-container');
    const onlineDeviceCountEl = document.getElementById('onlineDeviceCount');
    const totalDeviceCountEl = document.getElementById('totalDeviceCount');
    const DEVICE_STORAGE_KEY = 'device_overview_selected';
    const deviceSelectModal = document.getElementById('deviceSelectModal');
    const deviceSelectList = document.getElementById('deviceSelectList');
    const deviceSelectHint = document.getElementById('deviceSelectHint');
    let devicePickerResolver = null;
    let devicesCache = [];
    let ws = null;
    let wsReconnectTimer = null;
    const realtimeMap = new Map();
    const warningMap = new Map();
    const deviceLastSeenMap = new Map(); // è®°å½•æ¯ä¸ªè®¾å¤‡æœ€åæ”¶åˆ°æ•°æ®çš„æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
    const DEVICE_OFFLINE_TIMEOUT = 10; // è®¾å¤‡ç¦»çº¿è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ10ç§’å†…æ²¡æœ‰æ”¶åˆ°æ•°æ®åˆ™è®¤ä¸ºç¦»çº¿ï¼ˆçº¦ä¸¤ä¸ªæ•°æ®åŒ…é—´éš”ï¼‰
    let deviceStatusCheckInterval = null; // è®¾å¤‡çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨
    let requireDeviceSelection = true;

    function normalizeDeviceId(id) {
        if (!id) return '';
        return String(id).trim().toUpperCase();
    }

    function applySelectedDevice(deviceId) {
        const normalized = normalizeDeviceId(deviceId);
        if (!normalized) return;
        window.selectedDeviceId = normalized;
        localStorage.setItem(DEVICE_STORAGE_KEY, normalized);
        requireDeviceSelection = false;
    }

    function formatNumber(value, digits = 1) {
        if (typeof value !== 'number' || Number.isNaN(value)) {
            return '--';
        }
        return value.toFixed(digits);
    }

    function formatTime(ts) {
        if (!ts) return '--';
        const date = new Date(ts * 1000);
        if (Number.isNaN(date.getTime())) return '--';
        return date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    }

    function getStatusBadge(online, viaList) {
        const viaText = viaList && viaList.length ? viaList.join(' / ') : 'æœªçŸ¥é“¾è·¯';
        if (online) {
            return `<span class="chip chip-online">åœ¨çº¿ Â· ${viaText}</span>`;
        }
        return `<span class="chip chip-offline">ç¦»çº¿ Â· ${viaText}</span>`;
    }

    /**
     * æ ¹æ®æœ€åæ”¶åˆ°æ•°æ®çš„æ—¶é—´åˆ¤æ–­è®¾å¤‡æ˜¯å¦åœ¨çº¿
     * @param {string} deviceId - è®¾å¤‡ID
     * @param {boolean} fallbackOnline - æ­¤å‚æ•°å·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨åç«¯è¿”å›çš„çŠ¶æ€ä½œä¸ºåˆå§‹å€¼
     * @returns {boolean} è®¾å¤‡æ˜¯å¦åœ¨çº¿
     */
    function isDeviceOnline(deviceId, fallbackOnline = false) {
        const normalizedId = normalizeDeviceId(deviceId);
        if (!normalizedId) return false;
        
        const lastSeen = deviceLastSeenMap.get(normalizedId);
        if (!lastSeen) {
            // ä»æœªæ”¶åˆ°è¿‡ WebSocket æ•°æ®ï¼Œæ— æ³•ç¡®å®šè®¾å¤‡æ˜¯å¦åœ¨çº¿ï¼Œè¿”å›ç¦»çº¿
            // åªæœ‰æ”¶åˆ°ç¬¬ä¸€ä¸ªæ•°æ®åŒ…åï¼Œæ‰ä¼šæ ‡è®°ä¸ºåœ¨çº¿
            return false;
        }
        
        const now = Date.now() / 1000; // å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
        const timeSinceLastSeen = now - lastSeen;
        
        return timeSinceLastSeen <= DEVICE_OFFLINE_TIMEOUT;
    }

    /**
     * æ›´æ–°è®¾å¤‡æœ€åæ´»è·ƒæ—¶é—´
     */
    function updateDeviceLastSeen(deviceId) {
        const normalizedId = normalizeDeviceId(deviceId);
        if (!normalizedId) return;
        deviceLastSeenMap.set(normalizedId, Date.now() / 1000);
    }

    /**
     * æ›´æ–°å•ä¸ªè®¾å¤‡çš„çŠ¶æ€æ˜¾ç¤º
     */
    function updateDeviceStatusDisplay(deviceId) {
        const normalizedId = normalizeDeviceId(deviceId);
        if (!normalizedId) return;
        
        const deviceCard = container.querySelector(`[data-id="${normalizedId}"]`);
        if (!deviceCard) return;
        
        const statusBadgeEl = deviceCard.querySelector('.chip');
        if (!statusBadgeEl) return;
        
        // ä»è®¾å¤‡ç¼“å­˜ä¸­è·å–è®¾å¤‡ä¿¡æ¯
        const device = devicesCache.find(d => normalizeDeviceId(d.id || d.device_id) === normalizedId);
        if (!device) return;
        
        const transports = [];
        if (device.has_ble) transports.push('BLE');
        if (device.has_mqtt) transports.push('MQTT');
        const viaList = device.via || transports;
        const viaText = viaList && viaList.length ? viaList.join(' / ') : 'æœªçŸ¥é“¾è·¯';
        
        // ä½¿ç”¨å®æ—¶æ¨æ–­çš„åœ¨çº¿çŠ¶æ€ï¼Œåªæœ‰æ”¶åˆ°è¿‡ WebSocket æ•°æ®æ‰èƒ½åˆ¤æ–­æ˜¯å¦åœ¨çº¿
        const isOnline = isDeviceOnline(normalizedId);
        statusBadgeEl.className = isOnline ? 'chip chip-online' : 'chip chip-offline';
        statusBadgeEl.textContent = isOnline ? `åœ¨çº¿ Â· ${viaText}` : `ç¦»çº¿ Â· ${viaText}`;
    }

    /**
     * æ£€æŸ¥æ‰€æœ‰è®¾å¤‡çš„çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
     */
    function updateDeviceCounts() {
        if (!devicesCache || !devicesCache.length) {
            if (onlineDeviceCountEl) onlineDeviceCountEl.textContent = '0';
            if (totalDeviceCountEl) totalDeviceCountEl.textContent = '0';
            return;
        }
        
        // ç»Ÿè®¡åœ¨çº¿è®¾å¤‡æ•°é‡
        let onlineCount = 0;
        devicesCache.forEach((dev) => {
            const deviceId = normalizeDeviceId(dev.id || dev.device_id || '');
            if (isDeviceOnline(deviceId)) {
                onlineCount++;
            }
        });
        
        // æ›´æ–°æ˜¾ç¤º
        if (onlineDeviceCountEl) onlineDeviceCountEl.textContent = onlineCount;
        if (totalDeviceCountEl) totalDeviceCountEl.textContent = devicesCache.length;
    }

    function checkAllDevicesStatus() {
        devicesCache.forEach(device => {
            const deviceId = normalizeDeviceId(device.id || device.device_id);
            if (deviceId) {
                updateDeviceStatusDisplay(deviceId);
                // åŒæ—¶æ›´æ–°è­¦å‘Šæ˜¾ç¤ºï¼Œç¡®ä¿ç¦»çº¿è®¾å¤‡ä¸ä¼šæ˜¾ç¤º"è¿è¡ŒçŠ¶æ€è‰¯å¥½"
                updateWarningDisplay(deviceId);
            }
        });
        // æ›´æ–°è®¾å¤‡æ•°é‡ç»Ÿè®¡
        updateDeviceCounts();
    }

    function renderDevices(devices) {
        if (!devices || !devices.length) {
            container.innerHTML = '<div class="empty-tip">å½“å‰æ²¡æœ‰å·²é…ç½®çš„è®¾å¤‡ã€‚</div>';
            if (onlineDeviceCountEl) onlineDeviceCountEl.textContent = '0';
            if (totalDeviceCountEl) totalDeviceCountEl.textContent = '0';
            return;
        }
        
        // æ›´æ–°è®¾å¤‡æ•°é‡ç»Ÿè®¡
        updateDeviceCounts();
        
        const cards = devices.map((dev) => {
            const deviceId = normalizeDeviceId(dev.id || dev.device_id || '');
            const transports = [];
            if (dev.has_ble) transports.push('BLE');
            if (dev.has_mqtt) transports.push('MQTT');
            // ä½¿ç”¨å®æ—¶æ¨æ–­çš„åœ¨çº¿çŠ¶æ€ï¼Œåªæœ‰æ”¶åˆ°è¿‡ WebSocket æ•°æ®æ‰èƒ½åˆ¤æ–­æ˜¯å¦åœ¨çº¿
            const isOnline = isDeviceOnline(deviceId);
            const statusBadge = getStatusBadge(isOnline, dev.via || transports);
            const desc = dev.description || (transports.length ? `é“¾è·¯ï¼š${transports.join('/')}` : 'æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç»ˆç«¯');
            return `
                <div class="device-card" data-id="${deviceId}">
                    <div class="device-header">
                        <div>
                            <div class="device-name">${dev.name || ('è®¾å¤‡ ' + deviceId)}</div>
                            <div class="device-id">ID: ${deviceId}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="device-realtime">
                        <div class="realtime-metric">
                            <div class="metric-label">å®æ—¶æ¸©åº¦</div>
                            <div class="metric-value" data-device-field="temp" data-device-id="${deviceId}">
                                <span>--</span><span class="metric-unit">Â°C</span>
                            </div>
                        </div>
                        <div class="realtime-metric">
                            <div class="metric-label">å®æ—¶æ¹¿åº¦</div>
                            <div class="metric-value" data-device-field="hum" data-device-id="${deviceId}">
                                <span>--</span><span class="metric-unit">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="device-updated" data-device-field="updated" data-device-id="${deviceId}">æœ€è¿‘æ›´æ–°æ—¶é—´ï¼š--</div>
                    <div class="device-alert" data-device-field="alert" data-device-id="${deviceId}">ç­‰å¾…å®æ—¶æ•°æ®...</div>
                    <div class="device-footer">
                        <div class="device-footer-cta">
                            <span>æŸ¥çœ‹å®æ—¶æ•°æ®</span>
                            <span>âœ</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        container.innerHTML = `<div class="device-grid">${cards}</div>`;

        container.querySelectorAll('.device-card').forEach((card) => {
            card.addEventListener('click', () => {
                const id = card.getAttribute('data-id');
                if (id) {
                    applySelectedDevice(id);
                    window.location.href = `/realtime.html?device_id=${encodeURIComponent(id)}`;
                }
            });
        });

        devices.forEach((dev) => {
            const deviceId = normalizeDeviceId(dev.id || dev.device_id || '');
            updateRealtimeDisplay(deviceId);
            updateWarningDisplay(deviceId);
        });
        updateDevicePicker();
    }

    function updateRealtimeDisplay(deviceId) {
        if (!deviceId) return;
        const realtime = realtimeMap.get(deviceId);
        const tempEl = document.querySelector(`[data-device-field="temp"][data-device-id="${deviceId}"] span:first-child`);
        const humEl = document.querySelector(`[data-device-field="hum"][data-device-id="${deviceId}"] span:first-child`);

        const updatedEl = document.querySelector(`[data-device-field="updated"][data-device-id="${deviceId}"]`);
        let tempValue = null;
        if (realtime) {
            if (typeof realtime.temp === 'number' && !Number.isNaN(realtime.temp)) {
                tempValue = realtime.temp;
            } else if (typeof realtime.temp2 === 'number' && !Number.isNaN(realtime.temp2)) {
                tempValue = realtime.temp2;
            }
        }
        if (tempEl) {
            tempEl.textContent = tempValue === null ? '--' : formatNumber(tempValue, 1);
        }
        const humValue = realtime && typeof realtime.hum === 'number' && !Number.isNaN(realtime.hum)
            ? realtime.hum
            : null;
        if (humEl) {
            humEl.textContent = humValue === null ? '--' : formatNumber(humValue, 1);
        }
        if (updatedEl) {
            updatedEl.textContent = realtime && realtime.ts ? `æœ€è¿‘æ›´æ–°æ—¶é—´ï¼š${formatTime(realtime.ts)}` : 'æœ€è¿‘æ›´æ–°æ—¶é—´ï¼š--';
        }
    }

    function updateWarningDisplay(deviceId) {
        if (!deviceId) return;
        const alertEl = document.querySelector(`[data-device-field="alert"][data-device-id="${deviceId}"]`);
        const cardEl = document.querySelector(`.device-card[data-id="${deviceId}"]`);
        const warning = warningMap.get(deviceId);
        if (!alertEl) return;
        
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿
        const normalizedId = normalizeDeviceId(deviceId);
        const isOnline = isDeviceOnline(normalizedId);
        
        if (warning) {
            let warningValueText = '--';
            if (typeof warning.warning_value === 'number' && !Number.isNaN(warning.warning_value)) {
                warningValueText = warning.warning_value;
            } else if (typeof warning.warning_value === 'string' && warning.warning_value.trim() !== '') {
                warningValueText = warning.warning_value;
            }
            const warningUnit = warning.warning_unit || '';
            alertEl.textContent = `âš ï¸ ${warning.warning_name || 'å±é™©'} Â· ${warningValueText}${warningUnit}`;
            if (cardEl) {
                cardEl.classList.add('device-card-danger');
            }
        } else {
            // æ²¡æœ‰è­¦å‘Šæ—¶ï¼Œæ ¹æ®è®¾å¤‡åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
            if (isOnline) {
                alertEl.textContent = 'è¿è¡ŒçŠ¶æ€è‰¯å¥½';
            } else {
                alertEl.textContent = 'ç­‰å¾…å®æ—¶æ•°æ®...';
            }
            if (cardEl) {
                cardEl.classList.remove('device-card-danger');
            }
        }
    }

    async function loadDevices() {
        try {
            const res = await fetch('/api/devices');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
            devicesCache = (data.devices || []).map((d) => ({
                ...d,
                id: normalizeDeviceId(d.id || d.device_id || '')
            }));
            
            // ä¸å†æ ¹æ®åç«¯è¿”å›çš„çŠ¶æ€è®¾ç½®åˆå§‹æ—¶é—´æˆ³
            // åªæœ‰æ”¶åˆ°ç¬¬ä¸€ä¸ª WebSocket æ•°æ®åŒ…åï¼Œæ‰ä¼šæ ‡è®°è®¾å¤‡ä¸ºåœ¨çº¿
            
            renderDevices(devicesCache);
            // æ¸²æŸ“åç«‹å³æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰è®¾å¤‡çŠ¶æ€
            checkAllDevicesStatus();
        } catch (error) {
            console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š', error);
            container.innerHTML = `<div class="empty-tip">åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š${error.message || error}</div>`;
            if (onlineDeviceCountEl) onlineDeviceCountEl.textContent = '0';
            if (totalDeviceCountEl) totalDeviceCountEl.textContent = '0';
        }
    }

    function handleReadingMessage(payload) {
        const deviceId = normalizeDeviceId(payload.device_id || 'D01');
        // æ›´æ–°è®¾å¤‡æœ€åæ´»è·ƒæ—¶é—´
        updateDeviceLastSeen(deviceId);
        realtimeMap.set(deviceId, {
            temp: typeof payload.temp === 'number' ? payload.temp : null,
            hum: typeof payload.hum === 'number' ? payload.hum : null,
            ts: payload.ts || Date.now() / 1000
        });
        updateRealtimeDisplay(deviceId);
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        updateDeviceStatusDisplay(deviceId);
    }

    function handleWarningMessage(payload) {
        const deviceId = normalizeDeviceId(payload.device_id || 'D01');
        // è­¦å‘Šæ¶ˆæ¯ä¹Ÿè¯´æ˜è®¾å¤‡åœ¨çº¿
        updateDeviceLastSeen(deviceId);
        warningMap.set(deviceId, payload);
        updateWarningDisplay(deviceId);
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        updateDeviceStatusDisplay(deviceId);
        if (window.MessageCenter) {
            window.MessageCenter.handleWarningMessage(payload);
        }
    }

    function handleResolvedMessage(payload) {
        const deviceId = normalizeDeviceId(payload.device_id || 'D01');
        // æ¢å¤æ¶ˆæ¯ä¹Ÿè¯´æ˜è®¾å¤‡åœ¨çº¿
        updateDeviceLastSeen(deviceId);
        warningMap.delete(deviceId);
        updateWarningDisplay(deviceId);
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        updateDeviceStatusDisplay(deviceId);
        if (window.MessageCenter) {
            window.MessageCenter.handleResolvedMessage(payload);
        }
    }

    function connectWebSocket() {
        if (ws) {
            try {
                ws.close();
            } catch (e) {
                console.warn('å…³é—­æ—§ WebSocket å¤±è´¥ï¼š', e);
            }
        }
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        ws = new WebSocket(`${protocol}${window.location.host}/ws`);
        ws.onopen = () => console.log('âœ… devices.html WebSocket å·²è¿æ¥');
        ws.onclose = () => {
            console.warn('âš ï¸ devices.html WebSocket å·²æ–­å¼€ï¼Œå‡†å¤‡é‡è¿');
            ws = null;
            if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
            wsReconnectTimer = setTimeout(connectWebSocket, 2000);
        };
        ws.onmessage = (event) => {
            try {
                const payload = JSON.parse(event.data);
                if (!payload || !payload.type) return;
                switch (payload.type) {
                    case 'reading':
                        handleReadingMessage(payload);
                        break;
                    case 'warning':
                        handleWarningMessage(payload);
                        break;
                    case 'warning_resolved':
                        handleResolvedMessage(payload);
                        break;
                    default:
                        break;
                }
            } catch (error) {
                console.error('è§£æ WebSocket æ¶ˆæ¯å¤±è´¥ï¼š', error);
            }
        };
    }

    function updateDevicePicker(selectedDeviceId = null) {
        if (!deviceSelectList) return;
        // ä¸è‡ªåŠ¨ä½¿ç”¨window.selectedDeviceIdï¼Œé¿å…é»˜è®¤é€‰ä¸­æŸä¸ªè®¾å¤‡
        // åªæœ‰åœ¨æ˜ç¡®ä¼ é€’selectedDeviceIdæ—¶æ‰ä½¿ç”¨
        const selected = selectedDeviceId ? normalizeDeviceId(selectedDeviceId) : '';
        if (!devicesCache.length) {
            deviceSelectList.innerHTML = '<div class="empty-tip" style="margin:0;">æš‚æ— å¯é€‰è®¾å¤‡</div>';
            return;
        }
        deviceSelectList.innerHTML = devicesCache.map((dev) => {
            // ç¡®ä¿dev.idä¹Ÿæ˜¯å¤§å†™æ ¼å¼è¿›è¡Œæ¯”è¾ƒï¼Œé¿å…é”™è¯¯åŒ¹é…
            const devId = normalizeDeviceId(dev.id);
            const isActive = selected && devId && selected === devId;
            const status = dev.online ? 'åœ¨çº¿' : 'ç¦»çº¿';
            return `
                <button type="button" class="device-select-item ${isActive ? 'active' : ''}" data-device-id="${dev.id}">
                    <div class="device-select-meta">
                        <span class="device-select-name">${dev.name || ('è®¾å¤‡ ' + dev.id)}</span>
                        <span class="device-select-id">ID: ${dev.id}</span>
                    </div>
                    <span class="device-select-status">${status}</span>
                </button>
            `;
        }).join('');
    }

    function openDevicePicker(hintText) {
        if (!devicesCache.length) {
            if (typeof window.showNotification === 'function') {
                window.showNotification('æš‚æ— å¯é€‰è®¾å¤‡', true);
            }
            return Promise.resolve(null);
        }
        deviceSelectHint.textContent = hintText || 'è¯·é€‰æ‹©è¦æ“ä½œçš„è®¾å¤‡';
        // ä¸ä¼ é€’selectedDeviceIdï¼Œé¿å…é»˜è®¤é€‰ä¸­æŸä¸ªè®¾å¤‡
        updateDevicePicker(null);
        deviceSelectModal.classList.add('show');
        deviceSelectModal.setAttribute('aria-hidden', 'false');
        return new Promise((resolve) => {
            devicePickerResolver = resolve;
        });
    }

    function closeDevicePicker(result = null) {
        deviceSelectModal.classList.remove('show');
        deviceSelectModal.setAttribute('aria-hidden', 'true');
        if (devicePickerResolver) {
            devicePickerResolver(result);
            devicePickerResolver = null;
        }
    }

    if (deviceSelectList) {
        deviceSelectList.addEventListener('click', (event) => {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const item = event.target.closest('.device-select-item');
            if (!item) return;
            const deviceId = item.getAttribute('data-device-id');
            closeDevicePicker(deviceId || null);
        });
    }

    const deviceSelectCancelBtn = document.querySelector('[data-device-select-cancel]');
    if (deviceSelectCancelBtn) {
        deviceSelectCancelBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            closeDevicePicker(null);
        });
    }
    if (deviceSelectModal) {
        deviceSelectModal.addEventListener('click', (event) => {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ–‡æ¡£
            if (event.target === deviceSelectModal) closeDevicePicker(null);
        });
        // é˜»æ­¢å¼¹çª—å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        const deviceSelectContent = deviceSelectModal.querySelector('.confirm-content');
        if (deviceSelectContent) {
            deviceSelectContent.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        }
    }

    function guardAction(button, hintText, afterReady) {
        if (!button) return;
        const handler = async (event) => {
            if (!requireDeviceSelection && window.selectedDeviceId) {
                button.removeEventListener('click', handler, true);
                return;
            }
            event.preventDefault();
            event.stopImmediatePropagation();
            const deviceId = await openDevicePicker(hintText);
            if (!deviceId) return;
            applySelectedDevice(deviceId);
            button.removeEventListener('click', handler, true);
            if (typeof afterReady === 'function') {
                afterReady(deviceId);
            } else {
                setTimeout(() => button.click(), 0);
            }
        };
        button.addEventListener('click', handler, true);
    }

    function setupMessageCenterSelection() {
        const messageBtn = document.getElementById('messageCenterBtn');
        let pendingMessageCenterDeviceId = null;

        window.setPendingMessageCenterDevice = function (deviceId) {
            pendingMessageCenterDeviceId = deviceId ? String(deviceId).trim().toUpperCase() : null;
        };

        if (window.MessageCenter && typeof window.MessageCenter.setBeforeOpenHook === 'function') {
            window.MessageCenter.setBeforeOpenHook(() => {
                if (pendingMessageCenterDeviceId) {
                    const deviceId = pendingMessageCenterDeviceId;
                    pendingMessageCenterDeviceId = null;
                    applySelectedDevice(deviceId);
                    return deviceId;
                }
                // ä¸è¿”å›window.selectedDeviceIdï¼Œé¿å…é»˜è®¤é€‰ä¸­æŸä¸ªè®¾å¤‡
                return null;
            });
        }

        if (messageBtn) {
            messageBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                
                // å…ˆå…³é—­èœå•ï¼ˆå¦‚æœæ‰“å¼€çš„è¯ï¼‰
                const menuDropdown = document.querySelector('.menu-dropdown');
                const menuBtn = document.querySelector('.menu-btn');
                const menuArrow = document.querySelector('.menu-arrow');
                if (menuDropdown && menuDropdown.classList.contains('show')) {
                    menuDropdown.classList.remove('show');
                    if (menuBtn) menuBtn.classList.remove('active');
                    if (menuArrow) menuArrow.style.transform = 'rotate(0deg)';
                }
                
                // ä¸ä¼ é€’selectedDeviceIdï¼Œé¿å…é»˜è®¤é€‰ä¸­æŸä¸ªè®¾å¤‡
                const deviceId = await openDevicePicker('è¯·é€‰æ‹©è¦æŸ¥çœ‹æ¶ˆæ¯çš„è®¾å¤‡');
                if (!deviceId) return;
                
                applySelectedDevice(deviceId);
                if (typeof window.setPendingMessageCenterDevice === 'function') {
                    window.setPendingMessageCenterDevice(deviceId);
                } else {
                    pendingMessageCenterDeviceId = deviceId;
                }
                
                // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿å¼¹çª—å®Œå…¨å…³é—­
                setTimeout(() => {
                    if (window.MessageCenter && typeof window.MessageCenter.open === 'function') {
                        window.MessageCenter.open();
                    }
                }, 100);
            }, true);
        }
    }

    function setupActionGuards() {
        const powerBtn = document.getElementById('powerControlEntry');
        if (!powerBtn) return;
        
        // ç§»é™¤åŸæœ‰çš„ data-power-control-trigger ç»‘å®šï¼Œä½¿ç”¨è‡ªå®šä¹‰å¤„ç†
        powerBtn.removeAttribute('data-power-control-trigger');
        
        // å…ˆç§»é™¤å¯èƒ½å·²ç»ç»‘å®šçš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹çš„æ–¹å¼ï¼‰
        const newPowerBtn = powerBtn.cloneNode(true);
        powerBtn.parentNode.replaceChild(newPowerBtn, powerBtn);
        const actualPowerBtn = document.getElementById('powerControlEntry');
        
        // ç»‘å®šè‡ªå®šä¹‰ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨ capture é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆæ‰§è¡Œï¼‰
        actualPowerBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation(); // é˜»æ­¢å…¶ä»–äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œ
            
            // å…ˆå¼¹å‡ºè®¾å¤‡é€‰æ‹©å™¨
            const deviceId = await openDevicePicker('è¯·é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡');
            if (!deviceId) return; // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
            
            // åº”ç”¨é€‰æ‹©çš„è®¾å¤‡ID
            applySelectedDevice(deviceId);
            
            // æ‰“å¼€çœç”µæ§åˆ¶ä¸­å¿ƒï¼Œä¼ é€’å·²é€‰æ‹©çš„è®¾å¤‡ID
            if (window.PowerControlModal && typeof window.PowerControlModal.open === 'function') {
                await window.PowerControlModal.open(deviceId);
            } else {
                console.error('PowerControlModal æœªåˆå§‹åŒ–');
            }
        }, true); // ä½¿ç”¨ capture é˜¶æ®µ
    }

    function initSharedUI() {
        if (typeof window.setupThemeToggle === 'function') {
            window.setupThemeToggle('themeBtn');
        }
        if (typeof window.initFunctionMenu === 'function') {
            window.initFunctionMenu();
        }
        if (typeof window.initAboutModal === 'function') {
            window.initAboutModal();
        }
        if (typeof window.initHelpModal === 'function') {
            window.initHelpModal();
        }
        if (window.MessageCenter) {
            window.MessageCenter.init();
        }
        setupMessageCenterSelection();
        setupActionGuards();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem(DEVICE_STORAGE_KEY);
        if (saved) {
            const normalizedSaved = normalizeDeviceId(saved);
            if (normalizedSaved) {
                window.selectedDeviceId = normalizedSaved;
                requireDeviceSelection = false;
            } else {
                window.selectedDeviceId = null;
                requireDeviceSelection = true;
            }
        } else {
            window.selectedDeviceId = null;
            requireDeviceSelection = true;
        }
        initSharedUI();
        loadDevices();
        setInterval(loadDevices, 8000);
        connectWebSocket();
        // å¯åŠ¨è®¾å¤‡çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨ï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡è®¾å¤‡æ˜¯å¦ç¦»çº¿
        deviceStatusCheckInterval = setInterval(checkAllDevicesStatus, 5000);
        
        // æ£€æŸ¥é¦–æ¬¡è®¿é—®å¹¶æ˜¾ç¤ºå¸®åŠ©ï¼ˆé¦–é¡µæ˜¯devices.htmlï¼‰
        if (typeof window.checkFirstVisit === 'function') {
            window.checkFirstVisit();
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (deviceStatusCheckInterval) {
                clearInterval(deviceStatusCheckInterval);
                deviceStatusCheckInterval = null;
            }
            if (wsReconnectTimer) {
                clearTimeout(wsReconnectTimer);
                wsReconnectTimer = null;
            }
            if (ws) {
                try {
                    ws.close();
                } catch (e) {
                    // å¿½ç•¥å…³é—­é”™è¯¯
                }
            }
        });
    });
})();
</script>
</body>
</html>

