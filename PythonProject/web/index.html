<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
    <meta charset="UTF-8"/>
    <link rel="manifest" href="/resource/manifest.json">
    <link rel="icon" type="image/x-icon" href="/resource/favicon.ico">
    <link rel="apple-touch-icon" href="/resource/favicon_192.png" sizes="192x192">
    <link rel="icon" href="/resource/favicon_512.png" sizes="512x512">
    <link rel="stylesheet" href="/static/common-styles.css?v=20250205">
    <!-- é«˜å¾·åœ°å›¾APIï¼ˆKey åœ¨æœåŠ¡ç«¯æ³¨å…¥ï¼‰ -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=__AMAP_WEB_KEY__"></script>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <!-- å£°æ˜ä¸ºç§»åŠ¨Webåº”ç”¨ï¼ˆæ”¯æŒEdge/Chromeç­‰ï¼‰ -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- å£°æ˜ä¸ºiOS Webåº”ç”¨ï¼ˆæ”¯æŒSafariï¼‰ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- éšè—iOSçŠ¶æ€æ ï¼ˆè®©ç•Œé¢æ›´åƒAppï¼‰ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- æ¡Œé¢å›¾æ ‡åç§°ï¼ˆæ·»åŠ åˆ°æ¡Œé¢æ—¶æ˜¾ç¤ºçš„åç§°ï¼‰ -->
    <meta name="apple-mobile-web-app-title" content="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ">
    <meta name="application-name" content="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ">
    <title>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ - å®æ—¶æ•°æ®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        :root {
            --bg: #0b1020;
            --card: #0f162e;
            --bd: #1d2b4a;
            --text: #e6eefc;
            --muted: #9aa6bf;
            --good: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --primary: #3b82f6;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --chart-grid: #1b2544;
            --chart-line-temp-cold: #38bdf8;
            --chart-line-temp-warm: #f97316;
            --chart-line-hum: #34d399;
            --chart-line-lux: #a78bfa;
            --chart-line-smoke: #fb923c;
            --chart-line-pressure: #ec4899;
        }

        @media (prefers-color-scheme: light) {
            :root[data-theme="auto"] {
                --bg: #f5f7fa;
                --card: #fff;
                --bd: #d6d9e0;
                --text: #111827;
                --muted: #64748b;
                --good: #16a34a;
                --bad: #dc2626;
                --warn: #ea580c;
                --primary: #2563eb;
                --shadow: 0 8px 18px rgba(0, 0, 0, .08);
                --chart-grid: #e2e8f0;
                --chart-line-temp-cold: #2563eb;
                --chart-line-temp-warm: #ef4444;
                --chart-line-hum: #059669;
                --chart-line-lux: #7c3aed;
                --chart-line-smoke: #ea580c;
                --chart-line-pressure: #db2777;
            }
        }

        :root[data-theme="light"] {
            --bg: #f5f7fa;
            --card: #fff;
            --bd: #d6d9e0;
            --text: #111827;
            --muted: #64748b;
            --good: #16a34a;
            --bad: #dc2626;
            --warn: #ea580c;
            --primary: #2563eb;
            --shadow: 0 8px 18px rgba(0, 0, 0, .08);
            --chart-grid: #e2e8f0;
            --chart-line-temp-cold: #2563eb;
            --chart-line-temp-warm: #ef4444;
            --chart-line-hum: #059669;
            --chart-line-lux: #7c3aed;
            --chart-line-smoke: #ea580c;
            --chart-line-pressure: #db2777;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            letter-spacing: .2px;
            transition: .3s;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
                font-size: 14px
            }
        }

        .wrap {
            max-width: 1300px;
            margin: 0 auto
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px
            }

            h1 {
                font-size: 16px;
                text-align: center;
                margin-bottom: 0;
                justify-content: center
            }

            h1 .logo {
                height: 26px;
                width: auto
            }
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px
        }

        h1 .logo {
            height: 28px;
            width: auto;
            object-fit: contain;
            flex-shrink: 0
        }

        .status {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end
        }

        @media (max-width: 768px) {
            .status {
                gap: 6px;
                font-size: 11px;
                justify-content: center
            }

            .badge {
                padding: 4px 8px;
                font-size: 11px;
                flex-shrink: 0
            }
        }

        .badge, .theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid var(--bd);
            border-radius: 999px;
            color: var(--muted);
            background: var(--card);
            transition: all .2s ease;
            white-space: nowrap
        }

        .badge:hover {
            filter: brightness(1.05)
        }
        
        .badge.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .badge.clickable:hover {
            filter: brightness(1.15);
            transform: translateY(-1px);
        }
        
        .badge.clickable:active {
            transform: translateY(0);
        }
        
        /* è¿æ¥çŠ¶æ€å¼¹çª—å®¹å™¨ */
        .status-badge-wrapper {
            position: relative;
            display: inline-flex;
        }
        
        /* è¿æ¥çŠ¶æ€å¼¹çª— */
        .status-popup {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            min-width: 340px;
            max-width: 400px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 10000;
            white-space: normal;
        }
        
        .status-popup.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        
        /* å¼¹çª—ç®­å¤´ */
        .status-popup::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 12px;
            height: 12px;
            background: var(--card);
            border-left: 1px solid var(--bd);
            border-top: 1px solid var(--bd);
            transition: all 0.2s ease;
        }
        
        /* å‘ä¸‹å¼¹å‡ºï¼ˆé»˜è®¤ï¼‰ */
        .status-popup.popup-down {
            top: calc(100% + 8px);
            bottom: auto;
            max-height: none;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .status-popup.popup-down.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .status-popup.popup-down::before {
            top: -6px;
            bottom: auto;
            border-left: 1px solid var(--bd);
            border-top: 1px solid var(--bd);
            border-right: none;
            border-bottom: none;
        }
        
        /* å‘ä¸Šå¼¹å‡º */
        .status-popup.popup-up {
            top: auto;
            bottom: calc(100% + 8px);
            max-height: none;
            transform: translateX(-50%) translateY(10px);
        }
        
        .status-popup.popup-up.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .status-popup.popup-up::before {
            top: auto;
            bottom: -6px;
            border-left: none;
            border-top: none;
            border-right: 1px solid var(--bd);
            border-bottom: 1px solid var(--bd);
        }
        
        .status-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--bd);
        }
        
        .status-popup-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        
        .status-popup-close {
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            color: var(--muted);
            transition: color 0.2s ease;
            padding: 4px;
        }
        
        .status-popup-close:hover {
            color: var(--text);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--bd);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-item-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .status-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        
        .status-item-desc {
            font-size: 11px;
            color: var(--muted);
        }
        
        .status-item-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-item-badge.connected {
            background: var(--good);
            color: white;
        }
        
        .status-item-badge.disconnected {
            background: var(--muted);
            color: white;
        }
        
        .status-item-badge .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* å“åº”å¼ï¼šå°å±å¹•é€‚é… */
        @media (max-width: 768px) {
            .status-popup {
                /* ç§»é™¤å¼ºåˆ¶å±…ä¸­ï¼Œç”±JavaScriptåŠ¨æ€å®šä½ */
                left: 0;
                right: auto;
                min-width: 300px;
                max-width: calc(100vw - 20px);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
            }
            
            /* å‘ä¸‹å¼¹å‡º */
            .status-popup.popup-down {
                top: calc(100% + 8px);
                bottom: auto;
                max-height: calc(100vh - 140px); /* å¢åŠ æ›´å¤šè¾¹è· */
                transform: translateX(0) translateY(-10px);
            }
            
            .status-popup.popup-down.show {
                transform: translateX(0) translateY(0);
            }
            
            .status-popup.popup-down::before {
                top: -6px;
                bottom: auto;
                /* ç®­å¤´ä½ç½®ç”±JavaScriptåŠ¨æ€è®¾ç½® */
                left: 20px;
                transform: rotate(45deg);
                border-left: 1px solid var(--bd);
                border-top: 1px solid var(--bd);
                border-right: none;
                border-bottom: none;
            }
            
            /* å‘ä¸Šå¼¹å‡º */
            .status-popup.popup-up {
                top: auto;
                bottom: calc(100% + 8px);
                max-height: calc(100vh - 140px); /* å¢åŠ æ›´å¤šè¾¹è· */
                transform: translateX(0) translateY(10px);
            }
            
            .status-popup.popup-up.show {
                transform: translateX(0) translateY(0);
            }
            
            .status-popup.popup-up::before {
                top: auto;
                bottom: -6px;
                /* ç®­å¤´ä½ç½®ç”±JavaScriptåŠ¨æ€è®¾ç½® */
                left: 20px;
                transform: rotate(45deg);
                border-left: none;
                border-top: none;
                border-right: 1px solid var(--bd);
                border-bottom: 1px solid var(--bd);
            }
        }
        
        @media (max-width: 480px) {
            .status-popup {
                min-width: 280px;
                max-width: calc(100vw - 20px);
                left: auto;
                right: 0;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* å‘ä¸‹å¼¹å‡º */
            .status-popup.popup-down {
                top: calc(100% + 8px);
                bottom: auto;
                max-height: calc(100vh - 140px); /* å¢åŠ æ›´å¤šè¾¹è· */
                transform: translateX(0) translateY(-10px);
            }
            
            .status-popup.popup-down.show {
                transform: translateX(0) translateY(0);
            }
            
            .status-popup.popup-down::before {
                top: -6px;
                bottom: auto;
                left: auto;
                right: 40px;
                transform: rotate(45deg);
                border-left: 1px solid var(--bd);
                border-top: 1px solid var(--bd);
                border-right: none;
                border-bottom: none;
            }
            
            /* å‘ä¸Šå¼¹å‡º */
            .status-popup.popup-up {
                top: auto;
                bottom: calc(100% + 8px);
                max-height: calc(100vh - 140px); /* å¢åŠ æ›´å¤šè¾¹è· */
                transform: translateX(0) translateY(10px);
            }
            
            .status-popup.popup-up.show {
                transform: translateX(0) translateY(0);
            }
            
            .status-popup.popup-up::before {
                top: auto;
                bottom: -6px;
                left: auto;
                right: 40px;
                transform: rotate(45deg);
                border-left: none;
                border-top: none;
                border-right: 1px solid var(--bd);
                border-bottom: 1px solid var(--bd);
            }
        }
        
        /* é˜²æ­¢å°å±å¹•æ—¶å¼¹çª—å·¦ä¾§è¶…å‡º */
        @media (max-width: 420px) {
            .status-popup {
                right: -10px;
            }
            
            .status-popup::before {
                right: 30px;
            }
        }

        .theme-toggle {
            cursor: pointer;
            user-select: none;
            text-decoration: none
        }

        .theme-toggle:hover {
            filter: brightness(1.1);
            transform: translateY(-1px)
        }

        .theme-toggle:active {
            transform: translateY(0) scale(0.98)
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #94a3b8
        }

        .dot.ok {
            background: var(--good)
        }

        .dot.err {
            background: var(--bad)
        }

        .row {
            display: grid;
            gap: 12px;
            margin-bottom: 12px;
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* å°å±å¹•ï¼ˆåŒ…æ‹¬æ‰‹æœºï¼‰ï¼š3è¡Œ2åˆ—å¸ƒå±€ */
        @media (max-width: 768px) {
            .row {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            min-height: 170px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: border-color .5s ease, border-width .3s ease, box-shadow .5s ease;
            position: relative;
            min-width: 0; /* é˜²æ­¢ grid ä¸­çš„å¡ç‰‡è¢«å†…å®¹æ’‘å¼€ */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        /* å¡ç‰‡å†…å®¹å®¹å™¨ï¼Œç¡®ä¿å†…å®¹åœ¨ä¸Šå±‚ */
        .card > * {
            position: relative;
            z-index: 1;
        }
        
        /* è­¦å‘ŠçŠ¶æ€ï¼šæ©™è‰²è¾¹æ¡† */
        .card.card-warning {
            border: 3px solid var(--warn);
            box-shadow: 
                0 0 0 1px rgba(245, 158, 11, 0.3), 
                0 0 20px rgba(245, 158, 11, 0.4),
                var(--shadow);
        }
        
        /* è­¦å‘ŠçŠ¶æ€ï¼šæ©™è‰²è·‘é©¬ç¯æ•ˆæœ */
        .card.card-warning::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius);
            padding: 3px;
            background: linear-gradient(90deg, 
                transparent 0%,
                transparent 10%,
                rgba(245, 158, 11, 0.6) 20%,
                rgba(245, 158, 11, 1) 25%,
                rgba(255, 200, 50, 1) 30%,
                rgba(245, 158, 11, 1) 35%,
                rgba(245, 158, 11, 0.6) 40%,
                transparent 50%,
                transparent 60%,
                rgba(245, 158, 11, 0.6) 70%,
                rgba(245, 158, 11, 1) 75%,
                rgba(255, 200, 50, 1) 80%,
                rgba(245, 158, 11, 1) 85%,
                rgba(245, 158, 11, 0.6) 90%,
                transparent 100%);
            background-size: 200% 100%;
            -webkit-mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            -webkit-mask-clip: content-box, border-box;
            -webkit-mask-composite: xor;
            mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            mask-clip: content-box, border-box;
            mask-composite: exclude;
            z-index: 0;
            animation: warningMarquee 2s linear infinite;
            pointer-events: none;
        }
        
        /* è­¦å‘ŠçŠ¶æ€ï¼šä¸»æ•°å­—å˜æ©™è‰²ï¼Œå¸¦æ¸å˜åŠ¨ç”» */
        .card.card-warning .value {
            color: var(--warn);
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        /* å±é™©çŠ¶æ€ï¼šçº¢è‰²è¾¹æ¡† */
        .card.card-danger {
            border: 3px solid var(--bad);
            box-shadow: 
                0 0 0 1px rgba(239, 68, 68, 0.4), 
                0 0 25px rgba(239, 68, 68, 0.5),
                var(--shadow);
            animation: dangerPulse 1.5s ease-in-out infinite;
        }
        
        /* å±é™©çŠ¶æ€ï¼šçº¢è‰²è·‘é©¬ç¯æ•ˆæœ */
        .card.card-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius);
            padding: 3px;
            background: linear-gradient(90deg, 
                transparent 0%,
                transparent 8%,
                rgba(239, 68, 68, 0.5) 15%,
                rgba(239, 68, 68, 1) 20%,
                rgba(255, 100, 100, 1) 25%,
                rgba(239, 68, 68, 1) 30%,
                rgba(239, 68, 68, 0.5) 35%,
                transparent 42%,
                transparent 58%,
                rgba(239, 68, 68, 0.5) 65%,
                rgba(239, 68, 68, 1) 70%,
                rgba(255, 100, 100, 1) 75%,
                rgba(239, 68, 68, 1) 80%,
                rgba(239, 68, 68, 0.5) 85%,
                transparent 92%,
                transparent 100%);
            background-size: 200% 100%;
            -webkit-mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            -webkit-mask-clip: content-box, border-box;
            -webkit-mask-composite: xor;
            mask-image: linear-gradient(#fff 0 0), linear-gradient(#fff 0 0);
            mask-clip: content-box, border-box;
            mask-composite: exclude;
            z-index: 0;
            animation: dangerMarquee 1.2s linear infinite;
            pointer-events: none;
        }
        
        /* å±é™©çŠ¶æ€ï¼šä¸»æ•°å­—å˜çº¢è‰²ï¼Œå¸¦å‘å…‰æ•ˆæœ */
        .card.card-danger .value {
            color: var(--bad);
            text-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }
        
        /* æ©™è‰²è·‘é©¬ç¯åŠ¨ç”» */
        @keyframes warningMarquee {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 0%;
            }
        }
        
        /* çº¢è‰²è·‘é©¬ç¯åŠ¨ç”»ï¼ˆæ›´å¿«ï¼‰ */
        @keyframes dangerMarquee {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 0%;
            }
        }
        
        /* å±é™©çŠ¶æ€è„‰å†²åŠ¨ç”» */
        @keyframes dangerPulse {
            0%, 100% {
                box-shadow: 
                    0 0 0 1px rgba(239, 68, 68, 0.4), 
                    0 0 25px rgba(239, 68, 68, 0.5),
                    var(--shadow);
            }
            50% {
                box-shadow: 
                    0 0 0 2px rgba(239, 68, 68, 0.6), 
                    0 0 35px rgba(239, 68, 68, 0.7),
                    var(--shadow);
            }
        }


        .label {
            font-size: 12px;
            letter-spacing: .14em;
            text-transform: uppercase;
            color: var(--muted)
        }

        .value {
            margin-top: 8px;
            display: flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: nowrap;
            font-weight: 900;
            line-height: 1;
            white-space: nowrap;
            font-size: clamp(40px, 6vw, 72px);
            overflow: hidden; /* é˜²æ­¢æ•°å€¼æº¢å‡º */
            min-width: 0; /* å…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
            transition: color .5s ease, text-shadow .5s ease
        }
        
        .value > span:first-child {
            min-width: 0; /* å…è®¸æ•°å€¼éƒ¨åˆ†æ”¶ç¼© */
            overflow: hidden;
        }

        .unit {
            font-size: clamp(16px, 2vw, 24px);
            color: var(--muted);
            font-weight: 700;
            flex-shrink: 0;
            min-width: fit-content
        }

        .trend {
            margin-top: 8px;
            color: var(--muted);
            font-size: 13px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .trend .arrow {
            font-weight: 900
        }

        .trend.up {
            color: var(--bad)
        }

        .trend.down {
            color: var(--good)
        }

        .split {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(4, 1fr);
            align-items: start
        }

        .col {
            min-width: 0
        }

        /* ä¸­ç­‰å±å¹•ï¼š2åˆ— */
        @media (max-width: 1200px) {
            .split {
                grid-template-columns: 1fr 1fr
            }
        }

        /* æ‰‹æœºç«¯ï¼š1åˆ— */
        @media (max-width: 768px) {
            .split {
                grid-template-columns: 1fr
            }
        }

        .chart-card, .table-card {
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .chart-card {
            padding: 16px
        }

        .chart-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px
        }

        .chart-actions {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
            align-items: center
        }

        @media (max-width: 768px) {
            .chart-actions {
                gap: 2px
            }

            .chart-actions .btn {
                padding: 6px 8px;
                font-size: 10px;
                min-width: 28px
            }
        }

        /* æŒ‰é’®æ ·å¼å·²ç§»è‡³ common-styles.css */

        .chart-wrap {
            height: 340px;
            position: relative
        }

        canvas {
            background: transparent;
            border-radius: 12px
        }

        /* å›¾è¡¨å³ä¸‹è§’åŠå…¨å±æŒ‰é’® */
        .fullscreen-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            z-index: 3;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--bd);
            background: color-mix(in srgb, var(--card) 80%, black 0%);
            color: var(--muted);
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: .9;
            transition: all .2s ease
        }

        .fullscreen-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            opacity: 1
        }

        .fullscreen-btn:active {
            transform: translateY(0) scale(0.95)
        }

        /* åŠé€æ˜å…¨å±å¼¹å±‚ */
        .overlay {
            position: fixed;
            inset: 0;
            display: flex; /* å…è®¸è¿‡æ¸¡åŠ¨ç”» */
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .35);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .22s ease;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            width: min(1200px, 92vw);
            height: min(800px, 86vh);
            display: flex;
            flex-direction: column;
            background: color-mix(in srgb, var(--card) 100%, transparent 0%);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateY(8px) scale(.985);
            transition: transform .25s ease;
        }

        .overlay.show .modal {
            transform: translateY(0) scale(1);
        }


        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--bd);
        }

        .modal-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .table-wrap.full {
            max-height: none;
            height: 100%;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .close-btn {
            padding: 6px 10px;
            border: 1px solid var(--bd);
            background: var(--card);
            color: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all .2s ease
        }

        .close-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px)
        }

        .close-btn:active {
            transform: translateY(0) scale(0.98)
        }

        canvas {
            touch-action: none;
            overscroll-behavior: contain;
        }

        .chart-wrap {
            overscroll-behavior: contain;
        }

        .table-card {
            padding: 0;
            margin-top: 12px
        }

        .table-head {
            padding: 14px 16px;
            border-bottom: 1px solid var(--bd);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .table-wrap {
            max-height: 420px;
            overflow: auto;
            border-radius: 0 0 var(--radius) var(--radius)
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: var(--card);
            color: var(--muted);
            font-weight: 700;
            font-size: 13px;
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--bd)
        }

        tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--bd);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            white-space: nowrap
        }

        tbody tr:nth-child(even) {
            background: color-mix(in srgb, var(--card) 90%, var(--bd))
        }

        tbody tr:hover {
            background: color-mix(in srgb, var(--card) 80%, var(--bd))
        }

        .right {
            text-align: right
        }

        footer {
            margin-top: 10px;
            color: var(--muted);
            font-size: 12px;
            text-align: right
        }

        /* æ¨¡æ€æ¡†æ ·å¼å·²ç§»è‡³ common-styles.css å…±äº«ä½¿ç”¨ */
        /* æ¶ˆæ¯ä¸­å¿ƒæ ·å¼å·²ç§»è‡³ common-styles.css å…±äº«ä½¿ç”¨ */
        /* å¯åŠ¨ç”»é¢æ ·å¼å·²ç§»è‡³ common-styles.css å…±äº«ä½¿ç”¨ */
    </style>
</head>
<body>
<!-- å¯åŠ¨ç”»é¢ï¼ˆç”± common.js åŠ¨æ€ç”Ÿæˆï¼‰ -->

<div class="wrap">
    <header>
        <h1>
            <img src="../resource/logo.png" alt="Logo" class="logo">
            <span>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</span>
        </h1>
        <div class="status">
            <div class="status-badge-wrapper">
                <span class="badge clickable" id="wsStatusBadge" title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¿æ¥çŠ¶æ€"><span id="wsDot" class="dot"></span><span id="wsText">æœªè¿æ¥</span></span>
                <!-- è¿æ¥çŠ¶æ€è¯¦æƒ…å¼¹çª— -->
                <div id="statusPopup" class="status-popup popup-down">
                    <div class="status-popup-header">
                        <div class="status-popup-title">ğŸ“¡ è¿æ¥çŠ¶æ€è¯¦æƒ…</div>
                        <div class="status-popup-close" id="statusPopupClose">âœ•</div>
                    </div>
                    <div class="status-popup-body">
                        <div class="status-item">
                            <div class="status-item-left">
                                <div class="status-item-name">WebSocket è¿æ¥</div>
                                <div class="status-item-desc">æµè§ˆå™¨ â†” åç«¯æœåŠ¡å™¨</div>
                            </div>
                            <div class="status-item-badge" id="wsStatusDetail">
                                <span class="status-dot"></span>
                                <span>æœªè¿æ¥</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-item-left">
                                <div class="status-item-name">ğŸ”µ è“ç‰™è¿æ¥ (BT27)</div>
                                <div class="status-item-desc" id="bleStatusDesc">æœ¬åœ°è“ç‰™ Â· ä¼˜å…ˆæ•°æ®æº</div>
                            </div>
                            <div class="status-item-badge disconnected" id="bleStatusDetail">
                                <span class="status-dot"></span>
                                <span>æœªè¿æ¥</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-item-left">
                                <div class="status-item-name">ğŸ“¡ MQTT è¿æ¥</div>
                                <div class="status-item-desc" id="mqttStatusDesc">äº‘ç«¯MQTT Â· å¤‡ç”¨æ•°æ®æº</div>
                            </div>
                            <div class="status-item-badge disconnected" id="mqttStatusDetail">
                                <span class="status-dot"></span>
                                <span>æœªè¿æ¥</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <span class="badge">ä¸Šæ¬¡æ›´æ–°ï¼š<span id="lastTs">--</span></span>
            <span class="badge">æ ·æœ¬æ•°ï¼š<span id="count">0</span></span>
            <div class="menu-wrapper">
                <div class="menu-btn" id="menuBtn">
                    <span>âš™ï¸ åŠŸèƒ½</span>
                    <span style="font-size: 10px; transition: transform .2s ease" id="menuArrow">â–¼</span>
                    <span class="menu-btn-badge" id="menuBtnBadge"></span>
                </div>
                <div class="menu-dropdown" id="menuDropdown">
                    <a href="/analysis.html" class="menu-item" title="æŸ¥çœ‹æ•°æ®ç»Ÿè®¡åˆ†æ">
                        <span>ğŸ“ˆ</span>
                        <span>æ•°æ®åˆ†æ</span>
                        <span class="ai-inside-badge">AI</span>
                    </a>
                    <div class="menu-item" id="messageCenterBtn" title="æŸ¥çœ‹è­¦å‘Šæ¶ˆæ¯ä¸­å¿ƒ">
                        <span>ğŸ””</span>
                        <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
                        <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                    </div>
                    <div class="menu-item" data-power-control-trigger title="çœç”µæ§åˆ¶">
                        <span>ğŸ”‹</span>
                        <span>çœç”µæ§åˆ¶</span>
                    </div>
                    <div class="menu-item" id="loadDataBtn" title="åŠ è½½å†å²æ•°æ®">
                        <span>ğŸ“Š</span>
                        <span>åŠ è½½æ•°æ®</span>
                    </div>
                    <div class="menu-item" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜æ¨¡å¼">
                        <span>ğŸŒ™</span>
                        <span>åˆ‡æ¢ä¸»é¢˜</span>
                    </div>
                    <div class="menu-item" id="aboutBtn" title="å…³äºé¡¹ç›®">
                        <span>â„¹ï¸</span>
                        <span>å…³äºé¡¹ç›®</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="row">
        <div class="card" id="tempCard">
            <div class="label-with-info">
                <div class="label">æ¸©åº¦</div>
                <span class="info-btn" onclick="showInfo('temp')">i</span>
            </div>
            <div class="value"><span id="tempVal">--</span><span class="unit">Â°C</span></div>
            <div id="tempTrend" class="trend">
                <span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span>
                <span id="temp2Display" style="margin-left: 12px; color: var(--muted); font-size: 12px;"></span>
            </div>
        </div>
        <div class="card" id="tempDiffCard">
            <div class="label-with-info">
                <div class="label">æ¸©åº¦ Î”</div>
                <span class="info-btn" onclick="showInfo('tempDiff')">i</span>
            </div>
            <div class="value"><span id="tempDiffVal">--</span><span class="unit">Â°C</span></div>
            <div id="tempDiffTrend" class="trend"><span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span></div>
        </div>
        <div class="card" id="humCard">
            <div class="label-with-info">
                <div class="label">æ¹¿åº¦</div>
                <span class="info-btn" onclick="showInfo('hum')">i</span>
            </div>
            <div class="value"><span id="humVal">--</span><span class="unit">%</span></div>
            <div id="humTrend" class="trend"><span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span></div>
        </div>
        <div class="card" id="luxCard">
            <div class="label-with-info">
                <div class="label">äº®åº¦</div>
                <span class="info-btn" onclick="showInfo('lux')">i</span>
            </div>
            <div class="value"><span id="luxVal">--</span><span class="unit">lx</span></div>
            <div id="luxTrend" class="trend"><span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span></div>
        </div>
        <div class="card" id="smokeCard">
            <div class="label-with-info">
                <div class="label">çƒŸé›¾æµ“åº¦</div>
                <span class="info-btn" onclick="showInfo('smoke')">i</span>
            </div>
            <div class="value"><span id="smokeVal">--</span><span class="unit">ppm</span></div>
            <div id="smokeTrend" class="trend">
                <span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span>
                <span id="rsRoDisplay" style="margin-left: 12px; color: var(--muted); font-size: 12px;"></span>
            </div>
        </div>
        <div class="card" id="pressureCard">
            <div class="label-with-info">
                <div class="label">å¤§æ°”å‹</div>
                <span class="info-btn" onclick="showInfo('pressure')">i</span>
            </div>
            <div class="value"><span id="pressureVal">--</span><span class="unit">hPa</span></div>
            <div id="pressureTrend" class="trend"><span class="arrow">â€”</span><span class="txt">è¶‹åŠ¿ç¨³å®š</span></div>
        </div>
    </div>

    <!-- å®šä½ä¿¡æ¯å¡ç‰‡ -->
    <div class="card location-card" id="locationCard" style="margin-top: 0; margin-bottom: 12px;">
        <div class="label-with-info">
            <div class="label">ğŸ“ è®¾å¤‡å®šä½</div>
            <span class="info-btn" onclick="showInfo('location')">i</span>
        </div>
        
        <!-- å®šä½çŠ¶æ€å’Œåæ ‡ä¿¡æ¯ -->
        <div id="locationInfo" style="margin-top: 12px;">
            <div id="locationStatus" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span style="font-size: 12px; color: var(--muted);">çŠ¶æ€: </span>
                <span id="locationStatusText" style="font-size: 12px; color: var(--muted);">æœªè·å–å®šä½</span>
            </div>
            <div id="locationCoords" style="display: none; margin-bottom: 12px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; row-gap: 8px;">
                    <div style="display: flex; flex-direction: column;">
                        <span style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">ç»åº¦</span>
                        <span id="locationLon" class="location-value" style="color: var(--text); font-weight: 900; font-size: clamp(24px, 4vw, 40px); line-height: 1;">--</span>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <span style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">çº¬åº¦</span>
                        <span id="locationLat" class="location-value" style="color: var(--text); font-weight: 900; font-size: clamp(24px, 4vw, 40px); line-height: 1;">--</span>
                    </div>
                    <div id="locationExtra" style="grid-column: 1 / -1; font-size: 12px; color: var(--muted); display: none; margin-top: 4px;"></div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button id="queryLocationBtn" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                ğŸ“ è·å–å®šä½
            </button>
            <button id="toggleLocationMapBtn" class="btn" style="padding: 8px 12px; font-size: 13px; background: var(--card); color: var(--text); border: 1px solid var(--bd); border-radius: 6px; cursor: pointer; transition: all 0.2s; display: none;">
                ğŸ—ºï¸ æ˜¾ç¤ºåœ°å›¾
            </button>
        </div>

        <!-- åœ°å›¾å®¹å™¨ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div id="locationMapContainer" style="margin-top: 16px; border-radius: 8px; overflow: hidden; max-height: 0; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; border: 1px solid var(--bd); opacity: 0; visibility: hidden;">
            <div id="locationMap" style="width: 100%; height: 300px;"></div>
            <button id="closeLocationMap" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 12px; z-index: 1000; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.9)'" onmouseout="this.style.background='rgba(0,0,0,0.7)'">âœ• å…³é—­</button>
        </div>
    </div>

    <div class="split">
        <div class="col">
            <div class="chart-card">
                <div class="chart-head">
                    <div class="chart-title-with-info">
                        <div style="font-weight:700;">æ¸©æ¹¿åº¦æ›²çº¿</div>
                        <span class="info-btn" onclick="showInfo('chart-th')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInTH" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”+
                        </button>
                        <button id="zoomOutTH" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”-
                        </button>
                        <button id="panLeftTH" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†
                        </button>
                        <button id="panRightTH" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†’
                        </button>
                        <button id="resetTH" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„
                        </button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartTH"></canvas>
                    <button id="openFullChart" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹æ¸©æ¹¿åº¦æ›²çº¿">â¤¢</button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="chart-card">
                <div class="chart-head">
                    <div class="chart-title-with-info">
                        <div style="font-weight:700;">äº®åº¦æ›²çº¿</div>
                        <span class="info-btn" onclick="showInfo('chart-lux')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInLUX" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”+
                        </button>
                        <button id="zoomOutLUX" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”-
                        </button>
                        <button id="panLeftLUX" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†
                        </button>
                        <button id="panRightLUX" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†’
                        </button>
                        <button id="resetLUX" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„
                        </button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartLUX"></canvas>
                    <button id="openFullLux" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹äº®åº¦æ›²çº¿">â¤¢</button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="chart-card">
                <div class="chart-head">
                    <div class="chart-title-with-info">
                        <div style="font-weight:700;">çƒŸé›¾æµ“åº¦æ›²çº¿</div>
                        <span class="info-btn" onclick="showInfo('chart-smoke')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInSMOKE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”+
                        </button>
                        <button id="zoomOutSMOKE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”-
                        </button>
                        <button id="panLeftSMOKE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†
                        </button>
                        <button id="panRightSMOKE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†’
                        </button>
                        <button id="resetSMOKE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„
                        </button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartSMOKE"></canvas>
                    <button id="openFullSmoke" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹çƒŸé›¾æµ“åº¦æ›²çº¿">â¤¢</button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="chart-card">
                <div class="chart-head">
                    <div class="chart-title-with-info">
                        <div style="font-weight:700;">å¤§æ°”å‹æ›²çº¿</div>
                        <span class="info-btn" onclick="showInfo('chart-pressure')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInPRESSURE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">
                            ğŸ”+
                        </button>
                        <button id="zoomOutPRESSURE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">
                            ğŸ”-
                        </button>
                        <button id="panLeftPRESSURE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">
                            â†
                        </button>
                        <button id="panRightPRESSURE" class="btn"
                                style="padding:4px 6px;font-size:11px;min-width:32px;">â†’
                        </button>
                        <button id="resetPRESSURE" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„
                        </button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartPRESSURE"></canvas>
                    <button id="openFullPressure" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹å¤§æ°”å‹æ›²çº¿">â¤¢</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-card">
        <div class="table-head">
            <div style="font-weight:700;">æ•°æ®åˆ—è¡¨</div>
            <div style="color:var(--muted);font-size:13px;">ä»…æ˜¾ç¤ºæœ€è¿‘ 500 æ¡</div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th style="width:22%;">æ—¶é—´</th>
                    <th class="right" style="width:13%;">æ¸©åº¦ (Â°C)</th>
                    <th class="right" style="width:13%;">æ¹¿åº¦ (%)</th>
                    <th class="right" style="width:13%;">äº®åº¦ (lx)</th>
                    <th class="right" style="width:13%;">çƒŸé›¾ (ppm)</th>
                    <th class="right" style="width:13%;">å¤§æ°”å‹ (hPa)</th>
                </tr>
                </thead>
                <tbody id="tbodyAll"></tbody>
            </table>
        </div>
    </div>

    <footer>é™ˆé¹æ—­ Â· åŸºäº STM32 å’Œç‰©è”ç½‘çš„æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿè®¾è®¡ä¸å®ç° (<span data-latest-version>æœªçŸ¥ç‰ˆæœ¬</span>)</footer>

    <!-- ç§‘æ™®å¼¹çª— -->
    <div id="infoModal" class="info-modal">
        <div class="info-content">
            <div class="info-title">
                <span id="infoIcon"></span>
                <span id="infoTitle"></span>
            </div>
            <div class="info-body" id="infoBody"></div>
            <button class="info-close" onclick="closeInfo()">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- åŠ è½½æ•°æ®å¼¹çª— -->
    <div id="loadModal" class="load-modal">
        <div class="load-content">
            <div class="load-title">
                <span>ğŸ“Š</span>
                <span id="loadModalTitle">é€‰æ‹©åŠ è½½æ–¹å¼</span>
            </div>

            <!-- é€‰æ‹©åŠ è½½æ–¹å¼ -->
            <div id="loadChoiceView">
                <div class="load-option" onclick="showLoadForm('count')">
                    <div class="load-option-title">
                        <span>ğŸ“</span>
                        <span>æŒ‰æœ€è¿‘æ¡æ•°åŠ è½½</span>
                    </div>
                    <div class="load-option-desc">
                        åŠ è½½æœ€è¿‘çš„Næ¡æ•°æ®è®°å½•
                    </div>
                </div>

                <div class="load-option" onclick="showLoadForm('time')">
                    <div class="load-option-title">
                        <span>â±ï¸</span>
                        <span>æŒ‰æœ€è¿‘æ—¶é—´åŠ è½½</span>
                    </div>
                    <div class="load-option-desc">
                        åŠ è½½æœ€è¿‘å‡ åˆ†é’Ÿ/å°æ—¶/å¤©/æœˆçš„æ•°æ®
                    </div>
                </div>

                <div class="load-option" onclick="showLoadForm('range')">
                    <div class="load-option-title">
                        <span>ğŸ“…</span>
                        <span>è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</span>
                    </div>
                    <div class="load-option-desc">
                        é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œç²¾ç¡®åŠ è½½
                    </div>
                </div>

                <div class="load-option" onclick="showLoadAllConfirm()">
                    <div class="load-option-title">
                        <span>âš ï¸</span>
                        <span>åŠ è½½å…¨éƒ¨æ•°æ®</span>
                    </div>
                    <div class="load-option-desc">
                        åŠ è½½æ•°æ®åº“ä¸­çš„æ‰€æœ‰å†å²æ•°æ®ï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
                    </div>
                </div>
            </div>

            <!-- æŒ‰æœ€è¿‘æ¡æ•°åŠ è½½è¡¨å• -->
            <div id="loadFormCount" class="load-form-view" style="display: none;">
                <div class="form-group">
                    <label class="form-label">æ•°æ®æ¡æ•°</label>
                    <div class="form-input-group">
                        <input type="number" class="form-input" id="loadCountInput" placeholder="ä¾‹å¦‚ï¼š1000" min="1"
                               value="1000">
                        <span style="color: var(--muted); font-size: 13px;">æ¡</span>
                    </div>
                </div>
                <div class="load-actions">
                    <button class="load-btn load-btn-secondary" onclick="backToChoice()">
                        è¿”å›
                    </button>
                    <button class="load-btn load-btn-primary" onclick="loadByCount()">
                        åŠ è½½æ•°æ®
                    </button>
                </div>
            </div>

            <!-- æŒ‰æ—¶é—´æ®µåŠ è½½è¡¨å• -->
            <div id="loadFormTime" class="load-form-view" style="display: none;">
                <div class="form-group">
                    <label class="form-label">æ—¶é—´æ•°é‡</label>
                    <div class="form-input-group">
                        <input type="number" class="form-input" id="loadTimeValue" placeholder="ä¾‹å¦‚ï¼š1" min="1"
                               value="1">
                        <select class="form-input" id="loadTimeUnit">
                            <option value="minute">åˆ†é’Ÿ</option>
                            <option value="hour" selected>å°æ—¶</option>
                            <option value="day">å¤©</option>
                            <option value="month">æœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="load-actions">
                    <button class="load-btn load-btn-secondary" onclick="backToChoice()">
                        è¿”å›
                    </button>
                    <button class="load-btn load-btn-primary" onclick="loadByTime()">
                        åŠ è½½æ•°æ®
                    </button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰æ—¶é—´èŒƒå›´è¡¨å• -->
            <div id="loadFormRange" class="load-form-view" style="display: none;">
                <div class="form-group">
                    <label class="form-label">å¼€å§‹æ—¶é—´</label>
                    <input type="datetime-local" class="form-input" id="loadStartTime">
                </div>
                <div class="form-group">
                    <label class="form-label">ç»“æŸæ—¶é—´</label>
                    <input type="datetime-local" class="form-input" id="loadEndTime">
                </div>
                <div class="load-actions">
                    <button class="load-btn load-btn-secondary" onclick="backToChoice()">
                        è¿”å›
                    </button>
                    <button class="load-btn load-btn-primary" onclick="loadByRange()">
                        åŠ è½½æ•°æ®
                    </button>
                </div>
            </div>

            <!-- å–æ¶ˆæŒ‰é’®ï¼ˆä»…åœ¨é€‰æ‹©ç•Œé¢æ˜¾ç¤ºï¼‰ -->
            <div class="load-actions" id="loadChoiceActions">
                <button class="load-btn load-btn-secondary" onclick="closeLoadModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯ä¸­å¿ƒå¼¹çª— -->
    <div id="messageCenterPanel" class="message-center-panel">
        <div class="message-center-header">
            <div class="message-center-title">
                <span>ğŸ””</span>
                <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
            </div>
            <button class="message-center-close" onclick="closeMessageCenter()" title="å…³é—­">Ã—</button>
        </div>
        <div class="message-center-filters">
            <div class="calendar-wrapper" id="calendarWrapper"></div>
            <select id="warningTypeFilter" class="message-filter-select">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="T">æ¸©åº¦</option>
                <option value="H">æ¹¿åº¦</option>
                <option value="B">äº®åº¦</option>
                <option value="S">PPM</option>
                <option value="P">å¤§æ°”å‹</option>
            </select>
            <select id="warningStatusFilter" class="message-filter-select">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="0">æœªæ¢å¤</option>
                <option value="1">å·²æ¢å¤</option>
            </select>
            <button class="message-refresh-btn" onclick="loadWarningMessages()" title="åˆ·æ–°">ğŸ”„</button>
        </div>
        <div class="message-center-body" id="messageCenterBody">
            <div class="message-loading" id="messageLoading">åŠ è½½ä¸­...</div>
            <div class="message-empty" id="messageEmpty" style="display: none;">æš‚æ— è­¦å‘Šæ¶ˆæ¯</div>
            <div class="message-list" id="messageList"></div>
        </div>
    </div>

    <!-- è­¦å‘Šé€šçŸ¥å¼¹çª— -->
    <div id="warningNotification" class="warning-notification" style="display: none;">
        <div class="warning-notification-content">
            <div class="warning-notification-icon">âš ï¸</div>
            <div class="warning-notification-text">
                <div class="warning-notification-title" id="warningNotificationTitle"></div>
                <div class="warning-notification-desc" id="warningNotificationDesc"></div>
            </div>
            <button class="warning-notification-close" onclick="closeWarningNotification()">Ã—</button>
        </div>
    </div>

    <!-- å…³äºé¡¹ç›®å¼¹çª—ï¼ˆç”± common.js åŠ¨æ€ç”Ÿæˆï¼‰ -->
    
    <!-- å¸®åŠ©å¼¹çª—ï¼ˆç”± common.js åŠ¨æ€ç”Ÿæˆï¼‰ -->

    <!-- è­¦å‘Šç¡®è®¤æ¡† -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">âš ï¸</div>
            <div class="confirm-title">åŠ è½½å…¨éƒ¨æ•°æ®</div>
            <div class="confirm-message">
                æ‚¨å³å°†åŠ è½½æ•°æ®åº“ä¸­çš„<strong>å…¨éƒ¨å†å²æ•°æ®</strong>ã€‚<br>
                è¿™å¯èƒ½åŒ…å«æ•°åƒç”šè‡³æ•°ä¸‡æ¡è®°å½•ï¼Œå°†ä¼šï¼š<br>
                â€¢ æ¸…ç©ºå½“å‰å›¾è¡¨ä¸­çš„æ•°æ®<br>
                â€¢ éœ€è¦è¾ƒé•¿çš„åŠ è½½æ—¶é—´<br>
                â€¢ å¯èƒ½å¯¼è‡´é¡µé¢å¡é¡¿<br><br>
                ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ
            </div>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmModal()">
                    å–æ¶ˆ
                </button>
                <button class="confirm-btn confirm-btn-danger" onclick="confirmLoadAll()">
                    ç¡®å®šåŠ è½½
                </button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®é‡è¿‡å¤§è­¦å‘Šæ¡† -->
    <div id="largeDataWarningModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">âš ï¸</div>
            <div class="confirm-title">æ•°æ®é‡è¾ƒå¤§</div>
            <div class="confirm-message" id="largeDataMessage">
                è¯¥æ—¶é—´èŒƒå›´å†…æœ‰ <strong id="largeDataCount">0</strong> æ¡æ•°æ®ã€‚<br>
                åŠ è½½å¤§é‡æ•°æ®å¯èƒ½ä¼šï¼š<br>
                â€¢ éœ€è¦è¾ƒé•¿çš„åŠ è½½æ—¶é—´<br>
                â€¢ å¯¼è‡´é¡µé¢å¡é¡¿<br>
                â€¢ å½±å“æµè§ˆä½“éªŒ<br><br>
                <strong style="color: var(--warn);">å»ºè®®ï¼š</strong><br>
                â€¢ ç¼©å°æ—¶é—´èŒƒå›´<br>
                â€¢ æˆ–ä½¿ç”¨"æŒ‰æ¡æ•°åŠ è½½"åŠŸèƒ½<br><br>
                ç¡®å®šè¦ç»§ç»­åŠ è½½å—ï¼Ÿ
            </div>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeLargeDataWarning()">
                    å–æ¶ˆ
                </button>
                <button class="confirm-btn confirm-btn-danger" onclick="confirmLargeDataLoad()">
                    ç¡®å®šåŠ è½½
                </button>
            </div>
        </div>
    </div>

    <!-- åŠé€æ˜å…¨å±è¡¨æ ¼å¼¹çª— -->
    <div id="overlay" class="overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-head">
                <div id="modalTitle" style="font-weight:700;">æ¸©æ¹¿åº¦æ”¾å¤§å›¾ï¼ˆå®æ—¶ï¼‰</div>
                <div class="modal-actions">
                    <button id="zoomInFull" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                    <button id="zoomOutFull" class="btn" title="ç¼©å°">ğŸ”-</button>
                    <button id="panLeftFull" class="btn" title="å·¦ç§»">â†</button>
                    <button id="panRightFull" class="btn" title="å³ç§»">â†’</button>
                    <button id="resetFull" class="btn" title="é‡ç½®">ğŸ”„</button>
                    <button id="closeOverlay" class="close-btn" title="å…³é—­">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-wrap" style="height:100%;">
                    <canvas id="chartTHFull"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- äº®åº¦å…¨å±å¼¹çª— -->
    <div id="overlayLux" class="overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleLux">
            <div class="modal-head">
                <div id="modalTitleLux" style="font-weight:700;">äº®åº¦æ”¾å¤§å›¾ï¼ˆå®æ—¶ï¼‰</div>
                <div class="modal-actions">
                    <button id="zoomInFullLux" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                    <button id="zoomOutFullLux" class="btn" title="ç¼©å°">ğŸ”-</button>
                    <button id="panLeftFullLux" class="btn" title="å·¦ç§»">â†</button>
                    <button id="panRightFullLux" class="btn" title="å³ç§»">â†’</button>
                    <button id="resetFullLux" class="btn" title="é‡ç½®">ğŸ”„</button>
                    <button id="closeOverlayLux" class="close-btn" title="å…³é—­">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-wrap" style="height:100%;">
                    <canvas id="chartLUXFull"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- çƒŸé›¾å…¨å±å¼¹çª— -->
    <div id="overlaySmoke" class="overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleSmoke">
            <div class="modal-head">
                <div id="modalTitleSmoke" style="font-weight:700;">çƒŸé›¾æµ“åº¦æ”¾å¤§å›¾ï¼ˆå®æ—¶ï¼‰</div>
                <div class="modal-actions">
                    <button id="zoomInFullSmoke" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                    <button id="zoomOutFullSmoke" class="btn" title="ç¼©å°">ğŸ”-</button>
                    <button id="panLeftFullSmoke" class="btn" title="å·¦ç§»">â†</button>
                    <button id="panRightFullSmoke" class="btn" title="å³ç§»">â†’</button>
                    <button id="resetFullSmoke" class="btn" title="é‡ç½®">ğŸ”„</button>
                    <button id="closeOverlaySmoke" class="close-btn" title="å…³é—­">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-wrap" style="height:100%;">
                    <canvas id="chartSMOKEFull"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤§æ°”å‹å…¨å±å¼¹çª— -->
    <div id="overlayPressure" class="overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitlePressure">
            <div class="modal-head">
                <div id="modalTitlePressure" style="font-weight:700;">å¤§æ°”å‹æ”¾å¤§å›¾ï¼ˆå®æ—¶ï¼‰</div>
                <div class="modal-actions">
                    <button id="zoomInFullPressure" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                    <button id="zoomOutFullPressure" class="btn" title="ç¼©å°">ğŸ”-</button>
                    <button id="panLeftFullPressure" class="btn" title="å·¦ç§»">â†</button>
                    <button id="panRightFullPressure" class="btn" title="å³ç§»">â†’</button>
                    <button id="resetFullPressure" class="btn" title="é‡ç½®">ğŸ”„</button>
                    <button id="closeOverlayPressure" class="close-btn" title="å…³é—­">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-wrap" style="height:100%;">
                    <canvas id="chartPRESSUREFull"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="/static/changelog-data.js?v=20250205"></script>
<script src="/static/common.js?v=20250205"></script>

<script>
    // å¯åŠ¨ç”»é¢æ§åˆ¶é€»è¾‘å·²ç§»è‡³ common.js å…±äº«ä½¿ç”¨
    // åˆå§‹åŒ–å¯åŠ¨ç”»é¢ç³»ç»Ÿ
    if (typeof initSplashScreen === 'function') {
        initSplashScreen();
    }
    
    // ç§‘æ™®å†…å®¹æ•°æ®
    const infoData = {
        'temp': {
            icon: 'ğŸŒ¡ï¸',
            title: 'æ¸©åº¦ç›‘æµ‹',
            content: `<p>æ¸©åº¦æ˜¯å½±å“ç¯å¢ƒèˆ’é€‚åº¦çš„é‡è¦å‚æ•°ä¹‹ä¸€ã€‚</p>
                     <p><strong>é€‚å®œèŒƒå›´ï¼š</strong>ä¸€èˆ¬å®¤å†…æ¸©åº¦åº”ä¿æŒåœ¨ 20-25Â°C ä¹‹é—´ã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>æ¸©åº¦è¿‡é«˜æˆ–è¿‡ä½éƒ½ä¼šå½±å“äººä½“èˆ’é€‚åº¦å’Œè®¾å¤‡è¿è¡Œç¨³å®šæ€§ã€‚æ¸©åº¦æ³¢åŠ¨è¿˜ä¼šå½±å“ç²¾å¯†ä»ªå™¨çš„å‡†ç¡®æ€§ã€‚</p>
                     <p><strong>ç›‘æµ‹æ„ä¹‰ï¼š</strong>å®æ—¶ç›‘æµ‹æ¸©åº¦å˜åŒ–ï¼Œå¯ä»¥åŠæ—¶è°ƒæ•´ç©ºè°ƒç³»ç»Ÿï¼Œä¿è¯ç¯å¢ƒæ¡ä»¶çš„ç¨³å®šæ€§ã€‚</p>
                     <p><strong>å¦ä¸€æ•°æ®æºï¼š</strong>ç³»ç»Ÿé…å¤‡äº†ä¸¤ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨ï¼ˆDHT11å’ŒBMP280ï¼‰ï¼Œ"å¦ä¸€æ•°æ®æº"æ˜¾ç¤ºçš„æ˜¯ç¬¬äºŒä¸ªä¼ æ„Ÿå™¨çš„æ¸©åº¦è¯»æ•°ã€‚é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªä¼ æ„Ÿå™¨çš„æ•°æ®ï¼Œå¯ä»¥äº¤å‰éªŒè¯æµ‹é‡å‡†ç¡®æ€§ï¼Œå¹¶äº†è§£ä¸åŒä½ç½®çš„æ¸©åº¦åˆ†å¸ƒæƒ…å†µï¼Œæé«˜ç›‘æµ‹çš„å¯é æ€§ã€‚</p>`
        },
        'tempDiff': {
            icon: 'ğŸ“',
            title: 'æ¸©åº¦å·®å€¼ç›‘æµ‹',
            content: `<p>æ¸©åº¦å·®å€¼æ˜¾ç¤ºä¸¤ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨ä¹‹é—´çš„æ¸©å·®ã€‚</p>
                     <p><strong>æµ‹é‡æ„ä¹‰ï¼š</strong>é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªä½ç½®çš„æ¸©åº¦ï¼Œå¯ä»¥äº†è§£ç¯å¢ƒæ¸©åº¦åˆ†å¸ƒçš„å‡åŒ€æ€§ã€‚</p>
                     <p><strong>æ­£å¸¸èŒƒå›´ï¼š</strong>åŒä¸€ç©ºé—´å†…ä¸åŒä½ç½®çš„æ¸©å·®é€šå¸¸åº”å°äº2Â°Cï¼Œæ¸©å·®è¿‡å¤§è¯´æ˜ç©ºè°ƒç³»ç»Ÿåˆ†å¸ƒä¸å‡æˆ–å­˜åœ¨å±€éƒ¨çƒ­æºã€‚</p>
                     <p><strong>åº”ç”¨åœºæ™¯ï¼š</strong>å¤šç‚¹æ¸©åº¦ç›‘æµ‹æœ‰åŠ©äºå‘ç°æ¸©åº¦æ­»è§’ï¼Œä¼˜åŒ–ç©ºè°ƒå‡ºé£å£ä½ç½®ï¼Œç¡®ä¿æ•´ä½“ç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚</p>`
        },
        'hum': {
            icon: 'ğŸ’§',
            title: 'æ¹¿åº¦ç›‘æµ‹',
            content: `<p>æ¹¿åº¦åæ˜ ç©ºæ°”ä¸­æ°´è’¸æ°”çš„å«é‡ï¼Œå¯¹ç¯å¢ƒèˆ’é€‚åº¦è‡³å…³é‡è¦ã€‚</p>
                     <p><strong>é€‚å®œèŒƒå›´ï¼š</strong>æ ‡å‡†å®¤å†…æ¹¿åº¦åº”æ§åˆ¶åœ¨ 40-70% ä¹‹é—´ã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>æ¹¿åº¦è¿‡é«˜å®¹æ˜“å¯¼è‡´è®¾å¤‡è…èš€ã€ç‰©å“éœ‰å˜ï¼›æ¹¿åº¦è¿‡ä½åˆ™å¯èƒ½äº§ç”Ÿé™ç”µï¼Œå½±å“äººä½“èˆ’é€‚åº¦å’Œç”µå­è®¾å¤‡ã€‚</p>
                     <p><strong>æ¸©æ¹¿åº¦å…³ç³»ï¼š</strong>æ¸©åº¦å’Œæ¹¿åº¦ç›¸äº’å½±å“ï¼Œæ¸©åº¦å‡é«˜æ—¶ç›¸å¯¹æ¹¿åº¦ä¼šé™ä½ï¼Œå› æ­¤éœ€è¦åŒæ—¶ç›‘æµ‹è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p>`
        },
        'lux': {
            icon: 'ğŸ’¡',
            title: 'äº®åº¦ç›‘æµ‹',
            content: `<p>äº®åº¦ï¼ˆç…§åº¦ï¼‰åæ˜ ç¯å¢ƒçš„å…‰ç…§å¼ºåº¦ï¼Œå•ä½ä¸ºå‹’å…‹æ–¯ï¼ˆlxï¼‰ã€‚</p>
                     <p><strong>é€‚å®œèŒƒå›´ï¼š</strong>æ™®é€šå·¥ä½œåŒºåŸŸç…§åº¦åº”è¾¾åˆ° 300-750 lxï¼Œç²¾å¯†æ“ä½œåŒºåŸŸéœ€è¦ 750-1500 lxã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>å……è¶³çš„ç…§æ˜å¯ä»¥å‡å°‘æ“ä½œå¤±è¯¯ï¼Œæé«˜å·¥ä½œæ•ˆç‡ï¼›æŸäº›åœºæ™¯éœ€è¦ä¸¥æ ¼æ§åˆ¶å…‰ç…§æ¡ä»¶ã€‚</p>
                     <p><strong>ç›‘æµ‹æ„ä¹‰ï¼š</strong>å®æ—¶ç›‘æµ‹å…‰ç…§å¯ä»¥ä¼˜åŒ–ç…§æ˜ç³»ç»Ÿï¼Œæ—¢ä¿è¯å·¥ä½œéœ€æ±‚åˆèŠ‚çº¦èƒ½æºã€‚æŸäº›ç‰©å“éœ€é¿å…‰ä¿å­˜ï¼Œäº®åº¦ç›‘æµ‹æœ‰åŠ©äºåˆ¤æ–­å‚¨å­˜ç¯å¢ƒã€‚</p>`
        },
        'smoke': {
            icon: 'ğŸ”¥',
            title: 'çƒŸé›¾æµ“åº¦ç›‘æµ‹',
            content: `<p>çƒŸé›¾æµ“åº¦åæ˜ ç©ºæ°”ä¸­å¯ç‡ƒæ°”ä½“å’ŒçƒŸé›¾é¢—ç²’çš„å«é‡ï¼Œå•ä½ä¸º ppmï¼ˆç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼‰ã€‚</p>
                     <p><strong>å®‰å…¨é˜ˆå€¼ï¼š</strong>æ­£å¸¸ç¯å¢ƒåº”å°äº 50 ppmï¼Œè¶…è¿‡ 200 ppm éœ€è¦è­¦æƒ•ï¼Œè¶…è¿‡ 500 ppm å±äºå±é™©èŒƒå›´ã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>è¿™æ˜¯ç¯å¢ƒå®‰å…¨çš„å…³é”®æŒ‡æ ‡ã€‚æœ‰å®³æ°”ä½“æˆ–çƒŸé›¾çš„åŠæ—©å‘ç°å¯ä»¥é˜²æ­¢ç«ç¾å’Œä¸­æ¯’äº‹æ•…ã€‚</p>
                     <p><strong>åº”æ€¥æªæ–½ï¼š</strong>å½“çƒŸé›¾æµ“åº¦å¼‚å¸¸å‡é«˜æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºè­¦æŠ¥ï¼Œåº”ç«‹å³æ£€æŸ¥å‘¨å›´ç¯å¢ƒï¼Œå¼€å¯é€šé£ç³»ç»Ÿï¼Œå¿…è¦æ—¶ç–æ•£äººå‘˜ã€‚</p>
                     <p><strong>Rs/Roå€¼ï¼š</strong>è¿™æ˜¯MQ-2æ°”ä½“ä¼ æ„Ÿå™¨çš„åŸå§‹ç”µé˜»æ¯”å€¼ï¼ˆä¼ æ„Ÿå™¨ç”µé˜»Rsä¸æ¸…æ´ç©ºæ°”ä¸­ç”µé˜»R0çš„æ¯”å€¼ï¼‰ã€‚Rs/Roå€¼è¶Šå°ï¼Œè¯´æ˜æ°”ä½“æµ“åº¦è¶Šé«˜ã€‚è¿™ä¸ªåŸå§‹æ•°æ®ç»è¿‡è½¬æ¢è®¡ç®—åå¾—åˆ°çƒŸé›¾æµ“åº¦çš„ppmå€¼ï¼Œæ˜¾ç¤ºRs/Roå¯ä»¥å¸®åŠ©äº†è§£ä¼ æ„Ÿå™¨çš„å·¥ä½œçŠ¶æ€å’Œå“åº”ç‰¹æ€§ï¼Œä¾¿äºæ ¡å‡†å’Œè¯Šæ–­ä¼ æ„Ÿå™¨é—®é¢˜ã€‚</p>`
        },
        'mq2-control': {
            icon: 'ğŸ§¯',
            title: 'ä¸ºä»€ä¹ˆè¦å•ç‹¬æ§åˆ¶ MQ2ï¼Ÿ',
            content: `<p><strong>ä¼ æ„Ÿå™¨ç‰¹æ€§ï¼š</strong>MQ-2 å†…éƒ¨æœ‰åŠ çƒ­ä¸ï¼Œåªæœ‰åœ¨é¢„çƒ­åå‡ ç§’åæ‰èƒ½è¾“å‡ºç¨³å®šæ›²çº¿ã€‚</p>
                     <p><strong>ä¸é—´æ–­é€šç”µçš„é£é™©ï¼š</strong>æŒç»­é«˜åŠŸè€—ï¼ˆçº¦ 150mAï¼‰ã€çº¿åœˆå¯¿å‘½åŠ é€Ÿè¡°å‡ï¼Œä»¥åŠæ¸©æ¼‚å¼•èµ·çš„è¯¯æŠ¥ã€‚</p>
                     <p><strong>ä¾›ç”µå½±å“ï¼š</strong>ç³»ç»Ÿå†…ç½®å››æ¡£ä¾›ç”µç­–ç•¥ï¼Œé»˜è®¤çœç”µï¼ˆ5/25ï¼‰ï¼Œå¯åˆ‡æ¢ä¸ºå¹³è¡¡ï¼ˆ15/15ï¼‰ã€å®‰å…¨ï¼ˆ25/5ï¼‰æˆ–ä¸çœç”µï¼ˆæŒç»­ä¾›ç”µï¼‰ã€‚æ¨¡å¼ä¼šè‡ªåŠ¨è®°å½•ä¾›ç”µ/ä¼‘çœ çŠ¶æ€ï¼Œæ–¹ä¾¿æ’æŸ¥ã€‚</p>
                     <p><strong>æ‰‹åŠ¨æ§åˆ¶ï¼š</strong>å¦‚éœ€å³æ—¶ç»´æŠ¤ï¼Œå¯ç›´æ¥å‘é€å¼€å¯/å…³é—­æŒ‡ä»¤ï¼Œç­‰å¾…é¢„çƒ­å®Œæˆåå†è§‚å¯Ÿæ›²çº¿å³å¯ã€‚</p>`
        },
        'chart-th': {
            icon: 'ğŸ“ˆ',
            title: 'æ¸©æ¹¿åº¦æ›²çº¿å›¾',
            content: `<p>æ¸©æ¹¿åº¦æ›²çº¿å›¾åŒæ—¶æ˜¾ç¤ºæ¸©åº¦å’Œæ¹¿åº¦éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ã€‚</p>
                     <p><strong>åŒè½´æ˜¾ç¤ºï¼š</strong>å·¦ä¾§Yè½´è¡¨ç¤ºæ¸©åº¦ï¼ˆÂ°Cï¼‰ï¼Œå³ä¾§Yè½´è¡¨ç¤ºæ¹¿åº¦ï¼ˆ%ï¼‰ï¼Œä¾¿äºè§‚å¯Ÿä¸¤è€…çš„ç›¸å…³æ€§ã€‚</p>
                     <p><strong>è¶‹åŠ¿åˆ†æï¼š</strong>é€šè¿‡è§‚å¯Ÿæ›²çº¿èµ°åŠ¿ï¼Œå¯ä»¥å‘ç°æ¸©æ¹¿åº¦çš„å‘¨æœŸæ€§å˜åŒ–ã€çªå‘å¼‚å¸¸ç­‰æƒ…å†µã€‚ä¾‹å¦‚ï¼Œæ¸©åº¦ä¸Šå‡æ—¶æ¹¿åº¦é€šå¸¸ä¼šä¸‹é™ã€‚</p>
                     <p><strong>æ“ä½œæŠ€å·§ï¼š</strong>å¯ä»¥ä½¿ç”¨æ”¾å¤§ã€ç¼©å°ã€å¹³ç§»æŒ‰é’®æŸ¥çœ‹ä¸åŒæ—¶é—´æ®µçš„æ•°æ®ï¼Œæˆ–æŒ‰ä½Alté”®æ¡†é€‰åŒºåŸŸè¿›è¡Œæ”¾å¤§ã€‚</p>`
        },
        'chart-lux': {
            icon: 'ğŸ“Š',
            title: 'äº®åº¦æ›²çº¿å›¾',
            content: `<p>äº®åº¦æ›²çº¿å›¾æ˜¾ç¤ºç¯å¢ƒå…‰ç…§å¼ºåº¦éšæ—¶é—´çš„å˜åŒ–ã€‚</p>
                     <p><strong>æ—¥å¤œå‘¨æœŸï¼š</strong>é€šå¸¸èƒ½çœ‹åˆ°æ˜æ˜¾çš„æ—¥é—´/å¤œé—´å˜åŒ–è§„å¾‹ï¼Œç™½å¤©è‡ªç„¶å…‰çº¿å……è¶³æ—¶äº®åº¦è¾ƒé«˜ã€‚</p>
                     <p><strong>èƒ½è€—åˆ†æï¼š</strong>é€šè¿‡åˆ†æäº®åº¦æ›²çº¿ï¼Œå¯ä»¥è¯„ä¼°ç…§æ˜ç³»ç»Ÿçš„ä½¿ç”¨æ•ˆç‡ï¼Œä¼˜åŒ–å¼€å…³ç¯æ—¶é—´ã€‚</p>
                     <p><strong>æ•°æ®è®°å½•ï¼š</strong>å¯¹äºå…‰æ•æ„Ÿåœºæ™¯ï¼Œäº®åº¦æ›²çº¿å¯ä»¥ä½œä¸ºç¯å¢ƒæ¡ä»¶çš„é‡è¦è®°å½•ã€‚</p>`
        },
        'chart-smoke': {
            icon: 'ğŸš¨',
            title: 'çƒŸé›¾æµ“åº¦æ›²çº¿å›¾',
            content: `<p>çƒŸé›¾æµ“åº¦æ›²çº¿æ˜¯ç¯å¢ƒå®‰å…¨ç›‘æµ‹çš„æ ¸å¿ƒå·¥å…·ã€‚</p>
                     <p><strong>åŸºçº¿å€¼ï¼š</strong>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒçƒŸé›¾æµ“åº¦åº”ç»´æŒåœ¨è¾ƒä½æ°´å¹³ï¼ˆ< 50 ppmï¼‰å¹¶ä¿æŒç¨³å®šã€‚</p>
                     <p><strong>å¼‚å¸¸è¯†åˆ«ï¼š</strong>æ›²çº¿å‡ºç°çªç„¶ä¸Šå‡è¡¨ç¤ºå¯èƒ½æœ‰çƒŸé›¾æˆ–å¯ç‡ƒæ°”ä½“æ³„æ¼ï¼Œéœ€è¦ç«‹å³æŸ¥çœ‹ç°åœºæƒ…å†µã€‚</p>
                     <p><strong>äº‹æ•…å›æº¯ï¼š</strong>å†å²æ•°æ®å¯ç”¨äºåˆ†æäº‹æ•…å‘ç”Ÿæ—¶é—´å’ŒåŸå› ï¼Œä¸ºæ”¹è¿›å®‰å…¨æªæ–½æä¾›ä¾æ®ã€‚</p>
                     <p><strong>æ³¨æ„ï¼š</strong>å¦‚æœçœ‹åˆ°çƒŸé›¾æµ“åº¦æŒç»­å‡é«˜ï¼Œè¯·ç«‹å³é‡‡å–åº”æ€¥æªæ–½ï¼</p>`
        },
        'pressure': {
            icon: 'ğŸŒ¤ï¸',
            title: 'å¤§æ°”å‹ç›‘æµ‹',
            content: `<p>å¤§æ°”å‹æ˜¯ç©ºæ°”ä½œç”¨åœ¨å•ä½é¢ç§¯ä¸Šçš„åŠ›ï¼Œå•ä½ä¸ºç™¾å¸•ï¼ˆhPaï¼‰æˆ–åƒå¸•ï¼ˆkPaï¼‰ã€‚</p>
                     <p><strong>æ ‡å‡†å€¼ï¼š</strong>æµ·å¹³é¢æ ‡å‡†å¤§æ°”å‹çº¦ä¸º 1013 hPaï¼ˆ101.3 kPaï¼‰ï¼Œæ­£å¸¸èŒƒå›´ä¸€èˆ¬åœ¨ 980-1040 hPa ä¹‹é—´ã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>å¤§æ°”å‹å½±å“äººä½“èˆ’é€‚åº¦ã€æ¶²ä½“æ²¸ç‚¹ç­‰å‚æ•°ã€‚æŸäº›åœºæ™¯éœ€è¦è®°å½•å¤§æ°”å‹ä»¥ç¡®ä¿ç¯å¢ƒæ¡ä»¶çš„ç¨³å®šæ€§ã€‚</p>
                     <p><strong>æ°”è±¡å…³è”ï¼š</strong>å¤§æ°”å‹å˜åŒ–ä¸å¤©æ°”å˜åŒ–å¯†åˆ‡ç›¸å…³ï¼Œä½å‹é€šå¸¸ä¼´éšé˜´é›¨å¤©æ°”ï¼Œé«˜å‹åˆ™å¤šæ™´æœ—å¤©æ°”ã€‚</p>
                     <p><strong>ç›‘æµ‹æ„ä¹‰ï¼š</strong>å®æ—¶ç›‘æµ‹å¤§æ°”å‹å¯ä»¥å¸®åŠ©æ ¡å‡†ç²¾å¯†ä»ªå™¨ï¼Œé¢„æµ‹å¤©æ°”å˜åŒ–ï¼Œä¿è¯ç¯å¢ƒæ¡ä»¶çš„å‡†ç¡®è®°å½•ã€‚</p>`
        },
        'chart-pressure': {
            icon: 'ğŸ“‰',
            title: 'å¤§æ°”å‹æ›²çº¿å›¾',
            content: `<p>å¤§æ°”å‹æ›²çº¿æ˜¾ç¤ºç¯å¢ƒæ°”å‹éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ã€‚</p>
                     <p><strong>ç¨³å®šæ€§ï¼š</strong>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¤å†…æ°”å‹åº”ä¿æŒç›¸å¯¹ç¨³å®šï¼Œæ³¢åŠ¨èŒƒå›´åœ¨å‡ ä¸ªç™¾å¸•ä»¥å†…ã€‚</p>
                     <p><strong>å¤©æ°”é¢„æµ‹ï¼š</strong>æ°”å‹å¿«é€Ÿä¸‹é™é€šå¸¸é¢„ç¤ºç€å¤©æ°”è½¬åï¼Œæ°”å‹ä¸Šå‡åˆ™é¢„ç¤ºå¤©æ°”å¥½è½¬ã€‚</p>
                     <p><strong>æ•°æ®æ ¡å‡†ï¼š</strong>æŸäº›ç²¾å¯†è®¾å¤‡éœ€è¦æ ¹æ®å½“æ—¶çš„æ°”å‹å€¼è¿›è¡Œæ•°æ®æ ¡å‡†ï¼Œå†å²æ›²çº¿å¯ä½œä¸ºç¯å¢ƒè®°å½•çš„é‡è¦å‚è€ƒã€‚</p>
                     <p><strong>å¼‚å¸¸ç›‘æµ‹ï¼š</strong>æ°”å‹çªç„¶å¤§å¹…å˜åŒ–å¯èƒ½è¡¨ç¤ºé—¨çª—å¯†é—­æ€§é—®é¢˜æˆ–é€šé£ç³»ç»Ÿå¼‚å¸¸ã€‚</p>`
        },
        'location': {
            icon: 'ğŸ“',
            title: 'è®¾å¤‡å®šä½',
            content: `<p>è®¾å¤‡å®šä½åŠŸèƒ½å¯ä»¥å®æ—¶è·å–è®¾å¤‡çš„ç²¾ç¡®åœ°ç†ä½ç½®ä¿¡æ¯ã€‚</p>
                     <p><strong>å®šä½æ–¹å¼ï¼š</strong>ç³»ç»Ÿä½¿ç”¨LBSï¼ˆLocation Based Serviceï¼‰åŸºç«™å®šä½æŠ€æœ¯ï¼Œé€šè¿‡ç§»åŠ¨ç½‘ç»œè·å–è®¾å¤‡ä½ç½®ã€‚</p>
                     <p><strong>å®šä½ç²¾åº¦ï¼š</strong>LBSå®šä½ç²¾åº¦é€šå¸¸åœ¨å‡ ååˆ°å‡ ç™¾ç±³èŒƒå›´å†…ï¼Œé€‚åˆå¤§éƒ¨åˆ†ç›‘æµ‹åœºæ™¯çš„éœ€æ±‚ã€‚</p>
                     <p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong>å®šä½åŠŸèƒ½å¯ä»¥å¸®åŠ©æ‚¨äº†è§£è®¾å¤‡éƒ¨ç½²ä½ç½®ï¼Œåœ¨è®¾å¤‡ç§»åŠ¨æˆ–å¼‚å¸¸æ—¶å¿«é€Ÿå®šä½è®¾å¤‡æ‰€åœ¨ä½ç½®ï¼Œä¾¿äºç»´æŠ¤å’Œç®¡ç†ã€‚</p>
                     <p><strong>ä¿¡å·å¼ºåº¦ï¼š</strong>CSQå€¼è¡¨ç¤ºä¿¡å·å¼ºåº¦ï¼Œæ•°å€¼è¶Šå¤§è¡¨ç¤ºä¿¡å·è¶Šå¥½ï¼Œé€šå¸¸CSQå€¼åœ¨20ä»¥ä¸Šè¡¨ç¤ºä¿¡å·è‰¯å¥½ã€‚</p>
                     <p><strong>æ“ä½œè¯´æ˜ï¼š</strong>ç‚¹å‡»"è·å–å®šä½"æŒ‰é’®åï¼Œç³»ç»Ÿä¼šå‘è®¾å¤‡å‘é€å®šä½æŸ¥è¯¢å‘½ä»¤ï¼Œè®¾å¤‡è¿”å›å®šä½æ•°æ®åä¼šè‡ªåŠ¨åœ¨åœ°å›¾ä¸Šæ ‡è®°ä½ç½®ã€‚</p>`
        }
    };

    // showInfo, closeInfo å·²ç§»è‡³ common.js

    // ç§‘æ™®å¼¹çª—ç‚¹å‡»å¤–éƒ¨å…³é—­ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
    window.addEventListener('load', function () {
        setupInfoModalClickOutside();
    });

    window.addEventListener('load', function () {
        const ZoomPlugin = window.ChartZoom || window.chartjsPluginZoom || window.zoomPlugin || window.Zoom;
        if (ZoomPlugin) {
            Chart.register(ZoomPlugin);
            console.log('Chart.js zoom plugin loaded successfully');
        } else {
            console.error('Chart.js zoom plugin not found');
        }
        createCharts();
        // å¼¹çª—ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½å·²ç§»è‡³ common.jsï¼Œåœ¨å¼¹çª—åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®
    });

    // ä¸»é¢˜ç³»ç»Ÿå·²ç§»è‡³ common.js (root, THEME_KEY, applyTheme ç­‰)

    // åŠŸèƒ½èœå•æ§åˆ¶å·²ç§»è‡³ common.js çš„ initFunctionMenu()

    // ä¸»é¢˜åˆ‡æ¢ï¼ˆé¡µé¢åŠ è½½åè®¾ç½®ï¼‰
    window.addEventListener('load', function () {
        setupThemeToggle('themeBtn');
    });

    const wsDot = qs('#wsDot'), wsText = qs('#wsText'), lastTs = qs('#lastTs'), counter = qs('#count');
    const tempVal = qs('#tempVal'), humVal = qs('#humVal'), luxVal = qs('#luxVal'), smokeVal = qs('#smokeVal'),
        pressureVal = qs('#pressureVal'), tempDiffVal = qs('#tempDiffVal');
    const tempTrend = qs('#tempTrend'), humTrend = qs('#humTrend'), luxTrend = qs('#luxTrend'),
        smokeTrend = qs('#smokeTrend'), pressureTrend = qs('#pressureTrend'), tempDiffTrend = qs('#tempDiffTrend');
    const temp2Display = qs('#temp2Display');
    const rsRoDisplay = qs('#rsRoDisplay');
    const tbodyAll = qs('#tbodyAll');
    
    // è·å–å¡ç‰‡å…ƒç´ 
    const tempCard = qs('#tempCard');
    const tempDiffCard = qs('#tempDiffCard');
    const humCard = qs('#humCard');
    const luxCard = qs('#luxCard');
    const smokeCard = qs('#smokeCard');
    const pressureCard = qs('#pressureCard');
    const overlay = qs('#overlay');
    const chartTHFullCanvas = () => qs('#chartTHFull');
    const overlayLux = qs('#overlayLux');
    const chartLUXFullCanvas = () => qs('#chartLUXFull');
    const overlaySmoke = qs('#overlaySmoke');
    const chartSMOKEFullCanvas = () => qs('#chartSMOKEFull');
    const overlayPressure = qs('#overlayPressure');
    const chartPRESSUREFullCanvas = () => qs('#chartPRESSUREFull');

    // qs() å‡½æ•°å·²ç§»è‡³ common.js

    const MAX_ROWS = 500, N_TREND = 20;
    // å›¾è¡¨ï¼šçª—å£500æ¡ï¼Œä½†ä¿å­˜æ›´é•¿å†å²ç”¨äºæ‹–åŠ¨æŸ¥çœ‹
    const WINDOW_SIZE = 500;
    const MAX_CHART_HISTORY = 50000; // ä¸»å›¾è¡¨æœ€å¤§æ•°æ®é‡ // é˜²æ­¢æ— é™å¢é•¿
    const labelsAll = [], tempsAll = [], humsAll = [], luxAll = [], smokeAll = [], pressureAll = [], temps2All = [],
        tempDiffAll = [];
    const timestampArray = []; // ä¿å­˜æ¯ä¸ªæ•°æ®ç‚¹çš„æ—¶é—´æˆ³ï¼Œç”¨äºé‡æ–°æ ¼å¼åŒ–æ ‡ç­¾
    // æ”¾å¤§å›¾å†å²ï¼šä¸åšå‰ç«¯é™åˆ¶ï¼ˆä¾ç„¶å—åç«¯å‘é€é‡å½±å“ï¼‰
    const labelsFull = [], tempsFull = [], humsFull = [], temps2Full = [];
    const labelsLuxFull = [], luxFull = [];
    const labelsSmokeFull = [], smokeFull = [];
    const labelsPressureFull = [], pressureFull = [];

    // âœ… ç»Ÿä¸€ç®¡ç†ï¼šå›¾è¡¨é…ç½®å’ŒçŠ¶æ€
    window.chartConfig = {
        TH: {followLatest: true, fullChart: null},
        LUX: {followLatest: true, fullChart: null},
        SMOKE: {followLatest: true, fullChart: null},
        PRESSURE: {followLatest: true, fullChart: null}
    };

    // å…¨å±å›¾è¡¨å®ä¾‹ï¼ˆä¿ç•™å˜é‡ä»¥ä¾¿ä»£ç ä¸­å¼•ç”¨ï¼‰
    let chartTHFull = null;
    let chartLUXFull = null;
    let chartSMOKEFull = null;
    let chartPRESSUREFull = null;

    // æ¸©æ¹¿åº¦æ‹–åŠ¨ç´¯è®¡ï¼ˆå°†åƒç´ ->ç´¢å¼•çš„åˆ†æ•°éƒ¨åˆ†ç´¯ç§¯ï¼Œé¿å…å°æ‹–åŠ¨æ— æ•ˆï¼‰
    let carryShiftTH = 0;

    function setWsStatus(ok) {
        wsDot.classList.remove('ok', 'err');
        wsDot.classList.add(ok ? 'ok' : 'err');
        wsText.textContent = ok ? 'å·²è¿æ¥' : 'æœªè¿æ¥'
    }

    function delta(arr) {
        if (arr.length < 2) return 0;
        return arr[arr.length - 1] - arr[0]
    }
    
    // æ›´æ–°å¡ç‰‡çŠ¶æ€ï¼ˆæ ¹æ®æ•°å€¼æ˜¾ç¤ºè­¦å‘Š/å±é™©è‰²ï¼‰
    function updateCardStatus(card, value, warningThreshold, dangerThreshold, isReverse = false) {
        if (!card || value == null || isNaN(value)) {
            card?.classList.remove('card-warning', 'card-danger');
            return;
        }
        
        card.classList.remove('card-warning', 'card-danger');
        
        if (isReverse) {
            // åå‘åˆ¤æ–­ï¼ˆå¦‚äº®åº¦ã€æ¹¿åº¦ä¸‹é™ï¼‰
            if (value <= dangerThreshold) {
                card.classList.add('card-danger');
            } else if (value <= warningThreshold) {
                card.classList.add('card-warning');
            }
        } else {
            // æ­£å‘åˆ¤æ–­
            if (value >= dangerThreshold) {
                card.classList.add('card-danger');
            } else if (value >= warningThreshold) {
                card.classList.add('card-warning');
            }
        }
    }
    
    // æ¹¿åº¦èŒƒå›´åˆ¤æ–­ï¼ˆåŒå‘ï¼‰
    function updateHumidityStatus(card, value) {
        if (!card || value == null || isNaN(value)) {
            card?.classList.remove('card-warning', 'card-danger');
            return;
        }
        
        card.classList.remove('card-warning', 'card-danger');
        
        // è¿‡ä½æˆ–è¿‡é«˜éƒ½è­¦å‘Š
        if (value < 20 || value > 80) {
            card.classList.add('card-danger');
        } else if (value < 30 || value > 70) {
            card.classList.add('card-warning');
        }
    }
    
    // æ°”å‹èŒƒå›´åˆ¤æ–­ï¼ˆåŒå‘ï¼‰
    function updatePressureStatus(card, value) {
        if (!card || value == null || isNaN(value)) {
            card?.classList.remove('card-warning', 'card-danger');
            return;
        }
        
        card.classList.remove('card-warning', 'card-danger');
        
        // è¿‡ä½æˆ–è¿‡é«˜éƒ½è­¦å‘Š
        if (value < 995 || value > 1025) {
            card.classList.add('card-danger');
        } else if (value < 1000 || value > 1020) {
            card.classList.add('card-warning');
        }
    }

    function setTrend(ele, d, unit) {
        ele.classList.remove('up', 'down');
        const arrow = ele.querySelector('.arrow') || ele.appendChild(Object.assign(document.createElement('span'), {className: 'arrow'}));
        const txt = ele.querySelector('.txt') || ele.appendChild(Object.assign(document.createElement('span'), {className: 'txt'}));
        if (Math.abs(d) < 0.01) {
            arrow.textContent = 'â€”';
            txt.textContent = 'è¶‹åŠ¿ç¨³å®š'
        } else if (d > 0) {
            ele.classList.add('up');
            arrow.textContent = 'â†‘';
            txt.textContent = `ä¸Šå‡ ${d.toFixed(2)} ${unit}`
        } else {
            ele.classList.add('down');
            arrow.textContent = 'â†“';
            txt.textContent = `ä¸‹é™ ${Math.abs(d).toFixed(2)} ${unit}`
        }
    }

    function colorFromTemp(v) {
        const tMin = 0, tMax = 35, p = Math.min(1, Math.max(0, (v - tMin) / (tMax - tMin)));
        const s = getComputedStyle(document.documentElement);
        const cold = s.getPropertyValue('--chart-line-temp-cold').trim();
        const warm = s.getPropertyValue('--chart-line-temp-warm').trim();
        const h2r = h => {
            const m = h.replace('#', '');
            return [parseInt(m.slice(0, 2), 16), parseInt(m.slice(2, 4), 16), parseInt(m.slice(4, 6), 16)]
        }
        const r2h = a => "#" + a.map(n => n.toString(16).padStart(2, '0')).join('');
        const c1 = h2r(cold), c2 = h2r(warm), mix = [0, 1, 2].map(i => Math.round(c1[i] * (1 - p) + c2[i] * p));
        return r2h(mix)
    }

    // css() å‡½æ•°å·²ç§»è‡³ common.js

    function makeBaseOptions() {
        return {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: {mode: 'nearest', intersect: false, axis: 'x'},
            hover: {mode: 'nearest', intersect: false, animationDuration: 200},
            elements: {point: {radius: 0, hoverRadius: 5, hoverBorderWidth: 2}, line: {tension: 0.4, borderWidth: 2}},
            scales: {
                x: {
                    ticks: {
                        maxRotation: 0, // ä¸æ—‹è½¬æ ‡ç­¾
                        autoSkip: true,
                        autoSkipPadding: 20,
                        maxTicksLimit: 8,
                        callback: function(value, index, ticks) {
                            // å¦‚æœ makeTimeLabelFormatter å¯ç”¨ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨ç®€å•æ ¼å¼åŒ–
                            if (typeof window.makeTimeLabelFormatter === 'function') {
                                const formatter = window.makeTimeLabelFormatter();
                                return formatter.call(this, value, index, ticks);
                            }
                            const label = this.getLabelForValue(value);
                            return label || '';
                        }
                    },
                    grid: {color: css('--chart-grid')}
                },
                y: {position: 'left', grid: {color: css('--chart-grid')}},
                y1: {position: 'right', grid: {drawOnChartArea: false, color: css('--chart-grid')}}
            },
            plugins: {
                legend: {labels: {color: css('--muted')}},
                tooltip: {
                    mode: 'nearest', intersect: false,
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff', bodyColor: '#fff',
                    borderColor: css('--bd'), borderWidth: 1, cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title(ctx) {
                            return 'æ—¶é—´: ' + ctx[0].label;
                        },
                        label(ctx) {
                            const label = ctx.dataset.label || '';
                            const v = ctx.parsed.y;
                            return label + ': ' + (Number.isFinite(v) ? v.toFixed(2) : '--');
                        }
                    }
                },
                // æ’ä»¶åŸç”Ÿç¼©æ”¾/å¹³ç§»
                zoom: {
                    limits: {x: {min: 'original', max: 'original'}},
                    pan: {
                        enabled: true,
                        mode: 'x',
                        threshold: 4
                    },
                    zoom: {
                        wheel: {enabled: true, speed: 0.2},
                        pinch: {
                            enabled: true,
                            threshold: 0.1,
                            speed: 0.5,
                            mode: 'x'
                        },
                        drag: {
                            enabled: true,
                            modifierKey: 'alt',
                            backgroundColor: 'rgba(125,125,125,.12)',
                            borderColor: 'rgba(125,125,125,.3)',
                            threshold: 6
                        },
                        mode: 'x'
                    }
                }
            }
        };
    }

    // é€šç”¨å•è½´å›¾è¡¨é…ç½®ç”Ÿæˆå™¨
    function makeSingleAxisChartOptions() {
        const opts = makeBaseOptions();
        opts.scales = {
            x: {
                ticks: {
                    maxRotation: 0,
                    autoSkip: true,
                    autoSkipPadding: 20,
                    maxTicksLimit: 8,
                    callback: function (value, index, ticks) {
                        const label = this.getLabelForValue(value);
                        // åªæ˜¾ç¤ºæ—¶é—´éƒ¨åˆ†ï¼Œæ ¼å¼ï¼šHH:mm
                        if (label && label.includes(':')) {
                            const parts = label.split(' ');
                            if (parts.length >= 2) {
                                const timeParts = parts[1].split(':');
                                return timeParts[0] + ':' + timeParts[1];
                            }
                        }
                        return label;
                    }
                },
                grid: {color: css('--chart-grid')}
            },
            y: {position: 'left', grid: {color: css('--chart-grid')}}
        };
        // åªç¦ç”¨æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰çª—å£æ‹–åŠ¨
        if (opts?.plugins?.zoom?.pan) {
            opts.plugins.zoom.pan.enabled = false;
        }
        return opts;
    }

    function createCharts() {
        // â€” æ¸©æ¹¿ â€”
        const ctxTH = qs('#chartTH').getContext('2d');
        const dataTH = {
            labels: labelsAll, datasets: [
                {
                    label: 'æ¸©åº¦1 (Â°C)', data: tempsAll, yAxisID: 'y',
                    borderColor: css('--chart-line-temp-warm'),
                    pointHoverBorderColor: css('--chart-line-temp-warm')
                },
                {
                    label: 'æ¸©åº¦2 (Â°C)', data: temps2All, yAxisID: 'y',
                    borderColor: css('--chart-line-temp-cold'),
                    pointHoverBorderColor: css('--chart-line-temp-cold')
                },
                {
                    label: 'æ¹¿åº¦ (%)', data: humsAll, yAxisID: 'y1',
                    borderColor: css('--chart-line-hum'),
                    pointHoverBorderColor: css('--chart-line-hum')
                }
            ]
        };
        const optsTH = makeBaseOptions();
        // åªç¦ç”¨æ¸©æ¹¿åº¦å›¾çš„æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰çª—å£æ‹–åŠ¨
        if (optsTH?.plugins?.zoom?.pan) {
            optsTH.plugins.zoom.pan.enabled = false;
        }
        window.chartTH = new Chart(ctxTH, {type: 'line', data: dataTH, options: optsTH});

        // â€” äº®åº¦ â€”
        const ctxLUX = qs('#chartLUX').getContext('2d');
        const dataLUX = {
            labels: labelsAll, datasets: [
                {
                    label: 'äº®åº¦ (lx)', data: luxAll, yAxisID: 'y',
                    borderColor: css('--chart-line-lux'),
                    pointHoverBorderColor: css('--chart-line-lux')
                }
            ]
        };
        window.chartLUX = new Chart(ctxLUX, {type: 'line', data: dataLUX, options: makeSingleAxisChartOptions()});

        // â€” çƒŸé›¾ â€”
        const ctxSMOKE = qs('#chartSMOKE').getContext('2d');
        const dataSMOKE = {
            labels: labelsAll, datasets: [
                {
                    label: 'çƒŸé›¾æµ“åº¦ (ppm)', data: smokeAll, yAxisID: 'y',
                    borderColor: css('--chart-line-smoke'),
                    pointHoverBorderColor: css('--chart-line-smoke')
                }
            ]
        };
        window.chartSMOKE = new Chart(ctxSMOKE, {type: 'line', data: dataSMOKE, options: makeSingleAxisChartOptions()});

        // â€” å¤§æ°”å‹ â€”
        const ctxPRESSURE = qs('#chartPRESSURE').getContext('2d');
        const dataPRESSURE = {
            labels: labelsAll, datasets: [
                {
                    label: 'å¤§æ°”å‹ (hPa)', data: pressureAll, yAxisID: 'y',
                    borderColor: css('--chart-line-pressure'),
                    pointHoverBorderColor: css('--chart-line-pressure')
                }
            ]
        };
        window.chartPRESSURE = new Chart(ctxPRESSURE, {
            type: 'line',
            data: dataPRESSURE,
            options: makeSingleAxisChartOptions()
        });

        // é˜»æ–­é»˜è®¤æ»šåŠ¨é“¾ï¼Œé˜²æ­¢é¡µé¢è·Ÿç€æ»šï¼›åŒå‡»ç¡¬é‡ç½®
        ['chartTH', 'chartLUX', 'chartSMOKE', 'chartPRESSURE'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('wheel', e => {
                e.preventDefault();
            }, {passive: false, capture: true});
            el.addEventListener('dblclick', () => {
                if (id === 'chartTH') hardReset(window.chartTH);
                else if (id === 'chartLUX') hardReset(window.chartLUX);
                else if (id === 'chartSMOKE') hardReset(window.chartSMOKE);
                else if (id === 'chartPRESSURE') hardReset(window.chartPRESSURE);
            });

            // è§¦å±åŒå‡»é‡ç½®
            let lastTouchTime = 0;
            el.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                if (currentTime - lastTouchTime < 300 && e.touches.length === 0) {
                    if (id === 'chartTH') hardReset(window.chartTH);
                    else if (id === 'chartLUX') hardReset(window.chartLUX);
                    else if (id === 'chartSMOKE') hardReset(window.chartSMOKE);
                    else if (id === 'chartPRESSURE') hardReset(window.chartPRESSURE);
                }
                lastTouchTime = currentTime;
            });


            // å…‰æ ‡æç¤º
            el.style.cursor = 'grab';
            el.addEventListener('mousedown', () => {
                el.style.cursor = 'grabbing';
            });
            window.addEventListener('mouseup', () => {
                el.style.cursor = 'grab';
            });
        });

        // âœ… å…œåº•ï¼šå·¦é”®æ‹–åŠ¨å¹³ç§»ï¼ˆä¸æŒ‰ Alt æ—¶è§¦å‘ï¼‰ï¼Œä¸ä¾èµ–æ’ä»¶
        enableManualDragPan(document.getElementById('chartTH'), window.chartTH, 'TH');
        enableManualDragPan(document.getElementById('chartLUX'), window.chartLUX, 'LUX');
        enableManualDragPan(document.getElementById('chartSMOKE'), window.chartSMOKE, 'SMOKE');
        enableManualDragPan(document.getElementById('chartPRESSURE'), window.chartPRESSURE, 'PRESSURE');

        // åˆå§‹åŒ–çª—å£åˆ°æœ€è¿‘ WINDOW_SIZE
        const applyInitialWindow = (chart) => {
            const N = chart?.data?.labels?.length || 0;
            if (!N) return;
            const s = chart.options.scales.x;
            s.min = Math.max(0, N - WINDOW_SIZE);
            s.max = N - 1;
            chart.update('none');
        };

        // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®åŠ è½½å®Œæˆåå†åˆå§‹åŒ–çª—å£
        setTimeout(() => {
            applyInitialWindow(window.chartTH);
            applyInitialWindow(window.chartLUX);
            applyInitialWindow(window.chartSMOKE);
            applyInitialWindow(window.chartPRESSURE);
            window.chartConfig.TH.followLatest = true;
            window.chartConfig.LUX.followLatest = true;
            window.chartConfig.SMOKE.followLatest = true;
            window.chartConfig.PRESSURE.followLatest = true;
        }, 100);

        // é€šç”¨æŒ‰é’®ç»‘å®šå‡½æ•°
        function bindChartButtons(chartName, chart, configKey) {
            qs(`#zoomIn${chartName}`)?.addEventListener('click', () => chart?.zoom(1.2));
            qs(`#zoomOut${chartName}`)?.addEventListener('click', () => chart?.zoom(0.8));
            qs(`#panLeft${chartName}`)?.addEventListener('click', () => {
                if (window.chartConfig[configKey]) {
                    window.chartConfig[configKey].followLatest = false;
                }
                chart?.pan({x: 120});
            });
            qs(`#panRight${chartName}`)?.addEventListener('click', () => {
                chart?.pan({x: -120});
                const s = chart?.options?.scales?.x;
                const N = chart?.data?.labels?.length || 0;
                if (s && N && window.chartConfig[configKey] && (s.max ?? (N - 1)) >= N - 1 - 0.5) {
                    window.chartConfig[configKey].followLatest = true;
                }
            });
            qs(`#reset${chartName}`)?.addEventListener('click', () => hardReset(chart));
        }

        // ä¸ºå››ä¸ªå›¾è¡¨ç»‘å®šç›¸åŒçš„æŒ‰é’®é€»è¾‘
        bindChartButtons('TH', window.chartTH, 'TH');
        bindChartButtons('LUX', window.chartLUX, 'LUX');
        bindChartButtons('SMOKE', window.chartSMOKE, 'SMOKE');
        bindChartButtons('PRESSURE', window.chartPRESSURE, 'PRESSURE');
    }

    // å›¾è¡¨åˆ°é…ç½®çš„æ˜ å°„å·²ç§»è‡³ common.js

    // â€”â€” å…œåº•ï¼šå·¦é”®æ‹–åŠ¨å¹³ç§»ï¼ˆç›´æ¥æ”¹ x.min/x.maxï¼‰ï¼Œé¿å…ä¸ Alt æ¡†é€‰å†²çª â€”â€”
    function enableManualDragPan(canvas, chart, configKey) {
        if (!canvas || !chart) return;

        // æ³¨å†Œå›¾è¡¨å’Œå…¶é…ç½®çš„æ˜ å°„
        chartConfigMap.set(chart, configKey);

        // å– X è½´ï¼ˆå…¼å®¹ä¸åŒå‘½åï¼‰
        const getXScale = () => {
            const sc = chart.scales || {};
            return sc.x || sc['x-axis-0'] || Object.values(sc).find(s => s.isHorizontal?.()) || Object.values(sc)[0];
        };

        let dragging = false;
        let lastX = 0;

        function panByPixels(dxPixels) {
            const scale = getXScale();
            const N = chart.data.labels.length || 0;
            if (!scale || !N) return;

            // å½“å‰çª—å£
            let curMin = (chart.options.scales.x.min ?? 0);
            let curMax = (chart.options.scales.x.max ?? (N - 1));
            if (!Number.isFinite(curMin) || !Number.isFinite(curMax)) {
                curMin = 0;
                curMax = N - 1;
            }

            const range = Math.max(1, curMax - curMin);
            const pxPerIndex = Math.max(1, (scale.right - scale.left) / range);
            let shiftIdx = dxPixels / pxPerIndex;

            let newMin = curMin + shiftIdx;
            let newMax = curMax + shiftIdx;

            if (newMin < 0) {
                const d = -newMin;
                newMin += d;
                newMax += d;
            }
            if (newMax > N - 1) {
                const d = newMax - (N - 1);
                newMin -= d;
                newMax -= d;
            }

            // æ¸©æ¹¿åº¦å·²ä¸äº®åº¦å¯¹é½ï¼šä»ä½¿ç”¨æ’ä»¶/è½´å¹³ç§»é€»è¾‘
            chart.options.scales.x.min = newMin;
            chart.options.scales.x.max = newMax;
            chart.update('none');
        }

        // é¼ æ ‡äº‹ä»¶
        canvas.addEventListener('mousedown', (e) => {
            if (e.altKey || e.button !== 0) return; // Alt æ˜¯æ¡†é€‰æ”¾å¤§ï¼Œå³é”®ä¸å¤„ç†
            dragging = true;
            lastX = e.clientX;
            canvas.style.cursor = 'grabbing';

            // ç¡®ä¿çª—å£ä½ç½®å·²åˆå§‹åŒ–ï¼ˆé˜²æ­¢æ‹–åŠ¨æ—¶è¢«é‡ç½®ï¼‰
            const s = chart.options?.scales?.x;
            const N = chart.data.labels?.length || 0;
            if (s && N && (s.min === undefined || s.max === undefined)) {
                s.min = Math.max(0, N - WINDOW_SIZE);
                s.max = N - 1;
            }

            // ä½¿ç”¨é…ç½®å¯¹è±¡è®¾ç½®è·Ÿéšæ ‡å¿—
            const configKey = chartConfigMap.get(chart);
            if (configKey && window.chartConfig[configKey]) {
                window.chartConfig[configKey].followLatest = false;
            }
            e.preventDefault();
        }, {passive: false});

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const dx = e.clientX - lastX;
            lastX = e.clientX;
            panByPixels(-dx); // å‘å³æ‹– => çœ‹æ›´æ—©æ•°æ®
            e.preventDefault();
        }, {passive: false});

        window.addEventListener('mouseup', () => {
            if (!dragging) return;
            dragging = false;
            canvas.style.cursor = 'grab';
            // æ¾æ‰‹æ—¶å¦‚ä½äºæœ€å³ç«¯ï¼Œåˆ™å¼€å¯å®æ—¶è·Ÿéš
            try {
                const s = chart?.options?.scales?.x;
                const N = chart?.data?.labels?.length || 0;
                const configKey = chartConfigMap.get(chart);
                if (s && N && configKey && window.chartConfig[configKey]) {
                    const atRight = (s.max ?? (N - 1)) >= N - 1 - 0.5;
                    if (atRight) window.chartConfig[configKey].followLatest = true;
                }
            } catch (e) {
            }
        });

        // è§¦å±äº‹ä»¶ - åªå¤„ç†å•æŒ‡æ‹–æ‹½ï¼Œè®©Chart.jså¤„ç†åŒæŒ‡ç¼©æ”¾
        let initialTouches = 0;

        canvas.addEventListener('touchstart', (e) => {
            initialTouches = e.touches.length;

            if (e.touches.length === 1) {
                dragging = true;
                lastX = e.touches[0].clientX;

                // ç¡®ä¿çª—å£ä½ç½®å·²åˆå§‹åŒ–ï¼ˆé˜²æ­¢æ‹–åŠ¨æ—¶è¢«é‡ç½®ï¼‰
                const s = chart.options?.scales?.x;
                const N = chart.data.labels?.length || 0;
                if (s && N && (s.min === undefined || s.max === undefined)) {
                    s.min = Math.max(0, N - WINDOW_SIZE);
                    s.max = N - 1;
                }

                // ä½¿ç”¨é…ç½®å¯¹è±¡è®¾ç½®è·Ÿéšæ ‡å¿—
                const configKey = chartConfigMap.get(chart);
                if (configKey && window.chartConfig[configKey]) {
                    window.chartConfig[configKey].followLatest = false;
                }
            }
        }, {passive: true});

        window.addEventListener('touchmove', (e) => {
            // åªåœ¨å•æŒ‡æ—¶å¤„ç†æ‹–æ‹½ï¼ŒåŒæŒ‡æ—¶è®©Chart.jså¤„ç†ç¼©æ”¾
            if (initialTouches === 1 && dragging && e.touches.length === 1) {
                const dx = e.touches[0].clientX - lastX;
                lastX = e.touches[0].clientX;
                panByPixels(-dx);
                e.preventDefault();
            }
        }, {passive: false});

        window.addEventListener('touchend', (e) => {
            if (dragging && initialTouches === 1) {
                dragging = false;
            }
            // è§¦æ‘¸ç»“æŸæ—¶åŒæ ·æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æœ€å³ç«¯
            try {
                const s = chart?.options?.scales?.x;
                const N = chart?.data?.labels?.length || 0;
                const configKey = chartConfigMap.get(chart);
                if (s && N && configKey && window.chartConfig[configKey]) {
                    const atRight = (s.max ?? (N - 1)) >= N - 1 - 0.5;
                    if (atRight) window.chartConfig[configKey].followLatest = true;
                }
            } catch (e) {
            }
        });
    }

    // ç¡¬é‡ç½®ï¼šresetZoom + æ¸…é™¤ min/max + å¼€å¯è·Ÿéš
    function hardReset(chart) {
        if (!chart) return;
        try {
            chart.resetZoom?.();
        } catch (e) {
        }
        if (chart.options?.scales?.x) {
            chart.options.scales.x.min = undefined;
            chart.options.scales.x.max = undefined;
        }
        if (chart.options?.scales?.y) {
            chart.options.scales.y.min = undefined;
            chart.options.scales.y.max = undefined;
        }

        // é‡ç½®åå¼€å¯è·Ÿéšæœ€æ–°æ•°æ®
        const configKey = chartConfigMap.get(chart);
        if (configKey && window.chartConfig[configKey]) {
            window.chartConfig[configKey].followLatest = true;
        }

        chart.update('none');
    }

    function disableDragAndPanFor(chart) {
        if (!chart) return;
        const opts = chart.options?.plugins?.zoom;
        if (opts) {
            // å½»åº•å…³é—­å¹³ç§»ä¸æ‹–æ‹½ç¼©æ”¾
            if (opts.pan) opts.pan.enabled = false;
            if (opts.zoom?.drag) opts.zoom.drag.enabled = false;
        }
        // ä¹Ÿç§»é™¤æˆ‘ä»¬å…œåº•çš„æ‰‹åŠ¨æ‹–åŠ¨
        // æ–¹å¼ï¼šç»™ canvas è®¾ç½®ä¸å¯æ‹–åŠ¨çš„ cursorï¼Œå¹¶ä¸å†æ³¨å†Œäº‹ä»¶ï¼ˆæ”¾å¤§å›¾ä¸ä¼šè°ƒç”¨ enableManualDragPanï¼‰
        try {
            chart.canvas.style.cursor = 'default';
        } catch (e) {
        }
    }

    window.updateChartColors = function () {
        if (!window.chartTH || !window.chartLUX || !window.chartSMOKE || !window.chartPRESSURE) return;
        try {
            const s = css('--chart-grid');
            window.chartTH.options.scales.x.grid.color = s;
            window.chartTH.options.scales.y.grid.color = s;
            window.chartTH.options.scales.y1.grid.color = s;

            // è®¾ç½®æ¸©åº¦å’Œæ¹¿åº¦çº¿æ¡çš„å›¾ä¾‹é¢œè‰²ï¼ˆä½¿ç”¨CSSå˜é‡ï¼‰
            window.chartTH.data.datasets[0].borderColor = css('--chart-line-temp-warm');
            window.chartTH.data.datasets[1].borderColor = css('--chart-line-temp-cold');
            window.chartTH.data.datasets[2].borderColor = css('--chart-line-hum');
            window.chartTH.update('none');

            window.chartLUX.options.scales.x.grid.color = s;
            window.chartLUX.options.scales.y.grid.color = s;
            window.chartLUX.data.datasets[0].borderColor = css('--chart-line-lux');
            window.chartLUX.update('none');

            window.chartSMOKE.options.scales.x.grid.color = s;
            window.chartSMOKE.options.scales.y.grid.color = s;
            window.chartSMOKE.data.datasets[0].borderColor = css('--chart-line-smoke');
            window.chartSMOKE.update('none');

            window.chartPRESSURE.options.scales.x.grid.color = s;
            window.chartPRESSURE.options.scales.y.grid.color = s;
            window.chartPRESSURE.data.datasets[0].borderColor = css('--chart-line-pressure');
            window.chartPRESSURE.update('none');

            if (window.chartTHFull) {
                window.chartTHFull.options.scales.x.grid.color = s;
                window.chartTHFull.options.scales.y.grid.color = s;
                window.chartTHFull.options.scales.y1.grid.color = s;
                window.chartTHFull.data.datasets[0].borderColor = css('--chart-line-temp-warm');
                window.chartTHFull.data.datasets[1].borderColor = css('--chart-line-temp-cold');
                window.chartTHFull.data.datasets[2].borderColor = css('--chart-line-hum');
                window.chartTHFull.update('none');
            }
            if (window.chartLUXFull) {
                window.chartLUXFull.options.scales.x.grid.color = s;
                window.chartLUXFull.options.scales.y.grid.color = s;
                window.chartLUXFull.data.datasets[0].borderColor = css('--chart-line-lux');
                window.chartLUXFull.update('none');
            }
            if (window.chartSMOKEFull) {
                window.chartSMOKEFull.options.scales.x.grid.color = s;
                window.chartSMOKEFull.options.scales.y.grid.color = s;
                window.chartSMOKEFull.data.datasets[0].borderColor = css('--chart-line-smoke');
                window.chartSMOKEFull.update('none');
            }
            if (window.chartPRESSUREFull) {
                window.chartPRESSUREFull.options.scales.x.grid.color = s;
                window.chartPRESSUREFull.options.scales.y.grid.color = s;
                window.chartPRESSUREFull.data.datasets[0].borderColor = css('--chart-line-pressure');
                window.chartPRESSUREFull.update('none');
            }
        } catch (e) {
        }
    };
    (function initTheme() {
        const saved = localStorage.getItem(THEME_KEY) || 'auto';
        applyTheme(saved);
        setTimeout(() => {
            matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') {
                    setTimeout(() => window.updateChartColors(), 100);
                }
            });
        }, 1000);
    })();

    const ro = new ResizeObserver(() => {
        if (window.chartTH && typeof window.chartTH.resize === 'function') window.chartTH.resize();
        if (window.chartLUX && typeof window.chartLUX.resize === 'function') window.chartLUX.resize();
        if (window.chartSMOKE && typeof window.chartSMOKE.resize === 'function') window.chartSMOKE.resize();
        if (window.chartPRESSURE && typeof window.chartPRESSURE.resize === 'function') window.chartPRESSURE.resize();
    });
    const split = document.querySelector('.split');
    if (split) ro.observe(split);

    function addRow(ts, t, h, lx, sm, pr, t2, rs_ro) {
        // æ£€æŸ¥æ—¶é—´æˆ³ï¼Œé˜²æ­¢æ·»åŠ æ—§æ•°æ®ï¼ˆä½†å…è®¸åˆå§‹æ•°æ®ï¼‰
        if (lastDataTimestamp > 0 && ts <= lastDataTimestamp) {
            console.warn(`â­ï¸ [æ—¶é—´æˆ³æ£€æŸ¥] è·³è¿‡æ—§æ•°æ®: ${new Date(ts * 1000).toLocaleString()} (æ—¶é—´æˆ³: ${ts}) <= æœ€æ–°: ${new Date(lastDataTimestamp * 1000).toLocaleString()} (${lastDataTimestamp})`);
            return;
        }

        tempVal.textContent = t.toFixed(2);
        humVal.textContent = h.toFixed(2);
        luxVal.textContent = (lx == null ? '--' : lx.toFixed(1));
        smokeVal.textContent = (sm == null ? '--' : sm.toFixed(1));
        pressureVal.textContent = (pr == null ? '--' : pr.toFixed(1));

        // æ›´æ–°temp2æ˜¾ç¤ºå’Œæ¸©å·®
        let diff = 0;
        if (t2 != null) {
            temp2Display.textContent = `å¦ä¸€æ•°æ®æºï¼š${t2.toFixed(2)}â„ƒ`;
            diff = Math.abs(t - t2);
            tempDiffVal.textContent = diff.toFixed(2);
        } else {
            temp2Display.textContent = '';
            tempDiffVal.textContent = '--';
        }

        // æ›´æ–°Rs/Roæ˜¾ç¤º
        if (rs_ro != null) {
            rsRoDisplay.textContent = `Rs/Roï¼š${rs_ro.toFixed(2)}`;
        } else {
            rsRoDisplay.textContent = '';
        }

        lastTs.textContent = new Date(ts * 1000).toLocaleTimeString();
        counter.textContent = String(parseInt(counter.textContent || '0', 10) + 1);
        
        // æ›´æ–°å¡ç‰‡çŠ¶æ€é¢œè‰²
        updateCardStatus(tempCard, t, 25, 30);                    // æ¸©åº¦ï¼š>25Â°C è­¦å‘Šï¼Œ>30Â°C å±é™©
        updateCardStatus(tempDiffCard, diff, 2, 3);               // æ¸©å·®ï¼š>2Â°C è­¦å‘Šï¼Œ>3Â°C å±é™©
        updateHumidityStatus(humCard, h);                         // æ¹¿åº¦ï¼š<40æˆ–>70 è­¦å‘Šï¼Œ<20æˆ–>80 å±é™©
        updateCardStatus(luxCard, lx, 200, 100, true);            // äº®åº¦ï¼š<200lx è­¦å‘Šï¼Œ<100lx å±é™©ï¼ˆåå‘ï¼‰
        updateCardStatus(smokeCard, sm, 20, 50);                  // çƒŸé›¾ï¼š>20ppm è­¦å‘Šï¼Œ>50ppm å±é™©
        updatePressureStatus(pressureCard, pr);                   // æ°”å‹ï¼šåŒå‘åˆ¤æ–­

        // æ›´æ–°æ—¶é—´æˆ³è·Ÿè¸ªå™¨
        if (window.timeStampTracker) {
            window.timeStampTracker.update(ts);
        }
        if (ts > lastDataTimestamp) {
            lastDataTimestamp = ts;
        }
        
        // ä¿å­˜æ—¶é—´æˆ³
        timestampArray.push(ts);
        
        // ä½¿ç”¨formatTimeLabelæ ¼å¼åŒ–æ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å…œåº•å‡½æ•°
        const formatFunc = (typeof window.formatTimeLabel === 'function') ? window.formatTimeLabel : function(ts) {
            // å…œåº•ï¼šå¦‚æœæ²¡æœ‰formatTimeLabelï¼Œä½¿ç”¨åŸºæœ¬æ—¥æœŸæ ¼å¼
            if (!ts || ts <= 0) return '';
            const date = new Date(ts * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dataDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const isNotToday = dataDate.getTime() !== today.getTime();
            
            // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œæ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼›å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            if (isNotToday) {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                return `${month}-${day} ${hour}:${minute}`;
            } else {
                return date.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };
        const label = formatFunc(ts);
        labelsAll.push(label);
        tempsAll.push(t);
        humsAll.push(h);
        luxAll.push(lx == null ? NaN : lx);
        smokeAll.push(sm == null ? NaN : sm);
        pressureAll.push(pr == null ? NaN : pr);
        temps2All.push(t2 == null ? NaN : t2);
        tempDiffAll.push(t2 == null ? NaN : diff);

        // æ›´æ–°æœ€åçš„æ—¶é—´æˆ³ï¼ˆå·²åœ¨ä¸Šé¢æ›´æ–°ï¼‰
        if (labelsAll.length > MAX_CHART_HISTORY) {
            labelsAll.shift();
            tempsAll.shift();
            humsAll.shift();
            luxAll.shift();
            smokeAll.shift();
            pressureAll.shift();
            temps2All.shift();
            tempDiffAll.shift();
            timestampArray.shift();
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®å¹¶æ ¹æ®è·ŸéšçŠ¶æ€å†³å®šçª—å£ä½ç½®
        const updateChart = (chart, followFlag, chartName) => {
            if (!chart?.options?.scales?.x) return;
            const N = chart.data.labels.length || 0;
            if (!N) return;

            const s = chart.options.scales.x;

            if (followFlag) {
                // è·Ÿéšæ¨¡å¼ï¼šå¯¹é½åˆ°æœ€æ–°æ•°æ®
                s.min = Math.max(0, N - WINDOW_SIZE);
                s.max = N - 1;
            } else {
                // éè·Ÿéšæ¨¡å¼ï¼šä¿å­˜å¹¶æ¢å¤å½“å‰çª—å£ä½ç½®
                const currentMin = s.min;
                const currentMax = s.max;

                // å¦‚æœçª—å£ä½ç½®æœªåˆå§‹åŒ–ï¼Œæ‰è®¾ç½®åˆ°æœ€æ–°
                if (currentMin === undefined || currentMax === undefined) {
                    s.min = Math.max(0, N - WINDOW_SIZE);
                    s.max = N - 1;
                } else {
                    // æ˜ç¡®ä¿æŒå½“å‰ä½ç½®ï¼ˆé˜²æ­¢ Chart.js è‡ªåŠ¨è°ƒæ•´ï¼‰
                    s.min = currentMin;
                    s.max = currentMax;

                    // åªåœ¨çª—å£è¶…å‡ºèŒƒå›´æ—¶æ‰è°ƒæ•´
                    if (s.max > N - 1) {
                        const range = s.max - s.min;
                        s.max = N - 1;
                        s.min = Math.max(0, s.max - range);
                    }
                }
            }

            chart.update('none');
        };

        // ç»Ÿä¸€ï¼šæ¸©æ¹¿åº¦ä¹Ÿä½¿ç”¨å…¨å†å² + è½´çª—å£è·Ÿéš
        if (window.chartTH?.data) {
            window.chartTH.data.labels = labelsAll;
            if (window.chartTH.data.datasets?.[0]) window.chartTH.data.datasets[0].data = tempsAll;
            if (window.chartTH.data.datasets?.[1]) window.chartTH.data.datasets[1].data = temps2All;
            if (window.chartTH.data.datasets?.[2]) window.chartTH.data.datasets[2].data = humsAll;
            updateChart(window.chartTH, window.chartConfig.TH.followLatest, 'TH');
        }
        if (window.chartLUX?.data) {
            window.chartLUX.data.labels = labelsAll;
            if (window.chartLUX.data.datasets?.[0]) window.chartLUX.data.datasets[0].data = luxAll;
            updateChart(window.chartLUX, window.chartConfig.LUX.followLatest, 'LUX');
        }
        if (window.chartSMOKE?.data) {
            window.chartSMOKE.data.labels = labelsAll;
            if (window.chartSMOKE.data.datasets?.[0]) window.chartSMOKE.data.datasets[0].data = smokeAll;
            updateChart(window.chartSMOKE, window.chartConfig.SMOKE.followLatest, 'SMOKE');
        }
        if (window.chartPRESSURE?.data) {
            window.chartPRESSURE.data.labels = labelsAll;
            if (window.chartPRESSURE.data.datasets?.[0]) window.chartPRESSURE.data.datasets[0].data = pressureAll;
            updateChart(window.chartPRESSURE, window.chartConfig.PRESSURE.followLatest, 'PRESSURE');
        }

        const rowData = [new Date(ts * 1000).toLocaleString(), t.toFixed(2), h.toFixed(2), (lx == null ? '--' : lx.toFixed(1)), (sm == null ? '--' : sm.toFixed(1)), (pr == null ? '--' : pr.toFixed(1))];
        const tr = document.createElement('tr');
        rowData.forEach((v, i) => {
            const td = document.createElement('td');
            td.textContent = v;
            if (i > 0) td.classList.add('right');
            tr.appendChild(td);
        });
        tbodyAll.prepend(tr);
        while (tbodyAll.rows.length > MAX_ROWS) tbodyAll.deleteRow(-1);

        // æ”¾å¤§å›¾æ•°æ®ï¼ˆæ— é™åˆ¶ï¼‰
        labelsFull.push(label);
        tempsFull.push(t);
        humsFull.push(h);
        temps2Full.push(t2 == null ? NaN : t2);
        if (chartTHFull) chartTHFull.update('none');

        labelsLuxFull.push(label);
        luxFull.push(lx == null ? NaN : lx);
        if (chartLUXFull) chartLUXFull.update('none');

        labelsSmokeFull.push(label);
        smokeFull.push(sm == null ? NaN : sm);
        if (chartSMOKEFull) chartSMOKEFull.update('none');

        labelsPressureFull.push(label);
        pressureFull.push(pr == null ? NaN : pr);
        if (chartPRESSUREFull) chartPRESSUREFull.update('none');

        const tS = tempsAll.slice(-N_TREND), hS = humsAll.slice(-N_TREND),
            lS = luxAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
            sS = smokeAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
            pS = pressureAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
            dS = tempDiffAll.slice(-N_TREND).filter(x => !Number.isNaN(x));
        setTrend(tempTrend, delta(tS), 'Â°C');
        setTrend(humTrend, delta(hS), '%');
        if (dS.length >= 2) setTrend(tempDiffTrend, delta(dS), 'Â°C');
        if (lS.length >= 2) setTrend(luxTrend, delta(lS), 'lx');
        if (sS.length >= 2) setTrend(smokeTrend, delta(sS), 'ppm');
        if (pS.length >= 2) setTrend(pressureTrend, delta(pS), 'hPa');
    }

    let wsock;
    let historyLoaded = false;
    let isLoadingHistory = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨åŠ è½½å†å²æ•°æ®
    let lastDataTimestamp = 0; // è®°å½•æœ€åä¸€æ¡æ•°æ®çš„æ—¶é—´æˆ³ï¼Œé˜²æ­¢æ—¶é—´è½´é”™ä¹±

    // æ¸…ç©ºæ‰€æœ‰å›¾è¡¨æ•°æ®
    function clearAllData() {
        console.log('ğŸ—‘ï¸ æ¸…ç©ºç°æœ‰æ•°æ®...');

        // æ¸…ç©ºä¸»å›¾è¡¨æ•°æ®
        labelsAll.length = 0;
        tempsAll.length = 0;
        humsAll.length = 0;
        luxAll.length = 0;
        smokeAll.length = 0;
        pressureAll.length = 0;
        temps2All.length = 0;
        tempDiffAll.length = 0;
        timestampArray.length = 0;

        // æ¸…ç©ºæ”¾å¤§å›¾æ•°æ®
        labelsFull.length = 0;
        tempsFull.length = 0;
        humsFull.length = 0;
        temps2Full.length = 0;
        labelsLuxFull.length = 0;
        luxFull.length = 0;
        labelsSmokeFull.length = 0;
        smokeFull.length = 0;
        labelsPressureFull.length = 0;
        pressureFull.length = 0;

        // æ¸…ç©ºè¡¨æ ¼
        const tbodyAll = qs('#tbodyAll');
        if (tbodyAll) {
            tbodyAll.innerHTML = '';
        }

        // é‡ç½®è®¡æ•°å™¨
        const countSpan = qs('#count');
        if (countSpan) countSpan.textContent = '0';

        // é‡ç½®æ—¶é—´æˆ³
        lastDataTimestamp = 0;
        if (window.timeStampTracker) {
            window.timeStampTracker.reset();
        }

        console.log('âœ… æ•°æ®å·²æ¸…ç©º');
    }

    // æ‰¹é‡æ·»åŠ æ•°æ®ï¼ˆä¸è§¦å‘å›¾è¡¨æ›´æ–°ï¼Œä¸æ·»åŠ è¡¨æ ¼ï¼‰
    function addRowBatch(ts, t, h, lx, sm, pr, t2) {
        // æ›´æ–°æ—¶é—´æˆ³è·Ÿè¸ªå™¨
        if (window.timeStampTracker) {
            window.timeStampTracker.update(ts);
        }
        if (ts > lastDataTimestamp) {
            lastDataTimestamp = ts;
        }
        
        // ä¿å­˜æ—¶é—´æˆ³
        timestampArray.push(ts);
        
        // ä½¿ç”¨formatTimeLabelæ ¼å¼åŒ–æ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å…œåº•å‡½æ•°
        const formatFunc = (typeof window.formatTimeLabel === 'function') ? window.formatTimeLabel : function(ts) {
            // å…œåº•ï¼šå¦‚æœæ²¡æœ‰formatTimeLabelï¼Œä½¿ç”¨åŸºæœ¬æ—¥æœŸæ ¼å¼
            if (!ts || ts <= 0) return '';
            const date = new Date(ts * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dataDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const isNotToday = dataDate.getTime() !== today.getTime();
            
            // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œæ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼›å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            if (isNotToday) {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                return `${month}-${day} ${hour}:${minute}`;
            } else {
                return date.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };
        const label = formatFunc(ts);

        // è®¡ç®—æ¸©å·®
        const diff = (t2 != null) ? Math.abs(t - t2) : NaN;

        // åªæ·»åŠ åˆ°æ•°ç»„ï¼Œä¸æ›´æ–°å›¾è¡¨
        labelsAll.push(label);
        tempsAll.push(t);
        humsAll.push(h);
        luxAll.push(lx == null ? NaN : lx);
        smokeAll.push(sm == null ? NaN : sm);
        pressureAll.push(pr == null ? NaN : pr);
        temps2All.push(t2 == null ? NaN : t2);
        tempDiffAll.push(diff);

        // é™åˆ¶ä¸»å›¾æ•°æ®é‡
        if (labelsAll.length > MAX_CHART_HISTORY) {
            labelsAll.shift();
            tempsAll.shift();
            humsAll.shift();
            luxAll.shift();
            smokeAll.shift();
            pressureAll.shift();
            temps2All.shift();
            tempDiffAll.shift();
            timestampArray.shift();
        }

        // æ·»åŠ åˆ°æ”¾å¤§å›¾æ•°æ®
        labelsFull.push(label);
        tempsFull.push(t);
        humsFull.push(h);
        temps2Full.push(t2 == null ? NaN : t2);
        labelsLuxFull.push(label);
        luxFull.push(lx == null ? NaN : lx);
        labelsSmokeFull.push(label);
        smokeFull.push(sm == null ? NaN : sm);
        labelsPressureFull.push(label);
        pressureFull.push(pr == null ? NaN : pr);
    }

    // ä»æ•°æ®åº“åŠ è½½å†å²æ•°æ®
    // å¦‚æœæä¾›äº†preloadedDataï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ä»APIè·å–
    async function loadHistoryData(limit = 1000, clearFirst = false, customUrl = null, preloadedData = null) {
        try {
            // ç¡®ä¿æ ¼å¼åŒ–å‡½æ•°å·²åŠ è½½ï¼ˆå¦‚æœcommon.jsè¿˜æ²¡åŠ è½½å®Œæˆï¼Œç­‰å¾…ä¸€ä¸‹ï¼‰
            let formatTimeLabelFunc = window.formatTimeLabel;
            if (!formatTimeLabelFunc || typeof formatTimeLabelFunc !== 'function') {
                console.warn('âš ï¸ formatTimeLabel å‡½æ•°å°šæœªåŠ è½½ï¼Œç­‰å¾… common.js åŠ è½½...');
                // ç­‰å¾…æœ€å¤š 1 ç§’
                for (let i = 0; i < 10 && (!formatTimeLabelFunc || typeof formatTimeLabelFunc !== 'function'); i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    formatTimeLabelFunc = window.formatTimeLabel;
                }
                if (!formatTimeLabelFunc || typeof formatTimeLabelFunc !== 'function') {
                    console.error('âŒ formatTimeLabel å‡½æ•°åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸºæœ¬æ ¼å¼åŒ–å‡½æ•°');
                    // åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„æ ¼å¼åŒ–å‡½æ•°ä½œä¸ºå…œåº•
                    formatTimeLabelFunc = (timestamp) => {
                        if (!timestamp || timestamp <= 0) return '';
                        const date = new Date(timestamp * 1000);
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hour = String(date.getHours()).padStart(2, '0');
                        const minute = String(date.getMinutes()).padStart(2, '0');
                        const second = String(date.getSeconds()).padStart(2, '0');
                        return `${month}-${day} ${hour}:${minute}:${second}`;
                    };
                } else {
                    console.log('âœ… formatTimeLabel å‡½æ•°å·²åŠ è½½');
                }
            }
            
            // è®¾ç½®åŠ è½½æ ‡å¿—ï¼Œé˜»æ­¢WebSocketæ·»åŠ æ•°æ®
            isLoadingHistory = true;
            console.log('ğŸ”’ å·²æš‚åœæ¥æ”¶å®æ—¶æ•°æ®');

            // å¦‚æœéœ€è¦æ¸…ç©ºæ•°æ®ï¼ˆé‡æ–°åŠ è½½æ—¶ï¼‰
            if (clearFirst) {
                clearAllData();
            }

            let result;
            let fetchTime = 0; // åˆå§‹åŒ–fetchTime

            if (preloadedData) {
                // ä½¿ç”¨é¢„åŠ è½½çš„æ•°æ®ï¼ˆä»common.jsçš„æ•°æ®åŠ è½½å™¨è·å–ï¼‰
                console.log('ğŸ“¦ ä½¿ç”¨é¢„åŠ è½½æ•°æ®:', preloadedData.length, 'æ¡');
                result = {
                    success: true,
                    data: preloadedData,
                    count: preloadedData.length
                };
            } else {
                // è‡ªå·±ä»APIè·å–æ•°æ®
                const url = customUrl || (limit === -1 ? '/api/history?limit=-1' : `/api/history?limit=${limit}`);
                console.log('ğŸ”„ æ­£åœ¨ä»æ•°æ®åº“åŠ è½½å†å²æ•°æ®...');
                console.log('ğŸ“¡ è¯·æ±‚åœ°å€:', url);

                const startTime = performance.now();

                const response = await fetch(url, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼š${response.status}`);
                }

                result = await response.json();
                fetchTime = performance.now() - startTime;
                console.log(`ğŸ“¦ æ”¶åˆ°æ•°æ®: ${result.count} æ¡ (è€—æ—¶ ${fetchTime.toFixed(0)}ms)`);
            }

            if (result.success && result.data && result.data.length > 0) {
                // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†èšåˆ
                const isAggregated = result.aggregated === true;
                const originalCount = result.original_count || result.count;
                const interval = result.interval;
                
                if (isAggregated) {
                    const intervalText = interval >= 3600 ? `${interval / 3600}å°æ—¶` : 
                                        interval >= 60 ? `${interval / 60}åˆ†é’Ÿ` : `${interval}ç§’`;
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${result.count} æ¡èšåˆæ•°æ®ï¼ˆåŸå§‹æ•°æ® ${originalCount} æ¡ï¼Œèšåˆé—´éš”ï¼š${intervalText}ï¼‰`);
                    console.log(`ğŸ“Š æ•°æ®å·²ä¼˜åŒ–ï¼Œä» ${originalCount} æ¡èšåˆåˆ° ${result.count} æ¡ï¼Œæå‡æ€§èƒ½`);
                } else {
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${result.count} æ¡å†å²æ•°æ®`);
                }
                console.log('ğŸ“Š å¼€å§‹æ‰¹é‡æ¸²æŸ“æ•°æ®...');

                const renderStart = performance.now();
                let renderError = null; // è®°å½•æ¸²æŸ“è¿‡ç¨‹ä¸­çš„é”™è¯¯

                try {
                    // å…ˆæ›´æ–°æ‰€æœ‰æ—¶é—´æˆ³è·Ÿè¸ªå™¨ï¼ˆç”¨äºæ­£ç¡®è®¡ç®—æ—¶é—´è·¨åº¦ï¼‰
                    if (window.timeStampTracker) {
                        result.data.forEach(msg => {
                            if (msg.type === 'reading' && msg.ts) {
                                window.timeStampTracker.update(msg.ts);
                            }
                        });
                        console.log('ğŸ“… æ—¶é—´æˆ³è·Ÿè¸ªå™¨å·²æ›´æ–°ï¼Œæ—¶é—´è·¨åº¦ï¼š', window.timeStampTracker.getTimeSpan(), 'ç§’');
                    }

                    // æ‰¹é‡æ·»åŠ æ•°æ®åˆ°æ•°ç»„ï¼ˆä¸æ›´æ–°å›¾è¡¨å’Œè¡¨æ ¼ï¼‰
                    result.data.forEach(msg => {
                        if (msg.type === 'reading') {
                            addRowBatch(msg.ts, msg.temp, msg.hum, msg.lux, msg.smoke, msg.pressure, msg.temp2, msg.rs_ro);
                        }
                    });

                    // é‡æ–°æ ¼å¼åŒ–æ‰€æœ‰æ ‡ç­¾ï¼ˆå› ä¸ºç°åœ¨æ—¶é—´è·¨åº¦å·²ç»æ­£ç¡®è®¡ç®—äº†ï¼‰
                    // é‡è¦ï¼šå¿…é¡»é‡æ–°æ ¼å¼åŒ–æ‰€æœ‰æ ‡ç­¾ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„æ—¥æœŸæ ¼å¼
                    // ä½¿ç”¨ä¹‹å‰å‡†å¤‡å¥½çš„æ ¼å¼åŒ–å‡½æ•°
                    const formatFunc = formatTimeLabelFunc || window.formatTimeLabel;
                    
                    if (formatFunc && typeof formatFunc === 'function' && timestampArray.length > 0 && labelsAll.length === timestampArray.length) {
                        const timeSpan = window.timeStampTracker ? window.timeStampTracker.getTimeSpan() : 0;
                        console.log('ğŸ”„ é‡æ–°æ ¼å¼åŒ–æ ‡ç­¾ä»¥æ˜¾ç¤ºæ—¥æœŸ...');
                        console.log('ğŸ“… æ—¶é—´è·¨åº¦ï¼š', timeSpan, 'ç§’ï¼ˆ', (timeSpan / 86400).toFixed(2), 'å¤©ï¼‰');
                        console.log('ğŸ“Š æ ‡ç­¾æ•°é‡ï¼š', labelsAll.length, 'ï¼Œæ—¶é—´æˆ³æ•°é‡ï¼š', timestampArray.length);
                        
                        // é‡æ–°æ ¼å¼åŒ–æ‰€æœ‰æ ‡ç­¾
                        for (let i = 0; i < labelsAll.length && i < timestampArray.length; i++) {
                            labelsAll[i] = formatFunc(timestampArray[i]);
                        }
                        
                        // åŒæ—¶æ›´æ–°å…¨å±å›¾è¡¨çš„æ ‡ç­¾
                        if (labelsFull.length === timestampArray.length) {
                            for (let i = 0; i < labelsFull.length && i < timestampArray.length; i++) {
                                labelsFull[i] = formatFunc(timestampArray[i]);
                                if (i < labelsLuxFull.length) labelsLuxFull[i] = formatFunc(timestampArray[i]);
                                if (i < labelsSmokeFull.length) labelsSmokeFull[i] = formatFunc(timestampArray[i]);
                                if (i < labelsPressureFull.length) labelsPressureFull[i] = formatFunc(timestampArray[i]);
                            }
                        }
                        
                        // æ˜¾ç¤ºå‰å‡ ä¸ªæ ‡ç­¾çš„æ ¼å¼ï¼Œç”¨äºè°ƒè¯•
                        if (labelsAll.length > 0) {
                            console.log('ğŸ“‹ æ ‡ç­¾æ ¼å¼åŒ–ç¤ºä¾‹ï¼ˆå‰5ä¸ªï¼‰ï¼š');
                            for (let i = 0; i < Math.min(5, labelsAll.length); i++) {
                                console.log(`  [${i}]: "${labelsAll[i]}" (æ—¶é—´æˆ³: ${new Date(timestampArray[i] * 1000).toLocaleString()})`);
                            }
                        }
                        console.log('âœ… æ ‡ç­¾é‡æ–°æ ¼å¼åŒ–å®Œæˆ');
                    } else {
                        console.warn('âš ï¸ æ— æ³•é‡æ–°æ ¼å¼åŒ–æ ‡ç­¾ï¼š', {
                            hasFormatter: typeof window.formatTimeLabel === 'function',
                            formatFuncExists: !!formatFunc,
                            labelsLength: labelsAll.length,
                            timestampLength: timestampArray.length,
                            lengthsMatch: labelsAll.length === timestampArray.length
                        });
                        // å¦‚æœ formatTimeLabel ä¸å­˜åœ¨ï¼Œä½¿ç”¨å…œåº•å‡½æ•°
                        if (!formatFunc || typeof formatFunc !== 'function') {
                            console.log('âš ï¸ formatTimeLabel å‡½æ•°æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºæœ¬æ—¶é—´æ ¼å¼');
                            if (formatTimeLabelFunc && typeof formatTimeLabelFunc === 'function') {
                                // ä½¿ç”¨ä¹‹å‰å‡†å¤‡å¥½çš„å…œåº•å‡½æ•°
                                for (let i = 0; i < Math.min(labelsAll.length, timestampArray.length); i++) {
                                    labelsAll[i] = formatTimeLabelFunc(timestampArray[i]);
                                }
                                // åŒæ—¶æ›´æ–°å…¨å±å›¾è¡¨æ ‡ç­¾
                                if (labelsFull.length === timestampArray.length) {
                                    for (let i = 0; i < Math.min(labelsFull.length, timestampArray.length); i++) {
                                        labelsFull[i] = formatTimeLabelFunc(timestampArray[i]);
                                        if (i < labelsLuxFull.length) labelsLuxFull[i] = formatTimeLabelFunc(timestampArray[i]);
                                        if (i < labelsSmokeFull.length) labelsSmokeFull[i] = formatTimeLabelFunc(timestampArray[i]);
                                        if (i < labelsPressureFull.length) labelsPressureFull[i] = formatTimeLabelFunc(timestampArray[i]);
                                    }
                                }
                            } else {
                                // æœ€åçš„å…œåº•ï¼šåŸºæœ¬æ ¼å¼åŒ–
                                for (let i = 0; i < Math.min(labelsAll.length, timestampArray.length); i++) {
                                    const date = new Date(timestampArray[i] * 1000);
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const hour = String(date.getHours()).padStart(2, '0');
                                    const minute = String(date.getMinutes()).padStart(2, '0');
                                    labelsAll[i] = `${month}-${day} ${hour}:${minute}`;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('âš ï¸ æ•°æ®å¤„ç†é˜¶æ®µå‡ºé”™ï¼ˆä½†æ•°æ®å·²åŠ è½½ï¼‰:', error);
                    renderError = error;
                }

                // å›¾è¡¨æ›´æ–°éƒ¨åˆ†å•ç‹¬å¤„ç†é”™è¯¯ï¼Œé¿å…å½±å“æ•´ä½“æµç¨‹
                try {
                    // ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰å›¾è¡¨
                    if (window.chartTH?.data) {
                        window.chartTH.data.labels = labelsAll;
                        if (window.chartTH.data.datasets?.[0]) window.chartTH.data.datasets[0].data = tempsAll;
                        if (window.chartTH.data.datasets?.[1]) window.chartTH.data.datasets[1].data = temps2All;
                        if (window.chartTH.data.datasets?.[2]) window.chartTH.data.datasets[2].data = humsAll;
                        window.chartTH.update('none');
                    }
                    if (window.chartLUX?.data) {
                        window.chartLUX.data.labels = labelsAll;
                        if (window.chartLUX.data.datasets?.[0]) window.chartLUX.data.datasets[0].data = luxAll;
                        window.chartLUX.update('none');
                    }
                    if (window.chartSMOKE?.data) {
                        window.chartSMOKE.data.labels = labelsAll;
                        if (window.chartSMOKE.data.datasets?.[0]) window.chartSMOKE.data.datasets[0].data = smokeAll;
                        window.chartSMOKE.update('none');
                    }
                    if (window.chartPRESSURE?.data) {
                        window.chartPRESSURE.data.labels = labelsAll;
                        if (window.chartPRESSURE.data.datasets?.[0]) window.chartPRESSURE.data.datasets[0].data = pressureAll;
                        window.chartPRESSURE.update('none');
                    }
                } catch (error) {
                    console.error('âš ï¸ å›¾è¡¨æ›´æ–°æ—¶å‡ºé”™ï¼ˆä½†æ•°æ®å·²åŠ è½½ï¼‰:', error);
                    renderError = error;
                }

                // è¡¨æ ¼æ›´æ–°éƒ¨åˆ†å•ç‹¬å¤„ç†é”™è¯¯
                try {
                    // æ‰¹é‡æ›´æ–°è¡¨æ ¼ï¼ˆåªæ˜¾ç¤ºæœ€å100æ¡ï¼Œå€’åºæ˜¾ç¤ºï¼‰
                    const tbodyAll = qs('#tbodyAll');
                    if (tbodyAll) {
                        // æ¸…ç©ºè¡¨æ ¼
                        tbodyAll.innerHTML = '';
                        // å–æœ€å100æ¡æ•°æ®ï¼Œå€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                        const startIdx = Math.max(0, result.data.length - MAX_ROWS);
                        for (let i = result.data.length - 1; i >= startIdx; i--) {
                            const msg = result.data[i];
                            if (msg && msg.type === 'reading') {
                                const rowData = [
                                    new Date(msg.ts * 1000).toLocaleString(),
                                    msg.temp?.toFixed(2) || '--',
                                    msg.hum?.toFixed(2) || '--',
                                    (msg.lux == null ? '--' : msg.lux.toFixed(1)),
                                    (msg.smoke == null ? '--' : msg.smoke.toFixed(1)),
                                    (msg.pressure == null ? '--' : msg.pressure.toFixed(1))
                                ];
                                const tr = document.createElement('tr');
                                rowData.forEach((v, idx) => {
                                    const td = document.createElement('td');
                                    td.textContent = v;
                                    if (idx > 0) td.classList.add('right');
                                    tr.appendChild(td);
                                });
                                tbodyAll.appendChild(tr);
                            }
                        }
                    }
                } catch (error) {
                    console.error('âš ï¸ è¡¨æ ¼æ›´æ–°æ—¶å‡ºé”™ï¼ˆä½†æ•°æ®å·²åŠ è½½ï¼‰:', error);
                    renderError = error;
                }

                // ç•Œé¢æ›´æ–°éƒ¨åˆ†å•ç‹¬å¤„ç†é”™è¯¯
                try {
                    // æ›´æ–°è®¡æ•°å™¨ï¼ˆæ˜¾ç¤ºå®é™…åŠ è½½çš„æ•°æ®é‡ï¼‰
                    const countSpan = qs('#count');
                    if (countSpan) countSpan.textContent = result.count;

                    // æ›´æ–°ç•Œé¢æ˜¾ç¤ºæœ€æ–°æ•°æ®
                    if (result.data.length > 0) {
                        const lastMsg = result.data[result.data.length - 1];
                        if (lastMsg && lastMsg.type === 'reading') {
                            if (tempVal) tempVal.textContent = lastMsg.temp?.toFixed(2) || '--';
                            if (humVal) humVal.textContent = lastMsg.hum?.toFixed(2) || '--';
                            if (luxVal) luxVal.textContent = (lastMsg.lux == null ? '--' : lastMsg.lux.toFixed(1));
                            if (smokeVal) smokeVal.textContent = (lastMsg.smoke == null ? '--' : lastMsg.smoke.toFixed(1));
                            if (pressureVal) pressureVal.textContent = (lastMsg.pressure == null ? '--' : lastMsg.pressure.toFixed(1));

                            // æ›´æ–°temp2æ˜¾ç¤ºå’Œæ¸©å·®
                            if (lastMsg.temp2 != null) {
                                if (temp2Display) temp2Display.textContent = `å¦ä¸€æ•°æ®æºï¼š${lastMsg.temp2.toFixed(2)}â„ƒ`;
                                if (tempDiffVal) {
                                    const diff = Math.abs((lastMsg.temp || 0) - lastMsg.temp2);
                                    tempDiffVal.textContent = diff.toFixed(2);
                                }
                            } else {
                                if (temp2Display) temp2Display.textContent = '';
                                if (tempDiffVal) tempDiffVal.textContent = '--';
                            }

                            // æ›´æ–°Rs/Roæ˜¾ç¤º
                            if (lastMsg.rs_ro != null) {
                                if (rsRoDisplay) rsRoDisplay.textContent = `Rs/Roï¼š${lastMsg.rs_ro.toFixed(2)}`;
                            } else {
                                if (rsRoDisplay) rsRoDisplay.textContent = '';
                            }

                            if (lastTs) lastTs.textContent = new Date(lastMsg.ts * 1000).toLocaleTimeString();
                            
                            // æ›´æ–°å¡ç‰‡çŠ¶æ€é¢œè‰²
                            try {
                                const lastDiff = (lastMsg.temp2 != null) ? Math.abs((lastMsg.temp || 0) - lastMsg.temp2) : null;
                                if (tempCard) updateCardStatus(tempCard, lastMsg.temp, 25, 30);
                                if (tempDiffCard) updateCardStatus(tempDiffCard, lastDiff, 1.5, 3);
                                if (humCard) updateHumidityStatus(humCard, lastMsg.hum);
                                if (luxCard) updateCardStatus(luxCard, lastMsg.lux, 200, 100, true);
                                if (smokeCard) updateCardStatus(smokeCard, lastMsg.smoke, 200, 500);
                                if (pressureCard) updatePressureStatus(pressureCard, lastMsg.pressure);

                                // æ›´æ–°è¶‹åŠ¿
                                const tS = tempsAll.slice(-N_TREND), hS = humsAll.slice(-N_TREND),
                                    lS = luxAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
                                    sS = smokeAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
                                    pS = pressureAll.slice(-N_TREND).filter(x => !Number.isNaN(x)),
                                    dS = tempDiffAll.slice(-N_TREND).filter(x => !Number.isNaN(x));
                                if (tempTrend) setTrend(tempTrend, delta(tS), 'Â°C');
                                if (humTrend) setTrend(humTrend, delta(hS), '%');
                                if (tempDiffTrend && dS.length >= 2) setTrend(tempDiffTrend, delta(dS), 'Â°C');
                                if (luxTrend && lS.length >= 2) setTrend(luxTrend, delta(lS), 'lx');
                                if (smokeTrend && sS.length >= 2) setTrend(smokeTrend, delta(sS), 'ppm');
                                if (pressureTrend && pS.length >= 2) setTrend(pressureTrend, delta(pS), 'hPa');
                            } catch (error) {
                                console.error('âš ï¸ æ›´æ–°å¡ç‰‡çŠ¶æ€æ—¶å‡ºé”™:', error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('âš ï¸ ç•Œé¢æ›´æ–°æ—¶å‡ºé”™ï¼ˆä½†æ•°æ®å·²åŠ è½½ï¼‰:', error);
                    renderError = error;
                }

                const renderTime = performance.now() - renderStart;
                console.log(`âœ… æ¸²æŸ“å®Œæˆ (è€—æ—¶ ${renderTime.toFixed(0)}ms)`);
                console.log(`âš¡ æ€»è€—æ—¶: ${(fetchTime + renderTime).toFixed(0)}ms`);

                historyLoaded = true;

                // è§£é™¤åŠ è½½æ ‡å¿—ï¼Œæ¢å¤æ¥æ”¶å®æ—¶æ•°æ®
                isLoadingHistory = false;
                console.log('ğŸ”“ å·²æ¢å¤æ¥æ”¶å®æ—¶æ•°æ®');

                // æ³¨æ„ï¼šåŠ è½½å®Œæˆé€šçŸ¥å·²åœ¨ common.js çš„ executeDataLoad å‡½æ•°ä¸­æ˜¾ç¤ºï¼Œè¿™é‡Œä¸å†é‡å¤æ˜¾ç¤º
                // å³ä½¿æ¸²æŸ“è¿‡ç¨‹ä¸­æœ‰é”™è¯¯ï¼Œæ•°æ®ä¹Ÿå·²ç»æˆåŠŸåŠ è½½
                if (renderError) {
                    console.warn('âš ï¸ æ•°æ®åŠ è½½æˆåŠŸï¼Œä½†æ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›é—®é¢˜:', renderError);
                }

                return result.count;
            } else {
                console.warn('âš ï¸ æš‚æ— å†å²æ•°æ®æˆ–æ•°æ®æ ¼å¼é”™è¯¯');
                console.log('è¿”å›ç»“æœ:', result);
                isLoadingHistory = false;
                showNotification('âš ï¸ æš‚æ— å†å²æ•°æ®');
                return 0;
            }
        } catch (error) {
            console.error('âŒ åŠ è½½å†å²æ•°æ®å¤±è´¥ï¼š', error);
            console.error('é”™è¯¯è¯¦æƒ…:', error.message);
            isLoadingHistory = false; // ç¡®ä¿è§£é™¤æ ‡å¿—
            showNotification('âŒ åŠ è½½å†å²æ•°æ®å¤±è´¥');
            return 0;
        }
    }

    // æ•°æ®åŠ è½½ç›¸å…³å‡½æ•°å·²ç§»è‡³ common.js
    // é¦–é¡µé€šè¿‡ initDataLoader é…ç½®å›è°ƒæ¥å¤„ç†æ•°æ®

    // æ•°æ®é‡è¿‡å¤§è­¦å‘Šç›¸å…³å‡½æ•°å·²ç§»è‡³ common.js

    // å¼¹çª—ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½å·²ç§»è‡³ common.js çš„ setupModalClickOutside å‡½æ•°

    // æ›´æ–°æ‰€æœ‰å›¾è¡¨
    function updateAllCharts() {
        try {
            // æ›´æ–°ä¸»å›¾è¡¨
            if (window.chartTH?.data) {
                window.chartTH.data.labels = labelsAll;
                if (window.chartTH.data.datasets?.[0]) window.chartTH.data.datasets[0].data = tempsAll;
                if (window.chartTH.data.datasets?.[1]) window.chartTH.data.datasets[1].data = humsAll;
                window.chartTH.update('none');
            }
            if (window.chartLUX?.data) {
                window.chartLUX.data.labels = labelsAll;
                if (window.chartLUX.data.datasets?.[0]) window.chartLUX.data.datasets[0].data = luxAll;
                window.chartLUX.update('none');
            }
            if (window.chartSMOKE?.data) {
                window.chartSMOKE.data.labels = labelsAll;
                if (window.chartSMOKE.data.datasets?.[0]) window.chartSMOKE.data.datasets[0].data = smokeAll;
                window.chartSMOKE.update('none');
            }
            if (window.chartPRESSURE?.data) {
                window.chartPRESSURE.data.labels = labelsAll;
                if (window.chartPRESSURE.data.datasets?.[0]) window.chartPRESSURE.data.datasets[0].data = pressureAll;
                window.chartPRESSURE.update('none');
            }

            // æ›´æ–°å…¨å±å›¾è¡¨
            if (window.chartTHFull?.data) {
                window.chartTHFull.data.labels = labelsAll;
                if (window.chartTHFull.data.datasets?.[0]) window.chartTHFull.data.datasets[0].data = tempsAll;
                if (window.chartTHFull.data.datasets?.[1]) window.chartTHFull.data.datasets[1].data = humsAll;
                window.chartTHFull.update('none');
            }
            if (window.chartLUXFull?.data) {
                window.chartLUXFull.data.labels = labelsAll;
                if (window.chartLUXFull.data.datasets?.[0]) window.chartLUXFull.data.datasets[0].data = luxAll;
                window.chartLUXFull.update('none');
            }
            if (window.chartSMOKEFull?.data) {
                window.chartSMOKEFull.data.labels = labelsAll;
                if (window.chartSMOKEFull.data.datasets?.[0]) window.chartSMOKEFull.data.datasets[0].data = smokeAll;
                window.chartSMOKEFull.update('none');
            }
            if (window.chartPRESSUREFull?.data) {
                window.chartPRESSUREFull.data.labels = labelsAll;
                if (window.chartPRESSUREFull.data.datasets?.[0]) window.chartPRESSUREFull.data.datasets[0].data = pressureAll;
                window.chartPRESSUREFull.update('none');
            }

            console.log('âœ… æ‰€æœ‰å›¾è¡¨å·²æ›´æ–°');
        } catch (error) {
            console.error('âŒ æ›´æ–°å›¾è¡¨æ—¶å‡ºé”™:', error);
            throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚æ•è·
        }
    }

    // åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨ï¼ˆä½¿ç”¨common.jsçš„ç»Ÿä¸€åŠ è½½ç³»ç»Ÿï¼‰
    initDataLoader({
        onDataLoaded: async function (data, count) {
            console.log(`ğŸ“Š æ•°æ®åŠ è½½å›è°ƒï¼šæ”¶åˆ° ${count} æ¡æ•°æ®`);
            // è°ƒç”¨é¦–é¡µçš„loadHistoryDataå¤„ç†æ•°æ®ï¼ˆä¼ å…¥é¢„åŠ è½½çš„æ•°æ®ï¼‰
            await loadHistoryData(count, true, null, data);
        }
    });

    // æ—§çš„loadAllHistoryå‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    async function loadAllHistory() {
        showLoadAllConfirm();
    }

    // ========== å®šä½åœ°å›¾åŠŸèƒ½ ==========
    let locationMap = null;
    let locationMarker = null;
    const AMAP_KEY = '3d4e023b04c6dad5e19b296d51949237';
    const AMAP_SECRET = '0d9b66b69634d78b34635d7aee1ce9d1';

    // åˆå§‹åŒ–åœ°å›¾
    function initLocationMap(lon, lat, locationData = null) {
        const mapContainer = qs('#locationMap');
        if (!mapContainer) {
            console.error('âŒ åœ°å›¾å®¹å™¨ä¸å­˜åœ¨');
            return;
        }

        // æ£€æŸ¥å®¹å™¨æ˜¯å¦å¯è§
        const containerParent = mapContainer.closest('#locationMapContainer');
        if (containerParent && containerParent.style.display === 'none') {
            containerParent.style.display = 'block';
        }

        // éªŒè¯ç»çº¬åº¦
        if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
            console.error('âŒ æ— æ•ˆçš„ç»çº¬åº¦:', lon, lat);
            if (typeof showNotification === 'function') {
                showNotification('âŒ ç»çº¬åº¦æ•°æ®æ— æ•ˆ', true);
            }
            return;
        }

        // å¦‚æœåœ°å›¾å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
        if (locationMap) {
            try {
                locationMap.destroy();
            } catch (e) {
                console.warn('é”€æ¯æ—§åœ°å›¾æ—¶å‡ºé”™:', e);
            }
            locationMap = null;
            locationMarker = null;
        }

        try {
            // åˆ›å»ºåœ°å›¾å®ä¾‹
            locationMap = new AMap.Map('locationMap', {
                zoom: 15,
                center: [lon, lat],
                viewMode: '3D',
                mapStyle: 'amap://styles/normal'
            });

            // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å›¾æ ‡ï¼ˆçº¢è‰²å¤§åœ†ç‚¹ï¼‰
            // ä½¿ç”¨Canvasåˆ›å»ºå›¾æ ‡ï¼Œé¿å…SVGç¼–ç é—®é¢˜
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶çº¢è‰²åœ†ç‚¹
            ctx.beginPath();
            ctx.arc(16, 16, 12, 0, Math.PI * 2);
            ctx.fillStyle = '#ef4444';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶ç™½è‰²å†…ç‚¹
            ctx.beginPath();
            ctx.arc(16, 16, 6, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
            
            const markerIcon = new AMap.Icon({
                size: new AMap.Size(32, 32),
                image: canvas.toDataURL(),
                imageOffset: new AMap.Pixel(0, 0),
                imageSize: new AMap.Size(32, 32)
            });

            // æ·»åŠ æ ‡è®°
            locationMarker = new AMap.Marker({
                position: [lon, lat],
                title: 'è®¾å¤‡ä½ç½®',
                icon: markerIcon,
                zIndex: 1000,
                animation: 'AMAP_ANIMATION_DROP'  // æ·»åŠ è½ç‚¹åŠ¨ç”»
            });
            locationMap.add(locationMarker);

            // æ„å»ºä¿¡æ¯çª—ä½“å†…å®¹
            let infoContent = `<div style="padding: 12px; min-width: 200px;">
                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #333;">ğŸ“ è®¾å¤‡ä½ç½®</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ç»åº¦: <strong style="color: #333;">${lon.toFixed(6)}</strong></div>
                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">çº¬åº¦: <strong style="color: #333;">${lat.toFixed(6)}</strong></div>`;
            
            if (locationData) {
                if (locationData.utc) {
                    try {
                        const dateStr = new Date(locationData.utc).toLocaleString('zh-CN');
                        infoContent += `<div style="font-size: 12px; color: #999; margin-top: 6px;">æ—¶é—´: ${dateStr}</div>`;
                    } catch (e) {
                        infoContent += `<div style="font-size: 12px; color: #999; margin-top: 6px;">æ—¶é—´: ${locationData.utc}</div>`;
                    }
                }
                if (locationData.csq !== null && locationData.csq !== undefined) {
                    infoContent += `<div style="font-size: 12px; color: #999;">ä¿¡å·å¼ºåº¦: ${locationData.csq}</div>`;
                }
            }
            infoContent += '</div>';

            // æ·»åŠ ä¿¡æ¯çª—ä½“ï¼ˆæ˜¾ç¤ºåæ ‡ä¿¡æ¯ï¼‰
            const infoWindow = new AMap.InfoWindow({
                content: infoContent,
                offset: new AMap.Pixel(0, -40),
                closeWhenClickMap: true
            });

            // æ ‡è®°ç‚¹å‡»äº‹ä»¶
            locationMarker.on('click', () => {
                infoWindow.open(locationMap, locationMarker.getPosition());
            });

            // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—ä½“æ˜¾ç¤ºåæ ‡
            setTimeout(() => {
                infoWindow.open(locationMap, locationMarker.getPosition());
            }, 500);

            // è®¾ç½®åœ°å›¾è‡ªé€‚åº”ï¼Œç¡®ä¿æ ‡è®°åœ¨è§†é‡å†…
            locationMap.setFitView([locationMarker], false, [50, 50, 50, 50]);

            console.log('âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼Œå·²æ ‡è®°åæ ‡ç‚¹');
        } catch (error) {
            console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
            if (typeof showNotification === 'function') {
                showNotification('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé«˜å¾·åœ°å›¾APIé…ç½®', true);
            } else {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    }

    // æ›´æ–°åœ°å›¾ä½ç½®
    function updateLocationMap(lon, lat, locationData = null) {
        if (!locationMap || !locationMarker) {
            initLocationMap(lon, lat, locationData);
            return;
        }

        try {
            const position = [lon, lat];
            locationMarker.setPosition(position);
            locationMap.setCenter(position);
            locationMap.setFitView([locationMarker], false, [50, 50, 50, 50]);
            
            // æ›´æ–°ä¿¡æ¯çª—ä½“å†…å®¹
            let infoContent = `<div style="padding: 12px; min-width: 200px;">
                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #333;">ğŸ“ è®¾å¤‡ä½ç½®</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ç»åº¦: <strong style="color: #333;">${lon.toFixed(6)}</strong></div>
                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">çº¬åº¦: <strong style="color: #333;">${lat.toFixed(6)}</strong></div>`;
            
            if (locationData) {
                if (locationData.utc) {
                    try {
                        const dateStr = new Date(locationData.utc).toLocaleString('zh-CN');
                        infoContent += `<div style="font-size: 12px; color: #999; margin-top: 6px;">æ—¶é—´: ${dateStr}</div>`;
                    } catch (e) {
                        infoContent += `<div style="font-size: 12px; color: #999; margin-top: 6px;">æ—¶é—´: ${locationData.utc}</div>`;
                    }
                }
                if (locationData.csq !== null && locationData.csq !== undefined) {
                    infoContent += `<div style="font-size: 12px; color: #999;">ä¿¡å·å¼ºåº¦: ${locationData.csq}</div>`;
                }
            }
            infoContent += '</div>';
            
            // åˆ›å»ºæ–°çš„ä¿¡æ¯çª—ä½“
            const infoWindow = new AMap.InfoWindow({
                content: infoContent,
                offset: new AMap.Pixel(0, -40),
                closeWhenClickMap: true
            });
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œæ·»åŠ æ–°çš„
            locationMarker.off('click');
            locationMarker.on('click', () => {
                infoWindow.open(locationMap, locationMarker.getPosition());
            });
            
            // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—ä½“
            setTimeout(() => {
                infoWindow.open(locationMap, locationMarker.getPosition());
            }, 300);
            
            console.log('âœ… åœ°å›¾ä½ç½®å·²æ›´æ–°ï¼Œåæ ‡ç‚¹å·²æ ‡è®°');
        } catch (error) {
            console.error('âŒ æ›´æ–°åœ°å›¾ä½ç½®å¤±è´¥:', error);
        }
    }

    // å¤„ç†å®šä½æ•°æ®
    function handleLocationData(msg) {
        console.log('ğŸ“ æ”¶åˆ°å®šä½æ•°æ®:', msg);
        
        if (msg.lon && msg.lat) {
            const lon = parseFloat(msg.lon);
            const lat = parseFloat(msg.lat);
            
            // éªŒè¯ç»çº¬åº¦æ˜¯å¦æœ‰æ•ˆ
            if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                console.error('âŒ æ— æ•ˆçš„ç»çº¬åº¦:', lon, lat);
                if (typeof showNotification === 'function') {
                    showNotification('âŒ æ”¶åˆ°çš„å®šä½æ•°æ®æ— æ•ˆ', true);
                }
                return;
            }
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            const locationLon = qs('#locationLon');
            const locationLat = qs('#locationLat');
            const locationCoords = qs('#locationCoords');
            const locationStatusText = qs('#locationStatusText');
            const locationExtra = qs('#locationExtra');
            
            if (locationLon) locationLon.textContent = lon.toFixed(6);
            if (locationLat) locationLat.textContent = lat.toFixed(6);
            if (locationCoords) locationCoords.style.display = 'block';
            if (locationStatusText) {
                locationStatusText.textContent = 'å®šä½æˆåŠŸ';
                locationStatusText.style.color = 'var(--good)';
            }
            
            // æ˜¾ç¤ºé¢å¤–ä¿¡æ¯
            if (locationExtra) {
                let extraInfo = [];
                if (msg.utc) {
                    try {
                        const dateStr = new Date(msg.utc).toLocaleString('zh-CN');
                        extraInfo.push(`æ—¶é—´: ${dateStr}`);
                    } catch (e) {
                        extraInfo.push(`æ—¶é—´: ${msg.utc}`);
                    }
                }
                if (msg.csq !== null && msg.csq !== undefined) {
                    extraInfo.push(`ä¿¡å·å¼ºåº¦: ${msg.csq}`);
                }
                if (extraInfo.length > 0) {
                    locationExtra.textContent = extraInfo.join(' | ');
                    locationExtra.style.display = 'block';
                }
            }
            
            // è‡ªåŠ¨æ˜¾ç¤ºåœ°å›¾ï¼ˆç›´ä¸Šç›´ä¸‹å±•å¼€ï¼‰
            const mapContainer = qs('#locationMapContainer');
            const toggleMapBtn = qs('#toggleLocationMapBtn');
            
            if (mapContainer) {
                // æ˜¾ç¤ºåœ°å›¾å®¹å™¨ï¼ˆä½¿ç”¨max-heightåŠ¨ç”»ï¼Œç›´ä¸Šç›´ä¸‹ï¼‰
                mapContainer.style.visibility = 'visible';
                mapContainer.style.opacity = '1';
                mapContainer.style.maxHeight = '300px';
                
                // åˆå§‹åŒ–åœ°å›¾
                setTimeout(() => {
                    updateLocationMap(lon, lat, msg);
                }, 100);
            }
            
            // æ›´æ–°"æ˜¾ç¤ºåœ°å›¾"æŒ‰é’®æ–‡æœ¬
            if (toggleMapBtn) {
                toggleMapBtn.style.display = 'block';
                toggleMapBtn.textContent = 'ğŸ—ºï¸ éšè—åœ°å›¾';
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const queryBtn = qs('#queryLocationBtn');
            if (queryBtn) {
                queryBtn.textContent = 'ğŸ”„ é‡æ–°è·å–';
                queryBtn.disabled = false;
            }
            
            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
            if (typeof showNotification === 'function') {
                showNotification('âœ… å®šä½è·å–æˆåŠŸ', false);
            }
        } else {
            console.error('âŒ å®šä½æ•°æ®ç¼ºå°‘ç»çº¬åº¦:', msg);
            if (typeof showNotification === 'function') {
                showNotification('âŒ å®šä½æ•°æ®æ ¼å¼é”™è¯¯', true);
            }
        }
    }

    // æŸ¥è¯¢å®šä½
    async function queryLocation() {
        const queryBtn = qs('#queryLocationBtn');
        if (!queryBtn) return;

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        queryBtn.disabled = true;
        queryBtn.textContent = 'â³ æ­£åœ¨è·å–å®šä½...';

        try {
            const response = await fetch('/api/location/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                console.log('âœ… å®šä½æŸ¥è¯¢å‘½ä»¤å·²å‘é€:', result);
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const locationStatusText = qs('#locationStatusText');
                if (locationStatusText) {
                    locationStatusText.textContent = 'æ­£åœ¨è·å–å®šä½...';
                    locationStatusText.style.color = 'var(--warn)';
                }
                
                // æ³¨æ„ï¼šå®é™…çš„å®šä½æ•°æ®ä¼šé€šè¿‡WebSocketæ¨é€å›æ¥
                // è¿™é‡Œä¸ç›´æ¥æ›´æ–°æŒ‰é’®ï¼Œç­‰å¾…WebSocketæ¶ˆæ¯
                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ30ç§’å†…æ²¡æœ‰æ”¶åˆ°å®šä½æ•°æ®ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    if (queryBtn.disabled && queryBtn.textContent.includes('æ­£åœ¨è·å–å®šä½')) {
                        queryBtn.disabled = false;
                        queryBtn.textContent = 'ğŸ“ è·å–å®šä½';
                        if (locationStatusText) {
                            locationStatusText.textContent = 'è·å–è¶…æ—¶';
                            locationStatusText.style.color = 'var(--bad)';
                        }
                        if (typeof showNotification === 'function') {
                            showNotification('â° å®šä½æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•', true);
                        }
                    }
                }, 30000);
            } else {
                console.error('âŒ å®šä½æŸ¥è¯¢å¤±è´¥:', result.error);
                if (typeof showNotification === 'function') {
                    showNotification('âŒ å®šä½æŸ¥è¯¢å¤±è´¥: ' + (result.message || result.error), true);
                } else {
                    console.error('å®šä½æŸ¥è¯¢å¤±è´¥:', result);
                }
                queryBtn.disabled = false;
                queryBtn.textContent = 'ğŸ“ è·å–å®šä½';
                const locationStatusText = qs('#locationStatusText');
                if (locationStatusText) {
                    locationStatusText.textContent = 'è·å–å¤±è´¥';
                    locationStatusText.style.color = 'var(--bad)';
                }
            }
        } catch (error) {
            console.error('âŒ å®šä½æŸ¥è¯¢è¯·æ±‚å¤±è´¥:', error);
            if (typeof showNotification === 'function') {
                showNotification('âŒ å®šä½æŸ¥è¯¢è¯·æ±‚å¤±è´¥: ' + error.message, true);
            } else {
                console.error('å®šä½æŸ¥è¯¢è¯·æ±‚å¤±è´¥:', error);
            }
            queryBtn.disabled = false;
            queryBtn.textContent = 'ğŸ“ è·å–å®šä½';
            const locationStatusText = qs('#locationStatusText');
            if (locationStatusText) {
                locationStatusText.textContent = 'è¯·æ±‚å¤±è´¥';
                locationStatusText.style.color = 'var(--bad)';
            }
        }
    }

    // åˆ‡æ¢åœ°å›¾æ˜¾ç¤º/éšè—
    function toggleLocationMap() {
        const mapContainer = qs('#locationMapContainer');
        const toggleBtn = qs('#toggleLocationMapBtn');
        const locationLon = qs('#locationLon');
        const locationLat = qs('#locationLat');
        
        if (!mapContainer) return;
        
        // æ£€æŸ¥å½“å‰æ˜¯å¦å±•å¼€ï¼ˆé€šè¿‡max-heightåˆ¤æ–­ï¼‰
        const isExpanded = mapContainer.style.maxHeight && mapContainer.style.maxHeight !== '0px' && mapContainer.style.maxHeight !== '';
        
        if (!isExpanded) {
            // æ˜¾ç¤ºåœ°å›¾ï¼ˆç›´ä¸Šç›´ä¸‹å±•å¼€ï¼‰
            mapContainer.style.visibility = 'visible';
            mapContainer.style.opacity = '1';
            mapContainer.style.maxHeight = '300px';
            
            if (toggleBtn) toggleBtn.textContent = 'ğŸ—ºï¸ éšè—åœ°å›¾';
            
            // å¦‚æœæœ‰åæ ‡æ•°æ®ï¼Œåˆå§‹åŒ–åœ°å›¾
            if (locationLon && locationLat && locationLon.textContent !== '--' && locationLat.textContent !== '--') {
                const lon = parseFloat(locationLon.textContent);
                const lat = parseFloat(locationLat.textContent);
                if (!isNaN(lon) && !isNaN(lat)) {
                    setTimeout(() => {
                        updateLocationMap(lon, lat);
                    }, 100);
                }
            }
        } else {
            // éšè—åœ°å›¾ï¼ˆç›´ä¸Šç›´ä¸‹æ”¶èµ·ï¼‰
            mapContainer.style.maxHeight = '0';
            mapContainer.style.opacity = '0';
            setTimeout(() => {
                mapContainer.style.visibility = 'hidden';
            }, 400); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            if (toggleBtn) toggleBtn.textContent = 'ğŸ—ºï¸ æ˜¾ç¤ºåœ°å›¾';
        }
    }

    // ç»‘å®šå®šä½ç›¸å…³äº‹ä»¶
    const queryLocationBtn = qs('#queryLocationBtn');
    if (queryLocationBtn) {
        queryLocationBtn.addEventListener('click', queryLocation);
    }

    const toggleLocationMapBtn = qs('#toggleLocationMapBtn');
    if (toggleLocationMapBtn) {
        toggleLocationMapBtn.addEventListener('click', toggleLocationMap);
    }

    const closeLocationMapBtn = qs('#closeLocationMap');
    if (closeLocationMapBtn) {
        closeLocationMapBtn.addEventListener('click', () => {
            toggleLocationMap();
        });
    }

    function connect() {
        setWsStatus(false);
        const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
        wsock = new WebSocket(url);
        wsock.onopen = () => {
            setWsStatus(true);
            updateConnectionStatus(); // è¿æ¥æˆåŠŸåç«‹å³æ›´æ–°çŠ¶æ€
        };
        wsock.onclose = () => {
            setWsStatus(false);
            updateConnectionStatus(); // æ–­å¼€è¿æ¥åæ›´æ–°çŠ¶æ€
            setTimeout(connect, 1500);
        };
        wsock.onmessage = e => {
            try {
                const msg = JSON.parse(e.data);
                
                // å¤„ç†è­¦å‘Šé€šçŸ¥
                if (msg.type === 'warning') {
                    if (window.MessageCenter) {
                        window.MessageCenter.handleWarningMessage(msg);
                    }
                    return;
                }
                
                // å¤„ç†æ¢å¤é€šçŸ¥
                if (msg.type === 'warning_resolved') {
                    if (window.MessageCenter) {
                        window.MessageCenter.handleResolvedMessage(msg);
                    }
                    return;
                }
                
                // å¤„ç†å®šä½æ•°æ®
                if (msg.type === 'location') {
                    handleLocationData(msg);
                    return;
                }
                
                // å¦‚æœæ­£åœ¨åŠ è½½å†å²æ•°æ®ï¼Œæš‚æ—¶å¿½ç•¥å®æ—¶æ•°æ®
                if (isLoadingHistory) {
                    console.log('â¸ï¸ æ­£åœ¨åŠ è½½å†å²æ•°æ®ï¼Œæš‚æ—¶è·³è¿‡å®æ—¶æ•°æ®');
                    return;
                }
                if (msg.type === 'reading') addRow(msg.ts, msg.temp, msg.hum, msg.lux, msg.smoke, msg.pressure, msg.temp2, msg.rs_ro);
            } catch {
            }
        };
    }
    
    // ========== è¿æ¥çŠ¶æ€å¼¹çª—ç›¸å…³ ==========
    const statusPopup = document.getElementById('statusPopup');
    const wsStatusBadge = document.getElementById('wsStatusBadge');
    const statusPopupClose = document.getElementById('statusPopupClose');
    const wsStatusDetail = document.getElementById('wsStatusDetail');
    const bleStatusDetail = document.getElementById('bleStatusDetail');
    const mqttStatusDetail = document.getElementById('mqttStatusDetail');
    const bleStatusDesc = document.getElementById('bleStatusDesc');
    const mqttStatusDesc = document.getElementById('mqttStatusDesc');
    
    let statusUpdateInterval = null;
    
    // åŠ¨æ€è°ƒæ•´å¼¹çª—ä½ç½®ï¼Œç¡®ä¿åœ¨å±å¹•å†…å¯è§
    function adjustPopupPosition() {
        const badgeRect = wsStatusBadge.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        const isMobile = viewportWidth <= 768;
        const spaceBelow = viewportHeight - badgeRect.bottom;
        const spaceAbove = badgeRect.top;
        
        // å…ˆè®¾ç½®é»˜è®¤å‘ä¸‹å¼¹å‡ºï¼Œä»¥ä¾¿æµ‹é‡å°ºå¯¸
        statusPopup.classList.remove('popup-up');
        statusPopup.classList.add('popup-down');
        
        // ç­‰å¾…ä¸€å¸§ï¼Œè®©æµè§ˆå™¨æ¸²æŸ“å¹¶æµ‹é‡å®é™…å°ºå¯¸
        requestAnimationFrame(() => {
            const popupRect = statusPopup.getBoundingClientRect();
            let popupHeight = popupRect.height;
            let popupWidth = popupRect.width;
            
            // è®¡ç®—éœ€è¦çš„ç©ºé—´ï¼ˆå¼¹çª—é«˜åº¦ + æŒ‰é’®é—´è· + å®‰å…¨è¾¹è·ï¼‰
            const requiredSpace = popupHeight + 8 + 20; // 8pxé—´è· + 20pxå®‰å…¨è¾¹è·
            
            // åˆ¤æ–­ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            const canFitBelow = spaceBelow >= requiredSpace;
            const canFitAbove = spaceAbove >= requiredSpace;
            
            // ç§»åŠ¨ç«¯ï¼šæ ¹æ®æŒ‰é’®ä½ç½®åŠ¨æ€å®šä½ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
            if (isMobile) {
                // è®¡ç®—å¼¹çª—åº”è¯¥çš„leftä½ç½®ï¼ˆè®©å¼¹çª—è·ŸéšæŒ‰é’®ï¼Œä½†ä¸è¶…å‡ºå±å¹•ï¼‰
                const badgeCenterX = badgeRect.left + badgeRect.width / 2;
                let popupLeft = badgeCenterX - popupWidth / 2; // å…ˆå°è¯•å±…ä¸­å¯¹é½æŒ‰é’®
                
                // ç¡®ä¿å¼¹çª—ä¸è¶…å‡ºå±å¹•å·¦ä¾§
                const minLeft = 10;
                if (popupLeft < minLeft) {
                    popupLeft = minLeft;
                }
                
                // ç¡®ä¿å¼¹çª—ä¸è¶…å‡ºå±å¹•å³ä¾§
                const maxRight = viewportWidth - 10;
                if (popupLeft + popupWidth > maxRight) {
                    popupLeft = maxRight - popupWidth;
                }
                
                // è®¾ç½®å¼¹çª—ä½ç½®
                statusPopup.style.left = popupLeft + 'px';
                statusPopup.style.right = 'auto';
                
                // è®¡ç®—ç®­å¤´ä½ç½®ï¼ˆæŒ‡å‘æŒ‰é’®ä¸­å¿ƒï¼‰
                const arrowOffset = badgeCenterX - popupLeft;
                const arrowLeft = Math.max(10, Math.min(arrowOffset, popupWidth - 10)); // é™åˆ¶åœ¨10pxåˆ°popupWidth-10pxä¹‹é—´
                
                // è®¾ç½®ç®­å¤´ä½ç½®
                const arrowElement = window.getComputedStyle(statusPopup, '::before');
                statusPopup.style.setProperty('--arrow-left', arrowLeft + 'px');
                
                // å¦‚æœå‘ä¸‹å¼¹å‡ºç©ºé—´ä¸è¶³
                if (!canFitBelow) {
                    if (canFitAbove && spaceAbove > spaceBelow) {
                        // å‘ä¸Šå¼¹å‡ºæœ‰è¶³å¤Ÿç©ºé—´ï¼Œåˆ‡æ¢æ–¹å‘
                        statusPopup.classList.remove('popup-down');
                        statusPopup.classList.add('popup-up');
                        statusPopup.style.maxHeight = '';
                        statusPopup.style.top = '';
                        statusPopup.style.bottom = '';
                    } else {
                        // ä¸Šä¸‹ç©ºé—´éƒ½ä¸è¶³ï¼Œä¿æŒåœ¨ä¸‹æ–¹ä½†é™åˆ¶é«˜åº¦
                        statusPopup.classList.remove('popup-up');
                        statusPopup.classList.add('popup-down');
                        const maxAvailableHeight = Math.max(200, spaceBelow - 28);
                        statusPopup.style.maxHeight = maxAvailableHeight + 'px';
                    }
                } else {
                    // ç©ºé—´è¶³å¤Ÿï¼Œå‘ä¸‹å¼¹å‡ºå¹¶é‡ç½®æ ·å¼
                    statusPopup.classList.remove('popup-up');
                    statusPopup.classList.add('popup-down');
                    statusPopup.style.maxHeight = '';
                    statusPopup.style.top = '';
                    statusPopup.style.bottom = '';
                }
                
                // åŠ¨æ€è®¾ç½®ç®­å¤´ä½ç½®ï¼ˆé€šè¿‡CSSå˜é‡ï¼‰
                const arrowStyle = document.createElement('style');
                arrowStyle.id = 'status-popup-arrow-style';
                const existingStyle = document.getElementById('status-popup-arrow-style');
                if (existingStyle) existingStyle.remove();
                arrowStyle.textContent = `
                    @media (max-width: 768px) {
                        .status-popup.popup-down::before,
                        .status-popup.popup-up::before {
                            left: var(--arrow-left, 20px) !important;
                        }
                    }
                `;
                document.head.appendChild(arrowStyle);
                
                // æ›´æ–°ç®­å¤´ä½ç½®
                statusPopup.style.setProperty('--arrow-left', arrowLeft + 'px');
            } else {
                // æ¡Œé¢ç«¯ï¼šä¿æŒå±…ä¸­
                statusPopup.style.left = '';
                statusPopup.style.right = '';
                
                // å¦‚æœå‘ä¸‹å¼¹å‡ºç©ºé—´ä¸è¶³
                if (!canFitBelow) {
                    if (canFitAbove && spaceAbove > spaceBelow) {
                        statusPopup.classList.remove('popup-down');
                        statusPopup.classList.add('popup-up');
                        statusPopup.style.maxHeight = '';
                        statusPopup.style.top = '';
                        statusPopup.style.bottom = '';
                    } else {
                        statusPopup.classList.remove('popup-up');
                        statusPopup.classList.add('popup-down');
                        const maxAvailableHeight = Math.max(200, spaceBelow - 28);
                        statusPopup.style.maxHeight = maxAvailableHeight + 'px';
                    }
                } else {
                    statusPopup.classList.remove('popup-up');
                    statusPopup.classList.add('popup-down');
                    statusPopup.style.maxHeight = '';
                    statusPopup.style.top = '';
                    statusPopup.style.bottom = '';
                }
            }
            
            // äºŒæ¬¡æ£€æŸ¥ï¼šç¡®ä¿å¼¹çª—å®é™…ä½ç½®ä¸ä¼šè¶…å‡ºå±å¹•
            requestAnimationFrame(() => {
                const finalRect = statusPopup.getBoundingClientRect();
                const padding = 10;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•åº•éƒ¨
                if (finalRect.bottom > viewportHeight - padding) {
                    const overflow = finalRect.bottom - (viewportHeight - padding);
                    const currentMaxHeight = statusPopup.style.maxHeight || window.getComputedStyle(statusPopup).maxHeight;
                    const newMaxHeight = Math.max(200, parseFloat(currentMaxHeight) - overflow) + 'px';
                    statusPopup.style.maxHeight = newMaxHeight;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•é¡¶éƒ¨
                if (finalRect.top < padding) {
                    const overflow = padding - finalRect.top;
                    const currentMaxHeight = statusPopup.style.maxHeight || window.getComputedStyle(statusPopup).maxHeight;
                    const newMaxHeight = Math.max(200, parseFloat(currentMaxHeight) - overflow) + 'px';
                    statusPopup.style.maxHeight = newMaxHeight;
                }
                
                // ç§»åŠ¨ç«¯ï¼šå†æ¬¡æ£€æŸ¥å·¦å³è¾¹ç•Œï¼Œå¹¶é‡æ–°è®¡ç®—ç®­å¤´ä½ç½®
                if (isMobile) {
                    const currentWidth = finalRect.width;
                    let adjusted = false;
                    let newPopupLeft = parseFloat(statusPopup.style.left);
                    
                    if (finalRect.right > viewportWidth - padding) {
                        newPopupLeft = viewportWidth - currentWidth - padding;
                        statusPopup.style.left = newPopupLeft + 'px';
                        adjusted = true;
                    }
                    if (finalRect.left < padding) {
                        newPopupLeft = padding;
                        statusPopup.style.left = newPopupLeft + 'px';
                        adjusted = true;
                    }
                    
                    // å¦‚æœä½ç½®è¢«è°ƒæ•´äº†ï¼Œé‡æ–°è®¡ç®—ç®­å¤´ä½ç½®
                    if (adjusted) {
                        const badgeCenterX = badgeRect.left + badgeRect.width / 2;
                        const arrowOffset = badgeCenterX - newPopupLeft;
                        const arrowLeft = Math.max(10, Math.min(arrowOffset, currentWidth - 10));
                        statusPopup.style.setProperty('--arrow-left', arrowLeft + 'px');
                    }
                }
            });
        });
    }
    
    // ç‚¹å‡»çŠ¶æ€å¾½ç« æ˜¾ç¤ºå¼¹çª—
    wsStatusBadge.addEventListener('click', (e) => {
        e.stopPropagation();
        statusPopup.classList.toggle('show');
        
        if (statusPopup.classList.contains('show')) {
            // åŠ¨æ€è°ƒæ•´ä½ç½®
            adjustPopupPosition();
            
            updateConnectionStatus(); // æ‰“å¼€æ—¶ç«‹å³æ›´æ–°ä¸€æ¬¡
            // å¼€å§‹å®šæœŸæ›´æ–°ï¼ˆæ¯3ç§’ï¼‰
            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            statusUpdateInterval = setInterval(updateConnectionStatus, 3000);
        } else {
            // å…³é—­æ—¶åœæ­¢å®šæœŸæ›´æ–°
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }
    });
    
    // ç‚¹å‡»å…³é—­æŒ‰é’®
    statusPopupClose.addEventListener('click', () => {
        statusPopup.classList.remove('show');
        if (statusUpdateInterval) {
            clearInterval(statusUpdateInterval);
            statusUpdateInterval = null;
        }
    });
    
    // é˜»æ­¢å¼¹çª—å†…éƒ¨ç‚¹å‡»å†’æ³¡
    statusPopup.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
        if (statusPopup.classList.contains('show') && 
            !statusPopup.contains(e.target) && 
            !wsStatusBadge.contains(e.target)) {
            statusPopup.classList.remove('show');
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }
    });
    
    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
    async function updateConnectionStatus() {
        try {
            // æ›´æ–° WebSocket çŠ¶æ€
            const wsConnected = wsock && wsock.readyState === WebSocket.OPEN;
            updateStatusBadge(wsStatusDetail, wsConnected, wsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
            
            // ä»åç«¯è·å–è“ç‰™å’ŒMQTTçŠ¶æ€
            const response = await fetch('/api/status');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // æ›´æ–°è“ç‰™çŠ¶æ€
                    const bleConnected = data.ble?.connected || false;
                    updateStatusBadge(bleStatusDetail, bleConnected, bleConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
                    
                    // æ›´æ–°è“ç‰™æè¿°ï¼ˆæ ¹æ®åç«¯è¿”å›çš„descriptionï¼‰
                    if (data.ble?.description && bleStatusDesc) {
                        bleStatusDesc.textContent = data.ble.description;
                    }
                    
                    // æ›´æ–°MQTTçŠ¶æ€
                    const mqttConnected = data.mqtt?.connected || false;
                    updateStatusBadge(mqttStatusDetail, mqttConnected, mqttConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
                    
                    // æ›´æ–°MQTTæè¿°ï¼ˆæ ¹æ®åç«¯è¿”å›çš„descriptionï¼‰
                    if (data.mqtt?.description && mqttStatusDesc) {
                        mqttStatusDesc.textContent = data.mqtt.description;
                    }
                }
            }
        } catch (error) {
            console.error('æ›´æ–°è¿æ¥çŠ¶æ€å¤±è´¥:', error);
        }
    }
    
    // æ›´æ–°çŠ¶æ€å¾½ç« æ˜¾ç¤º
    function updateStatusBadge(element, isConnected, text) {
        if (!element) return;
        
        element.classList.remove('connected', 'disconnected');
        element.classList.add(isConnected ? 'connected' : 'disconnected');
        
        const textSpan = element.querySelector('span:last-child');
        if (textSpan) {
            textSpan.textContent = text;
        }
    }

    // â€”â€” åŠå…¨å±å¼¹çª—äº¤äº’ â€”â€”
    function openOverlay() {
        if (!overlay) return;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
    }

    function closeOverlay() {
        if (!overlay) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
    }

    function openOverlayLux() {
        if (!overlayLux) return;
        overlayLux.classList.add('show');
        overlayLux.setAttribute('aria-hidden', 'false');
    }

    function closeOverlayLux() {
        if (!overlayLux) return;
        overlayLux.classList.remove('show');
        overlayLux.setAttribute('aria-hidden', 'true');
    }

    function openOverlaySmoke() {
        if (!overlaySmoke) return;
        overlaySmoke.classList.add('show');
        overlaySmoke.setAttribute('aria-hidden', 'false');
    }

    function closeOverlaySmoke() {
        if (!overlaySmoke) return;
        overlaySmoke.classList.remove('show');
        overlaySmoke.setAttribute('aria-hidden', 'true');
    }

    function openOverlayPressure() {
        if (!overlayPressure) return;
        overlayPressure.classList.add('show');
        overlayPressure.setAttribute('aria-hidden', 'false');
    }

    function closeOverlayPressure() {
        if (!overlayPressure) return;
        overlayPressure.classList.remove('show');
        overlayPressure.setAttribute('aria-hidden', 'true');
    }

    const openBtn = qs('#openFullChart');
    if (openBtn) openBtn.addEventListener('click', () => {
        openOverlay();
        // æ‡’åˆ›å»ºæ”¾å¤§å›¾
        if (!chartTHFull && chartTH && chartTH.data) {
            const ctx = chartTHFullCanvas()?.getContext('2d');
            if (ctx) {
                const data = {
                    labels: labelsFull,
                    datasets: [
                        {
                            label: 'æ¸©åº¦1 (Â°C)',
                            data: tempsFull,
                            yAxisID: 'y',
                            borderColor: css('--chart-line-temp-warm'),
                            pointHoverBorderColor: css('--chart-line-temp-warm')
                        },
                        {
                            label: 'æ¸©åº¦2 (Â°C)',
                            data: temps2Full,
                            yAxisID: 'y',
                            borderColor: css('--chart-line-temp-cold'),
                            pointHoverBorderColor: css('--chart-line-temp-cold')
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: humsFull,
                            yAxisID: 'y1',
                            borderColor: css('--chart-line-hum'),
                            pointHoverBorderColor: css('--chart-line-hum')
                        }
                    ]
                };
                const opts = makeBaseOptions();
                // å…¨å±å›¾å…è®¸æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ã€æ»šè½®/åŒæŒ‡ç¼©æ”¾ï¼‰
                if (opts?.plugins?.zoom?.pan) {
                    opts.plugins.zoom.pan.enabled = true;
                }
                chartTHFull = new Chart(ctx, {type: 'line', data, options: opts});
                // ç»‘å®šå…œåº•çš„æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»ä¸æŠ“æ‰‹æ ·å¼
                try {
                    const c = chartTHFull.canvas;
                    if (c) {
                        c.style.cursor = 'grab';
                        c.addEventListener('mousedown', () => {
                            c.style.cursor = 'grabbing';
                        });
                        window.addEventListener('mouseup', () => {
                            c.style.cursor = 'grab';
                        });
                    }
                } catch (e) {
                }
                enableManualDragPan(chartTHFullCanvas(), chartTHFull);
            }
        }
        // åˆå¼€æ—¶åŒæ­¥é¢œè‰²
        setTimeout(() => window.updateChartColors?.(), 50);
    });

    const closeBtn = qs('#closeOverlay');
    if (closeBtn) closeBtn.addEventListener('click', closeOverlay);
    if (overlay) overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeOverlay();
    });

    // å¼¹çª—æŒ‰é’®æ“ä½œæ”¾å¤§å›¾
    qs('#zoomInFull')?.addEventListener('click', () => chartTHFull?.zoom(1.2));
    qs('#zoomOutFull')?.addEventListener('click', () => chartTHFull?.zoom(0.8));
    qs('#panLeftFull')?.addEventListener('click', () => chartTHFull?.pan({x: 120}));
    qs('#panRightFull')?.addEventListener('click', () => chartTHFull?.pan({x: -120}));
    qs('#resetFull')?.addEventListener('click', () => chartTHFull && hardReset(chartTHFull));

    // äº®åº¦å…¨å±é€»è¾‘
    const openBtnLux = qs('#openFullLux');
    if (openBtnLux) openBtnLux.addEventListener('click', () => {
        openOverlayLux();
        if (!chartLUXFull && chartLUX && chartLUX.data) {
            const ctx = chartLUXFullCanvas()?.getContext('2d');
            if (ctx) {
                const data = {
                    labels: labelsLuxFull,
                    datasets: [
                        {
                            label: 'äº®åº¦ (lx)',
                            data: luxFull,
                            yAxisID: 'y',
                            borderColor: css('--chart-line-lux'),
                            pointHoverBorderColor: css('--chart-line-lux')
                        }
                    ]
                };
                const opts = makeBaseOptions();
                // å…¨å±å›¾å…è®¸æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰
                if (opts?.plugins?.zoom?.pan) {
                    opts.plugins.zoom.pan.enabled = true;
                }
                chartLUXFull = new Chart(ctx, {type: 'line', data, options: opts});
                try {
                    const c = chartLUXFull.canvas;
                    if (c) {
                        c.style.cursor = 'grab';
                        c.addEventListener('mousedown', () => {
                            c.style.cursor = 'grabbing';
                        });
                        window.addEventListener('mouseup', () => {
                            c.style.cursor = 'grab';
                        });
                    }
                } catch (e) {
                }
                enableManualDragPan(chartLUXFullCanvas(), chartLUXFull);
            }
        }
        setTimeout(() => window.updateChartColors?.(), 50);
    });

    const closeBtnLux = qs('#closeOverlayLux');
    if (closeBtnLux) closeBtnLux.addEventListener('click', closeOverlayLux);
    if (overlayLux) overlayLux.addEventListener('click', (e) => {
        if (e.target === overlayLux) closeOverlayLux();
    });

    qs('#zoomInFullLux')?.addEventListener('click', () => chartLUXFull?.zoom(1.2));
    qs('#zoomOutFullLux')?.addEventListener('click', () => chartLUXFull?.zoom(0.8));
    qs('#panLeftFullLux')?.addEventListener('click', () => chartLUXFull?.pan({x: 120}));
    qs('#panRightFullLux')?.addEventListener('click', () => chartLUXFull?.pan({x: -120}));
    qs('#resetFullLux')?.addEventListener('click', () => chartLUXFull && hardReset(chartLUXFull));

    // çƒŸé›¾å…¨å±é€»è¾‘
    const openBtnSmoke = qs('#openFullSmoke');
    if (openBtnSmoke) openBtnSmoke.addEventListener('click', () => {
        openOverlaySmoke();
        if (!chartSMOKEFull && chartSMOKE && chartSMOKE.data) {
            const ctx = chartSMOKEFullCanvas()?.getContext('2d');
            if (ctx) {
                const data = {
                    labels: labelsSmokeFull,
                    datasets: [
                        {
                            label: 'çƒŸé›¾æµ“åº¦ (ppm)',
                            data: smokeFull,
                            yAxisID: 'y',
                            borderColor: css('--chart-line-smoke'),
                            pointHoverBorderColor: css('--chart-line-smoke')
                        }
                    ]
                };
                const opts = makeBaseOptions();
                opts.scales = {
                    x: {ticks: {maxRotation: 0, autoSkip: true}, grid: {color: css('--chart-grid')}},
                    y: {position: 'left', grid: {color: css('--chart-grid')}}
                };
                // å…¨å±å›¾å…è®¸æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰
                if (opts?.plugins?.zoom?.pan) {
                    opts.plugins.zoom.pan.enabled = true;
                }
                chartSMOKEFull = new Chart(ctx, {type: 'line', data, options: opts});
                try {
                    const c = chartSMOKEFull.canvas;
                    if (c) {
                        c.style.cursor = 'grab';
                        c.addEventListener('mousedown', () => {
                            c.style.cursor = 'grabbing';
                        });
                        window.addEventListener('mouseup', () => {
                            c.style.cursor = 'grab';
                        });
                    }
                } catch (e) {
                }
                enableManualDragPan(chartSMOKEFullCanvas(), chartSMOKEFull);
            }
        }
        setTimeout(() => window.updateChartColors?.(), 50);
    });

    const closeBtnSmoke = qs('#closeOverlaySmoke');
    if (closeBtnSmoke) closeBtnSmoke.addEventListener('click', closeOverlaySmoke);
    if (overlaySmoke) overlaySmoke.addEventListener('click', (e) => {
        if (e.target === overlaySmoke) closeOverlaySmoke();
    });

    // MQ2 æ§åˆ¶å¿«æ·å…¥å£
    if (smokeCard) {
        smokeCard.style.cursor = 'pointer';
        smokeCard.addEventListener('click', (e) => {
            if (e?.target?.closest?.('.info-btn')) return;
            if (typeof window.openOverlayMQ2 === 'function') {
                window.openOverlayMQ2();
            }
        });
    }

    qs('#zoomInFullSmoke')?.addEventListener('click', () => chartSMOKEFull?.zoom(1.2));
    qs('#zoomOutFullSmoke')?.addEventListener('click', () => chartSMOKEFull?.zoom(0.8));
    qs('#panLeftFullSmoke')?.addEventListener('click', () => chartSMOKEFull?.pan({x: 120}));
    qs('#panRightFullSmoke')?.addEventListener('click', () => chartSMOKEFull?.pan({x: -120}));
    qs('#resetFullSmoke')?.addEventListener('click', () => chartSMOKEFull && hardReset(chartSMOKEFull));

    // å¤§æ°”å‹å…¨å±é€»è¾‘
    const openBtnPressure = qs('#openFullPressure');
    if (openBtnPressure) openBtnPressure.addEventListener('click', () => {
        openOverlayPressure();
        if (!chartPRESSUREFull && chartPRESSURE && chartPRESSURE.data) {
            const ctx = chartPRESSUREFullCanvas()?.getContext('2d');
            if (ctx) {
                const data = {
                    labels: labelsPressureFull,
                    datasets: [
                        {
                            label: 'å¤§æ°”å‹ (hPa)',
                            data: pressureFull,
                            yAxisID: 'y',
                            borderColor: css('--chart-line-pressure'),
                            pointHoverBorderColor: css('--chart-line-pressure')
                        }
                    ]
                };
                const opts = makeBaseOptions();
                opts.scales = {
                    x: {ticks: {maxRotation: 0, autoSkip: true}, grid: {color: css('--chart-grid')}},
                    y: {position: 'left', grid: {color: css('--chart-grid')}}
                };
                // å…¨å±å›¾å…è®¸æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰
                if (opts?.plugins?.zoom?.pan) {
                    opts.plugins.zoom.pan.enabled = true;
                }
                chartPRESSUREFull = new Chart(ctx, {type: 'line', data, options: opts});
                try {
                    const c = chartPRESSUREFull.canvas;
                    if (c) {
                        c.style.cursor = 'grab';
                        c.addEventListener('mousedown', () => {
                            c.style.cursor = 'grabbing';
                        });
                        window.addEventListener('mouseup', () => {
                            c.style.cursor = 'grab';
                        });
                    }
                } catch (e) {
                }
                enableManualDragPan(chartPRESSUREFullCanvas(), chartPRESSUREFull);
            }
        }
        setTimeout(() => window.updateChartColors?.(), 50);
    });

    const closeBtnPressure = qs('#closeOverlayPressure');
    if (closeBtnPressure) closeBtnPressure.addEventListener('click', closeOverlayPressure);
    if (overlayPressure) overlayPressure.addEventListener('click', (e) => {
        if (e.target === overlayPressure) closeOverlayPressure();
    });

    qs('#zoomInFullPressure')?.addEventListener('click', () => chartPRESSUREFull?.zoom(1.2));
    qs('#zoomOutFullPressure')?.addEventListener('click', () => chartPRESSUREFull?.zoom(0.8));
    qs('#panLeftFullPressure')?.addEventListener('click', () => chartPRESSUREFull?.pan({x: 120}));
    qs('#panRightFullPressure')?.addEventListener('click', () => chartPRESSUREFull?.pan({x: -120}));
    qs('#resetFullPressure')?.addEventListener('click', () => chartPRESSUREFull && hardReset(chartPRESSUREFull));

    // ç»‘å®š"åŠ è½½æ•°æ®"æŒ‰é’®
    const loadDataBtn = qs('#loadDataBtn');
    if (loadDataBtn) {
        loadDataBtn.addEventListener('click', openLoadModal);
    }

    // æ¶ˆæ¯ä¸­å¿ƒåŠŸèƒ½å·²ç§»è‡³ common.jsï¼Œä½¿ç”¨ MessageCenter å¯¹è±¡

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    window.addEventListener('load', function () {
        // åˆå§‹åŒ–å¸®åŠ©å¼¹çª—å’ŒåŠŸèƒ½èœå•
        initHelpModal();
        initAboutModal();
        initFunctionMenu();

        // æ£€æŸ¥é¦–æ¬¡è®¿é—®å¹¶æ˜¾ç¤ºå¸®åŠ©
        checkFirstVisit();
    });

    // é¦–æ¬¡åŠ è½½ï¼šä¸æ¸…ç©ºæ•°æ®ï¼ˆå› ä¸ºæœ¬æ¥å°±æ˜¯ç©ºçš„ï¼‰
    loadHistoryData(100, false).then(() => {
        console.log('âœ… å†å²æ•°æ®åŠ è½½æµç¨‹å®Œæˆï¼Œå¼€å§‹è¿æ¥WebSocket...');
        connect();
        // åˆå§‹åŒ–æ¶ˆæ¯ä¸­å¿ƒ
        if (window.MessageCenter) {
            window.MessageCenter.init();
            window.MessageCenter.loadUnreadWarningCount();
        }
    }).catch(err => {
        console.error('âŒ å†å²æ•°æ®åŠ è½½å‡ºé”™ï¼Œä»ç»§ç»­è¿æ¥WebSocketï¼š', err);
        connect();
        // åˆå§‹åŒ–æ¶ˆæ¯ä¸­å¿ƒ
        if (window.MessageCenter) {
            window.MessageCenter.init();
            window.MessageCenter.loadUnreadWarningCount();
        }
    });
</script>


</body>
</html>
