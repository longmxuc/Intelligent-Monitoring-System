# STM32 æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ Beta 3

é¢å‘ STM32F103C8T6ï¼ˆCortex-M3ï¼‰çš„å¤šä¼ æ„Ÿå™¨ç¯å¢ƒç›‘æµ‹é¡¹ç›®ï¼Œæ•´åˆ **AHT20** æ¸©æ¹¿åº¦ã€ **BH1750** äº®åº¦ã€ **BMP180** æ°”å‹/æ¸©åº¦/æµ·æ‹”ã€ **MQ2** çƒŸé›¾/å¯ç‡ƒæ°”ä½“ä¼ æ„Ÿå™¨ï¼Œå¹¶é€šè¿‡ 0.96"~1.3" IÂ²C OLED å®æ—¶å±•ç¤ºã€‚ç³»ç»Ÿå†…å»ºå¤šå±‚æ»¤æ³¢ã€å¼‚å¸¸æ£€æµ‹ä¸åŒä¸²å£ï¼ˆAir780e æ¨¡å— + è“ç‰™ï¼‰çš„æ•°æ®ä¸Šä¼ èƒ½åŠ›ï¼Œå¯é…åˆ GitHub/Open-Source å·¥ä½œæµä½¿ç”¨ã€‚
> ğŸ‘‰ åœ¨çº¿ä½“éªŒåœ°å€ï¼šhttps://znhj.iepose.cn

## åŠŸèƒ½äº®ç‚¹

- **å¤šä¼ æ„Ÿå™¨èåˆ**ï¼šIÂ²C é‡‡é›† AHT20/BH1750/BMP180 + ADC é‡‡é›† MQ2ï¼Œå®ç°ç¯å¢ƒæ¸©æ¹¿åº¦ã€å…‰ç…§ã€æ°”å‹/æµ·æ‹”ä¸çƒŸé›¾å€¼çš„åŒæ­¥ç›‘æµ‹ã€‚
- **å¤šå±‚ç¨³å¥æ»¤æ³¢**ï¼šèŒƒå›´é™å¹… + éå¯¹ç§°å˜åŒ–ç‡é™åˆ¶ + ä¸­å€¼æ»¤æ³¢ + è¶‹åŠ¿æ£€æµ‹ã€‚
- **OLED å¤šé¡µé¢ UI**ï¼šå•é”®é˜²æŠ–åˆ‡æ¢ä¸‰å¤§é¡µé¢ï¼ˆæ¸©æ¹¿åº¦/äº®åº¦ã€æ°”å‹æ¸©åº¦/æµ·æ‹”ã€MQ2 Rs/Ro & PPMï¼‰ã€‚
- **åŒä¸²å£æ•°æ®ä¸Šä¼ **ï¼š`USART3` è“ç‰™ & `USART2` Air780eï¼Œä¾æ® `BLE_STATE` å¼•è„šè‡ªåŠ¨åˆ‡æ¢ï¼Œå¸§æ ¼å¼ `T=...H=...`ã€‚
- **å¼‚å¸¸é˜ˆå€¼ä¸å‘Šè­¦**ï¼šæ¸©æ¹¿åº¦/äº®åº¦/æ°”å‹/PPM è¶…é™æŒç»­ 3s è§¦å‘ `Alert_SendWarning()`ï¼Œè‡ªåŠ¨é€‰æ‹©å¯ç”¨ä¸²å£æ¨é€å‘Šè­¦ã€‚
- **è¿œç¨‹æ§åˆ¶**ï¼š`ONMQ2` / `OFFMQ2` æ–‡æœ¬æŒ‡ä»¤ï¼ˆä¸¤è·¯ä¸²å£å‡å¯ï¼‰åˆ‡æ¢ MQ2 ä¾›ç”µï¼Œä¾¿äºèŠ‚èƒ½æˆ–è¿œç¨‹ç»´æŠ¤ã€‚
- **ç°ä»£æ„å»ºé“¾è·¯**ï¼šCMakePresets + Ninja + GCC ARM toolchainï¼Œå¯åœ¨ VS Codeã€CLionã€CubeIDE CMake å·¥ç¨‹ç­‰ç¯å¢ƒç›´æ¥å¤ç°ã€‚

## ç¡¬ä»¶ç»„æˆ

| æ¨¡å— | æ¥å£/èµ„æº | è¯´æ˜ |
| --- | --- | --- |
| STM32F103C8T6 | Cortex-M3 @ 72â€¯MHzï¼Œ64â€¯KB Flash | ä¸»æ§ï¼Œä½¿ç”¨ STM32Cube HAL |
| OLED 128Ã—64 | IÂ²Cï¼ˆ`hi2c1`ï¼‰ | å¤šé¡µé¢æ•°æ®æ˜¾ç¤º |
| AHT20 / DHT20 | IÂ²C | æ¸©æ¹¿åº¦é‡‡é›† |
| BH1750 | IÂ²C | äº®åº¦ï¼ˆLuxï¼‰æµ‹é‡ï¼Œå•æ¬¡é«˜åˆ†è¾¨ç‡æ¨¡å¼ |
| BMP180 | IÂ²C | æ°”å‹ã€æ¸©åº¦ã€æµ·æ‹”ï¼ˆOSS_3ï¼‰ |
| MQ2 | ADC1 é€šé“ + GPIO æ§ç”µ | çƒŸé›¾/å¯ç‡ƒæ°”ä½“ï¼Œæ”¯æŒå¿«é€Ÿæ ¡å‡† & è¿œç¨‹æ–­ç”µ |
| Air780e | USART2 + DMA | èœ‚çªç‰©è”ç½‘æ¨¡ç»„ä¸ŠæŠ¥æ•°æ® |
| è“ç‰™æ¨¡å—ï¼ˆHC-05 ç­‰ï¼‰ | USART3 + DMA | æœ¬åœ° BLE/ä¸²å£é€ä¼  |
| SWITCH_KEY | PB12 è¾“å…¥ | OLED é¡µé¢åˆ‡æ¢ |
| BLE_STATE | PA8 è¾“å…¥ | è¡¨ç¤ºè“ç‰™è¿æ¥çŠ¶æ€ï¼Œå†³å®šä¸²å£è¾“å‡ºè·¯ç”± |

## æ¥çº¿å›¾

> æ‰€æœ‰ IÂ²C è®¾å¤‡ï¼ˆOLEDã€AHT20ã€BH1750ã€BMP180ï¼‰å…±ç”¨ `3.3â€¯V` ä¸ `GND`ï¼Œå¹¶å¹¶è”åœ¨ `PB6/PB7` ä¸Šï¼›MQ2 ä¼ æ„Ÿå™¨ä½¿ç”¨ `5â€¯V` ä¾›ç”µä¸”æ¨¡æ‹Ÿè¾“å‡ºæ¥å…¥ `PA0`ã€‚

### IÂ²C æ€»çº¿ï¼ˆ`hi2c1`ï¼Œ400â€¯kHzï¼‰

| è®¾å¤‡ | VCC | GND | SCL | SDA | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- |
| OLED 128Ã—64 | 3.3â€¯V | GND | PB6 | PB7 | åœ°å€ `0x3C`ï¼ŒIÂ²C OLED |
| AHT20 | 3.3â€¯V | GND | PB6 | PB7 | åœ°å€ `0x38` |
| BH1750 | 3.3â€¯V | GND | PB6 | PB7 | `ADDR` æ¥ VCC â†’ åœ°å€ `0x5C` |
| BMP180 | 3.3â€¯V | GND | PB6 | PB7 | OSS_3ï¼Œé«˜ç²¾åº¦æ¨¡å¼ |

ç®€åŒ–æ‹“æ‰‘ï¼ˆä¿¯è§†ï¼‰ï¼š

```
PB6 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ OLED SCL
              â”œâ”€ AHT20 SCL
              â”œâ”€ BH1750 SCL
              â””â”€ BMP180 SCL

PB7 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ OLED SDA
              â”œâ”€ AHT20 SDA
              â”œâ”€ BH1750 SDA
              â””â”€ BMP180 SDA
```

### æ¨¡æ‹Ÿ/æ§åˆ¶æ¥å£

| è®¾å¤‡ | å¼•è„š | STM32F103 å¼•è„š | è¯´æ˜ |
| --- | --- | --- | --- |
| MQ2 æ¨¡æ‹Ÿè¾“å‡º | AOUT | `PA0` (`ADC1_IN0`) | å‘¨æœŸé‡‡æ · + å¤šçº§æ»¤æ³¢ |
| MQ2 ä¾›ç”µ | VCC | 5â€¯V | å»ºè®®åŒç”µæºæ—åŠ  0.1â€¯ÂµF + 10â€¯ÂµF |
| MQ2 åœ° | GND | GND | ä¸ MCU å…±åœ° |
| MQ2 ç”µæºæ§åˆ¶ | EN/VCC_SW | `PB1` (`MQ2_POWER`) | `ONMQ2/OFFMQ2` è¿œç¨‹å¼€å…³ |
| SWITCH_KEY | ä¸€ç«¯ | `PB12` | ä¸Šæ‹‰è¾“å…¥ |
| SWITCH_KEY | å¦ä¸€ç«¯ | GND | æŒ‰ä¸‹æ¥åœ°å®ç°é¡µé¢åˆ‡æ¢ |
| BLE_STATE è¾“å…¥ | æ¨¡å—çŠ¶æ€è„š | `PA8` | é«˜ç”µå¹³è¡¨ç¤ºè“ç‰™è¿æ¥ï¼Œæ§åˆ¶ä¸²å£è·¯ç”± |

### ä¸²å£ä¸æ— çº¿æ¨¡ç»„

| é€šè®¯å¯¹è±¡ | STM32 å¼•è„š | å¤–è®¾å¼•è„š | è¯´æ˜ |
| --- | --- | --- | --- |
| Air780eï¼ˆèœ‚çªï¼‰ | `PA2` (`USART2_TX`) â†’ æ¨¡å— RX | `PA3` (`USART2_RX`) â† æ¨¡å— TX | 115200â€¯bpsï¼Œä¸ŠæŠ¥ç¯å¢ƒå¸§ |
| è“ç‰™ä¸²å£ï¼ˆHC-05 ç­‰ï¼‰ | `PB10` (`USART3_TX`) â†’ æ¨¡å— RX | `PB11` (`USART3_RX`) â† æ¨¡å— TX | 9600â€¯bps + DMAï¼ŒBLE_STATE å†³å®šæ˜¯å¦å‘å°„ |

> è®°å¾—æ‰€æœ‰å¤–è®¾éœ€ä¸ MCU å…±åœ°ï¼›è‹¥å¤–è®¾é€»è¾‘ä¸º 5â€¯Vï¼ˆå¦‚éƒ¨åˆ†è“ç‰™æ¨¡ç»„ï¼‰ï¼Œéœ€ä½¿ç”¨ç”µå¹³è½¬æ¢æˆ–ç¡®è®¤å…¶å…¼å®¹ 3.3â€¯V TTLã€‚

## ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ Core/                 # CubeMX ç”Ÿæˆæºç ï¼ˆmain.cã€å¤–è®¾é©±åŠ¨ã€ä¼ æ„Ÿå™¨ç®—æ³•ç­‰ï¼‰
â”‚   â”œâ”€â”€ Inc/
â”‚   â””â”€â”€ Src/
â”œâ”€â”€ Drivers/              # è¯·è‡ªè¡Œä½¿ç”¨CubeMXç”Ÿæˆ
â”œâ”€â”€ cmake/                # å·¥å…·é“¾ & CubeMX å­é¡¹ç›®é…ç½®
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ CMakePresets.json     # é¢„è®¾æ„å»ºé…ç½®ï¼ˆDebug/Releaseâ€¦ï¼‰
â”œâ”€â”€ oled.ioc              # STM32CubeMX å·¥ç¨‹æ–‡ä»¶
â”œâ”€â”€ STM32F103XX_FLASH.ld  # é“¾æ¥è„šæœ¬
â””â”€â”€ startup_stm32f103xb.s
```

## å¼€å‘ç¯å¢ƒ

- CMake â‰¥ 3.22
- Ninja â‰¥ 1.10
- `arm-none-eabi-gcc` å·¥å…·é“¾ï¼ˆæ¨è 10.x åŠä»¥ä¸Šï¼‰
- STM32CubeMXï¼ˆå¦‚éœ€é‡æ–°ç”Ÿæˆå¤–è®¾åˆå§‹åŒ–ä»£ç ï¼‰
- ST-LINK CLI / STM32CubeProgrammer / `st-flash` ç­‰çƒ§å½•å·¥å…·

> **Tip**ï¼š`cmake/gcc-arm-none-eabi.cmake` å·²å°è£… MCU ç›®æ ‡ã€é“¾æ¥è„šæœ¬ã€`-u _printf_float` ç­‰ç»†èŠ‚ï¼Œç¡®ä¿åœ¨ Windows/macOS/Linux ä¸Šç»Ÿä¸€ä½“éªŒã€‚

## æ„å»ºæ­¥éª¤

```bash
# 1. ç”Ÿæˆæ„å»ºç›®å½•ï¼ˆä»¥ Debug ä¸ºä¾‹ï¼‰
cmake --preset Debug

# 2. ç¼–è¯‘
cmake --build --preset Debug

# 3. ç”ŸæˆäºŒè¿›åˆ¶ï¼ˆå¦‚éœ€æ‰‹åŠ¨çƒ§å½•ï¼‰
arm-none-eabi-objcopy -O binary build/Debug/oled.elf build/Debug/oled.bin
```

æ„å»ºè¾“å‡ºä½äº `build/<Preset>/`ï¼Œå« `.elf`ã€`.map` ä¸ç¼–è¯‘æ•°æ®åº“ `compile_commands.json`ã€‚

## çƒ§å½•ä¸è°ƒè¯•

1. **ä½¿ç”¨ ST-LINK CLI / CubeProgrammer**ï¼šç›´æ¥åŠ è½½ `build/Debug/oled.elf`ï¼Œæˆ–è½¬æ¢åçš„ `oled.bin`ã€‚
2. **å‘½ä»¤è¡Œç¤ºä¾‹ï¼ˆst-flashï¼‰**ï¼š
   ```bash
   st-flash write build/Debug/oled.bin 0x08000000
   ```
3. çƒ§å½•åé€šè¿‡ `USART3`ï¼ˆè“ç‰™ï¼‰æˆ– `USART2`ï¼ˆAir780eï¼‰ç›‘è§†ä¸²å£å¸§ï¼Œæ³¢ç‰¹ç‡ä¸ CubeMX è®¾ç½®ä¸€è‡´ï¼ˆé»˜è®¤ 115200ï¼‰ã€‚

## è¿è¡Œæ—¶é€»è¾‘

- **ä»»åŠ¡è°ƒåº¦**ï¼šä¸»å¾ªç¯ä»¥æ¯«ç§’èŠ‚æ‹è½®è¯¢ï¼Œéé˜»å¡è§¦å‘/è¯»å–å„ä¼ æ„Ÿå™¨ï¼šBH1750 ä¸€æ¬¡æ€§é«˜åˆ†è¾¨ç‡ã€MQ2 å‘¨æœŸæ€§ ADCã€BMP180 OSS_3ã€AHT20 500â€¯ms å‘¨æœŸï¼Œå¹¶åœ¨åŒå‘¨æœŸä¸­åˆ·æ–° OLEDã€‚
- **OLED é¡µé¢**ï¼š`SWITCH_KEY` è§¦å‘æ¶ˆæŠ–ï¼Œå¾ªç¯æ˜¾ç¤ºï¼š
  1. æ¸©åº¦/æ¹¿åº¦ + Luxï¼›
  2. æ°”å‹ï¼ˆhPaï¼‰/BMP180 æ¸©åº¦/æµ·æ‹”ï¼›
  3. MQ2 Rs/Ro + PPMã€‚
- **æ»¤æ³¢ä¸æ ¡å‡†**ï¼šç³»ç»Ÿä¸Šç”µåå…ˆæ‰§è¡Œ MQ2 å¿«é€Ÿæ ¡å‡†ï¼ˆæ´å‡€ç©ºæ°”ä¸­çº¦ 1s å®Œæˆï¼‰ï¼›ä¼ æ„Ÿå™¨è¯»æ•°ç»Ÿä¸€ç»è¿‡å¤šå±‚æ»¤æ³¢ï¼Œç¼“è§£ IÂ²C æŠ–åŠ¨ã€ç”µæºå™ªå£°ä¸ ADC è·³å˜ã€‚
- **å¼‚å¸¸æ£€æµ‹**ï¼š`Alert_CheckAndSend()` æŒ‰é˜ˆå€¼ï¼ˆå¯åœ¨ `Core/Src/main.c` ä¸­è°ƒæ•´ï¼‰è·Ÿè¸ªå„é‡çš„æŒç»­å¼‚å¸¸ï¼Œè¶…è¿‡ 3â€¯s å³é€šè¿‡å¯ç”¨ä¸²å£å‘é€ä¸€æ¬¡å‘Šè­¦å­—ç¬¦ã€‚
- **ä¸²å£è¾“å‡º**ï¼šå‘¨æœŸæ€§æ ¼å¼åŒ– `T=%.2fH=%.2fL=%.1fR=%.2fY=%.1fW=%.2fP=%.2f\r\n`ï¼Œ`USART3` ä»…åœ¨ `BLE_STATE=High`ï¼ˆè“ç‰™è¿æ¥ï¼‰æ—¶å‘é€ï¼›å¦åˆ™ç”± `USART2`ï¼ˆAir780eï¼‰è´Ÿè´£ã€‚
- **è¿œç¨‹æŒ‡ä»¤**ï¼šä»»ä½•ä¸²å£æ”¶åˆ°æ–‡æœ¬ `ONMQ2` / `OFFMQ2` å³é€šè¿‡ `MQ2_POWER` å¼•è„šå¼€/æ–­ä¼ æ„Ÿå™¨ç”µæºï¼Œæ”¯æŒ DMA æ¥æ”¶æˆ–å­—èŠ‚æµè§£æã€‚

## æ•°æ®åè®®ä¸æ‰©å±•

ç¤ºä¾‹ä¸ŠæŠ¥ï¼š

```
T=25.31H=42.88L=123.4R=1.27Y=35.6W=24.5P=1012.8
```

| å­—æ®µ | è¯´æ˜ |
| --- | --- |
| `T` | AHT20 è¿‡æ»¤åçš„æ¸©åº¦ï¼ˆâ„ƒï¼‰ |
| `H` | AHT20 ç›¸å¯¹æ¹¿åº¦ï¼ˆ%ï¼‰ |
| `L` | BH1750 äº®åº¦ï¼ˆLuxï¼‰ |
| `R` | MQ2 Rs/Ro æ¯”å€¼ |
| `Y` | MQ2 PPMï¼ˆéœ€å·²æ ¡å‡†ï¼‰ |
| `W` | BMP180 æ¸©åº¦ï¼ˆâ„ƒï¼‰ |
| `P` | BMP180 æ°”å‹ï¼ˆhPaï¼‰ |


> å¦‚åœ¨æ„å»ºæˆ–éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿æäº¤ Issue æˆ– PRã€‚ç¥ä½¿ç”¨é¡ºåˆ©ï¼
