<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
    <meta charset="UTF-8"/>
    <link rel="manifest" href="/resource/manifest.json">
    <link rel="icon" type="image/x-icon" href="/resource/favicon.ico">
    <link rel="apple-touch-icon" href="/resource/favicon_192.png" sizes="192x192">
    <link rel="icon" href="/resource/favicon_512.png" sizes="512x512">
    <link rel="stylesheet" href="/static/common-styles.css?v=20250205">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ•°æ®åˆ†æ">
    <meta name="application-name" content="æ•°æ®åˆ†æ">
    <title>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ - æ•°æ®åˆ†æ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        :root {
            --bg: #0b1020;
            --card: #0f162e;
            --bd: #1d2b4a;
            --text: #e6eefc;
            --muted: #9aa6bf;
            --good: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --primary: #3b82f6;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --chart-grid: #1b2544;
            --chart-line-temp-cold: #38bdf8;
            --chart-line-temp-warm: #f97316;
            --chart-line-hum: #34d399;
            --chart-line-lux: #a78bfa;
            --chart-line-smoke: #fb923c;
            --chart-line-pressure: #ec4899;
        }

        @media (prefers-color-scheme: light) {
            :root[data-theme="auto"] {
                --bg: #f5f7fa;
                --card: #fff;
                --bd: #d6d9e0;
                --text: #111827;
                --muted: #64748b;
                --good: #16a34a;
                --bad: #dc2626;
                --warn: #ea580c;
                --primary: #2563eb;
                --shadow: 0 8px 18px rgba(0, 0, 0, .08);
                --chart-grid: #e2e8f0;
                --chart-line-temp-cold: #2563eb;
                --chart-line-temp-warm: #ef4444;
                --chart-line-hum: #059669;
                --chart-line-lux: #7c3aed;
                --chart-line-smoke: #ea580c;
                --chart-line-pressure: #db2777;
            }
        }

        :root[data-theme="light"] {
            --bg: #f5f7fa;
            --card: #fff;
            --bd: #d6d9e0;
            --text: #111827;
            --muted: #64748b;
            --good: #16a34a;
            --bad: #dc2626;
            --warn: #ea580c;
            --primary: #2563eb;
            --shadow: 0 8px 18px rgba(0, 0, 0, .08);
            --chart-grid: #e2e8f0;
            --chart-line-temp-cold: #2563eb;
            --chart-line-temp-warm: #ef4444;
            --chart-line-hum: #059669;
            --chart-line-lux: #7c3aed;
            --chart-line-smoke: #ea580c;
            --chart-line-pressure: #db2777;
        }

        * {
            box-sizing: border-box
        }

        html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            letter-spacing: .2px;
            transition: .3s;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
                font-size: 14px;
            }
        }

        .wrap {
            max-width: 1300px;
            margin: 0 auto;
            border: none;
            outline: none;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
            border: none;
            outline: none;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                padding: 16px;
                margin-bottom: 24px;
            }
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 20px;
                text-align: center;
                margin-bottom: 4px;
            }
        }

        .nav-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        @media (max-width: 768px) {
            .nav-actions {
                gap: 8px;
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        /* æŒ‰é’®æ ·å¼å·²ç§»è‡³ common-styles.css */

        .card {
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: .3s
        }
        
        /* æ•°æ®åŠ è½½æç¤ºåŠ¨ç”» - è¶…çº§æ˜æ˜¾çš„å¼¹è·³æ•ˆæœ */
        @keyframes bounceAndHighlight {
            0%, 100% {
                transform: translateY(0) scale(1);
                box-shadow: var(--shadow);
            }
            5%, 25%, 45% {
                transform: translateY(-20px) scale(1.05);
                box-shadow: 0 15px 50px rgba(59, 130, 246, 0.5),
                            0 0 0 0 rgba(59, 130, 246, 0.8);
            }
            10%, 35% {
                transform: translateY(-10px) scale(1.03);
                box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
            }
            15%, 40% {
                transform: translateY(0) scale(1.01);
                box-shadow: 0 5px 30px rgba(59, 130, 246, 0.3);
            }
            50% {
                transform: translateY(0) scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.9), 
                            0 0 0 15px rgba(59, 130, 246, 0.4), 
                            0 0 0 30px rgba(59, 130, 246, 0.2);
            }
            70% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7), 
                            0 0 0 25px rgba(59, 130, 246, 0.3), 
                            0 0 0 50px rgba(59, 130, 246, 0.1);
            }
            85% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5), 
                            0 0 0 35px rgba(59, 130, 246, 0.1), 
                            0 0 0 70px rgba(59, 130, 246, 0);
            }
        }
        
        @keyframes borderPulseHighlight {
            0%, 100% {
                border-color: var(--bd);
                background-color: var(--card);
            }
            15%, 35%, 55% {
                border-color: rgba(59, 130, 246, 1);
                background-color: rgba(59, 130, 246, 0.05);
            }
            25%, 45% {
                border-color: rgba(59, 130, 246, 0.6);
                background-color: var(--card);
            }
        }
        
        /* åº”ç”¨åŠ¨ç”»çš„ç±» */
        .card.bounce-highlight {
            animation: bounceAndHighlight 2.5s ease-out, 
                       borderPulseHighlight 2.5s ease-in-out;
            border-width: 3px;
            position: relative;
            z-index: 100;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .chart-title-with-info .card-title {
            margin-bottom: 0
        }

        .filter-section {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .05em
        }

        input[type="number"],
        input[type="datetime-local"],
        select {
            padding: 10px 12px;
            border: 1px solid var(--bd);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            transition: all .2s
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .1)
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap
        }

        .stat-section {
            margin-bottom: 24px
        }

        /* AI åˆ†æåŠ©æ‰‹æ ·å¼ */
        .ai-chat-container {
            position: relative;
            border-radius: var(--radius);
            margin-bottom: 20px;
            /* é»˜è®¤æ™®é€šè¾¹æ¡†ï¼ˆ1pxï¼Œä¸å…¶ä»–å¡ç‰‡ä¸€è‡´ï¼‰ */
            border: 1px solid var(--bd);
            background: var(--card);
            box-shadow: var(--shadow);
            /* æ·»åŠ æ˜æ˜¾çš„è¿‡æ¸¡åŠ¨ç”» */
            transition: border 1.2s cubic-bezier(0.4, 0, 0.2, 1), 
                        box-shadow 1.2s cubic-bezier(0.4, 0, 0.2, 1),
                        background 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* AI å›ç­”æ—¶çš„æµå…‰æº¢å½©è¾¹æ¡†æ•ˆæœ */
        .ai-chat-container.ai-responding {
            /* ä½¿ç”¨ 3px è¾¹æ¡† + æµå…‰æ¸å˜ */
            border: 3px solid transparent;
            background: 
                linear-gradient(var(--card), var(--card)) padding-box,
                linear-gradient(
                    90deg,
                    #ff6b6b,
                    #feca57,
                    #48dbfb,
                    #ff9ff3,
                    #54a0ff,
                    #00d2d3,
                    #ff6b6b
                ) border-box;
            background-size: auto, 300% 300%;
            box-shadow:
                0 0 30px rgba(255, 107, 107, 0.4),
                0 0 50px rgba(72, 219, 251, 0.3),
                0 0 70px rgba(255, 159, 243, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.15);
            /* åŒæ—¶åº”ç”¨æµå…‰å’Œè„‰å†²åŠ¨ç”» */
            animation: gradientShift 4s ease infinite, 
                       borderPulse 2s ease-in-out infinite;
        }
        
        /* å½“åº”ç”¨æµå…‰æ•ˆæœæ—¶ï¼Œè°ƒæ•´headeråœ†è§’ä»¥åŒ¹é…3pxè¾¹æ¡† */
        .ai-chat-container.ai-responding .ai-chat-header {
            border-radius: calc(var(--radius) - 3px) calc(var(--radius) - 3px) 0 0;
        }
        
        /* æš—è‰²æ¨¡å¼ä¸‹å¢å¼ºå‘å…‰æ•ˆæœï¼ˆä»…åœ¨ AI å›ç­”æ—¶ï¼‰ */
        [data-theme="dark"] .ai-chat-container.ai-responding {
            box-shadow:
                0 0 40px rgba(255, 107, 107, 0.6),
                0 0 60px rgba(72, 219, 251, 0.5),
                0 0 80px rgba(255, 159, 243, 0.4),
                0 10px 50px rgba(0, 0, 0, 0.8);
        }
        
        /* æµå…‰æº¢å½©åŠ¨ç”» */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        /* å¯åŠ¨æµå…‰æ•ˆæœæ—¶çš„è„‰å†²åŠ¨ç”» */
        @keyframes borderPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.005);
                opacity: 0.95;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        

        .ai-chat-header {
            padding: 16px 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0;
            position: relative;
            z-index: 10;
        }
        
        .ai-chat-header:hover {
            background: #2563eb;
        }
        
        /* æŠ˜å çŠ¶æ€ä¸‹ï¼Œheader åªä¿ç•™é¡¶éƒ¨åœ†è§’ï¼ˆä¸‹é¢è¿˜æœ‰é¢„è®¾é—®é¢˜æ ï¼‰ */
        .ai-chat-container.collapsed .ai-chat-header {
            border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0;
        }
        
        /* æŠ˜å çŠ¶æ€ + æµå…‰æ•ˆæœï¼šè°ƒæ•´åœ†è§’ä»¥åŒ¹é…3pxè¾¹æ¡† */
        .ai-chat-container.collapsed.ai-responding .ai-chat-header {
            border-radius: calc(var(--radius) - 3px);
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            display: inline-block;
            color: white;
            opacity: 0.9;
        }
        
        .ai-chat-container.collapsed .ai-toggle-icon {
            transform: rotate(-90deg);
        }
        
        .ai-chat-messages {
            height: 400px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
            scroll-behavior: smooth;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
            opacity: 1;
        }
        
        .ai-chat-container.collapsed .ai-chat-messages {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }
        
        .ai-chat-input-area {
            padding: 16px 20px;
            background: var(--card);
            border-top: 1px solid var(--bd);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
            max-height: 200px;
            opacity: 1;
            border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
        }
        
        .ai-chat-container.collapsed .ai-chat-input-area {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none;
        }
        
        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            overflow: visible;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
            max-height: none;
            opacity: 1;
        }
        
        .ai-chat-container.collapsed .ai-suggestions {
            display: none !important;
        }
        
        .ai-collapsed-hint {
            font-size: 13px;
            color: white;
            opacity: 0.7;
            display: none;
        }
        
        .ai-chat-container.collapsed .ai-collapsed-hint {
            display: block;
        }
        
        .ai-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .ai-clear-btn {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            height: 32px;
            display: inline-flex;
            align-items: center;
        }
        
        .ai-clear-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* AI æ¸…ç©ºç¡®è®¤å¼¹çª— */
        .ai-clear-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        
        .ai-clear-modal.show {
            display: flex;
        }
        
        .ai-clear-modal.closing {
            animation: fadeOut 0.2s ease-out forwards;
        }
        
        .ai-clear-modal.closing .ai-clear-content {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .ai-clear-content {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .ai-clear-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-clear-message {
            color: var(--muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .ai-clear-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .ai-clear-actions button {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .ai-clear-cancel {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--bd);
        }
        
        .ai-clear-cancel:hover {
            background: var(--card);
            border-color: var(--primary);
        }
        
        .ai-clear-confirm {
            background: #ef4444;
            color: white;
        }
        
        .ai-clear-confirm:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .ai-status {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ai-model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        /* è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨ */
        .ai-model-custom-select {
            position: relative;
            min-width: 180px;
            z-index: 100;
        }

        .ai-model-selected {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .ai-model-selected:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .ai-model-selected-text {
            flex: 1;
            white-space: nowrap;
        }

        .ai-model-arrow {
            font-size: 10px;
            transition: transform 0.2s;
            color: rgba(255, 255, 255, 0.6);
            transform: rotate(-90deg);
        }

        .ai-model-custom-select.open .ai-model-arrow {
            transform: rotate(0deg);
        }

        .ai-model-options {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            transform-origin: top;
            transform: scaleY(0);
            transition: all 0.2s ease;
            z-index: 10001;
            padding: 3px 0;
        }

        .ai-model-custom-select.open .ai-model-options {
            max-height: 500px;
            opacity: 1;
            visibility: visible;
            transform: scaleY(1);
        }

        /* ç»Ÿä¸€çš„æ¨¡å‹é€‰é¡¹æ ·å¼ï¼ˆæ¡Œé¢ç«¯å’Œæ‰‹æœºç«¯å…±ç”¨ï¼‰ */
        .ai-model-option,
        .ai-model-popup-option {
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.15s;
            margin: 3px 4px;
            border: 1px solid var(--bd);
            border-radius: 6px;
            background: var(--bg);
        }

        .ai-model-option:hover,
        .ai-model-popup-option:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .ai-model-option.selected,
        .ai-model-popup-option.selected {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
            border-width: 2px;
            padding: 7px 9px;
        }

        /* ğŸ¯ ç¦ç”¨çŠ¶æ€çš„æ¨¡å‹é€‰é¡¹ï¼ˆæœ¬åœ°æœåŠ¡ç¦»çº¿æ—¶ï¼‰ */
        .ai-model-option.disabled,
        .ai-model-popup-option.disabled {
            opacity: 0.4 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            background: var(--bg) !important;
        }

        .ai-model-option-header,
        .ai-model-popup-option-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }

        .ai-model-option-radio,
        .ai-model-popup-option-radio {
            width: 14px;
            height: 14px;
            border: 2px solid var(--muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-model-option.selected .ai-model-option-radio,
        .ai-model-popup-option.selected .ai-model-popup-option-radio {
            border-color: #3b82f6;
        }

        .ai-model-option.selected .ai-model-option-radio::after,
        .ai-model-popup-option.selected .ai-model-popup-option-radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
        }

        .ai-model-option-name,
        .ai-model-popup-option-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .ai-model-option-desc,
        .ai-model-popup-option-desc {
            font-size: 11px;
            color: var(--muted);
            line-height: 1.3;
            margin-left: 0;
        }

        /* æ‰‹æœºç«¯æ¨¡å‹é€‰æ‹©å®¹å™¨ï¼ˆæ¡Œé¢ç«¯é»˜è®¤éšè—ï¼‰ */
        .ai-model-selector-mobile {
            display: none;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            flex: 0 0 auto;
            position: relative;
            z-index: 100;
        }
        
        .ai-model-selector-mobile .ai-model-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* æ‰‹æœºç«¯æ¨¡å‹é€‰æ‹©æŒ‰é’® */
        .ai-model-mobile-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            height: 32px;
            white-space: nowrap;
            position: relative;
        }

        .ai-model-mobile-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-model-mobile-btn .ai-model-arrow {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            transition: transform 0.2s;
            transform: rotate(-90deg);
        }

        .ai-model-mobile-text {
            font-weight: 500;
        }

        /* æ‰‹æœºç«¯ä¸‹æ‹‰æ¡†ï¼ˆæ¡Œé¢ç«¯é»˜è®¤éšè—ï¼‰ */
        .ai-model-options-mobile {
            display: none;
        }

        /* æ‰‹æœºç«¯å¼¹çª—é€‰é¡¹æ ·å¼å·²åˆå¹¶åˆ°ç»Ÿä¸€æ ·å¼ä¸­ */

        /* ==================== ä¸­ç­‰å±å¹•UI (å¹³æ¿) ==================== */
        @media (max-width: 1024px) and (min-width: 769px) {
            .ai-suggestion {
                flex: 0 1 calc(33.333% - 8px) !important;
            }
        }

        /* ==================== æ‰‹æœºç«¯UI ==================== */
        @media (max-width: 768px) {
            /* 1. éšè—æ¡Œé¢ç«¯ä¸“ç”¨å…ƒç´  */
            .ai-model-selector {
                display: none !important;
            }
            
            .ai-status {
                display: none !important;
            }

            /* 2. AIåŠ©æ‰‹å®¹å™¨ */
            .ai-chat-container {
                margin-bottom: 20px;
            }
            
            /* 3. æ ‡é¢˜æ å¸ƒå±€ - æŠ˜å çŠ¶æ€ï¼ˆç®€æ´ï¼‰ */
            .ai-chat-header {
                padding: 14px 16px;
                flex: 0 0 auto;
                flex-direction: row;
                align-items: center;
                gap: 0;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .ai-chat-header > div:first-child {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }
            
            .ai-chat-header h3 {
                font-size: 15px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .ai-chat-header h3 span:first-child {
                font-size: 18px;
            }
            
            /* æç¤ºæ–‡å­— */
            .ai-collapsed-hint {
                font-size: 11px;
                opacity: 0.85;
                margin-left: auto;
                margin-right: 8px;
                flex-shrink: 0;
            }
            
            /* æŠ˜å æ—¶æ˜¾ç¤ºæç¤ºå’Œç®­å¤´ */
            .ai-chat-container.collapsed .ai-collapsed-hint {
                display: inline-block;
            }
            
            .ai-chat-container.collapsed .ai-toggle-icon {
                display: inline-block !important;
            }
            
            /* æ‰‹æœºç«¯æŠ˜å çŠ¶æ€ä¸‹ï¼Œheader éœ€è¦å®Œæ•´åœ†è§’ï¼ˆå› ä¸ºé¢„è®¾é—®é¢˜æ è¢«éšè—ï¼‰ */
            .ai-chat-container.collapsed .ai-chat-header {
                border-radius: calc(var(--radius) - 1px);
            }
            
            /* æ‰‹æœºç«¯æŠ˜å çŠ¶æ€ + æµå…‰æ•ˆæœï¼šè°ƒæ•´åœ†è§’ä»¥åŒ¹é…3pxè¾¹æ¡† */
            .ai-chat-container.collapsed.ai-responding .ai-chat-header {
                border-radius: calc(var(--radius) - 3px);
            }
            
            /* æ‰‹æœºç«¯å±•å¼€çŠ¶æ€ + æµå…‰æ•ˆæœï¼šè°ƒæ•´åœ†è§’ä»¥åŒ¹é…3pxè¾¹æ¡† */
            .ai-chat-container:not(.collapsed).ai-responding .ai-chat-header {
                border-radius: calc(var(--radius) - 3px) calc(var(--radius) - 3px) 0 0;
            }
            
            /* å±•å¼€æ—¶éšè—æç¤ºï¼Œä½†ä¿ç•™ç®­å¤´ */
            .ai-chat-container:not(.collapsed) .ai-collapsed-hint {
                display: none;
            }

            .ai-chat-container:not(.collapsed) .ai-toggle-icon {
                display: inline-block !important;
            }
            
            /* ç®­å¤´æ”¾å¤§ä¸€ç‚¹ */
            .ai-toggle-icon {
                font-size: 16px;
                flex-shrink: 0;
            }
            
            /* 4. å±•å¼€åçš„å¸ƒå±€ï¼ˆå¤æ‚ï¼‰ */
            .ai-chat-container:not(.collapsed) .ai-chat-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                padding: 16px;
            }
            
            .ai-chat-container:not(.collapsed) .ai-chat-header > div:first-child {
                justify-content: space-between;
            }
            
            /* 5. æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
            .ai-header-right {
                display: none !important;
                position: relative;
                gap: 10px;
                flex-wrap: wrap;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            /* å±•å¼€æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’® */
            .ai-chat-container:not(.collapsed) .ai-header-right {
                display: flex !important;
                opacity: 1;
            }
            
            /* æŠ˜å æ—¶ç¡®ä¿å®Œå…¨éšè— */
            .ai-chat-container.collapsed .ai-header-right {
                display: none !important;
                opacity: 0;
                height: 0;
                overflow: hidden;
            }
            
            .ai-clear-btn {
                padding: 10px 14px;
                font-size: 13px;
                flex: 0 0 auto;
            }
            
            .ai-model-selector-mobile {
                display: flex !important;
            }
            
            .ai-model-selector-mobile .ai-model-label {
                font-size: 13px;
            }
            
            .ai-model-mobile-btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            /* 6. æ‰‹æœºç«¯æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† */
            .ai-model-options-mobile {
                display: block;
                position: absolute;
                top: calc(100% + 8px);
                right: 0;
                width: auto;
                min-width: 150px;
                max-width: calc(100vw - 40px);
                background: var(--card);
                border: 1px solid var(--bd);
                border-radius: 8px;
                box-shadow: var(--shadow);
                padding: 8px 0;
                z-index: 10002;
                opacity: 0;
                visibility: hidden;
                transform: translateY(-8px);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .ai-model-options-mobile.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            
            /* ç»™æŒ‰é’®æ·»åŠ openç±»æ—¶ï¼Œç®­å¤´æ—‹è½¬æœä¸‹ */
            .ai-model-mobile-btn.open .ai-model-arrow {
                transform: rotate(0deg);
            }
            
            /* 7. æ•´ä½“å®¹å™¨ */
            .ai-chat-container {
                display: flex;
                flex-direction: column;
            }
            
            /* å¤´éƒ¨å›ºå®šé«˜åº¦ï¼Œä¸æŠ¢å æ»šåŠ¨ */
            .ai-chat-header {
                flex: 0 0 auto;
            }
            
            /* æ¶ˆæ¯åŒºï¼šå›ºå®šé«˜åº¦ï¼Œæ”¯æŒæ»šåŠ¨ */
            .ai-chat-messages {
                height: 50vh;
                max-height: 50vh;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 12px;
                transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
                opacity: 1;
            }
            
            /* æŠ˜å çŠ¶æ€ä¸‹å®Œå…¨éšè—æ¶ˆæ¯åŒº */
            .ai-chat-container.collapsed .ai-chat-messages {
                max-height: 0;
                opacity: 0;
                padding-top: 0;
                padding-bottom: 0;
                overflow: hidden;
            }
            
            /* 8. å¿«æ·é—®é¢˜æ ·å¼ */
            .ai-suggestions-collapse-wrapper {
                margin: 0;
                border-top: 1px solid var(--bd);
                background: white;
            }
            
            /* äº®è‰²æ¨¡å¼ä¸‹èƒŒæ™¯ä¸ºç™½è‰² */
            body:not(.dark-mode) .ai-suggestions-collapse-wrapper {
                background: white;
            }
            
            /* æš—è‰²æ¨¡å¼ä¸‹ä½¿ç”¨å¡ç‰‡è‰² */
            body.dark-mode .ai-suggestions-collapse-wrapper {
                background: var(--card);
            }
            
            .ai-suggestions-collapse-header {
                margin: 0;
                padding: 14px 16px;
                border-top: none;
            }
            
            /* æ˜¾ç¤ºå¿«æ·é—®é¢˜çš„ç®­å¤´ */
            .ai-suggestions-collapse-icon {
                display: inline-block !important;
                transition: transform 0.3s ease;
            }
            
            /* 9. è”åå›¾ - ä¸Šä¸‹æ’åˆ—å¤§å°ºå¯¸ */
            .ai-logo-container {
                flex-direction: column;
                gap: 24px;
                padding: 36px 20px;
                align-items: center;
            }
            
            .ai-logo-item {
                width: 100%;
                max-width: 220px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .ai-logo-item img {
                width: 100%;
                max-width: 220px;
                height: auto;
            }
            
            .ai-logo-separator {
                font-size: 36px;
                line-height: 1;
                transform: rotate(90deg);
                opacity: 0.7;
            }
            
            .ai-logo-label {
                font-size: 14px;
                text-align: center;
                line-height: 1.4;
                font-weight: 600;
                color: var(--text);
            }
            
            /* 10. å¿«æ·é—®é¢˜æ ï¼šæ‰‹æœºç«¯éšè—ï¼Œæ”¹ç”¨æŒ‰é’®å¼¹å‡º */
            .ai-suggestions-bar {
                display: none !important;
            }
            
            /* æ‰‹æœºç«¯æ˜¾ç¤ºé¢„è®¾é—®é¢˜æŒ‰é’® */
            .ai-suggestions-mobile-btn-wrapper {
                display: block !important;
                padding: 12px;
                background: var(--card);
                border-top: 1px solid var(--bd);
            }
            
            /* ç¡®ä¿æŒ‰é’®åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
            .ai-chat-input-area {
                border-top: 1px solid var(--bd);
            }
            
            /* æŠ˜å çŠ¶æ€ä¸‹éšè—é¢„è®¾é—®é¢˜æŒ‰é’® */
            .ai-chat-container.collapsed .ai-suggestions-mobile-btn-wrapper {
                display: none !important;
            }
            
            .ai-suggestion {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px 12px;
                font-size: 13px;
                font-weight: 500;
                background: var(--card);
                border: 1px solid var(--bd);
                border-radius: 8px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                cursor: pointer;
                transition: all 0.2s;
                min-height: 42px;
            }
            
            .ai-suggestion:active {
                transform: scale(0.98);
                background: rgba(59, 130, 246, 0.1);
            }
            
            /* éšè—æŠ˜å åˆ—è¡¨ */
            .ai-suggestions-collapse-wrapper {
                display: none !important;
            }
            
            /* 11. è¾“å…¥åŒº */
            .ai-chat-input-area {
                padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
                background: var(--card);
                border-top: 1px solid var(--bd);
                display: flex;
                gap: 10px;
                align-items: flex-end;
                overflow: hidden;
                transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
                max-height: 200px;
                opacity: 1;
            }
            
            /* æŠ˜å çŠ¶æ€ä¸‹å®Œå…¨éšè—è¾“å…¥åŒº */
            .ai-chat-container.collapsed .ai-chat-input-area {
                max-height: 0;
                opacity: 0;
                padding-top: 0;
                padding-bottom: 0;
                border-top: none;
            }
            
            /* é™åˆ¶å¤šè¡Œè¾“å…¥é«˜åº¦ï¼Œé¿å…é”®å…¥é•¿æ–‡æœ¬æ—¶æŠŠå¸ƒå±€æ’‘é«˜ */
            .ai-chat-input {
                font-size: 15px;
                padding: 12px 14px;
                min-height: 48px;
                max-height: 120px;
                overflow-y: auto;
            }
            
            .ai-send-btn {
                padding: 12px 20px;
                font-size: 15px;
                min-width: 88px;
            }
            
            /* 12. æ¶ˆæ¯å†…å®¹ */
            .ai-message-content {
                font-size: 14px;
                padding: 12px 14px;
            }
        }

        .ai-message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½ï¼Œå¤´åƒåœ¨å³è¾¹ */
        .ai-message.user {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .ai-message.user .ai-message-header {
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .ai-message.user .ai-message-avatar {
            background: var(--primary);
        }

        .ai-message.assistant .ai-message-avatar {
            background: var(--good);
        }

        .ai-message-content {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .ai-message.user .ai-message-content {
            background: var(--primary);
            color: white;
            margin-right: 32px;
            white-space: pre-wrap;
            max-width: 85%;
        }

        .ai-message.assistant .ai-message-content {
            background: var(--card);
            border: 1px solid var(--bd);
            color: var(--text);
            margin-left: 32px;
        }

        /* Markdown æ ·å¼ */
        .ai-message-content h1,
        .ai-message-content h2,
        .ai-message-content h3,
        .ai-message-content h4 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-message-content h1 { font-size: 1.5em; }
        .ai-message-content h2 { font-size: 1.3em; }
        .ai-message-content h3 { font-size: 1.1em; }

        .ai-message-content p {
            margin: 8px 0;
        }

        .ai-message-content ul,
        .ai-message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .ai-message-content li {
            margin: 4px 0;
        }

        .ai-message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .ai-message-content pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .ai-message-content pre code {
            background: none;
            padding: 0;
        }

        .ai-message-content strong {
            font-weight: 600;
        }

        .ai-message-content em {
            font-style: italic;
        }

        .ai-message-content blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 12px;
            margin: 8px 0;
            opacity: 0.8;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .ai-thinking-section {
            margin-bottom: 12px;
            border: 1px solid var(--bd);
            border-radius: 8px;
            overflow: hidden;
        }

        .ai-thinking-header {
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.08);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: background 0.2s;
        }

        .ai-thinking-header:hover {
            background: rgba(59, 130, 246, 0.12);
        }

        .ai-thinking-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-thinking-toggle {
            font-size: 12px;
            opacity: 0.7;
        }

        .ai-thinking-content {
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            color: var(--muted);
            font-size: 13px;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 1px solid var(--bd);
        }

        .ai-thinking-content.collapsed {
            display: none;
        }

        .ai-typing {
            display: inline-flex;
            gap: 4px;
            padding: 8px 0;
        }

        .ai-typing span {
            width: 8px;
            height: 8px;
            background: var(--muted);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .ai-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--bd);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.2s;
        }

        .ai-chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .ai-send-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }

        .ai-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .ai-send-btn:active {
            transform: translateY(0);
        }

        .ai-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* AI åœæ­¢æŒ‰é’®æ ·å¼ï¼ˆä¸­æ–­æµå¼å“åº”æ—¶ä½¿ç”¨ï¼‰ */
        .ai-send-btn.ai-stop-btn {
            background: #ef4444;
        }

        .ai-send-btn.ai-stop-btn:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .ai-welcome {
            text-align: center;
            padding: 30px 20px 40px 20px;
            color: var(--muted);
        }

        /* è”å Logo æ ·å¼ */
        .ai-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .ai-logo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ai-logo-item img {
            height: 60px;
            width: auto;
            object-fit: contain;
            transition: transform 0.3s;
        }

        .ai-logo-item img:hover {
            transform: scale(1.05);
        }

        .ai-logo-separator {
            font-size: 24px;
            color: var(--muted);
            font-weight: 300;
        }

        .ai-logo-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }

        /* å“åº”å¼ï¼šç«–å±æ—¶å‚ç›´æ’åˆ— logo */
        @media (max-width: 600px) {
            .ai-logo-container {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }
            
            .ai-logo-separator {
                transform: rotate(0deg);
                order: 0;
                margin: 2px 0;
            }
            
            .ai-logo-item:first-child {
                order: -1;
            }
            
            .ai-logo-item:last-child {
                order: 1;
            }
            
            /* AIæŠ˜å çŠ¶æ€ä¸‹éšè—å¿«æ·é—®é¢˜ */
            .ai-chat-container.collapsed .ai-suggestions {
                display: none !important;
            }
        }
        
        /* å“åº”å¼ï¼šå°å±å¹•æ—¶è°ƒæ•´å¸ƒå±€ */
        @media (max-width: 480px) {
            .ai-logo-container {
                gap: 8px;
            }
            
            .ai-logo-item img {
                height: 50px;
            }
            
            .ai-logo-separator {
                font-size: 20px;
            }
            
            /* æå°å±å¹•æ—¶å¿«æ·é—®é¢˜æ¯è¡Œ1ä¸ª */
            .ai-suggestion {
                flex: 0 1 100% !important;
                font-size: 14px !important;
            }
        }

        .ai-welcome-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 60px;
            color: var(--text);
        }

        .ai-welcome-desc {
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        /* åº•éƒ¨å¿«æ·é—®é¢˜æ ï¼ˆä¸å—æŠ˜å çŠ¶æ€å½±å“ï¼‰ */
        .ai-suggestions-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        /* æŠ˜å çŠ¶æ€ä¸‹ï¼Œé¢„è®¾é—®é¢˜æ éœ€è¦ä¸‹åœ†è§’ï¼ˆå®ƒæ˜¯æœ€åº•éƒ¨å…ƒç´ ï¼‰ */
        .ai-chat-container.collapsed .ai-suggestions-bar {
            border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
        }
        
        /* å¿«æ·é—®é¢˜æŠ˜å åˆ—è¡¨ï¼ˆä»…ç«–å±æ˜¾ç¤ºï¼‰ */
        .ai-suggestions-collapse-wrapper {
            display: none;
            border-top: 1px solid var(--bd);
            background: var(--bg);
        }
        
        .ai-suggestions-collapse-header {
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            background: var(--card);
            border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
        }
        
        .ai-suggestions-collapse-header:hover {
            background: var(--bg);
        }
        
        .ai-suggestions-collapse-header:active {
            background: var(--bd);
        }
        
        .ai-suggestions-collapse-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        
        .ai-suggestions-collapse-icon {
            font-size: 12px;
            color: var(--muted);
            transition: transform 0.3s ease;
            display: inline-block;
            transform: rotate(-90deg);
        }
        
        .ai-suggestions-collapse-icon.expanded {
            transform: rotate(0deg);
        }
        
        .ai-suggestions-collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .ai-suggestions-collapse-content.show {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* å½“æŠ˜å å†…å®¹å±•å¼€æ—¶ï¼ŒæŠ˜å å¤´éƒ¨ä¸éœ€è¦åº•éƒ¨åœ†è§’ */
        .ai-suggestions-collapse-wrapper:has(.ai-suggestions-collapse-content.show) .ai-suggestions-collapse-header {
            border-radius: 0;
        }
        
        .ai-suggestions-collapse-item {
            padding: 14px 20px;
            margin: 0;
            background: var(--card);
            border-bottom: 1px solid var(--bd);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text);
        }
        
        .ai-suggestions-collapse-item:last-child {
            border-bottom: none;
            border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
        }
        
        .ai-suggestions-collapse-item:hover {
            background: var(--primary);
            color: white;
            padding-left: 24px;
        }
        
        .ai-suggestions-collapse-item:active {
            background: #2563eb;
        }

        .ai-suggestion {
            padding: 10px 18px;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .ai-suggestion:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .ai-suggestion:active {
            transform: translateY(0);
        }
        
        /* æ‰‹æœºç«¯é¢„è®¾é—®é¢˜æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼Œä»…åœ¨æ‰‹æœºç«¯æ˜¾ç¤ºï¼‰ */
        .ai-suggestions-mobile-btn-wrapper {
            display: none;
        }
        
        .ai-suggestions-mobile-btn {
            width: 100%;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-suggestions-mobile-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .ai-suggestions-mobile-btn:active {
            transform: translateY(0);
        }
        
        /* æŒ‰é’®å±•å¼€æ—¶ï¼Œé¡¶éƒ¨åœ†è§’å˜ä¸ºç›´è§’ï¼Œä¸å¼¹çª—è¡”æ¥ */
        .ai-suggestions-mobile-btn.active {
            border-radius: 0 0 12px 12px;
        }
        
        .ai-suggestions-mobile-arrow {
            font-size: 12px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
        }
        
        .ai-suggestions-mobile-btn.active .ai-suggestions-mobile-arrow {
            transform: rotate(180deg);
        }
        
        /* æ‰‹æœºç«¯é¢„è®¾é—®é¢˜å¼¹çª—ï¼ˆä»æŒ‰é’®ä½ç½®å‘ä¸Šå¼¹å‡ºï¼‰ */
        .ai-suggestions-mobile-modal {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: transparent;
            z-index: 10002;
            pointer-events: none;
        }
        
        .ai-suggestions-mobile-modal.show {
            pointer-events: auto;
        }
        
        .ai-suggestions-mobile-content {
            position: fixed;
            background: var(--card);
            border: 1px solid var(--bd);
            border-bottom: none;
            border-radius: 12px 12px 0 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            /* å½“é«˜åº¦ä¸º0æ—¶ï¼Œéšè—è¾¹æ¡†ï¼Œé˜²æ­¢å‡ºç°é¡¶éƒ¨ç°çº¿ */
            visibility: hidden;
            opacity: 0;
        }
        
        .ai-suggestions-mobile-modal.show .ai-suggestions-mobile-content {
            visibility: visible;
            opacity: 1;
        }
        
        .ai-suggestions-mobile-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--bd);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            min-height: 44px;
        }

        .ai-suggestions-mobile-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        
        .ai-suggestions-mobile-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .ai-suggestions-mobile-close:hover {
            color: var(--text);
            background: var(--bg);
        }
        
        .ai-suggestions-mobile-list {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            align-content: start;
            grid-auto-rows: 48px;
        }
        
        .ai-suggestions-mobile-item {
            padding: 10px 8px;
            background: var(--bg);
            border: 1px solid var(--bd);
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 48px;
            min-height: 48px;
            max-height: 48px;
            width: 100%;
            word-break: break-word;
            overflow: hidden;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .ai-suggestions-mobile-item:active {
            transform: scale(0.98);
        }
        
        .ai-suggestions-mobile-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        /* å¿«æ·é—®é¢˜å¼¹çª— */
        .ai-suggestions-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        
        .ai-suggestions-modal.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        .ai-suggestions-modal.closing {
            opacity: 0;
        }
        
        .ai-suggestions-modal.closing .ai-suggestions-modal-content {
            animation: slideDownToBottom 0.3s ease forwards;
        }
        
        .ai-suggestions-modal-content {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideDownToBottom {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(100%);
            }
        }
        
        .ai-suggestions-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .ai-suggestions-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        
        .ai-suggestions-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 4px;
            line-height: 1;
        }
        
        .ai-suggestions-modal-close:hover {
            opacity: 1;
        }
        
        .ai-suggestions-modal-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ai-suggestions-modal-item {
            padding: 14px 18px;
            background: var(--bg);
            border: 1px solid var(--bd);
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--text);
            text-align: left;
        }
        
        .ai-suggestions-modal-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .ai-suggestions-modal-item:active {
            transform: translateX(4px) scale(0.98);
        }

        .stat-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--bd);
            display: flex;
            align-items: center;
            gap: 8px
        }

        .stats-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            text-align: center;
            transition: all .2s ease
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, .15)
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: .1em;
            margin-bottom: 8px
        }

        .stat-value {
            font-size: 32px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 4px
        }

        .stat-unit {
            font-size: 14px;
            color: var(--muted);
            font-weight: 600
        }

        .chart-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            margin-bottom: 20px
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .card-title {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .btn-group {
                gap: 12px;
                flex-direction: column;
            }
            
            .btn-group .btn {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
                font-size: 15px;
            }
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px
        }

        .chart-wrap {
            height: 320px;
            position: relative
        }

        canvas {
            background: transparent;
            border-radius: 12px
        }

        .table-wrap {
            max-height: 500px;
            overflow: auto;
            border-radius: var(--radius);
            border: 1px solid var(--bd)
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: var(--card);
            color: var(--muted);
            font-weight: 700;
            font-size: 13px;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--bd)
        }

        tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--bd);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums
        }

        tbody tr:nth-child(even) {
            background: color-mix(in srgb, var(--card) 90%, var(--bd))
        }

        tbody tr:hover {
            background: color-mix(in srgb, var(--card) 80%, var(--bd))
        }

        .right {
            text-align: right
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 16px
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--bd);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* é€šçŸ¥æ ·å¼å·²ç§»è‡³ common-notification.js */

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted)
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: .3
        }

        /* åˆ†æé¡µç‰¹å®šæ ·å¼ */
        .chart-title-with-info {
            margin-bottom: 16px
        }

        /* å›¾è¡¨æ“ä½œæŒ‰é’®æ ·å¼ */
        .chart-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px
        }

        .chart-actions {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
            align-items: center
        }
        
        @media (max-width: 768px) {
            .chart-actions {
                gap: 2px
            }
            
            .chart-actions .btn {
                padding: 6px 8px;
                font-size: 10px;
                min-width: 28px
            }
        }

        /* å›¾è¡¨å³ä¸‹è§’åŠå…¨å±æŒ‰é’® */
        .fullscreen-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            z-index: 3;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--bd);
            background: color-mix(in srgb, var(--card) 80%, black 0%);
            color: var(--muted);
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: .9;
            transition: all .2s ease
        }

        .fullscreen-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            opacity: 1
        }

        .fullscreen-btn:active {
            transform: translateY(0) scale(0.95)
        }

        /* åŠé€æ˜å…¨å±å¼¹å±‚ */
        .overlay {
            position: fixed;
            inset: 0;
            display: flex; /* å…è®¸è¿‡æ¸¡åŠ¨ç”» */
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .35);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .22s ease;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            width: min(1200px, 92vw);
            height: min(800px, 86vh);
            display: flex;
            flex-direction: column;
            background: color-mix(in srgb, var(--card) 100%, transparent 0%);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateY(8px) scale(.985);
            transition: transform .25s ease;
        }

        .overlay.show .modal { transform: translateY(0) scale(1); }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--bd);
            flex-shrink: 0;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .modal-actions .btn {
            padding: 6px 10px;
            font-size: 12px;
            min-width: 32px;
        }

        .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .modal-body {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }

        .modal-body .chart-wrap {
            height: 100%;
            position: relative;
        }

    </style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>ğŸ“Š æ•°æ®åˆ†æ</h1>
        <div class="nav-actions">
            <a href="/" class="btn">ğŸ  è¿”å›é¦–é¡µ</a>
            <div class="menu-wrapper">
                <div class="menu-btn" id="menuBtn">
                    <span>âš™ï¸ åŠŸèƒ½</span>
                    <span style="font-size: 10px; transition: transform .2s ease" id="menuArrow">â–¼</span>
                    <span class="menu-btn-badge" id="menuBtnBadge"></span>
                </div>
                <div class="menu-dropdown" id="menuDropdown">
                    <div class="menu-item" id="messageCenterBtn" title="æŸ¥çœ‹è­¦å‘Šæ¶ˆæ¯ä¸­å¿ƒ">
                        <span>ğŸ””</span>
                        <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
                        <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                    </div>
                    <div class="menu-item" data-power-control-trigger title="çœç”µæ§åˆ¶">
                        <span>ğŸ”‹</span>
                        <span>çœç”µæ§åˆ¶</span>
                    </div>
                    <div class="menu-item" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜æ¨¡å¼">
                        <span>ğŸŒ™</span>
                        <span>åˆ‡æ¢ä¸»é¢˜</span>
                    </div>
                    <div class="menu-item" id="aboutBtn" title="å…³äºé¡¹ç›®">
                        <span>â„¹ï¸</span>
                        <span>å…³äºé¡¹ç›®</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- æ•°æ®åŠ è½½åŒº -->
    <div class="card" id="dataLoadCard">
        <div class="card-title">ğŸ” æ•°æ®åŠ è½½</div>
        <p style="color: var(--muted); margin-bottom: 16px; line-height: 1.6;">
            é€‰æ‹©æ•°æ®åŠ è½½æ–¹å¼ï¼Œæ”¯æŒæŒ‰æ¡æ•°ã€æŒ‰æ—¶é—´èŒƒå›´ã€è‡ªå®šä¹‰æ—¶é—´æˆ–åŠ è½½å…¨éƒ¨æ•°æ®ã€‚
        </p>
        <div class="btn-group">
            <button class="btn primary" onclick="openLoadModal()">ğŸ“¥ åŠ è½½æ•°æ®</button>
            <button class="btn" id="clearDataBtn">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        </div>
    </div>

    <!-- AI åˆ†æåŠ©æ‰‹ -->
    <div class="ai-chat-container collapsed" id="aiChatContainer">
        <div class="ai-chat-header" onclick="toggleAIChat()">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <h3>
                    <span>ğŸ¤–</span>
                    <span>AI æ•°æ®åˆ†æåŠ©æ‰‹</span>
                </h3>
                <span class="ai-collapsed-hint">ç‚¹å‡»æ­¤å¤„ä»¥å±•å¼€</span>
            </div>
            
            <div class="ai-header-right" onclick="event.stopPropagation()">
                <!-- æ¸…ç©ºèŠå¤©æŒ‰é’® -->
                <button class="ai-clear-btn" onclick="clearAIChat()" title="æ¸…ç©ºèŠå¤©è®°å½•">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
                
                <!-- æ¡Œé¢ç«¯ï¼šè‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨ -->
                <div class="ai-model-selector">
                    <span>æ¨¡å‹:</span>
                    <div class="ai-model-custom-select" id="aiModelCustomSelect">
                        <div class="ai-model-selected" id="aiModelSelected" title="ç‚¹å‡»åˆ‡æ¢æ¨¡å‹">
                            <span class="ai-model-selected-text">DeepSeek V3.2</span>
                            <span class="ai-model-arrow">â–¼</span>
                        </div>
                        <div class="ai-model-options" id="aiModelOptions">
                            <div class="ai-model-option" data-value="deepseek-r1-0528-qwen3-8b">
                                <div class="ai-model-option-header">
                                    <div class="ai-model-option-radio"></div>
                                    <div class="ai-model-option-name">DeepSeek R1 8B</div>
                                </div>
                                <div class="ai-model-option-desc">âš¡ å¿«é€Ÿæ€è€ƒï¼Œé€‚åˆç®€å•é—®é¢˜</div>
                            </div>
                            <div class="ai-model-option" data-value="gemma 3">
                                <div class="ai-model-option-header">
                                    <div class="ai-model-option-radio"></div>
                                    <div class="ai-model-option-name">Gemma 3 4B</div>
                                </div>
                                <div class="ai-model-option-desc">ğŸŒ  å¿«é€Ÿå›ç­”ï¼Œé€‚åˆç›´å‡ºç­”æ¡ˆ</div>
                            </div>
                            <div class="ai-model-option" data-value="qwq-32b">
                                <div class="ai-model-option-header">
                                    <div class="ai-model-option-radio"></div>
                                    <div class="ai-model-option-name">Qwen QWQ 32B</div>
                                </div>
                                <div class="ai-model-option-desc">ğŸ§  æ·±åº¦æ€è€ƒï¼Œé€‚åˆå¤æ‚é—®é¢˜</div>
                            </div>
                            <div class="ai-model-option selected" data-value="deepseek-reasoner">
                                <div class="ai-model-option-header">
                                    <div class="ai-model-option-radio"></div>
                                    <div class="ai-model-option-name">DeepSeek V3.2</div>
                                </div>
                                <div class="ai-model-option-desc">ğŸš€ æ·±åº¦æ€è€ƒï¼Œå®˜ç½‘å…¨å‚æ¨¡å‹</div>
                            </div>
                        </div>
                    </div>
                    <!-- éšè—çš„çœŸå®selectï¼Œç”¨äºå­˜å‚¨å€¼ -->
                    <select id="aiModelInput" style="display: none;">
                        <option value="deepseek-r1-0528-qwen3-8b">DeepSeek R1 8B</option>
                        <option value="gemma 3">Gemma 3 4B</option>
                        <option value="qwq-32b">Qwen QWQ 32B</option>
                        <option value="deepseek-reasoner" selected>DeepSeek V3.2</option>
                    </select>
                </div>
                
                <!-- æ‰‹æœºç«¯ï¼šæ˜¾ç¤ºå½“å‰æ¨¡å‹åç§°æŒ‰é’® -->
                <div class="ai-model-selector-mobile">
                    <span class="ai-model-label">æ¨¡å‹:</span>
                    <button class="ai-model-mobile-btn" id="aiModelMobileBtn" title="ç‚¹å‡»åˆ‡æ¢æ¨¡å‹">
                        <span class="ai-model-mobile-text">DeepSeek V3.2</span>
                        <span class="ai-model-arrow">â–¼</span>
                    </button>
                    
                    <!-- æ‰‹æœºç«¯ä¸‹æ‹‰æ¡† -->
                    <div class="ai-model-options-mobile" id="aiModelOptionsMobile">
                        <div class="ai-model-option" data-value="deepseek-r1-0528-qwen3-8b">
                            <div class="ai-model-option-header">
                                <div class="ai-model-option-radio"></div>
                                <div class="ai-model-option-name">DeepSeek R1 8B</div>
                            </div>
                            <div class="ai-model-option-desc">âš¡ å“åº”å¿«é€Ÿï¼Œé€‚åˆç®€å•é—®é¢˜</div>
                        </div>
                        <div class="ai-model-option" data-value="gemma 3">
                            <div class="ai-model-option-header">
                                <div class="ai-model-option-radio"></div>
                                <div class="ai-model-option-name">Gemma 3 4B</div>
                            </div>
                            <div class="ai-model-option-desc">ğŸŒ  å¿«é€Ÿå›ç­”ï¼Œé€‚åˆç›´å‡ºç­”æ¡ˆ</div>
                        </div>
                        <div class="ai-model-option" data-value="qwq-32b">
                            <div class="ai-model-option-header">
                                <div class="ai-model-option-radio"></div>
                                <div class="ai-model-option-name">Qwen QWQ 32B</div>
                            </div>
                            <div class="ai-model-option-desc">ğŸ§  æ·±åº¦æ€è€ƒï¼Œé€‚åˆå¤æ‚é—®é¢˜</div>
                        </div>
                        <div class="ai-model-option selected" data-value="deepseek-reasoner">
                            <div class="ai-model-option-header">
                                <div class="ai-model-option-radio"></div>
                                <div class="ai-model-option-name">DeepSeek V3.2</div>
                            </div>
                            <div class="ai-model-option-desc">ğŸš€ æ·±åº¦æ€è€ƒï¼Œå®˜ç½‘å…¨å‚æ¨¡å‹</div>
                        </div>
                    </div>
                </div>
                
                <div class="ai-status" style="cursor: pointer;" id="aiStatusContainer" title="æœ¬åœ°æ¨¡å‹åœ¨çº¿ - ç‚¹å‡»é‡æ–°æ£€æµ‹" onclick="handleAIStatusClick(event)">
                    <div class="ai-status-dot"></div>
                    <span id="aiStatusText">æœ¬åœ°åœ¨çº¿</span>
                </div>
            </div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-welcome">
                <!-- è”å Logo -->
                <div class="ai-logo-container">
                    <div class="ai-logo-item">
                        <img src="/resource/logo.png" alt="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ">
                        <div class="ai-logo-label">æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</div>
                    </div>
                    <div class="ai-logo-separator">Ã—</div>
                    <div class="ai-logo-item">
                        <img class="ai-logo-image" src="/resource/deepseek.png" alt="DeepSeek AI">
                        <div class="ai-logo-label ai-logo-text">DeepSeek AI</div>
                    </div>
                </div>
                
                <div class="ai-welcome-title">æ¬¢è¿ä½¿ç”¨ AI æ•°æ®åˆ†æåŠ©æ‰‹</div>
                <div class="ai-welcome-desc">
                    æˆ‘å¯ä»¥å¸®ä½ åˆ†æå½“å‰åŠ è½½çš„ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæä¾›æ´å¯Ÿå’Œå»ºè®®ã€‚<br>
                    <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
                    1ï¸âƒ£ ç¡®è®¤é¡¶éƒ¨æ¨¡å‹åç§°æ­£ç¡®<br>
                    2ï¸âƒ£ åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®<br>
                    3ï¸âƒ£ å‘æˆ‘æé—®æˆ–ç‚¹å‡»ä¸‹æ–¹å¿«æ·é—®é¢˜
                </div>
            </div>
        </div>
        <!-- å¸¸é©»çš„å¿«æ·é—®é¢˜ï¼ˆæ¨ªå±æ˜¾ç¤ºï¼Œ6ä¸ªé—®é¢˜ï¼‰ -->
        <div class="ai-suggestions-bar" style="padding: 12px 20px; background: var(--bg); border-top: 1px solid var(--bd);">
            <div class="ai-suggestion" onclick="sendSuggestion('åˆ†ææ¸©åº¦è¶‹åŠ¿')">ğŸ“ˆ åˆ†ææ¸©åº¦è¶‹åŠ¿</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ')">ğŸ’§ æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æ€»ç»“æ•°æ®ç‰¹å¾')">ğŸ“Š æ€»ç»“æ•°æ®ç‰¹å¾</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ')">âš ï¸ æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ</div>
            <div class="ai-suggestion" onclick="sendSuggestion('å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ')">ğŸ’¡ å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ</div>
            <div class="ai-suggestion" onclick="sendSuggestion('çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ')">ğŸŒ«ï¸ çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ</div>
        </div>
        
        <!-- å¿«æ·é—®é¢˜æŠ˜å åˆ—è¡¨ï¼ˆç«–å±æ˜¾ç¤ºï¼‰ -->
        <div class="ai-suggestions-collapse-wrapper">
            <div class="ai-suggestions-collapse-header" onclick="toggleSuggestionsCollapse()">
                <span class="ai-suggestions-collapse-title">ğŸ’¡ å¿«æ·é—®é¢˜</span>
                <span class="ai-suggestions-collapse-icon" id="suggestionsCollapseIcon">â–¼</span>
            </div>
            <div class="ai-suggestions-collapse-content" id="suggestionsCollapseContent">
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('åˆ†ææ¸©åº¦è¶‹åŠ¿')">
                    ğŸ“ˆ åˆ†ææ¸©åº¦è¶‹åŠ¿
                </div>
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ')">
                    ğŸ’§ æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ
                </div>
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('æ€»ç»“æ•°æ®ç‰¹å¾')">
                    ğŸ“Š æ€»ç»“æ•°æ®ç‰¹å¾
                </div>
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ')">
                    âš ï¸ æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ
                </div>
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ')">
                    ğŸ’¡ å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ
                </div>
                <div class="ai-suggestions-collapse-item" onclick="sendSuggestion('çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ')">
                    ğŸŒ«ï¸ çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ
                </div>
            </div>
        </div>
        <!-- æ‰‹æœºç«¯é¢„è®¾é—®é¢˜æŒ‰é’®ï¼ˆä»…æ‰‹æœºç«¯æ˜¾ç¤ºï¼‰ -->
        <div class="ai-suggestions-mobile-btn-wrapper">
            <button class="ai-suggestions-mobile-btn" id="aiSuggestionsMobileBtn" onclick="toggleMobileSuggestions()">
                <span>ğŸ’¡ é¢„è®¾é—®é¢˜</span>
                <span class="ai-suggestions-mobile-arrow">â–¼</span>
            </button>
        </div>
        <div class="ai-chat-input-area">
            <textarea 
                id="aiChatInput" 
                class="ai-chat-input" 
                placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒShift+Enter æ¢è¡Œ..."
                rows="1"
            ></textarea>
            <button id="aiSendBtn" class="ai-send-btn" onclick="handleAISendClick()">
                <span>ğŸ“¤ å‘é€</span>
            </button>
        </div>
    </div>

    <!-- æ‰‹æœºç«¯é¢„è®¾é—®é¢˜å¼¹çª—ï¼ˆå‘ä¸Šå¼¹å‡ºï¼‰ -->
    <div id="aiSuggestionsMobileModal" class="ai-suggestions-mobile-modal" onclick="closeMobileSuggestions(event)">
        <div class="ai-suggestions-mobile-content" onclick="event.stopPropagation()">
            <div class="ai-suggestions-mobile-header">
                <span class="ai-suggestions-mobile-title">ğŸ’¡ é¢„è®¾é—®é¢˜</span>
                <button class="ai-suggestions-mobile-close" onclick="closeMobileSuggestions()">âœ•</button>
            </div>
            <div class="ai-suggestions-mobile-list">
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('åˆ†ææ¸©åº¦è¶‹åŠ¿')">
                    ğŸ“ˆ åˆ†ææ¸©åº¦è¶‹åŠ¿
                </div>
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ')">
                    ğŸ’§ æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ
                </div>
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('æ€»ç»“æ•°æ®ç‰¹å¾')">
                    ğŸ“Š æ€»ç»“æ•°æ®ç‰¹å¾
                </div>
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ')">
                    âš ï¸ æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ
                </div>
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ')">
                    ğŸ’¡ å…‰ç…§å¼ºåº¦å¦‚ä½•ï¼Ÿ
                </div>
                <div class="ai-suggestions-mobile-item" onclick="selectMobileSuggestion('çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ')">
                    ğŸŒ«ï¸ çƒŸé›¾æµ“åº¦æ­£å¸¸å—ï¼Ÿ
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingState" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <!-- æ•°æ®ä¸ºç©ºçŠ¶æ€ -->
    <div id="emptyState" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 17v-6a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6m-6 0H7m8 0h2M4 7h16M4 7v13h16V7M8 3h8"/>
        </svg>
        <div style="font-size: 18px; margin-bottom: 8px;">æš‚æ— æ•°æ®</div>
        <div style="font-size: 14px;">è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"åŠ è½½æ•°æ®"</div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div id="statsSection" style="display: none;">
        <!-- åŸºç¡€ç»Ÿè®¡ -->
        <div class="stat-section">
            <div class="stat-section-title">ğŸ“Š åŸºç¡€ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®æ€»é‡</div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-unit">æ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ—¶é—´è·¨åº¦</div>
                    <div class="stat-value" id="statTimeSpan">--</div>
                    <div class="stat-unit">å°æ—¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¼€å§‹æ—¶é—´</div>
                    <div class="stat-value" style="font-size: 18px" id="statStartTime">--</div>
                    <div class="stat-unit">æ—¶åˆ»</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç»“æŸæ—¶é—´</div>
                    <div class="stat-value" style="font-size: 18px" id="statEndTime">--</div>
                    <div class="stat-unit">æ—¶åˆ»</div>
                </div>
            </div>
        </div>

        <!-- æ¸©åº¦ç»Ÿè®¡ -->
        <div class="stat-section">
            <div class="stat-section-title">ğŸŒ¡ï¸ æ¸©åº¦ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ¸©åº¦</div>
                    <div class="stat-value" id="statAvgTemp">--</div>
                    <div class="stat-unit">Â°C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜æ¸©åº¦</div>
                    <div class="stat-value" id="statMaxTemp">--</div>
                    <div class="stat-unit">Â°C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€ä½æ¸©åº¦</div>
                    <div class="stat-value" id="statMinTemp">--</div>
                    <div class="stat-unit">Â°C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ¸©åº¦æ³¢åŠ¨</div>
                    <div class="stat-value" id="statTempRange">--</div>
                    <div class="stat-unit">Â°C</div>
                </div>
            </div>
        </div>

        <!-- æ¹¿åº¦ç»Ÿè®¡ -->
        <div class="stat-section">
            <div class="stat-section-title">ğŸ’§ æ¹¿åº¦ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ¹¿åº¦</div>
                    <div class="stat-value" id="statAvgHum">--</div>
                    <div class="stat-unit">%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜æ¹¿åº¦</div>
                    <div class="stat-value" id="statMaxHum">--</div>
                    <div class="stat-unit">%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€ä½æ¹¿åº¦</div>
                    <div class="stat-value" id="statMinHum">--</div>
                    <div class="stat-unit">%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ¹¿åº¦æ³¢åŠ¨</div>
                    <div class="stat-value" id="statHumRange">--</div>
                    <div class="stat-unit">%</div>
                </div>
            </div>
        </div>

        <!-- ç¯å¢ƒç»Ÿè®¡ -->
        <div class="stat-section">
            <div class="stat-section-title">ğŸ’¡ ç¯å¢ƒç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡äº®åº¦</div>
                    <div class="stat-value" id="statAvgLux">--</div>
                    <div class="stat-unit">lx</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜äº®åº¦</div>
                    <div class="stat-value" id="statMaxLux">--</div>
                    <div class="stat-unit">lx</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡çƒŸé›¾</div>
                    <div class="stat-value" id="statAvgSmoke">--</div>
                    <div class="stat-unit">ppm</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜çƒŸé›¾</div>
                    <div class="stat-value" id="statMaxSmoke">--</div>
                    <div class="stat-unit">ppm</div>
                </div>
            </div>
        </div>

        <!-- å¤§æ°”å‹ç»Ÿè®¡ -->
        <div class="stat-section">
            <div class="stat-section-title">ğŸŒ¤ï¸ å¤§æ°”å‹ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ°”å‹</div>
                    <div class="stat-value" id="statAvgPressure">--</div>
                    <div class="stat-unit">hPa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜æ°”å‹</div>
                    <div class="stat-value" id="statMaxPressure">--</div>
                    <div class="stat-unit">hPa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€ä½æ°”å‹</div>
                    <div class="stat-value" id="statMinPressure">--</div>
                    <div class="stat-unit">hPa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ°”å‹å˜åŒ–</div>
                    <div class="stat-value" id="statRangePressure">--</div>
                    <div class="stat-unit">hPa</div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">æ¸©æ¹¿åº¦è¶‹åŠ¿å¯¹æ¯”</div>
                    <span class="info-btn" onclick="showInfo('trend')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInTrend" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”+</button>
                        <button id="zoomOutTrend" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”-</button>
                        <button id="panLeftTrend" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†</button>
                        <button id="panRightTrend" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†’</button>
                        <button id="resetTrend" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„</button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartTrend"></canvas>
                    <button id="openFullTrend" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹æ¸©æ¹¿åº¦è¶‹åŠ¿å¯¹æ¯”">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">äº®åº¦ä¸çƒŸé›¾è¶‹åŠ¿</div>
                    <span class="info-btn" onclick="showInfo('lux-smoke')">i</span>
                    </div>
                    <div class="chart-actions">
                        <button id="zoomInLuxSmoke" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”+</button>
                        <button id="zoomOutLuxSmoke" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”-</button>
                        <button id="panLeftLuxSmoke" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†</button>
                        <button id="panRightLuxSmoke" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">â†’</button>
                        <button id="resetLuxSmoke" class="btn" style="padding:4px 6px;font-size:11px;min-width:32px;">ğŸ”„</button>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartLuxSmoke"></canvas>
                    <button id="openFullLuxSmoke" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹äº®åº¦ä¸çƒŸé›¾è¶‹åŠ¿">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">æ¸©åº¦åˆ†å¸ƒ</div>
                    <span class="info-btn" onclick="showInfo('temp-dist')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartTempDist"></canvas>
                    <button id="openFullTempDist" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹æ¸©åº¦åˆ†å¸ƒ">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">æ¹¿åº¦åˆ†å¸ƒ</div>
                    <span class="info-btn" onclick="showInfo('hum-dist')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartHumDist"></canvas>
                    <button id="openFullHumDist" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹æ¹¿åº¦åˆ†å¸ƒ">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">å°æ—¶ç»Ÿè®¡ï¼ˆå¹³å‡æ¸©åº¦ï¼‰</div>
                    <span class="info-btn" onclick="showInfo('hourly')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartHourly"></canvas>
                    <button id="openFullHourly" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹å°æ—¶ç»Ÿè®¡">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">æ¸©æ¹¿åº¦ç›¸å…³æ€§</div>
                    <span class="info-btn" onclick="showInfo('correlation')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartCorrelation"></canvas>
                    <button id="openFullCorrelation" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹æ¸©æ¹¿åº¦ç›¸å…³æ€§">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">ğŸŒ¡ï¸ å¤§æ°”å‹è¶‹åŠ¿</div>
                    <span class="info-btn" onclick="showInfo('pressure-trend')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartPressureTrend"></canvas>
                    <button id="openFullPressureTrend" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹å¤§æ°”å‹è¶‹åŠ¿">â¤¢</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-head">
                <div class="chart-title-with-info">
                    <div class="card-title">ğŸ“Š å¤§æ°”å‹åˆ†å¸ƒ</div>
                    <span class="info-btn" onclick="showInfo('pressure-dist')">i</span>
                    </div>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartPressureDist"></canvas>
                    <button id="openFullPressureDist" class="fullscreen-btn" title="åŠå…¨å±æŸ¥çœ‹å¤§æ°”å‹åˆ†å¸ƒ">â¤¢</button>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <div class="card-title">ğŸ“‹ æ•°æ®æ˜ç»†ï¼ˆæœ€å¤šæ˜¾ç¤º 500 æ¡ï¼‰</div>
            <div class="table-wrap">
                <table>
                    <thead>
                    <tr>
                        <th style="width: 20%">æ—¶é—´</th>
                        <th class="right" style="width: 13%">æ¸©åº¦ (Â°C)</th>
                        <th class="right" style="width: 13%">æ¹¿åº¦ (%)</th>
                        <th class="right" style="width: 16%">äº®åº¦ (lx)</th>
                        <th class="right" style="width: 16%">çƒŸé›¾ (ppm)</th>
                        <th class="right" style="width: 16%">å¤§æ°”å‹ (hPa)</th>
                    </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/changelog-data.js?v=20250205"></script>
<script src="/static/common.js?v=20250205"></script>

<script>
    // ä¸»é¢˜ç³»ç»Ÿã€å·¥å…·å‡½æ•°ã€é€šçŸ¥ç³»ç»Ÿã€æ•°æ®åŠ è½½ç³»ç»Ÿå·²ç§»è‡³ common.js
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    const DEVICE_STORAGE_KEY = 'device_overview_selected';
    let requireDeviceSelection = true;
    let pendingMessageCenterDeviceId = null;

    function normalizeDeviceId(id) {
        if (!id && id !== 0) return '';
        return String(id).trim().toUpperCase();
    }

    function applySelectedDevice(deviceId) {
        const normalized = normalizeDeviceId(deviceId);
        if (!normalized) return;
        window.selectedDeviceId = normalized;
        requireDeviceSelection = false;
        try {
            localStorage.setItem(DEVICE_STORAGE_KEY, normalized);
        } catch (error) {
            console.warn('ä¿å­˜è®¾å¤‡é€‰æ‹©å¤±è´¥ï¼š', error);
        }
    }

    async function openDeviceSelector(hintText) {
        if (typeof window.openDevicePicker === 'function') {
            return window.openDevicePicker(hintText, requireDeviceSelection ? null : window.selectedDeviceId);
        }
        return null;
    }

    function closeFunctionMenuDropdown() {
        const menuDropdown = document.getElementById('menuDropdown');
        const menuBtn = document.getElementById('menuBtn');
        const menuArrow = document.getElementById('menuArrow');
        if (menuDropdown && menuDropdown.classList.contains('show')) {
            menuDropdown.classList.remove('show');
            menuBtn?.classList.remove('active');
            if (menuArrow) {
                menuArrow.style.transform = 'rotate(0deg)';
            }
        }
    }

    function setupAnalysisMessageCenterSelection() {
        const messageBtn = document.getElementById('messageCenterBtn');
        if (!messageBtn) return;

        window.setPendingMessageCenterDevice = function (deviceId) {
            pendingMessageCenterDeviceId = deviceId ? normalizeDeviceId(deviceId) : null;
        };

        if (window.MessageCenter && typeof window.MessageCenter.setBeforeOpenHook === 'function') {
            window.MessageCenter.setBeforeOpenHook(() => {
                if (pendingMessageCenterDeviceId) {
                    const deviceId = pendingMessageCenterDeviceId;
                    pendingMessageCenterDeviceId = null;
                    return deviceId;
                }
                return window.selectedDeviceId || null;
            });
        }

        messageBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            closeFunctionMenuDropdown();

            const deviceId = await openDeviceSelector('è¯·é€‰æ‹©è¦æŸ¥çœ‹æ¶ˆæ¯çš„è®¾å¤‡');
            if (!deviceId) return;

            applySelectedDevice(deviceId);
            pendingMessageCenterDeviceId = normalizeDeviceId(deviceId);

            setTimeout(() => {
                if (window.MessageCenter && typeof window.MessageCenter.open === 'function') {
                    window.MessageCenter.open();
                }
            }, 80);
        }, true);
    }

    function setupAnalysisPowerControlGuard() {
        const originalBtn = document.querySelector('[data-power-control-trigger]');
        if (!originalBtn) return;

        const powerBtn = originalBtn.cloneNode(true);
        originalBtn.parentNode.replaceChild(powerBtn, originalBtn);

        powerBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            closeFunctionMenuDropdown();

            const deviceId = await openDeviceSelector('è¯·é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡');
            if (!deviceId) return;

            applySelectedDevice(deviceId);

            if (window.PowerControlModal && typeof window.PowerControlModal.open === 'function') {
                window.PowerControlModal.open(normalizeDeviceId(deviceId));
            } else {
                console.error('PowerControlModal æœªåˆå§‹åŒ–');
            }
        }, true);
    }

    document.addEventListener('DOMContentLoaded', () => {
        try {
            const saved = localStorage.getItem(DEVICE_STORAGE_KEY);
            const normalized = normalizeDeviceId(saved);
            if (normalized) {
                window.selectedDeviceId = normalized;
                requireDeviceSelection = false;
            }
        } catch (error) {
            console.warn('è¯»å–è®¾å¤‡é€‰æ‹©å¤±è´¥ï¼š', error);
        }
        setupAnalysisMessageCenterSelection();
        setupAnalysisPowerControlGuard();
    });

    window.addEventListener('load', function() {
        // åˆå§‹åŒ–å¸®åŠ©å¼¹çª—å’ŒåŠŸèƒ½èœå•
        initHelpModal();
        initAboutModal();
        initFunctionMenu();
        
        // åˆå§‹åŒ–æ¶ˆæ¯ä¸­å¿ƒ
        if (window.MessageCenter) {
            window.MessageCenter.init();
            window.MessageCenter.loadUnreadWarningCount();
        }
        
        // è¿æ¥WebSocketï¼ˆç”¨äºæ¥æ”¶è­¦å‘Šæ¶ˆæ¯ï¼‰
        connectWebSocket();
        
        // è®¾ç½®ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        setupThemeToggle('themeBtn');
        
        // æ³¨å†ŒChart.js zoomæ’ä»¶
        const ZoomPlugin = window.ChartZoom || window.chartjsPluginZoom || window.zoomPlugin || window.Zoom;
        if (ZoomPlugin) {
            Chart.register(ZoomPlugin);
            console.log('Chart.js zoom plugin loaded successfully');
        } else {
            console.error('Chart.js zoom plugin not found');
        }
    });

    // å…¨å±€æ•°æ®å­˜å‚¨
    let currentData = [];
    let charts = {};
    
    // è®¾å¤‡ä¿¡æ¯å­˜å‚¨ï¼ˆç”¨äº AI åˆ†æï¼‰
    let analysisDeviceInfo = {
        deviceId: null,  // null è¡¨ç¤ºå…¨éƒ¨è®¾å¤‡ï¼Œå¦åˆ™æ˜¯è®¾å¤‡ID
        deviceName: null,  // è®¾å¤‡åç§°
        isMultiDevice: false  // æ˜¯å¦ä¸ºå¤šè®¾å¤‡æ•°æ®
    };
    
    // è®¾ç½®åˆ†æè®¾å¤‡ä¿¡æ¯ï¼ˆç”± common.js è°ƒç”¨ï¼‰
    window.setAnalysisDeviceInfo = async function(deviceId) {
        analysisDeviceInfo.deviceId = deviceId;
        analysisDeviceInfo.isMultiDevice = !deviceId;
        
        if (deviceId) {
            // å•è®¾å¤‡ï¼šè·å–è®¾å¤‡åç§°
            try {
                const res = await fetch('/api/devices');
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.devices) {
                        const device = data.devices.find(d => {
                            const id = (d.id || d.device_id || '').toString().trim().toUpperCase();
                            return id === deviceId.toUpperCase();
                        });
                        analysisDeviceInfo.deviceName = device ? (device.name || `è®¾å¤‡ ${deviceId}`) : `è®¾å¤‡ ${deviceId}`;
                    }
                }
            } catch (error) {
                console.warn('è·å–è®¾å¤‡åç§°å¤±è´¥ï¼š', error);
                analysisDeviceInfo.deviceName = `è®¾å¤‡ ${deviceId}`;
            }
        } else {
            // å…¨éƒ¨è®¾å¤‡ï¼šè·å–æ‰€æœ‰è®¾å¤‡åç§°
            try {
                const res = await fetch('/api/devices');
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.devices) {
                        analysisDeviceInfo.deviceName = data.devices.map(d => d.name || `è®¾å¤‡ ${d.id}`).join('ã€');
                    }
                }
            } catch (error) {
                console.warn('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š', error);
                analysisDeviceInfo.deviceName = 'å…¨éƒ¨è®¾å¤‡';
            }
        }
    };
    
    // WebSocketè¿æ¥ï¼ˆç”¨äºæ¥æ”¶è­¦å‘Šæ¶ˆæ¯ï¼‰
    let wsock = null;
    
    function connectWebSocket() {
        const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
        wsock = new WebSocket(url);
        
        wsock.onopen = () => {
            console.log('âœ… WebSocketå·²è¿æ¥ï¼ˆåˆ†æé¡µï¼‰');
        };
        
        wsock.onclose = () => {
            console.log('âš ï¸ WebSocketå·²æ–­å¼€ï¼ˆåˆ†æé¡µï¼‰ï¼Œ1.5ç§’åé‡è¿...');
            setTimeout(connectWebSocket, 1500);
        };
        
        wsock.onerror = (error) => {
            console.error('âŒ WebSocketé”™è¯¯ï¼ˆåˆ†æé¡µï¼‰:', error);
        };
        
        wsock.onmessage = e => {
            try {
                const msg = JSON.parse(e.data);
                
                // å¤„ç†è­¦å‘Šé€šçŸ¥
                if (msg.type === 'warning') {
                    if (window.MessageCenter) {
                        window.MessageCenter.handleWarningMessage(msg);
                    }
                    return;
                }
                
                // å¤„ç†æ¢å¤é€šçŸ¥
                if (msg.type === 'warning_resolved') {
                    if (window.MessageCenter) {
                        window.MessageCenter.handleResolvedMessage(msg);
                    }
                    return;
                }
                
                // åˆ†æé¡µä¸»è¦ç”¨äºæŸ¥çœ‹å†å²æ•°æ®ï¼Œä¸å¤„ç†å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®
                // å¦‚æœéœ€è¦å®æ—¶æ›´æ–°ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç›¸åº”çš„å¤„ç†é€»è¾‘
            } catch (error) {
                console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
            }
        };
    }
    
    // é¡µé¢å¸è½½æ—¶å…³é—­WebSocket
    window.addEventListener('beforeunload', function() {
        if (wsock) {
            wsock.close();
        }
    });

    // åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨
    initDataLoader({
        onDataLoaded: function(data, count) {
            console.log(`ğŸ“Š æ•°æ®åŠ è½½å›è°ƒï¼šæ”¶åˆ° ${count} æ¡æ•°æ®`);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            
            if (data && data.length > 0) {
                currentData = data;
                
                // æ›´æ–°æ—¶é—´æˆ³è·Ÿè¸ªå™¨
                if (window.timeStampTracker) {
                    window.timeStampTracker.reset();
                    data.forEach(d => {
                        if (d.ts) {
                            window.timeStampTracker.update(d.ts);
                        }
                    });
                }
                
                renderAnalysis();
            } else {
                currentData = [];
                if (window.timeStampTracker) {
                    window.timeStampTracker.reset();
                }
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                showNotification('æœªæŸ¥è¯¢åˆ°æ•°æ®', true);
            }
        }
    });

    // æ¸…ç©ºæ•°æ®
    document.getElementById('clearDataBtn').addEventListener('click', () => {
        currentData = [];
        if (window.timeStampTracker) {
            window.timeStampTracker.reset();
        }
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        showNotification('å·²æ¸…ç©ºæ•°æ®');
    });

    // æ¸²æŸ“åˆ†æç»“æœ
    function renderAnalysis() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('statsSection').style.display = 'block';

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const temps = currentData.map(d => d.temp).filter(v => v != null);
        const hums = currentData.map(d => d.hum).filter(v => v != null);
        const luxs = currentData.map(d => d.lux).filter(v => v != null);
        const smokes = currentData.map(d => d.smoke).filter(v => v != null);
        const pressures = currentData.map(d => d.pressure).filter(v => v != null);

        // å¹³å‡å€¼
        const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;
        const avgHum = hums.reduce((a, b) => a + b, 0) / hums.length;
        const avgLux = luxs.length > 0 ? luxs.reduce((a, b) => a + b, 0) / luxs.length : 0;
        const avgSmoke = smokes.length > 0 ? smokes.reduce((a, b) => a + b, 0) / smokes.length : 0;
        const avgPressure = pressures.length > 0 ? pressures.reduce((a, b) => a + b, 0) / pressures.length : 0;

        // æœ€å¤§æœ€å°å€¼
        const minTemp = Math.min(...temps);
        const maxTemp = Math.max(...temps);
        const minHum = Math.min(...hums);
        const maxHum = Math.max(...hums);
        const maxLux = luxs.length > 0 ? Math.max(...luxs) : 0;
        const maxSmoke = smokes.length > 0 ? Math.max(...smokes) : 0;
        const minPressure = pressures.length > 0 ? Math.min(...pressures) : 0;
        const maxPressure = pressures.length > 0 ? Math.max(...pressures) : 0;

        // æ—¶é—´ç»Ÿè®¡
        const timestamps = currentData.map(d => d.ts);
        const minTime = Math.min(...timestamps);
        const maxTime = Math.max(...timestamps);
        const timeSpan = (maxTime - minTime) / 3600; // å°æ—¶

        // æ ¼å¼åŒ–æ—¶é—´
        const formatTime = (timestamp) => {
            const date = new Date(timestamp * 1000);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${month}-${day} ${hours}:${minutes}`;
        };

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        // åŸºç¡€ç»Ÿè®¡
        document.getElementById('statTotal').textContent = currentData.length;
        document.getElementById('statTimeSpan').textContent = timeSpan.toFixed(1);
        document.getElementById('statStartTime').textContent = formatTime(minTime);
        document.getElementById('statEndTime').textContent = formatTime(maxTime);
        
        // æ¸©åº¦ç»Ÿè®¡
        document.getElementById('statAvgTemp').textContent = avgTemp.toFixed(2);
        document.getElementById('statMaxTemp').textContent = maxTemp.toFixed(2);
        document.getElementById('statMinTemp').textContent = minTemp.toFixed(2);
        document.getElementById('statTempRange').textContent = (maxTemp - minTemp).toFixed(2);
        
        // æ¹¿åº¦ç»Ÿè®¡
        document.getElementById('statAvgHum').textContent = avgHum.toFixed(2);
        document.getElementById('statMaxHum').textContent = maxHum.toFixed(2);
        document.getElementById('statMinHum').textContent = minHum.toFixed(2);
        document.getElementById('statHumRange').textContent = (maxHum - minHum).toFixed(2);
        
        // ç¯å¢ƒç»Ÿè®¡
        document.getElementById('statAvgLux').textContent = avgLux > 0 ? avgLux.toFixed(1) : '--';
        document.getElementById('statMaxLux').textContent = maxLux > 0 ? maxLux.toFixed(1) : '--';
        document.getElementById('statAvgSmoke').textContent = avgSmoke > 0 ? avgSmoke.toFixed(1) : '--';
        document.getElementById('statMaxSmoke').textContent = maxSmoke > 0 ? maxSmoke.toFixed(1) : '--';
        
        // å¤§æ°”å‹ç»Ÿè®¡
        document.getElementById('statAvgPressure').textContent = avgPressure > 0 ? avgPressure.toFixed(1) : '--';
        document.getElementById('statMaxPressure').textContent = maxPressure > 0 ? maxPressure.toFixed(1) : '--';
        document.getElementById('statMinPressure').textContent = minPressure > 0 ? minPressure.toFixed(1) : '--';
        document.getElementById('statRangePressure').textContent = (maxPressure > 0 && minPressure > 0) ? (maxPressure - minPressure).toFixed(1) : '--';

        // æ¸²æŸ“å›¾è¡¨
        renderCharts();

        // æ¸²æŸ“æ•°æ®è¡¨æ ¼
        renderTable();
    }

    // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
    function renderCharts() {
        // å‡†å¤‡æ•°æ® - ä½¿ç”¨æ™ºèƒ½æ—¶é—´æ ¼å¼åŒ–
        const labels = currentData.map(d => {
            if (typeof window.formatTimeLabel === 'function') {
                return window.formatTimeLabel(d.ts);
            } else {
                // å…œåº•ï¼šå¦‚æœæ²¡æœ‰formatTimeLabelå‡½æ•°ï¼Œä½¿ç”¨ç®€å•æ ¼å¼
                const date = new Date(d.ts * 1000);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
        });
        const temps = currentData.map(d => d.temp);
        const hums = currentData.map(d => d.hum);
        const luxs = currentData.map(d => d.lux);
        const smokes = currentData.map(d => d.smoke);

        // 1. æ¸©æ¹¿åº¦è¶‹åŠ¿å¯¹æ¯”
        const ctxTrend = document.getElementById('chartTrend').getContext('2d');
        if (charts.trend) charts.trend.destroy();
        const trendOptions = makeBaseChartOptions();
        trendOptions.scales.y.title = {display: true, text: 'æ¸©åº¦ (Â°C)'};
        trendOptions.scales.y1.title = {display: true, text: 'æ¹¿åº¦ (%)'};
        trendOptions.plugins.legend = {position: 'top'};
        // åªç¦ç”¨æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰çª—å£æ‹–åŠ¨
        if (trendOptions?.plugins?.zoom?.pan) {
            trendOptions.plugins.zoom.pan.enabled = false;
        }
        
        charts.trend = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ¸©åº¦ (Â°C)',
                        data: temps,
                        borderColor: css('--chart-line-temp-warm'),
                        backgroundColor: css('--chart-line-temp-warm') + '20',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'æ¹¿åº¦ (%)',
                        data: hums,
                        borderColor: css('--chart-line-hum'),
                        backgroundColor: css('--chart-line-hum') + '20',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: trendOptions
        });
        
        // ç»‘å®šå…œåº•çš„æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»
        enableManualDragPan(document.getElementById('chartTrend'), charts.trend, 'Trend');

        // 2. äº®åº¦ä¸çƒŸé›¾è¶‹åŠ¿
        const ctxLuxSmoke = document.getElementById('chartLuxSmoke').getContext('2d');
        if (charts.luxSmoke) charts.luxSmoke.destroy();
        const luxSmokeOptions = makeBaseChartOptions();
        luxSmokeOptions.scales.y.title = {display: true, text: 'äº®åº¦ (lx)'};
        luxSmokeOptions.scales.y1.title = {display: true, text: 'çƒŸé›¾ (ppm)'};
        luxSmokeOptions.plugins.legend = {position: 'top'};
        // åªç¦ç”¨æ’ä»¶å¹³ç§»ï¼ˆä¿ç•™ Alt+æ¡†é€‰æ”¾å¤§åŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰çª—å£æ‹–åŠ¨
        if (luxSmokeOptions?.plugins?.zoom?.pan) {
            luxSmokeOptions.plugins.zoom.pan.enabled = false;
        }
        
        charts.luxSmoke = new Chart(ctxLuxSmoke, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'äº®åº¦ (lx)',
                        data: luxs,
                        borderColor: css('--chart-line-lux'),
                        backgroundColor: css('--chart-line-lux') + '20',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'çƒŸé›¾ (ppm)',
                        data: smokes,
                        borderColor: css('--chart-line-smoke'),
                        backgroundColor: css('--chart-line-smoke') + '20',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: luxSmokeOptions
        });
        
        // ç»‘å®šå…œåº•çš„æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»
        enableManualDragPan(document.getElementById('chartLuxSmoke'), charts.luxSmoke, 'LuxSmoke');

        // 3. æ¸©åº¦åˆ†å¸ƒç›´æ–¹å›¾
        const tempBins = createHistogram(temps, 10);
        const ctxTempDist = document.getElementById('chartTempDist').getContext('2d');
        if (charts.tempDist) charts.tempDist.destroy();
        const tempDistOptions = makeSingleAxisChartOptions();
        tempDistOptions.scales.y.beginAtZero = true;
        tempDistOptions.scales.y.title = {display: true, text: 'æ•°é‡'};
        tempDistOptions.plugins.legend = {display: false};
        // ç¦ç”¨zoomåŠŸèƒ½
        if (tempDistOptions.plugins.zoom) {
            tempDistOptions.plugins.zoom.zoom.wheel.enabled = false;
            tempDistOptions.plugins.zoom.zoom.pinch.enabled = false;
            tempDistOptions.plugins.zoom.zoom.drag.enabled = false;
            tempDistOptions.plugins.zoom.pan.enabled = false;
        }
        charts.tempDist = new Chart(ctxTempDist, {
            type: 'bar',
            data: {
                labels: tempBins.labels,
                datasets: [{
                    label: 'æ•°æ®é‡',
                    data: tempBins.counts,
                    backgroundColor: css('--chart-line-temp-warm') + '80',
                    borderColor: css('--chart-line-temp-warm'),
                    borderWidth: 1
                }]
            },
            options: tempDistOptions
        });
        
        // æ¸©åº¦åˆ†å¸ƒå›¾ä¸éœ€è¦æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»

        // 4. æ¹¿åº¦åˆ†å¸ƒç›´æ–¹å›¾
        const humBins = createHistogram(hums, 10);
        const ctxHumDist = document.getElementById('chartHumDist').getContext('2d');
        if (charts.humDist) charts.humDist.destroy();
        const humDistOptions = makeSingleAxisChartOptions();
        humDistOptions.scales.y.beginAtZero = true;
        humDistOptions.scales.y.title = {display: true, text: 'æ•°é‡'};
        humDistOptions.plugins.legend = {display: false};
        // ç¦ç”¨zoomåŠŸèƒ½
        if (humDistOptions.plugins.zoom) {
            humDistOptions.plugins.zoom.zoom.wheel.enabled = false;
            humDistOptions.plugins.zoom.zoom.pinch.enabled = false;
            humDistOptions.plugins.zoom.zoom.drag.enabled = false;
            humDistOptions.plugins.zoom.pan.enabled = false;
        }
        charts.humDist = new Chart(ctxHumDist, {
            type: 'bar',
            data: {
                labels: humBins.labels,
                datasets: [{
                    label: 'æ•°æ®é‡',
                    data: humBins.counts,
                    backgroundColor: css('--chart-line-hum') + '80',
                    borderColor: css('--chart-line-hum'),
                    borderWidth: 1
                }]
            },
            options: humDistOptions
        });
        
        // æ¹¿åº¦åˆ†å¸ƒå›¾ä¸éœ€è¦æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»

        // 5. å°æ—¶ç»Ÿè®¡
        const hourlyData = calculateHourlyAverage(currentData);
        const ctxHourly = document.getElementById('chartHourly').getContext('2d');
        if (charts.hourly) charts.hourly.destroy();
        const hourlyOptions = makeSingleAxisChartOptions();
        hourlyOptions.scales.x.title = {display: true, text: 'å°æ—¶'};
        hourlyOptions.scales.y.title = {display: true, text: 'å¹³å‡æ¸©åº¦ (Â°C)'};
        hourlyOptions.plugins.legend = {display: false};
        // ç¦ç”¨zoomåŠŸèƒ½
        if (hourlyOptions.plugins.zoom) {
            hourlyOptions.plugins.zoom.zoom.wheel.enabled = false;
            hourlyOptions.plugins.zoom.zoom.pinch.enabled = false;
            hourlyOptions.plugins.zoom.zoom.drag.enabled = false;
            hourlyOptions.plugins.zoom.pan.enabled = false;
        }
        charts.hourly = new Chart(ctxHourly, {
            type: 'bar',
            data: {
                labels: hourlyData.hours,
                datasets: [{
                    label: 'å¹³å‡æ¸©åº¦ (Â°C)',
                    data: hourlyData.temps,
                    backgroundColor: css('--chart-line-temp-warm') + '80',
                    borderColor: css('--chart-line-temp-warm'),
                    borderWidth: 1
                }]
            },
            options: hourlyOptions
        });
        
        // å°æ—¶ç»Ÿè®¡å›¾ä¸éœ€è¦æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»

        // 6. æ¸©æ¹¿åº¦ç›¸å…³æ€§æ•£ç‚¹å›¾
        const ctxCorr = document.getElementById('chartCorrelation').getContext('2d');
        if (charts.correlation) charts.correlation.destroy();
        const correlationData = temps.map((t, i) => ({x: t, y: hums[i]}));
        // æ•£ç‚¹å›¾ä¸éœ€è¦å¤æ‚çš„zoomé…ç½®ï¼Œä½¿ç”¨ç®€å•é…ç½®
        const correlationOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                x: {
                    title: {display: true, text: 'æ¸©åº¦ (Â°C)'},
                    grid: {color: css('--chart-grid')}
                },
                y: {
                    title: {display: true, text: 'æ¹¿åº¦ (%)'},
                    grid: {color: css('--chart-grid')}
                }
                },
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `æ¸©åº¦: ${ctx.parsed.x.toFixed(2)}Â°C, æ¹¿åº¦: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                }
        };
        charts.correlation = new Chart(ctxCorr, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'æ¸©æ¹¿åº¦å…³ç³»',
                    data: correlationData,
                    backgroundColor: css('--primary') + '60',
                    borderColor: css('--primary'),
                    borderWidth: 1
                }]
            },
            options: correlationOptions
        });
        
        // ç›¸å…³æ€§æ•£ç‚¹å›¾ä¸éœ€è¦æ‰‹åŠ¨æ‹–åŠ¨å¹³ç§»

        // 7. å¤§æ°”å‹è¶‹åŠ¿å›¾
        const pressures = currentData.map(d => d.pressure);
        const ctxPressureTrend = document.getElementById('chartPressureTrend').getContext('2d');
        if (charts.pressureTrend) charts.pressureTrend.destroy();
        const pressureTrendOptions = makeBaseChartOptions();
        pressureTrendOptions.scales.y.title = {display: true, text: 'å¤§æ°”å‹ (hPa)'};
        pressureTrendOptions.plugins.legend = {display: false};
        if (pressureTrendOptions?.plugins?.zoom?.pan) {
            pressureTrendOptions.plugins.zoom.pan.enabled = false;
        }
        
        charts.pressureTrend = new Chart(ctxPressureTrend, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å¤§æ°”å‹ (hPa)',
                    data: pressures,
                    borderColor: css('--chart-line-pressure'),
                    backgroundColor: css('--chart-line-pressure') + '20',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: pressureTrendOptions
        });
        
        enableManualDragPan(document.getElementById('chartPressureTrend'), charts.pressureTrend, 'PressureTrend');

        // 8. å¤§æ°”å‹åˆ†å¸ƒç›´æ–¹å›¾
        const ctxPressureDist = document.getElementById('chartPressureDist').getContext('2d');
        if (charts.pressureDist) charts.pressureDist.destroy();
        const pressureHistData = createHistogram(pressures.filter(p => p != null), 20);
        const pressureDistOptions = makeBaseChartOptions();
        pressureDistOptions.scales.y.title = {display: true, text: 'é¢‘æ¬¡'};
        pressureDistOptions.scales.x.title = {display: true, text: 'å¤§æ°”å‹ (hPa)'};
        pressureDistOptions.plugins.legend = {display: false};
        pressureDistOptions.plugins.zoom = undefined; // ç›´æ–¹å›¾ä¸éœ€è¦ç¼©æ”¾
        
        charts.pressureDist = new Chart(ctxPressureDist, {
            type: 'bar',
            data: {
                labels: pressureHistData.labels,
                datasets: [{
                    label: 'é¢‘æ¬¡',
                    data: pressureHistData.counts,
                    backgroundColor: css('--chart-line-pressure') + '80',
                    borderColor: css('--chart-line-pressure'),
                    borderWidth: 1
                }]
            },
            options: pressureDistOptions
        });

        // ç»‘å®šæ‰€æœ‰å›¾è¡¨çš„äº¤äº’åŠŸèƒ½
        bindAllChartInteractions();
    }

    // åˆ›å»ºç›´æ–¹å›¾æ•°æ®
    function createHistogram(data, bins) {
        const min = Math.min(...data);
        const max = Math.max(...data);
        const binWidth = (max - min) / bins;
        const counts = new Array(bins).fill(0);
        const labels = [];

        for (let i = 0; i < bins; i++) {
            const start = min + i * binWidth;
            const end = start + binWidth;
            labels.push(`${start.toFixed(1)}-${end.toFixed(1)}`);
        }

        data.forEach(value => {
            const binIndex = Math.min(Math.floor((value - min) / binWidth), bins - 1);
            counts[binIndex]++;
        });

        return {labels, counts};
    }

    // è®¡ç®—å°æ—¶å¹³å‡å€¼
    function calculateHourlyAverage(data) {
        if (!data || data.length === 0) {
            return {hours: [], temps: []};
        }

        // é¦–å…ˆç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æˆ³æ’åº
        const sortedData = [...data].sort((a, b) => a.ts - b.ts);

        // è·å–æ•°æ®çš„æ—¶é—´èŒƒå›´
        const timestamps = sortedData.map(d => d.ts);
        const minTime = Math.min(...timestamps);
        const maxTime = Math.max(...timestamps);
        
        const minDate = new Date(minTime * 1000);
        const maxDate = new Date(maxTime * 1000);
        
        // è®¡ç®—æ—¶é—´è·¨åº¦ï¼ˆå°æ—¶ï¼‰
        const timeSpanHours = Math.ceil((maxTime - minTime) / 3600);

        const hours = [];
        const temps = [];
        
        // å¦‚æœæ—¶é—´è·¨åº¦å°äº48å°æ—¶ï¼ŒæŒ‰å®é™…æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆåªæ˜¾ç¤ºæœ‰æ•°æ®çš„å°æ—¶ï¼‰
        if (timeSpanHours < 48) {
            // ä½¿ç”¨å¸¦æ—¥æœŸå’Œå°æ—¶çš„é”®æ¥åŒºåˆ†ä¸åŒå¤©çš„åŒä¸€å°æ—¶
            const hourDataMap = new Map();
            
            // å°†æ•°æ®åˆ†é…åˆ°å¯¹åº”çš„å°æ—¶æ¡¶ä¸­
            sortedData.forEach(d => {
                const date = new Date(d.ts * 1000);
                const hour = date.getHours();
                const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}-${hour}`;
                if (!hourDataMap.has(dateKey)) {
                    hourDataMap.set(dateKey, {
                        temps: [],
                        timestamp: new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, 0, 0, 0).getTime(),
                        hour: hour,
                        date: `${date.getMonth()+1}/${date.getDate()}`
                    });
                }
                hourDataMap.get(dateKey).temps.push(d.temp);
            });
            
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œåªä¿ç•™æœ‰æ•°æ®çš„å°æ—¶
            const sortedHours = Array.from(hourDataMap.entries())
                .sort((a, b) => a[1].timestamp - b[1].timestamp);
            
            // ç”Ÿæˆå›¾è¡¨æ•°æ®
            sortedHours.forEach(([dateKey, data]) => {
                const isSameDay = minDate.getDate() === maxDate.getDate() && 
                                  minDate.getMonth() === maxDate.getMonth() && 
                                  minDate.getFullYear() === maxDate.getFullYear();
                
                // å¦‚æœè·¨å¤©ï¼Œæ˜¾ç¤ºæ—¥æœŸ+å°æ—¶ï¼›å¦åˆ™åªæ˜¾ç¤ºå°æ—¶
                if (!isSameDay) {
                    hours.push(`${data.date} ${data.hour}:00`);
                } else {
                    hours.push(`${data.hour}:00`);
                }
                
                const arr = data.temps;
                if (arr && arr.length > 0) {
                    temps.push(arr.reduce((a, b) => a + b, 0) / arr.length);
                } else {
                    temps.push(null);
                }
            });
        } else {
            // æ—¶é—´è·¨åº¦å¤§äºç­‰äº48å°æ—¶ï¼ŒæŒ‰ä¼ ç»Ÿ0-23å°æ—¶æ˜¾ç¤ºï¼ˆåˆå¹¶æ‰€æœ‰å¤©çš„åŒä¸€å°æ—¶ï¼‰
            const hourMap = new Map();
            sortedData.forEach(d => {
                const hour = new Date(d.ts * 1000).getHours();
                if (!hourMap.has(hour)) {
                    hourMap.set(hour, []);
                }
                hourMap.get(hour).push(d.temp);
            });
            
            for (let h = 0; h < 24; h++) {
                hours.push(`${h}:00`);
                if (hourMap.has(h)) {
                    const arr = hourMap.get(h);
                    temps.push(arr.reduce((a, b) => a + b, 0) / arr.length);
                } else {
                    temps.push(null);
                }
            }
        }

        return {hours, temps};
    }

    // æ¸²æŸ“æ•°æ®è¡¨æ ¼
    function renderTable() {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';

        // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°æ•°æ®åœ¨ä¸Šé¢
        const displayData = currentData.slice(-500).reverse(); // å–æœ€å500æ¡ï¼Œç„¶åå€’åº
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(row.ts * 1000).toLocaleString()}</td>
                <td class="right">${row.temp.toFixed(2)}</td>
                <td class="right">${row.hum.toFixed(2)}</td>
                <td class="right">${row.lux != null ? row.lux.toFixed(1) : '--'}</td>
                <td class="right">${row.smoke != null ? row.smoke.toFixed(1) : '--'}</td>
                <td class="right">${row.pressure != null ? row.pressure.toFixed(1) : '--'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // æ›´æ–°æ‰€æœ‰å›¾è¡¨é¢œè‰²ï¼ˆä¸»é¢˜åˆ‡æ¢æ—¶ï¼‰
    window.updateAllCharts = function () {
        Object.values(charts).forEach(chart => {
            if (chart && chart.update) {
                chart.update('none');
            }
        });
    };

    // å›¾è¡¨é…ç½®å’Œäº¤äº’åŠŸèƒ½
    let fullscreenCharts = {};

    // ç»‘å®šæ‰€æœ‰å›¾è¡¨çš„æŒ‰é’®å’Œå…¨å±åŠŸèƒ½
    function bindAllChartInteractions() {
        // åªä¸ºæ¸©æ¹¿åº¦å’Œäº®åº¦çƒŸé›¾å›¾ç»‘å®šæŒ‰é’®
        const chartMappings = [
            { name: 'Trend', chart: charts.trend },
            { name: 'LuxSmoke', chart: charts.luxSmoke }
        ];

        chartMappings.forEach(({ name, chart }) => {
            if (chart) {
                bindChartButtons(name, chart, name);
            }
        });

        // ç»‘å®šå…¨å±æŒ‰é’®
        const fullscreenMappings = [
            { buttonId: 'openFullTrend', overlayId: 'overlayTrend', chartId: 'chartTrendFull' },
            { buttonId: 'openFullLuxSmoke', overlayId: 'overlayLuxSmoke', chartId: 'chartLuxSmokeFull' },
            { buttonId: 'openFullTempDist', overlayId: 'overlayTempDist', chartId: 'chartTempDistFull' },
            { buttonId: 'openFullHumDist', overlayId: 'overlayHumDist', chartId: 'chartHumDistFull' },
            { buttonId: 'openFullHourly', overlayId: 'overlayHourly', chartId: 'chartHourlyFull' },
            { buttonId: 'openFullCorrelation', overlayId: 'overlayCorrelation', chartId: 'chartCorrelationFull' }
        ];

        fullscreenMappings.forEach(({ buttonId, overlayId, chartId }) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.addEventListener('click', () => {
                    openOverlay(overlayId);
                    createFullscreenChartFromOriginal(chartId, overlayId);
                });
            }
        });

        // æ·»åŠ å¤§æ°”å‹å›¾è¡¨çš„å…¨å±æŒ‰é’®
        const pressureTrendBtn = document.getElementById('openFullPressureTrend');
        if (pressureTrendBtn) {
            pressureTrendBtn.addEventListener('click', () => {
                openOverlay('overlayPressureTrend');
                createFullscreenChartFromOriginal('chartPressureTrendFull', 'overlayPressureTrend');
            });
        }
        
        const pressureDistBtn = document.getElementById('openFullPressureDist');
        if (pressureDistBtn) {
            pressureDistBtn.addEventListener('click', () => {
                openOverlay('overlayPressureDist');
                createFullscreenChartFromOriginal('chartPressureDistFull', 'overlayPressureDist');
            });
        }

        // ç»‘å®šå…³é—­æŒ‰é’®
        const closeMappings = [
            { buttonId: 'closeOverlayTrend', overlayId: 'overlayTrend' },
            { buttonId: 'closeOverlayLuxSmoke', overlayId: 'overlayLuxSmoke' },
            { buttonId: 'closeOverlayTempDist', overlayId: 'overlayTempDist' },
            { buttonId: 'closeOverlayHumDist', overlayId: 'overlayHumDist' },
            { buttonId: 'closeOverlayHourly', overlayId: 'overlayHourly' },
            { buttonId: 'closeOverlayCorrelation', overlayId: 'overlayCorrelation' },
            { buttonId: 'closeOverlayPressureTrend', overlayId: 'overlayPressureTrend' },
            { buttonId: 'closeOverlayPressureDist', overlayId: 'overlayPressureDist' }
        ];

        closeMappings.forEach(({ buttonId, overlayId }) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.addEventListener('click', () => closeOverlay(overlayId));
            }
            
            // ç‚¹å‡»overlayèƒŒæ™¯å…³é—­
            const overlay = document.getElementById(overlayId);
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeOverlay(overlayId);
                    }
                });
            }
        });
    }

    // ä»åŸå§‹å›¾è¡¨åˆ›å»ºå…¨å±å›¾è¡¨
    function createFullscreenChartFromOriginal(chartId, overlayId) {
        if (fullscreenCharts[chartId]) {
            fullscreenCharts[chartId].destroy();
        }

        let chartData, chartType, chartOptions;
        
        switch (chartId) {
            case 'chartTrendFull':
                chartData = charts.trend?.data;
                chartType = 'line';
                chartOptions = charts.trend?.options;
                break;
            case 'chartLuxSmokeFull':
                chartData = charts.luxSmoke?.data;
                chartType = 'line';
                chartOptions = charts.luxSmoke?.options;
                break;
            case 'chartTempDistFull':
                chartData = charts.tempDist?.data;
                chartType = 'bar';
                chartOptions = charts.tempDist?.options;
                break;
            case 'chartHumDistFull':
                chartData = charts.humDist?.data;
                chartType = 'bar';
                chartOptions = charts.humDist?.options;
                break;
            case 'chartHourlyFull':
                chartData = charts.hourly?.data;
                chartType = 'bar';
                chartOptions = charts.hourly?.options;
                break;
            case 'chartCorrelationFull':
                chartData = charts.correlation?.data;
                chartType = 'scatter';
                chartOptions = charts.correlation?.options;
                break;
            case 'chartPressureTrendFull':
                chartData = charts.pressureTrend?.data;
                chartType = 'line';
                chartOptions = charts.pressureTrend?.options;
                break;
            case 'chartPressureDistFull':
                chartData = charts.pressureDist?.data;
                chartType = 'bar';
                chartOptions = charts.pressureDist?.options;
                break;
        }

        if (chartData && chartType && chartOptions) {
            fullscreenCharts[chartId] = createFullscreenChart(chartId, chartType, chartData, chartOptions);
            
            // ä¸ºæ¸©æ¹¿åº¦è¶‹åŠ¿å’Œäº®åº¦çƒŸé›¾å›¾ç»‘å®šæŒ‰é’®
            if (chartId === 'chartTrendFull') {
                bindChartButtons('FullTrend', fullscreenCharts[chartId], 'FullTrend');
            } else if (chartId === 'chartLuxSmokeFull') {
                bindChartButtons('FullLuxSmoke', fullscreenCharts[chartId], 'FullLuxSmoke');
            } else if (chartId === 'chartPressureTrendFull') {
                bindChartButtons('PressureTrend', fullscreenCharts[chartId], 'PressureTrend');
            }
        }
    }

    // ç§‘æ™®å†…å®¹æ•°æ®
    const infoData = {
        'trend': {
            icon: 'ğŸ“ˆ',
            title: 'æ¸©æ¹¿åº¦è¶‹åŠ¿å¯¹æ¯”',
            content: `<p>è¿™ä¸ªå›¾è¡¨åŒæ—¶å±•ç¤ºæ¸©åº¦å’Œæ¹¿åº¦éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ï¼Œå¸®åŠ©ä½ å‘ç°å®ƒä»¬ä¹‹é—´çš„å…³è”ã€‚</p>
                     <p><strong>ä¸ºä»€ä¹ˆå¯¹æ¯”ï¼š</strong>æ¸©åº¦å’Œæ¹¿åº¦æ˜¯ç›¸äº’å½±å“çš„ã€‚é€šå¸¸æ¸©åº¦ä¸Šå‡æ—¶ï¼Œç›¸å¯¹æ¹¿åº¦ä¼šä¸‹é™ï¼›åä¹‹äº¦ç„¶ã€‚</p>
                     <p><strong>å¦‚ä½•é˜…è¯»ï¼š</strong>å·¦ä¾§Yè½´è¡¨ç¤ºæ¸©åº¦ï¼ˆÂ°Cï¼‰ï¼Œå³ä¾§Yè½´è¡¨ç¤ºæ¹¿åº¦ï¼ˆ%ï¼‰ã€‚æ©™è‰²çº¿æ˜¯æ¸©åº¦ï¼Œç»¿è‰²çº¿æ˜¯æ¹¿åº¦ã€‚</p>
                     <p><strong>å¼‚å¸¸è¯†åˆ«ï¼š</strong>å¦‚æœæ¸©æ¹¿åº¦åŒæ—¶å‰§çƒˆæ³¢åŠ¨ï¼Œå¯èƒ½è¡¨ç¤ºç©ºè°ƒç³»ç»Ÿæœ‰é—®é¢˜ï¼›å¦‚æœæ¸©åº¦ç¨³å®šä½†æ¹¿åº¦å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é™¤æ¹¿/åŠ æ¹¿è®¾å¤‡æ•…éšœã€‚</p>`
        },
        'lux-smoke': {
            icon: 'ğŸ’¡',
            title: 'äº®åº¦ä¸çƒŸé›¾è¶‹åŠ¿',
            content: `<p>è¿™ä¸ªå›¾è¡¨å±•ç¤ºå…‰ç…§å¼ºåº¦å’ŒçƒŸé›¾æµ“åº¦çš„å˜åŒ–ï¼Œç”¨äºç¯å¢ƒç›‘æµ‹å’Œå®‰å…¨åˆ†æã€‚</p>
                     <p><strong>äº®åº¦ç›‘æµ‹ï¼š</strong>å¯ä»¥çœ‹åˆ°æ—¥å¤œå‘¨æœŸå˜åŒ–ã€‚å¦‚æœç™½å¤©äº®åº¦å¼‚å¸¸ä½ï¼Œå¯èƒ½æ˜¯é®å…‰æˆ–ä¼ æ„Ÿå™¨æ•…éšœã€‚</p>
                     <p><strong>çƒŸé›¾ç›‘æµ‹ï¼š</strong>æ­£å¸¸æƒ…å†µä¸‹åº”ä¿æŒä½ä½ï¼ˆ< 50 ppmï¼‰ã€‚ä»»ä½•çªå‘ä¸Šå‡éƒ½éœ€è¦è­¦æƒ•ã€‚</p>
                     <p><strong>è”åˆåˆ†æï¼š</strong>ä¸¤è€…ç»“åˆå¯ä»¥åˆ¤æ–­æ•´ä½“ç¯å¢ƒçŠ¶å†µï¼Œä¾‹å¦‚å¤œé—´æœ‰å¼‚å¸¸äº®åº¦å’ŒçƒŸé›¾å‡é«˜ï¼Œå¯èƒ½æ˜¯æœ‰äººåœ¨è¿›è¡Œå±é™©æ“ä½œã€‚</p>`
        },
        'temp-dist': {
            icon: 'ğŸŒ¡ï¸',
            title: 'æ¸©åº¦åˆ†å¸ƒ',
            content: `<p>ç›´æ–¹å›¾æ˜¾ç¤ºæ¸©åº¦å€¼åœ¨ä¸åŒåŒºé—´çš„åˆ†å¸ƒæƒ…å†µï¼Œå¸®åŠ©è¯„ä¼°æ¸©åº¦ç¨³å®šæ€§ã€‚</p>
                     <p><strong>ç†æƒ³åˆ†å¸ƒï¼š</strong>å¦‚æœæ¸©æ§è‰¯å¥½ï¼Œæ¸©åº¦åº”è¯¥é›†ä¸­åœ¨ä¸€ä¸ªçª„èŒƒå›´å†…ï¼Œç›´æ–¹å›¾å‘ˆç°å•å³°åˆ†å¸ƒã€‚</p>
                     <p><strong>åˆ†æ•£åˆ†å¸ƒï¼š</strong>å¦‚æœæŸ±å­åˆ†æ•£åœ¨å¤šä¸ªåŒºé—´ï¼Œè¯´æ˜æ¸©åº¦æ³¢åŠ¨å¤§ï¼Œç¯å¢ƒä¸ç¨³å®šã€‚</p>
                     <p><strong>åæ€åˆ†å¸ƒï¼š</strong>å¦‚æœæ•°æ®å‘ä¸€ä¾§å€¾æ–œï¼Œå¯èƒ½è¡¨ç¤ºç©ºè°ƒè®¾å®šæ¸©åº¦åé«˜æˆ–åä½ã€‚</p>
                     <p><strong>åº”ç”¨ä»·å€¼ï¼š</strong>é€šè¿‡åˆ†æåˆ†å¸ƒå¯ä»¥ä¼˜åŒ–æ¸©æ§ç³»ç»Ÿå‚æ•°ï¼Œæé«˜èƒ½æ•ˆã€‚</p>`
        },
        'hum-dist': {
            icon: 'ğŸ’§',
            title: 'æ¹¿åº¦åˆ†å¸ƒ',
            content: `<p>ç›´æ–¹å›¾æ˜¾ç¤ºæ¹¿åº¦å€¼çš„åˆ†å¸ƒæƒ…å†µï¼Œåæ˜ æ¹¿åº¦æ§åˆ¶æ•ˆæœã€‚</p>
                     <p><strong>é›†ä¸­åˆ†å¸ƒï¼š</strong>ç†æƒ³çš„é™¤æ¹¿/åŠ æ¹¿ç³»ç»Ÿåº”ä½¿æ¹¿åº¦é›†ä¸­åœ¨ 40-60% åŒºé—´ã€‚</p>
                     <p><strong>åŒå³°åˆ†å¸ƒï¼š</strong>å¦‚æœå‡ºç°ä¸¤ä¸ªå³°å€¼ï¼Œå¯èƒ½æ˜¯ç™½å¤©/å¤œé—´æ¹¿åº¦å·®å¼‚å¤§ï¼Œæˆ–è®¾å¤‡é—´æ­‡æ€§å·¥ä½œã€‚</p>
                     <p><strong>æå€¼åˆ†æï¼š</strong>æ³¨æ„å¼‚å¸¸é«˜å€¼ï¼ˆ>70%ï¼‰å’Œä½å€¼ï¼ˆ<30%ï¼‰ï¼Œè¿™äº›æƒ…å†µéœ€è¦ç‰¹åˆ«å¤„ç†ã€‚</p>
                     <p><strong>å­£èŠ‚å½±å“ï¼š</strong>ä¸åŒå­£èŠ‚çš„æ¹¿åº¦åˆ†å¸ƒä¼šæœ‰å·®å¼‚ï¼Œå¯ä»¥é€šè¿‡é•¿æœŸæ•°æ®å¯¹æ¯”å‘ç°è§„å¾‹ã€‚</p>`
        },
        'hourly': {
            icon: 'â°',
            title: 'å°æ—¶ç»Ÿè®¡ï¼ˆå¹³å‡æ¸©åº¦ï¼‰',
            content: `<p>æŒ‰24å°æ—¶ç»Ÿè®¡çš„å¹³å‡æ¸©åº¦ï¼Œæ­ç¤ºæ¸©åº¦çš„æ—¥å‘¨æœŸè§„å¾‹ã€‚</p>
                     <p><strong>å·¥ä½œæ—¶æ®µï¼š</strong>é€šå¸¸å·¥ä½œæ—¶é—´ï¼ˆ9:00-18:00ï¼‰æ¸©åº¦è¾ƒç¨³å®šï¼Œè¿™æ˜¯ç©ºè°ƒç³»ç»Ÿä¸»åŠ¨è°ƒæ§çš„ç»“æœã€‚</p>
                     <p><strong>å¤œé—´è§„å¾‹ï¼š</strong>å¤œé—´æ¸©åº¦å¯èƒ½ç•¥æœ‰ä¸‹é™ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœæ³¢åŠ¨è¿‡å¤§ï¼Œè¯´æ˜ä¿æ¸©ä¸è¶³ã€‚</p>
                     <p><strong>å³°è°·è¯†åˆ«ï¼š</strong>æ‰¾å‡ºæ¸©åº¦æœ€é«˜å’Œæœ€ä½çš„æ—¶æ®µï¼Œå¯ä»¥ä¼˜åŒ–ç©ºè°ƒå·¥ä½œæ—¶é—´ï¼ŒèŠ‚çº¦èƒ½æºã€‚</p>
                     <p><strong>å¼‚å¸¸æ—¶æ®µï¼š</strong>å¦‚æœæŸä¸ªæ—¶æ®µæ¸©åº¦ç»å¸¸å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯è¯¥æ—¶æ®µæœ‰é«˜è€—èƒ½è®¾å¤‡è¿è¡Œã€‚</p>`
        },
        'correlation': {
            icon: 'ğŸ”—',
            title: 'æ¸©æ¹¿åº¦ç›¸å…³æ€§',
            content: `<p>æ•£ç‚¹å›¾å±•ç¤ºæ¯ä¸ªæ—¶åˆ»çš„æ¸©åº¦å’Œæ¹¿åº¦ï¼Œæ­ç¤ºä¸¤è€…çš„ç›¸å…³å…³ç³»ã€‚</p>
                     <p><strong>è´Ÿç›¸å…³ï¼š</strong>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¸©åº¦å‡é«˜æ—¶æ¹¿åº¦é™ä½ï¼Œæ•£ç‚¹å‘ˆç°ä»å·¦ä¸Šåˆ°å³ä¸‹çš„è¶‹åŠ¿ã€‚</p>
                     <p><strong>ç´§å¯†èšé›†ï¼š</strong>å¦‚æœæ•°æ®ç‚¹èšé›†åœ¨ä¸€èµ·ï¼Œè¯´æ˜æ¸©æ¹¿åº¦é…åˆè‰¯å¥½ï¼Œç¯å¢ƒç¨³å®šã€‚</p>
                     <p><strong>åˆ†æ•£åˆ†å¸ƒï¼š</strong>å¦‚æœæ•°æ®ç‚¹å¾ˆåˆ†æ•£ï¼Œå¯èƒ½æ˜¯æ¸©æ¹¿åº¦æ§åˆ¶ä¸åè°ƒï¼Œéœ€è¦è°ƒæ•´è®¾å¤‡å‚æ•°ã€‚</p>
                     <p><strong>å¼‚å¸¸ç‚¹ï¼š</strong>è¿œç¦»ä¸»è¦è¶‹åŠ¿çš„ç‚¹å¯èƒ½æ˜¯å¼‚å¸¸äº‹ä»¶ï¼ˆå¦‚é—¨çª—å¼€å¯ã€è®¾å¤‡æ•…éšœï¼‰çš„è®°å½•ã€‚</p>`
        },
        'pressure-trend': {
            icon: 'ğŸŒ¡ï¸',
            title: 'å¤§æ°”å‹è¶‹åŠ¿',
            content: `<p>è¿™ä¸ªå›¾è¡¨å±•ç¤ºå¤§æ°”å‹éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ï¼Œå¸®åŠ©ç›‘æµ‹ç¯å¢ƒå˜åŒ–å’Œé¢„æµ‹å¤©æ°”ã€‚</p>
                     <p><strong>æ­£å¸¸èŒƒå›´ï¼š</strong>æ ‡å‡†å¤§æ°”å‹çº¦ä¸º1013 hPaï¼ˆç™¾å¸•ï¼‰ï¼Œå®¤å†…å¤§æ°”å‹é€šå¸¸åœ¨990-1030 hPaä¹‹é—´ã€‚</p>
                     <p><strong>ä¸Šå‡è¶‹åŠ¿ï¼š</strong>å¤§æ°”å‹ä¸Šå‡é€šå¸¸é¢„ç¤ºç€å¤©æ°”è½¬æ™´ï¼Œç©ºæ°”è´¨é‡å¯èƒ½æ”¹å–„ã€‚</p>
                     <p><strong>ä¸‹é™è¶‹åŠ¿ï¼š</strong>å¤§æ°”å‹ä¸‹é™å¯èƒ½é¢„ç¤ºç€å¤©æ°”è½¬é˜´æˆ–æœ‰é™é›¨ï¼Œéœ€è¦æ³¨æ„é˜²æ½®ã€‚</p>
                     <p><strong>å‰§çƒˆæ³¢åŠ¨ï¼š</strong>å¦‚æœå¤§æ°”å‹çŸ­æ—¶é—´å†…å‰§çƒˆå˜åŒ–ï¼Œå¯èƒ½æ˜¯é—¨çª—å¼€å¯ã€ç©ºè°ƒç³»ç»Ÿæˆ–ä¼ æ„Ÿå™¨å¼‚å¸¸ã€‚</p>`
        },
        'pressure-dist': {
            icon: 'ğŸ“Š',
            title: 'å¤§æ°”å‹åˆ†å¸ƒ',
            content: `<p>ç›´æ–¹å›¾å±•ç¤ºä¸åŒå¤§æ°”å‹åŒºé—´å‡ºç°çš„é¢‘æ¬¡ï¼Œåæ˜ å¤§æ°”å‹çš„åˆ†å¸ƒç‰¹å¾ã€‚</p>
                     <p><strong>é›†ä¸­åˆ†å¸ƒï¼š</strong>å¦‚æœæ•°æ®é›†ä¸­åœ¨æŸä¸ªåŒºé—´ï¼Œè¯´æ˜ç¯å¢ƒæ°”å‹ç¨³å®šã€‚</p>
                     <p><strong>åŒå³°åˆ†å¸ƒï¼š</strong>å¦‚æœå‡ºç°ä¸¤ä¸ªå³°å€¼ï¼Œå¯èƒ½åæ˜ äº†ä¸åŒå¤©æ°”çŠ¶æ€ï¼ˆæ™´å¤©/é˜´é›¨å¤©ï¼‰ã€‚</p>
                     <p><strong>åæ€åˆ†å¸ƒï¼š</strong>åˆ†å¸ƒå‘å·¦æˆ–å‘å³åæ–œï¼Œå¯èƒ½ä¸å­£èŠ‚æ€§å¤©æ°”æ¨¡å¼æœ‰å…³ã€‚</p>
                     <p><strong>å¼‚å¸¸å€¼ï¼š</strong>è¿œç¦»ä¸»åˆ†å¸ƒçš„æ•°æ®ç‚¹å¯èƒ½æ˜¯æµ‹é‡å¼‚å¸¸æˆ–æç«¯å¤©æ°”äº‹ä»¶ã€‚</p>`
        }
    };

    // showInfo, closeInfo å·²ç§»è‡³ common.js
    
    // ==================== AI åˆ†æåŠ©æ‰‹ ====================
    const AI_API_URL = '/api/ai/chat';  // ä½¿ç”¨åç«¯ä»£ç†ï¼Œé¿å…è·¨åŸŸé—®é¢˜
    const AI_HEALTH_URL = '/api/ai/health';  // AI æœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹
    let aiChatHistory = [];
    let isAISending = false;           // æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸€æ¬¡ AI å¯¹è¯
    let aiAbortController = null;      // å½“å‰æµå¼è¯·æ±‚çš„ä¸­æ–­æ§åˆ¶å™¨ï¼ˆAbortControllerï¼‰
    let availableModels = [];
    let selectedModel = null;

    // ä»è¾“å…¥æ¡†è·å–æ¨¡å‹åç§°
    function getSelectedModel() {
        const modelInput = document.getElementById('aiModelInput');
        const modelName = modelInput ? modelInput.value.trim() : '';
        return modelName || null;
    }
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯åœ¨çº¿æ¨¡å‹
    function isOnlineModel(modelName) {
        const onlineModels = ['deepseek-reasoner', 'deepseek-chat'];
        return onlineModels.includes(modelName);
    }
    
    // ç¦ç”¨/å¯ç”¨æœ¬åœ°æ¨¡å‹é€‰é¡¹
    function setLocalModelsEnabled(enabled) {
        const localModelValues = [
            'deepseek-r1-0528-qwen3-8b',
            'gemma 3',
            'qwq-32b'
        ];
        
        // ğŸ¯ ç¦ç”¨/å¯ç”¨æ¡Œé¢ç«¯ä¸‹æ‹‰é€‰é¡¹
        const desktopOptions = document.querySelectorAll('.ai-model-option');
        desktopOptions.forEach(option => {
            const value = option.getAttribute('data-value');
            if (localModelValues.includes(value)) {
                if (enabled) {
                    option.classList.remove('disabled');
                    option.style.opacity = '1';
                    option.style.cursor = 'pointer';
                    option.style.pointerEvents = 'auto';
                } else {
                    option.classList.add('disabled');
                    option.style.opacity = '0.4';
                    option.style.cursor = 'not-allowed';
                    option.style.pointerEvents = 'none';
                }
            }
        });
        
        // ğŸ¯ ç¦ç”¨/å¯ç”¨ <select> ä¸­çš„é€‰é¡¹
        const selectOptions = document.querySelectorAll('#aiModelInput option');
        selectOptions.forEach(option => {
            const value = option.value;
            if (localModelValues.includes(value)) {
                option.disabled = !enabled;
            }
        });
        
        // ğŸ¯ å¦‚æœæœ¬åœ°æ¨¡å‹ç¦»çº¿ï¼Œä¸”å½“å‰é€‰ä¸­çš„æ˜¯æœ¬åœ°æ¨¡å‹ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å‹
        if (!enabled) {
            const currentModel = getSelectedModel();
            if (currentModel && localModelValues.includes(currentModel)) {
                console.log('âš ï¸ å½“å‰é€‰ä¸­æœ¬åœ°æ¨¡å‹ä½†æœåŠ¡ç¦»çº¿ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å‹');
                switchToOnlineModel();
            }
        }
    }
    
    // åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å‹ï¼ˆDeepSeek V3.2ï¼‰
    function switchToOnlineModel() {
        const onlineModelValue = 'deepseek-reasoner';
        const modelInput = document.getElementById('aiModelInput');
        
        if (modelInput) {
            // æ›´æ–° <select> å€¼
            modelInput.value = onlineModelValue;
            
            // è§¦å‘æ¨¡å‹å˜åŒ–äº‹ä»¶
            onModelChange();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('å·²è‡ªåŠ¨åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å‹ DeepSeek V3.2', 'info');
        }
    }
    
    // æ›´æ–° AI åœ¨çº¿çŠ¶æ€æ˜¾ç¤º
    function updateAIStatus(isOnline, statusText = null, modelType = 'local') {
        const statusContainer = document.getElementById('aiStatusContainer');
        const statusTextElement = document.getElementById('aiStatusText');
        const statusDot = document.querySelector('.ai-status-dot');
        
        if (!statusContainer || !statusTextElement || !statusDot) return;
        
        if (modelType === 'online') {
            // åœ¨çº¿æ¨¡å‹å§‹ç»ˆæ˜¾ç¤ºåœ¨çº¿
            statusTextElement.textContent = 'åœ¨çº¿æ¨¡å‹';
            statusDot.style.background = '#10b981'; // ç¿ ç»¿è‰²
            statusContainer.title = 'DeepSeek åœ¨çº¿æ¨¡å‹ - æ— éœ€æœ¬åœ°éƒ¨ç½²';
        } else {
            // æœ¬åœ°æ¨¡å‹æ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿çŠ¶æ€
            if (isOnline) {
                statusTextElement.textContent = statusText || 'æœ¬åœ°åœ¨çº¿';
                statusDot.style.background = '#4ade80'; // ç»¿è‰²
                statusContainer.title = 'æœ¬åœ°æ¨¡å‹åœ¨çº¿ - ç‚¹å‡»é‡æ–°æ£€æµ‹çŠ¶æ€';
                // ğŸ¯ å¯ç”¨æœ¬åœ°æ¨¡å‹é€‰é¡¹
                setLocalModelsEnabled(true);
            } else {
                statusTextElement.textContent = statusText || 'æœ¬åœ°ç¦»çº¿';
                statusDot.style.background = '#ef4444'; // çº¢è‰²
                statusContainer.title = 'æœ¬åœ°æ¨¡å‹ç¦»çº¿ - ç‚¹å‡»é‡æ–°æ£€æµ‹ (è¯·æ£€æŸ¥ LM Studio)';
                // ğŸ¯ ç¦ç”¨æœ¬åœ°æ¨¡å‹é€‰é¡¹
                setLocalModelsEnabled(false);
            }
        }
    }
    
    // æ£€æµ‹ AI æœåŠ¡æ˜¯å¦åœ¨çº¿
    async function checkAIServiceStatus(showLoadingState = true) {
        console.log('ğŸ” æ£€æµ‹æœ¬åœ° AI æœåŠ¡çŠ¶æ€...');
        
        // æ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€
        if (showLoadingState) {
            const statusContainer = document.getElementById('aiStatusContainer');
            const statusTextElement = document.getElementById('aiStatusText');
            const statusDot = document.querySelector('.ai-status-dot');
            
            if (statusContainer && statusTextElement && statusDot) {
                statusTextElement.textContent = 'æ£€æµ‹ä¸­...';
                statusDot.style.background = '#f59e0b'; // æ©™è‰²
                statusContainer.title = 'æ­£åœ¨æ£€æµ‹æœ¬åœ°æ¨¡å‹çŠ¶æ€...';
            }
        }
        
        try {
            // ä½¿ç”¨ä¸“ç”¨çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆæ›´è½»é‡çº§ï¼‰
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
            
            const response = await fetch(AI_HEALTH_URL, {
                method: 'GET',
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            // æ£€æŸ¥ HTTP çŠ¶æ€ç 
            if (response.ok) {
                const data = await response.json();
                
                // æ£€æŸ¥è¿”å›æ•°æ®ä¸­çš„ online å­—æ®µ
                if (data.online === true) {
                    console.log('âœ… æœ¬åœ° AI æœåŠ¡åœ¨çº¿');
                    if (data.models_count !== undefined) {
                        console.log(`ğŸ“¦ å·²åŠ è½½ ${data.models_count} ä¸ªæ¨¡å‹`);
                    }
                    updateAIStatus(true);
                    return true;
                } else {
                    console.warn('âš ï¸ æœ¬åœ° AI æœåŠ¡è¿”å›ç¦»çº¿çŠ¶æ€:', data.message);
                    updateAIStatus(false);
                    return false;
                }
            } else {
                // çŠ¶æ€ç ä¸æ˜¯ 200ï¼Œè¯´æ˜æœåŠ¡ç¦»çº¿
                console.warn('âš ï¸ æœ¬åœ° AI æœåŠ¡å“åº”å¼‚å¸¸:', response.status);
                updateAIStatus(false);
                return false;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('âŒ æœ¬åœ° AI æœåŠ¡æ£€æµ‹è¶…æ—¶');
            } else {
                console.error('âŒ æœ¬åœ° AI æœåŠ¡ç¦»çº¿:', error.message);
            }
            updateAIStatus(false);
            return false;
        }
    }
    
    // å¤„ç† AI çŠ¶æ€ç‚¹å‡»äº‹ä»¶
    async function handleAIStatusClick(event) {
        event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘æŠ˜å /å±•å¼€
        
        // æ£€æŸ¥å½“å‰æ¨¡å‹ç±»å‹
        const currentModel = getSelectedModel();
        if (isOnlineModel(currentModel)) {
            // åœ¨çº¿æ¨¡å‹ï¼Œæ— éœ€æ£€æµ‹
            showNotification('â„¹ï¸ å½“å‰ä½¿ç”¨åœ¨çº¿æ¨¡å‹ï¼Œæ— éœ€æ£€æµ‹æœ¬åœ°æœåŠ¡');
            return;
        }
        
        // æœ¬åœ°æ¨¡å‹ï¼Œé‡æ–°æ£€æµ‹ï¼ˆä¼šæ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€ï¼‰
        const isOnline = await checkAIServiceStatus(true);
        
        // æ˜¾ç¤ºæ£€æµ‹ç»“æœæç¤º
        showNotification(isOnline ? 'âœ… æœ¬åœ°æ¨¡å‹åœ¨çº¿' : 'âŒ æœ¬åœ°æ¨¡å‹ç¦»çº¿ï¼Œè¯·æ£€æŸ¥ LM Studio');
    }
    
    // åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼ˆä¿ç•™ç”¨äºæœªæ¥æ‰©å±•ï¼‰
    async function loadAIModels() {
        console.log('ã€AIã€‘æ¨¡å‹è¾“å…¥æ¡†å·²å°±ç»ª');
        console.log('ã€AIã€‘æç¤ºï¼šæ”¯æŒæœ¬åœ°æ¨¡å‹å’Œåœ¨çº¿æ¨¡å‹');
        
        // ğŸ¯ æ— è®ºé»˜è®¤é€‰ä¸­ä»€ä¹ˆæ¨¡å‹ï¼Œéƒ½å…ˆæ£€æµ‹æœ¬åœ°æœåŠ¡çŠ¶æ€
        const defaultModel = getSelectedModel();
        
        // å…ˆæ£€æµ‹æœ¬åœ°æœåŠ¡ï¼ˆè¿™ä¼šè‡ªåŠ¨ç¦ç”¨/å¯ç”¨æœ¬åœ°æ¨¡å‹é€‰é¡¹ï¼‰
        await checkAIServiceStatus(false); // ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé¿å…é—ªçƒ
        
        // å¦‚æœé»˜è®¤æ˜¯åœ¨çº¿æ¨¡å‹ï¼Œæ›´æ–°çŠ¶æ€æ˜¾ç¤ºä¸ºåœ¨çº¿æ¨¡å‹
        if (isOnlineModel(defaultModel)) {
            updateAIStatus(true, null, 'online');
            console.log('ã€AIã€‘é»˜è®¤ä½¿ç”¨åœ¨çº¿æ¨¡å‹: ' + defaultModel);
        } else {
            console.log('ã€AIã€‘é»˜è®¤ä½¿ç”¨æœ¬åœ°æ¨¡å‹: ' + defaultModel);
        }
    }

    // åˆ‡æ¢ AI èŠå¤©åŠ©æ‰‹å±•å¼€/æŠ˜å 
    window.toggleAIChat = function toggleAIChat() {
        const container = document.getElementById('aiChatContainer');
        if (container) {
            container.classList.toggle('collapsed');
            
            // ä¿å­˜çŠ¶æ€åˆ° localStorage
            const isCollapsed = container.classList.contains('collapsed');
            localStorage.setItem('aiChatCollapsed', isCollapsed);
        }
    }

    // åˆå§‹åŒ– AI èŠå¤©åŠ©æ‰‹æŠ˜å çŠ¶æ€
    function initAIChatState() {
        const container = document.getElementById('aiChatContainer');
        if (container) {
            // ä» localStorage è¯»å–çŠ¶æ€ï¼Œé»˜è®¤ä¸ºæŠ˜å 
            const savedState = localStorage.getItem('aiChatCollapsed');
            const shouldCollapse = savedState === null ? true : savedState === 'true';
            
            if (shouldCollapse) {
                container.classList.add('collapsed');
            } else {
                container.classList.remove('collapsed');
            }
        }
    }

    // æ£€æŸ¥é¦–æ¬¡è®¿é—®æ•°æ®åˆ†æé¡µï¼Œå±•ç¤º AI åŠ©æ‰‹æ¼”ç¤º
    function checkFirstVisitAnalysis() {
        const hasVisitedAnalysis = localStorage.getItem('analysis-page-visited');
        
        if (!hasVisitedAnalysis) {
            console.log('ğŸ‰ é¦–æ¬¡è®¿é—®æ•°æ®åˆ†æé¡µï¼Œæ¼”ç¤º AI åŠ©æ‰‹');
            
            const container = document.getElementById('aiChatContainer');
            if (container) {
                // å»¶è¿Ÿ 800ms åå±•å¼€ AI åŠ©æ‰‹
                setTimeout(() => {
                    container.classList.remove('collapsed');
                    console.log('ğŸ’¬ å±•å¼€ AI åŠ©æ‰‹');
                    
                    // è‡ªåŠ¨æ”¶å›
                    setTimeout(() => {
                        container.classList.add('collapsed');
                        localStorage.setItem('aiChatCollapsed', 'true');
                        console.log('ğŸ’¬ æ”¶å› AI åŠ©æ‰‹');
                        
                        // æ ‡è®°ç”¨æˆ·å·²è®¿é—®è¿‡æ•°æ®åˆ†æé¡µ
                        localStorage.setItem('analysis-page-visited', 'true');
                    }, 800);
                }, 800);
            }
        }
    }

    // åˆå§‹åŒ– AI èŠå¤©è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    function initAIChatInput() {
        const input = document.getElementById('aiChatInput');
        if (!input) return;

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });
    }

    // å‘é€å»ºè®®é—®é¢˜
    function sendSuggestion(text) {
        // å…ˆå±•å¼€ AI åŠ©æ‰‹ï¼ˆå¦‚æœå¤„äºæŠ˜å çŠ¶æ€ï¼‰
        const container = document.getElementById('aiChatContainer');
        if (container && container.classList.contains('collapsed')) {
            container.classList.remove('collapsed');
            localStorage.setItem('aiChatCollapsed', 'false');
            console.log('ğŸ’¬ å±•å¼€ AI åŠ©æ‰‹');
        }
        
        // å¡«å……é—®é¢˜å¹¶å‘é€
        const input = document.getElementById('aiChatInput');
        input.value = text;
        sendAIMessage();
    }
    
    // åˆ‡æ¢å¿«æ·é—®é¢˜æŠ˜å åˆ—è¡¨
    function toggleSuggestionsCollapse() {
        const content = document.getElementById('suggestionsCollapseContent');
        const icon = document.getElementById('suggestionsCollapseIcon');
        
        if (content && icon) {
            const isExpanded = content.classList.contains('show');
            
            if (isExpanded) {
                // æ”¶èµ·
                content.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                // å±•å¼€
                content.classList.add('show');
                icon.classList.add('expanded');
            }
        }
    }
    
    // æ‰‹æœºç«¯ï¼šåˆ‡æ¢é¢„è®¾é—®é¢˜å¼¹çª—
    function toggleMobileSuggestions() {
        const modal = document.getElementById('aiSuggestionsMobileModal');
        const btn = document.getElementById('aiSuggestionsMobileBtn');
        
        if (!modal || !btn) return;
        
        const isOpen = modal.classList.contains('show');
        
        if (isOpen) {
            closeMobileSuggestions();
        } else {
            openMobileSuggestions();
        }
    }
    
    // æ›´æ–°å¼¹çª—ä½ç½®ï¼ˆç”¨äºæ»šåŠ¨æ—¶æ›´æ–°ï¼‰
    let lastMaxHeight = 0; // è®°å½•ä¸Šæ¬¡çš„maxHeightï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
    function updateMobileSuggestionsPosition(updateMaxHeight = true) {
        const modal = document.getElementById('aiSuggestionsMobileModal');
        const content = modal ? modal.querySelector('.ai-suggestions-mobile-content') : null;
        const btn = document.getElementById('aiSuggestionsMobileBtn');
        
        if (!modal || !content || !btn || !modal.classList.contains('show')) return;
        
        // è®¡ç®—æŒ‰é’®çš„ä½ç½®å’Œå°ºå¯¸ï¼ˆgetBoundingClientRectè¿”å›ç›¸å¯¹äºè§†å£çš„åæ ‡ï¼‰
        const btnRect = btn.getBoundingClientRect();
        
        // å¼¹çª—å®½åº¦ä¸æŒ‰é’®å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬è¾¹æ¡†ï¼‰
        content.style.width = `${btnRect.width}px`;
        content.style.left = `${btnRect.left}px`;
        content.style.right = 'auto';
        
        // å¼¹çª—åº•éƒ¨ç´§è´´æŒ‰é’®é¡¶éƒ¨ï¼ˆä½¿ç”¨fixedå®šä½ï¼Œç›´æ¥ä½¿ç”¨è§†å£åæ ‡ï¼‰
        // iOS Safari ä½¿ç”¨ visualViewport è·å–æ›´å‡†ç¡®çš„è§†å£é«˜åº¦
        const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        content.style.bottom = `${viewportHeight - btnRect.top}px`;
        content.style.top = 'auto';
        
        // åªåœ¨éœ€è¦æ—¶æ›´æ–°maxHeightï¼ˆé¿å…æ»šåŠ¨æ—¶é¢‘ç¹æ›´æ–°å¯¼è‡´å¸ƒå±€æŠ–åŠ¨ï¼‰
        if (updateMaxHeight) {
            // è®¡ç®—å¯ç”¨é«˜åº¦ï¼ˆæŒ‰é’®ä¸Šæ–¹åˆ°å±å¹•é¡¶éƒ¨çš„è·ç¦»ï¼‰
            const availableHeight = btnRect.top;
            
            // è®¾ç½®å¼¹çª—çš„æœ€å¤§é«˜åº¦ï¼ˆä¸è¶…è¿‡å¯ç”¨é«˜åº¦ï¼Œä½†è‡³å°‘ä¿ç•™æœ€å°é«˜åº¦ï¼‰
            const minHeight = 200; // æœ€å°é«˜åº¦200px
            const calculatedMaxHeight = Math.max(minHeight, availableHeight - 20); // ç•™20pxè¾¹è·
            
            // åªåœ¨å€¼çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„å¸ƒå±€é‡æ’
            if (Math.abs(calculatedMaxHeight - lastMaxHeight) > 5) { // 5pxå®¹å·®
                content.style.maxHeight = `${calculatedMaxHeight}px`;
                lastMaxHeight = calculatedMaxHeight;
            }
        }
    }
    
    // æ»šåŠ¨ç›‘å¬å™¨ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–ï¼‰
    let mobileSuggestionsScrollHandler = null;
    let mobileSuggestionsResizeHandler = null;
    let mobileSuggestionsVisualViewportResizeHandler = null;
    let mobileSuggestionsVisualViewportScrollHandler = null;
    let scrollUpdateRafId = null;
    
    // æ‰‹æœºç«¯ï¼šæ‰“å¼€é¢„è®¾é—®é¢˜å¼¹çª—
    function openMobileSuggestions() {
        const modal = document.getElementById('aiSuggestionsMobileModal');
        const content = modal.querySelector('.ai-suggestions-mobile-content');
        const btn = document.getElementById('aiSuggestionsMobileBtn');
        
        if (!modal || !content || !btn) return;
        
        // é‡ç½®maxHeightè®°å½•ï¼Œç¡®ä¿æ­£ç¡®è®¡ç®—åˆå§‹é«˜åº¦
        lastMaxHeight = 0;
        
        // æ›´æ–°ä½ç½®
        updateMobileSuggestionsPosition();
        
        // å…ˆè®¾ç½®max-heightä¸º0ï¼Œç„¶åç«‹å³è®¾ç½®ä¸ºç›®æ ‡å€¼ï¼Œè§¦å‘åŠ¨ç”»
        content.style.maxHeight = '0px';
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿æ ·å¼å·²åº”ç”¨
        requestAnimationFrame(() => {
            updateMobileSuggestionsPosition();
        });
        
        modal.classList.add('show');
        btn.classList.add('active');
        
        // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼ˆä½¿ç”¨ requestAnimationFrame èŠ‚æµï¼‰
        if (!mobileSuggestionsScrollHandler) {
            mobileSuggestionsScrollHandler = () => {
                // å–æ¶ˆä¹‹å‰çš„æ›´æ–°è¯·æ±‚
                if (scrollUpdateRafId) {
                    cancelAnimationFrame(scrollUpdateRafId);
                }
                // ä½¿ç”¨ requestAnimationFrame èŠ‚æµï¼Œé¿å…é¢‘ç¹æ›´æ–°
                scrollUpdateRafId = requestAnimationFrame(() => {
                    // æ»šåŠ¨æ—¶åªæ›´æ–°ä½ç½®ï¼Œä¸æ›´æ–°maxHeightï¼ˆé¿å…å¸ƒå±€æŠ–åŠ¨ï¼‰
                    updateMobileSuggestionsPosition(false);
                    scrollUpdateRafId = null;
                });
            };
            
            mobileSuggestionsResizeHandler = () => {
                // resize æ—¶æ›´æ–°ä½ç½®å’ŒmaxHeight
                updateMobileSuggestionsPosition(true);
            };
            
            window.addEventListener('scroll', mobileSuggestionsScrollHandler, { passive: true });
            window.addEventListener('resize', mobileSuggestionsResizeHandler);
            
            // iOS Safari éœ€è¦ç›‘å¬ visualViewport å˜åŒ–
            if (window.visualViewport) {
                mobileSuggestionsVisualViewportResizeHandler = () => {
                    updateMobileSuggestionsPosition(true);
                };
                mobileSuggestionsVisualViewportScrollHandler = mobileSuggestionsScrollHandler;
                window.visualViewport.addEventListener('resize', mobileSuggestionsVisualViewportResizeHandler);
                window.visualViewport.addEventListener('scroll', mobileSuggestionsVisualViewportScrollHandler);
            }
        }
    }
    
    // æ‰‹æœºç«¯ï¼šå…³é—­é¢„è®¾é—®é¢˜å¼¹çª—
    function closeMobileSuggestions(event) {
        // å¦‚æœä¼ å…¥äº†eventï¼Œæ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯å†…å®¹åŒºåŸŸ
        if (event) {
            // ç‚¹å‡»çš„æ˜¯å†…å®¹åŒºåŸŸå†…éƒ¨ï¼Œä¸å…³é—­ï¼ˆé™¤éæ˜¯å…³é—­æŒ‰é’®ï¼‰
            if (event.target.closest('.ai-suggestions-mobile-content') && 
                !event.target.closest('.ai-suggestions-mobile-close')) {
                return;
            }
        }
        
        const modal = document.getElementById('aiSuggestionsMobileModal');
        const content = modal ? modal.querySelector('.ai-suggestions-mobile-content') : null;
        const btn = document.getElementById('aiSuggestionsMobileBtn');
        
        if (!modal || !btn) return;
        
        // å…ˆè®¾ç½®max-heightä¸º0ï¼Œè§¦å‘æ”¶èµ·åŠ¨ç”»
        if (content) {
            content.style.maxHeight = '0px';
        }
        
        // ç«‹å³ç§»é™¤æŒ‰é’®çš„activeç±»ï¼Œè®©åœ†è§’å˜åŒ–ä¸å¼¹çª—æ”¶èµ·åŠ¨ç”»åŒæ­¥
        btn.classList.remove('active');
        
        // ç§»é™¤æ»šåŠ¨ç›‘å¬å™¨
        if (mobileSuggestionsScrollHandler) {
            // å–æ¶ˆå¾…å¤„ç†çš„åŠ¨ç”»å¸§
            if (scrollUpdateRafId) {
                cancelAnimationFrame(scrollUpdateRafId);
                scrollUpdateRafId = null;
            }
            
            window.removeEventListener('scroll', mobileSuggestionsScrollHandler);
            if (mobileSuggestionsResizeHandler) {
                window.removeEventListener('resize', mobileSuggestionsResizeHandler);
            }
            
            // ç§»é™¤ visualViewport ç›‘å¬å™¨
            if (window.visualViewport) {
                if (mobileSuggestionsVisualViewportResizeHandler) {
                    window.visualViewport.removeEventListener('resize', mobileSuggestionsVisualViewportResizeHandler);
                }
                if (mobileSuggestionsVisualViewportScrollHandler) {
                    window.visualViewport.removeEventListener('scroll', mobileSuggestionsVisualViewportScrollHandler);
                }
            }
            
            mobileSuggestionsScrollHandler = null;
            mobileSuggestionsResizeHandler = null;
            mobileSuggestionsVisualViewportResizeHandler = null;
            mobileSuggestionsVisualViewportScrollHandler = null;
            lastMaxHeight = 0; // é‡ç½®è®°å½•
        }
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†ç§»é™¤showç±»å’Œé‡ç½®æ ·å¼
        setTimeout(() => {
            modal.classList.remove('show');
            
            if (content) {
                content.style.top = '';
                content.style.bottom = '';
                content.style.left = '';
                content.style.right = '';
                content.style.width = '';
                content.style.maxHeight = '';
            }
        }, 600); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
    }
    
    // æ‰‹æœºç«¯ï¼šé€‰æ‹©é¢„è®¾é—®é¢˜
    function selectMobileSuggestion(text) {
        // å…³é—­å¼¹çª—
        closeMobileSuggestions();
        
        // å‘é€é—®é¢˜
        sendSuggestion(text);
    }

    // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ï¼ˆå¹³å‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ã€åˆ†ä½æ•°ç­‰ï¼‰
    function calculateStatistics(values) {
        if (!values || values.length === 0) return null;
        
        const sorted = [...values].sort((a, b) => a - b);
        const n = sorted.length;
        const sum = sorted.reduce((a, b) => a + b, 0);
        const mean = sum / n;
        
        // è®¡ç®—æ ‡å‡†å·®
        const variance = sorted.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
        const stdDev = Math.sqrt(variance);
        
        // è®¡ç®—ä¸­ä½æ•°
        const median = n % 2 === 0 
            ? (sorted[n/2 - 1] + sorted[n/2]) / 2 
            : sorted[Math.floor(n/2)];
        
        // è®¡ç®—åˆ†ä½æ•°
        const percentile = (arr, p) => {
            const index = (arr.length - 1) * p;
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index - lower;
            return arr[lower] * (1 - weight) + arr[upper] * weight;
        };
        
        return {
            å¹³å‡å€¼: mean,
            ä¸­ä½æ•°: median,
            æ ‡å‡†å·®: stdDev,
            æœ€å°å€¼: sorted[0],
            æœ€å¤§å€¼: sorted[n - 1],
            ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: percentile(sorted, 0.25),
            ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: percentile(sorted, 0.75),
            å››åˆ†ä½è·_IQR: percentile(sorted, 0.75) - percentile(sorted, 0.25),
            æ•°æ®é‡: n
        };
    }
    
    // æŒ‰æ—¶é—´è½´é¡ºåºè·å–æ•°æ®ï¼ˆæ™ºèƒ½é‡‡æ ·ï¼Œç®€åŒ–æ ¼å¼ä»¥å‡å°‘tokenæ¶ˆè€—ï¼‰
    function getTimeSeriesData(data, field, maxSamples = 50) {
        if (!data || data.length === 0) return [];
        
        // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆç¡®ä¿æ—¶é—´é¡ºåºï¼‰
        const sortedData = [...data].sort((a, b) => a.ts - b.ts);
        
        const validData = sortedData.filter(d => d[field] != null && !isNaN(d[field]));
        if (validData.length === 0) return [];
        
        // å¦‚æœæ•°æ®é‡å°äºç­‰äºæœ€å¤§é‡‡æ ·æ•°ï¼Œè¿”å›å…¨éƒ¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
        if (validData.length <= maxSamples) {
            return validData.map(d => {
                const date = new Date(d.ts * 1000);
                // ç®€åŒ–æ—¶é—´æ ¼å¼ï¼šåªä¿ç•™æœˆ-æ—¥ æ—¶:åˆ†
                const timeStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                return [timeStr, Number(d[field].toFixed(2))];
            });
        }
        
        // æ™ºèƒ½é‡‡æ ·ï¼šå‡åŒ€é‡‡æ · + ä¿ç•™é¦–å°¾
        const step = Math.floor(validData.length / maxSamples);
        const samples = [];
        
        // ä¿ç•™ç¬¬ä¸€æ¡
        const first = validData[0];
        const firstDate = new Date(first.ts * 1000);
        const firstTimeStr = `${String(firstDate.getMonth() + 1).padStart(2, '0')}-${String(firstDate.getDate()).padStart(2, '0')} ${String(firstDate.getHours()).padStart(2, '0')}:${String(firstDate.getMinutes()).padStart(2, '0')}`;
        samples.push([firstTimeStr, Number(first[field].toFixed(2))]);
        
        // å‡åŒ€é‡‡æ ·ä¸­é—´æ•°æ®
        for (let i = step; i < validData.length - step; i += step) {
            const d = validData[i];
            const date = new Date(d.ts * 1000);
            const timeStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            samples.push([timeStr, Number(d[field].toFixed(2))]);
        }
        
        // ä¿ç•™æœ€åä¸€æ¡
        const last = validData[validData.length - 1];
        const lastDate = new Date(last.ts * 1000);
        const lastTimeStr = `${String(lastDate.getMonth() + 1).padStart(2, '0')}-${String(lastDate.getDate()).padStart(2, '0')} ${String(lastDate.getHours()).padStart(2, '0')}:${String(lastDate.getMinutes()).padStart(2, '0')}`;
        samples.push([lastTimeStr, Number(last[field].toFixed(2))]);
        
        return samples;
    }
    
    // è·å–è­¦å‘Šæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´æ®µï¼Œè°ƒç”¨åç«¯APIï¼‰
    async function getWarningData() {
        try {
            // è·å–å½“å‰æ•°æ®çš„æ—¶é—´èŒƒå›´
            if (!currentData || currentData.length === 0) {
                console.warn('âš ï¸ å½“å‰æ— æ•°æ®ï¼Œæ— æ³•è·å–è­¦å‘Š');
                return null;
            }
            
            const minTime = Math.min(...currentData.map(d => d.ts));
            const maxTime = Math.max(...currentData.map(d => d.ts));
            
            console.log(`ğŸ” è·å–è­¦å‘Šæ•°æ® - æ—¶é—´èŒƒå›´: ${new Date(minTime * 1000).toLocaleString('zh-CN')} è‡³ ${new Date(maxTime * 1000).toLocaleString('zh-CN')}`);
            console.log(`ğŸ” æ—¶é—´æˆ³èŒƒå›´: ${minTime} è‡³ ${maxTime}`);
            
            // è®¡ç®—æ—¶é—´èŒƒå›´å†…æ¶‰åŠçš„æ‰€æœ‰æ—¥æœŸ
            const dates = new Set();
            const minDateObj = new Date(minTime * 1000);
            const maxDateObj = new Date(maxTime * 1000);
            
            // ä»æœ€å°æ—¥æœŸåˆ°æœ€å¤§æ—¥æœŸï¼Œæ”¶é›†æ‰€æœ‰æ—¥æœŸ
            const currentDate = new Date(minDateObj);
            currentDate.setHours(0, 0, 0, 0);
            const endDate = new Date(maxDateObj);
            endDate.setHours(23, 59, 59, 999);
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                dates.add(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const dateArray = Array.from(dates);
            console.log(`ğŸ“… æ¶‰åŠæ—¥æœŸ: ${dateArray.join(', ')}`);
            
            // è·å–æ‰€æœ‰ç›¸å…³æ—¥æœŸçš„è­¦å‘Šæ•°æ®ï¼ˆä½¿ç”¨æ¶ˆæ¯ä¸­å¿ƒçš„è°ƒç”¨æ–¹å¼ï¼‰
            const allWarnings = [];
            
            // å¦‚æœæ—¥æœŸä¸è¶…è¿‡7å¤©ï¼ŒæŒ‰æ—¥æœŸé€ä¸ªè·å–ï¼ˆæ›´ç²¾ç¡®ï¼‰
            if (dateArray.length <= 7) {
                console.log(`ğŸ“¡ æŒ‰æ—¥æœŸé€ä¸ªè·å–è­¦å‘Šï¼ˆ${dateArray.length}å¤©ï¼‰`);
                for (const date of dateArray) {
                    try {
                        const url = `/api/warnings?limit=1000&date=${date}`;
                        console.log(`  â†’ è¯·æ±‚: ${url}`);
                        const response = await fetch(url);
                        if (response.ok) {
                            const result = await response.json();
                            console.log(`  â†’ å“åº”:`, result);
                            if (result.success && result.data && Array.isArray(result.data)) {
                                console.log(`  âœ“ æ—¥æœŸ ${date}: è·å–åˆ° ${result.data.length} æ¡è­¦å‘Š`);
                                if (result.data.length > 0) {
                                    // æ‰“å°ç¬¬ä¸€æ¡è­¦å‘Šçš„ç¤ºä¾‹ï¼Œç”¨äºè°ƒè¯•
                                    console.log(`  â†’ ç¤ºä¾‹è­¦å‘Š:`, JSON.stringify(result.data[0], null, 2));
                                }
                                allWarnings.push(...result.data);
                            } else {
                                console.log(`  âš  æ—¥æœŸ ${date}: APIè¿”å›å¤±è´¥æˆ–æ•°æ®ä¸ºç©º`, result);
                            }
                        } else {
                            const errorText = await response.text().catch(() => 'æ— æ³•è¯»å–é”™è¯¯ä¿¡æ¯');
                            console.warn(`  âŒ æ—¥æœŸ ${date}: HTTP ${response.status}`, errorText);
                        }
                    } catch (e) {
                        console.error(`  âŒ æ—¥æœŸ ${date} çš„è­¦å‘Šè·å–å¤±è´¥:`, e);
                    }
                }
            } else {
                // å¦‚æœæ—¥æœŸè¶…è¿‡7å¤©ï¼Œä¸€æ¬¡æ€§è·å–æ‰€æœ‰è­¦å‘Šï¼Œç„¶åè¿‡æ»¤
                console.log(`ğŸ“¡ ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è­¦å‘Šï¼ˆæ—¥æœŸè¶…è¿‡7å¤©ï¼‰`);
                try {
                    const response = await fetch(`/api/warnings?limit=5000`);
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`  â†’ å“åº”:`, result);
                        if (result.success && result.data && Array.isArray(result.data)) {
                            console.log(`  âœ“ è·å–åˆ° ${result.data.length} æ¡è­¦å‘Š`);
                            if (result.data.length > 0) {
                                // æ‰“å°ç¬¬ä¸€æ¡è­¦å‘Šçš„ç¤ºä¾‹ï¼Œç”¨äºè°ƒè¯•
                                console.log(`  â†’ ç¤ºä¾‹è­¦å‘Š:`, JSON.stringify(result.data[0], null, 2));
                            }
                            allWarnings.push(...result.data);
                        } else {
                            console.log(`  âš  APIè¿”å›å¤±è´¥æˆ–æ•°æ®ä¸ºç©º`, result);
                        }
                    } else {
                        const errorText = await response.text().catch(() => 'æ— æ³•è¯»å–é”™è¯¯ä¿¡æ¯');
                        console.warn(`  âŒ HTTP ${response.status}`, errorText);
                    }
                } catch (e) {
                    console.error(`  âŒ è·å–è­¦å‘Šå¤±è´¥:`, e);
                }
            }
            
            console.log(`ğŸ“Š æ€»å…±è·å–åˆ° ${allWarnings.length} æ¡è­¦å‘Šï¼ˆè¿‡æ»¤å‰ï¼‰`);
            
            // è¿‡æ»¤å‡ºæ—¶é—´èŒƒå›´å†…çš„è­¦å‘Šï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
            // æ³¨æ„ï¼šwarning_start_time å¯èƒ½æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆæ•°å­—ï¼‰æˆ–æ—¥æœŸå­—ç¬¦ä¸²
            let debugCount = 0; // ç”¨äºé™åˆ¶è°ƒè¯•ä¿¡æ¯æ•°é‡
            const filteredWarnings = allWarnings.filter(w => {
                if (!w.warning_start_time) return false;
                
                let warningTime;
                // åˆ¤æ–­ warning_start_time çš„ç±»å‹
                if (typeof w.warning_start_time === 'number') {
                    // å¦‚æœæ˜¯æ•°å­—ï¼Œåˆ¤æ–­æ˜¯ç§’çº§è¿˜æ˜¯æ¯«ç§’çº§æ—¶é—´æˆ³
                    // å¦‚æœå°äº 10000000000ï¼Œè®¤ä¸ºæ˜¯ç§’çº§ï¼›å¦åˆ™æ˜¯æ¯«ç§’çº§
                    if (w.warning_start_time < 10000000000) {
                        // ç§’çº§æ—¶é—´æˆ³
                        warningTime = w.warning_start_time;
                    } else {
                        // æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºç§’
                        warningTime = Math.floor(w.warning_start_time / 1000);
                    }
                } else {
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ Date è§£æ
                    warningTime = Math.floor(new Date(w.warning_start_time).getTime() / 1000);
                }
                
                const inRange = warningTime >= minTime && warningTime <= maxTime;
                
                // æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆå‰10æ¡ä¸åœ¨èŒƒå›´å†…çš„è­¦å‘Šï¼‰
                if (!inRange && debugCount < 10) {
                    debugCount++;
                    const warningDate = new Date(warningTime * 1000).toLocaleString('zh-CN');
                    const minDate = new Date(minTime * 1000).toLocaleString('zh-CN');
                    const maxDate = new Date(maxTime * 1000).toLocaleString('zh-CN');
                    console.log(`  âš  è­¦å‘Šæ—¶é—´ ${warningDate} (${warningTime}) ä¸åœ¨èŒƒå›´å†… [${minDate} (${minTime}), ${maxDate} (${maxTime})]`);
                }
                
                return inRange;
            });
            
            console.log(`ğŸ“Š è¿‡æ»¤åå‰©ä½™ ${filteredWarnings.length} æ¡è­¦å‘Š`);
            
            // å¦‚æœè¿‡æ»¤åä¸º0ä½†æœ‰è­¦å‘Šæ•°æ®ï¼Œæ‰“å°æ›´å¤šè°ƒè¯•ä¿¡æ¯
            if (filteredWarnings.length === 0 && allWarnings.length > 0) {
                console.warn('âš ï¸ è­¦å‘Šï¼šè·å–åˆ°è­¦å‘Šä½†è¿‡æ»¤åä¸º0ï¼Œæ£€æŸ¥æ—¶é—´èŒƒå›´åŒ¹é…');
                const sampleWarning = allWarnings[0];
                let sampleTime;
                if (typeof sampleWarning.warning_start_time === 'number') {
                    sampleTime = sampleWarning.warning_start_time < 10000000000 
                        ? sampleWarning.warning_start_time 
                        : Math.floor(sampleWarning.warning_start_time / 1000);
                } else {
                    sampleTime = Math.floor(new Date(sampleWarning.warning_start_time).getTime() / 1000);
                }
                console.log(`  ç¤ºä¾‹è­¦å‘Šæ—¶é—´æˆ³: ${sampleWarning.warning_start_time} (è§£æå: ${sampleTime})`);
                console.log(`  æ•°æ®æ—¶é—´èŒƒå›´: ${minTime} è‡³ ${maxTime}`);
                console.log(`  æ—¶é—´å·®: ${sampleTime - minTime} ç§’ (å¦‚æœä¸ºè´Ÿï¼Œè¯´æ˜è­¦å‘Šåœ¨æ•°æ®ä¹‹å‰)`);
            }
            
            // å»é‡ï¼ˆæ ¹æ®idï¼‰
            const uniqueWarnings = [];
            const seenIds = new Set();
            filteredWarnings.forEach(w => {
                if (w.id && !seenIds.has(w.id)) {
                    seenIds.add(w.id);
                    uniqueWarnings.push(w);
                } else if (!w.id) {
                    // å¦‚æœæ²¡æœ‰idï¼Œä½¿ç”¨æ—¶é—´+ç±»å‹+å€¼ä½œä¸ºå”¯ä¸€æ ‡è¯†
                    const key = `${w.warning_start_time}_${w.warning_type}_${w.warning_value}`;
                    if (!seenIds.has(key)) {
                        seenIds.add(key);
                        uniqueWarnings.push(w);
                    }
                }
            });
            
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            uniqueWarnings.sort((a, b) => {
                const timeA = new Date(a.warning_start_time).getTime();
                const timeB = new Date(b.warning_start_time).getTime();
                return timeB - timeA;
            });
            
            // è½¬æ¢ä¸ºç®€åŒ–æ ¼å¼ï¼Œå‡å°‘tokenæ¶ˆè€—
            const simplifiedWarnings = uniqueWarnings.map(w => {
                const typeName = {
                    'T': 'æ¸©åº¦',
                    'H': 'æ¹¿åº¦',
                    'B': 'äº®åº¦',
                    'S': 'çƒŸé›¾',
                    'P': 'å¤§æ°”å‹'
                }[w.warning_type] || w.warning_type;
                
                const date = new Date(w.warning_start_time);
                const timeStr = `${date.getMonth() + 1}-${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                return {
                    ç±»å‹: typeName,
                    æ—¶é—´: timeStr,
                    å€¼: w.warning_value,
                    æ¶ˆæ¯: w.warning_message,
                    çŠ¶æ€: w.is_resolved ? 'å·²æ¢å¤' : 'æœªæ¢å¤',
                    æ¢å¤æ—¶é—´: w.warning_resolved_time ? new Date(w.warning_resolved_time).toLocaleString('zh-CN') : null
                };
            });
            
            // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ï¼ˆåŸºäºæ‰€æœ‰å»é‡åçš„è­¦å‘Šï¼Œè€Œä¸æ˜¯åªåŸºäºå‰50æ¡ï¼‰
            const totalCount = uniqueWarnings.length;
            const stats = {
                æ€»è­¦å‘Šæ•°: totalCount,
                æŒ‰ç±»å‹ç»Ÿè®¡: {},
                æŒ‰çŠ¶æ€ç»Ÿè®¡: {
                    æœªæ¢å¤: 0,
                    å·²æ¢å¤: 0
                }
            };
            
            // ç»Ÿè®¡æ‰€æœ‰è­¦å‘Šï¼ˆä¸ä»…ä»…æ˜¯å‰50æ¡ï¼‰
            uniqueWarnings.forEach(w => {
                const typeName = {
                    'T': 'æ¸©åº¦',
                    'H': 'æ¹¿åº¦',
                    'B': 'äº®åº¦',
                    'S': 'çƒŸé›¾',
                    'P': 'å¤§æ°”å‹'
                }[w.warning_type] || w.warning_type;
                
                if (!stats.æŒ‰ç±»å‹ç»Ÿè®¡[typeName]) {
                    stats.æŒ‰ç±»å‹ç»Ÿè®¡[typeName] = {
                        æ•°é‡: 0,
                        æœªæ¢å¤: 0,
                        å·²æ¢å¤: 0
                    };
                }
                stats.æŒ‰ç±»å‹ç»Ÿè®¡[typeName].æ•°é‡++;
                if (w.is_resolved) {
                    stats.æŒ‰çŠ¶æ€ç»Ÿè®¡.å·²æ¢å¤++;
                    stats.æŒ‰ç±»å‹ç»Ÿè®¡[typeName].å·²æ¢å¤++;
                } else {
                    stats.æŒ‰çŠ¶æ€ç»Ÿè®¡.æœªæ¢å¤++;
                    stats.æŒ‰ç±»å‹ç»Ÿè®¡[typeName].æœªæ¢å¤++;
                }
            });
            
            console.log(`âœ… æœ€ç»ˆè¿”å› ${simplifiedWarnings.slice(0, 50).length} æ¡è­¦å‘Šç»™AIï¼ˆæ€»è®¡ ${totalCount} æ¡ï¼‰`);
            
            return {
                ç»Ÿè®¡: stats,
                è­¦å‘Šåˆ—è¡¨: simplifiedWarnings.slice(0, 50) // æœ€å¤šè¿”å›50æ¡è­¦å‘Šï¼Œé¿å…æ•°æ®é‡è¿‡å¤§
            };
        } catch (error) {
            console.error('âŒ è·å–è­¦å‘Šæ•°æ®å¤±è´¥:', error);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
            return null;
        }
    }
    
    // æ£€æµ‹å¼‚å¸¸å€¼ï¼ˆä½¿ç”¨IQRæ–¹æ³•ï¼‰
    function detectOutliers(values, stats) {
        if (!values || !stats) return [];
        
        const Q1 = stats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1;
        const Q3 = stats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3;
        const IQR = stats.å››åˆ†ä½è·_IQR;
        const lowerBound = Q1 - 1.5 * IQR;
        const upperBound = Q3 + 1.5 * IQR;
        
        const outliers = [];
        values.forEach((val, idx) => {
            if (val < lowerBound || val > upperBound) {
                outliers.push({
                    ç´¢å¼•: idx,
                    å€¼: val,
                    ç±»å‹: val < lowerBound ? 'è¿‡ä½å¼‚å¸¸' : 'è¿‡é«˜å¼‚å¸¸'
                });
            }
        });
        
        return outliers.slice(0, 20); // æœ€å¤šè¿”å›20ä¸ªå¼‚å¸¸å€¼
    }

    // å‡†å¤‡æ•°æ®æ‘˜è¦ï¼ˆå‘é€ç»™AIï¼‰- å¢å¼ºç‰ˆï¼ŒåŒ…å«æ—¶é—´åºåˆ—æ•°æ®å’Œè­¦å‘Šç»Ÿè®¡
    async function prepareDataSummary() {
        if (!currentData || currentData.length === 0) {
            return 'å½“å‰æ²¡æœ‰åŠ è½½ä»»ä½•æ•°æ®ã€‚';
        }

        const temps = currentData.map(d => d.temp).filter(v => v != null && !isNaN(v));
        const hums = currentData.map(d => d.hum).filter(v => v != null && !isNaN(v));
        const luxs = currentData.map(d => d.lux).filter(v => v != null && !isNaN(v));
        const smokes = currentData.map(d => d.smoke).filter(v => v != null && !isNaN(v));
        const pressures = currentData.map(d => d.pressure).filter(v => v != null && !isNaN(v));

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾æœ€å€¼å¯¹åº”çš„æ—¶é—´æˆ³
        const findTimestamp = (field, value) => {
            const record = currentData.find(d => d[field] === value);
            return record ? new Date(record.ts * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥';
        };
        
        // è®¡ç®—å„ä¼ æ„Ÿå™¨çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
        const tempStats = calculateStatistics(temps);
        const humStats = calculateStatistics(hums);
        const luxStats = calculateStatistics(luxs);
        const smokeStats = calculateStatistics(smokes);
        const pressureStats = calculateStatistics(pressures);
        
        // æŒ‰æ—¶é—´è½´é¡ºåºè·å–æ•°æ®ï¼ˆæ¯ä¸ªä¼ æ„Ÿå™¨æœ€å¤š50ä¸ªæ•°æ®ç‚¹ï¼ŒæŒ‰æ—¶é—´é¡ºåºï¼Œç”¨äºè¶‹åŠ¿åˆ†æï¼‰
        // å¤§å¹…å‡å°‘æ•°æ®é‡ï¼Œé¿å…è¶…è¿‡tokené™åˆ¶
        const tempTimeSeries = getTimeSeriesData(currentData, 'temp', 50);
        const humTimeSeries = getTimeSeriesData(currentData, 'hum', 50);
        const luxTimeSeries = getTimeSeriesData(currentData, 'lux', 50);
        const smokeTimeSeries = getTimeSeriesData(currentData, 'smoke', 50);
        const pressureTimeSeries = getTimeSeriesData(currentData, 'pressure', 50);
        
        // æ£€æµ‹å¼‚å¸¸å€¼
        const tempOutliers = tempStats ? detectOutliers(temps, tempStats) : [];
        const humOutliers = humStats ? detectOutliers(hums, humStats) : [];
        const luxOutliers = luxStats ? detectOutliers(luxs, luxStats) : [];
        const smokeOutliers = smokeStats ? detectOutliers(smokes, smokeStats) : [];
        const pressureOutliers = pressureStats ? detectOutliers(pressures, pressureStats) : [];
        
        // è°ƒç”¨åç«¯APIè·å–è­¦å‘Šæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´æ®µï¼‰
        const warningData = await getWarningData();
        
        // åˆ†ææ•°æ®ä¸­çš„è®¾å¤‡IDï¼ˆç”¨äºå¤šè®¾å¤‡åˆ†æï¼‰
        const deviceIdsInData = new Set();
        currentData.forEach(d => {
            if (d.device_id) {
                deviceIdsInData.add(d.device_id.toUpperCase());
            }
        });
        const deviceCount = deviceIdsInData.size;
        const isMultiDeviceData = deviceCount > 1;
        
        // è·å–è®¾å¤‡åç§°æ˜ å°„
        let deviceNameMap = {};
        try {
            const res = await fetch('/api/devices');
            if (res.ok) {
                const data = await res.json();
                if (data.success && data.devices) {
                    data.devices.forEach(device => {
                        const id = (device.id || device.device_id || '').toString().trim().toUpperCase();
                        deviceNameMap[id] = device.name || `è®¾å¤‡ ${id}`;
                    });
                }
            }
        } catch (error) {
            console.warn('è·å–è®¾å¤‡åç§°æ˜ å°„å¤±è´¥ï¼š', error);
        }
        
        // æŒ‰è®¾å¤‡åˆ†ç»„ç»Ÿè®¡æ•°æ®ï¼ˆä»…å¤šè®¾å¤‡æ—¶ï¼‰
        let deviceStats = null;
        if (isMultiDeviceData) {
            deviceStats = {};
            Array.from(deviceIdsInData).forEach(deviceId => {
                const deviceData = currentData.filter(d => {
                    const dId = d.device_id ? d.device_id.toString().trim().toUpperCase() : '';
                    return dId === deviceId;
                });
                
                if (deviceData.length > 0) {
                    const deviceTemps = deviceData.map(d => d.temp).filter(v => v != null && !isNaN(v));
                    const deviceHums = deviceData.map(d => d.hum).filter(v => v != null && !isNaN(v));
                    const deviceLuxs = deviceData.map(d => d.lux).filter(v => v != null && !isNaN(v));
                    const deviceSmokes = deviceData.map(d => d.smoke).filter(v => v != null && !isNaN(v));
                    const devicePressures = deviceData.map(d => d.pressure).filter(v => v != null && !isNaN(v));
                    
                    const findDeviceTimestamp = (field, value) => {
                        const record = deviceData.find(d => d[field] === value);
                        return record ? new Date(record.ts * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥';
                    };
                    
                    deviceStats[deviceId] = {
                        è®¾å¤‡åç§°: deviceNameMap[deviceId] || `è®¾å¤‡ ${deviceId}`,
                        è®¾å¤‡ID: deviceId,
                        æ•°æ®é‡: deviceData.length,
                        æ¸©åº¦: deviceTemps.length > 0 ? {
                            å¹³å‡å€¼: calculateStatistics(deviceTemps).å¹³å‡å€¼.toFixed(2) + 'Â°C',
                            æœ€å°å€¼: calculateStatistics(deviceTemps).æœ€å°å€¼.toFixed(2) + 'Â°C',
                            æœ€å¤§å€¼: calculateStatistics(deviceTemps).æœ€å¤§å€¼.toFixed(2) + 'Â°C',
                            æ ‡å‡†å·®: calculateStatistics(deviceTemps).æ ‡å‡†å·®.toFixed(2) + 'Â°C'
                        } : null,
                        æ¹¿åº¦: deviceHums.length > 0 ? {
                            å¹³å‡å€¼: calculateStatistics(deviceHums).å¹³å‡å€¼.toFixed(2) + '%',
                            æœ€å°å€¼: calculateStatistics(deviceHums).æœ€å°å€¼.toFixed(2) + '%',
                            æœ€å¤§å€¼: calculateStatistics(deviceHums).æœ€å¤§å€¼.toFixed(2) + '%',
                            æ ‡å‡†å·®: calculateStatistics(deviceHums).æ ‡å‡†å·®.toFixed(2) + '%'
                        } : null,
                        å…‰ç…§: deviceLuxs.length > 0 ? {
                            å¹³å‡å€¼: calculateStatistics(deviceLuxs).å¹³å‡å€¼.toFixed(2) + ' lux',
                            æœ€å°å€¼: calculateStatistics(deviceLuxs).æœ€å°å€¼.toFixed(2) + ' lux',
                            æœ€å¤§å€¼: calculateStatistics(deviceLuxs).æœ€å¤§å€¼.toFixed(2) + ' lux',
                            æ ‡å‡†å·®: calculateStatistics(deviceLuxs).æ ‡å‡†å·®.toFixed(2) + ' lux'
                        } : null,
                        çƒŸé›¾: deviceSmokes.length > 0 ? {
                            å¹³å‡å€¼: calculateStatistics(deviceSmokes).å¹³å‡å€¼.toFixed(2) + ' ppm',
                            æœ€å°å€¼: calculateStatistics(deviceSmokes).æœ€å°å€¼.toFixed(2) + ' ppm',
                            æœ€å¤§å€¼: calculateStatistics(deviceSmokes).æœ€å¤§å€¼.toFixed(2) + ' ppm',
                            æ ‡å‡†å·®: calculateStatistics(deviceSmokes).æ ‡å‡†å·®.toFixed(2) + ' ppm'
                        } : null,
                        å¤§æ°”å‹: devicePressures.length > 0 ? {
                            å¹³å‡å€¼: calculateStatistics(devicePressures).å¹³å‡å€¼.toFixed(2) + ' hPa',
                            æœ€å°å€¼: calculateStatistics(devicePressures).æœ€å°å€¼.toFixed(2) + ' hPa',
                            æœ€å¤§å€¼: calculateStatistics(devicePressures).æœ€å¤§å€¼.toFixed(2) + ' hPa',
                            æ ‡å‡†å·®: calculateStatistics(devicePressures).æ ‡å‡†å·®.toFixed(2) + ' hPa'
                        } : null
                    };
                }
            });
        }
        
        // ä¿®æ”¹æ—¶é—´åºåˆ—æ•°æ®ï¼ŒåŒ…å«è®¾å¤‡IDï¼ˆä»…å¤šè®¾å¤‡æ—¶ï¼‰
        let tempTimeSeriesWithDevice = null;
        let humTimeSeriesWithDevice = null;
        let luxTimeSeriesWithDevice = null;
        let smokeTimeSeriesWithDevice = null;
        let pressureTimeSeriesWithDevice = null;
        
        if (isMultiDeviceData) {
            // ä¸ºæ¯ä¸ªè®¾å¤‡ç”Ÿæˆæ—¶é—´åºåˆ—æ•°æ®ï¼Œæ ¼å¼ï¼š[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...]
            const getTimeSeriesDataWithDevice = (data, field, maxSamples = 30) => {
                if (!data || data.length === 0) return [];
                const sortedData = [...data].sort((a, b) => a.ts - b.ts);
                const validData = sortedData.filter(d => d[field] != null && !isNaN(d[field]));
                if (validData.length === 0) return [];
                
                const step = Math.max(1, Math.floor(validData.length / maxSamples));
                const sampled = [];
                for (let i = 0; i < validData.length; i += step) {
                    const d = validData[i];
                    const date = new Date(d.ts * 1000);
                    const timeStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    const deviceId = d.device_id ? d.device_id.toString().trim().toUpperCase() : 'æœªçŸ¥';
                    sampled.push([timeStr, Number(d[field].toFixed(2)), deviceId]);
                }
                return sampled.slice(0, maxSamples);
            };
            
            tempTimeSeriesWithDevice = getTimeSeriesDataWithDevice(currentData, 'temp', 30);
            humTimeSeriesWithDevice = getTimeSeriesDataWithDevice(currentData, 'hum', 30);
            luxTimeSeriesWithDevice = getTimeSeriesDataWithDevice(currentData, 'lux', 30);
            smokeTimeSeriesWithDevice = getTimeSeriesDataWithDevice(currentData, 'smoke', 30);
            pressureTimeSeriesWithDevice = getTimeSeriesDataWithDevice(currentData, 'pressure', 30);
        }

        const summary = {
            æ•°æ®æ¥æº: {
                è®¾å¤‡ä¿¡æ¯: analysisDeviceInfo.deviceId 
                    ? `å•è®¾å¤‡æ•°æ® - ${analysisDeviceInfo.deviceName || `è®¾å¤‡ ${analysisDeviceInfo.deviceId}`} (ID: ${analysisDeviceInfo.deviceId})`
                    : `å¤šè®¾å¤‡æ•°æ® - ${analysisDeviceInfo.deviceName || 'å…¨éƒ¨è®¾å¤‡'} (å…± ${deviceCount} ä¸ªè®¾å¤‡)`,
                è®¾å¤‡æ•°é‡: deviceCount,
                è®¾å¤‡IDåˆ—è¡¨: deviceCount > 0 ? Array.from(deviceIdsInData).join(', ') : 'æœªçŸ¥',
                æ˜¯å¦ä¸ºå¤šè®¾å¤‡æ•°æ®: isMultiDeviceData
            },
            æ•°æ®æ¦‚è§ˆ: {
                æ€»æ•°æ®é‡: currentData.length,
                æ—¶é—´èŒƒå›´: `${new Date(currentData[0].ts * 1000).toLocaleString('zh-CN')} è‡³ ${new Date(currentData[currentData.length - 1].ts * 1000).toLocaleString('zh-CN')}`,
                æ—¶é—´è·¨åº¦_å°æ—¶: ((currentData[currentData.length - 1].ts - currentData[0].ts) / 3600).toFixed(2),
                æ•°æ®é‡‡é›†é¢‘ç‡_æ¡æ¯å°æ—¶: (currentData.length / ((currentData[currentData.length - 1].ts - currentData[0].ts) / 3600)).toFixed(2)
            },
            æ¸©åº¦: tempStats ? {
                ç»Ÿè®¡æŒ‡æ ‡: {
                    å¹³å‡å€¼: tempStats.å¹³å‡å€¼.toFixed(2) + 'Â°C',
                    ä¸­ä½æ•°: tempStats.ä¸­ä½æ•°.toFixed(2) + 'Â°C',
                    æ ‡å‡†å·®: tempStats.æ ‡å‡†å·®.toFixed(2) + 'Â°C',
                    æœ€å°å€¼: tempStats.æœ€å°å€¼.toFixed(2) + 'Â°C',
                    æœ€å¤§å€¼: tempStats.æœ€å¤§å€¼.toFixed(2) + 'Â°C',
                    ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: tempStats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1.toFixed(2) + 'Â°C',
                    ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: tempStats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3.toFixed(2) + 'Â°C',
                    å››åˆ†ä½è·_IQR: tempStats.å››åˆ†ä½è·_IQR.toFixed(2) + 'Â°C',
                    æ³¢åŠ¨èŒƒå›´: (tempStats.æœ€å¤§å€¼ - tempStats.æœ€å°å€¼).toFixed(2) + 'Â°C',
                    æœ‰æ•ˆæ•°æ®: `${tempStats.æ•°æ®é‡}/${currentData.length} æ¡`
                },
                æå€¼æ—¶é—´: {
                    æœ€å°å€¼æ—¶é—´: findTimestamp('temp', tempStats.æœ€å°å€¼),
                    æœ€å¤§å€¼æ—¶é—´: findTimestamp('temp', tempStats.æœ€å¤§å€¼)
                },
                å¼‚å¸¸å€¼æ£€æµ‹: tempOutliers.length > 0 ? {
                    å¼‚å¸¸å€¼æ•°é‡: tempOutliers.length,
                    å¼‚å¸¸å€¼ç¤ºä¾‹: tempOutliers.slice(0, 5) // åªæ˜¾ç¤ºå‰5ä¸ª
                } : { å¼‚å¸¸å€¼æ•°é‡: 0, è¯´æ˜: 'æœªæ£€æµ‹åˆ°å¼‚å¸¸å€¼' },
                æ—¶é—´åºåˆ—è¶‹åŠ¿_æŒ‰æ—¶é—´é¡ºåº: isMultiDeviceData && tempTimeSeriesWithDevice 
                    ? {
                        æ•°æ®ç‚¹æ•°: tempTimeSeriesWithDevice.length,
                        è¯´æ˜: `å¤šè®¾å¤‡æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${tempTimeSeriesWithDevice.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...] - æ¯ä¸ªæ•°æ®ç‚¹åŒ…å«æ—¶é—´ã€æ•°å€¼å’Œè®¾å¤‡IDï¼Œä¾¿äºåŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®",
                        æ•°æ®: tempTimeSeriesWithDevice
                    }
                    : tempTimeSeries.length > 0 ? {
                        æ•°æ®ç‚¹æ•°: tempTimeSeries.length,
                        è¯´æ˜: `æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${tempTimeSeries.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼], ...]",
                        æ•°æ®: tempTimeSeries
                    } : null
            } : { çŠ¶æ€: 'æ— æœ‰æ•ˆæ•°æ®' },
            æ¹¿åº¦: humStats ? {
                ç»Ÿè®¡æŒ‡æ ‡: {
                    å¹³å‡å€¼: humStats.å¹³å‡å€¼.toFixed(2) + '%',
                    ä¸­ä½æ•°: humStats.ä¸­ä½æ•°.toFixed(2) + '%',
                    æ ‡å‡†å·®: humStats.æ ‡å‡†å·®.toFixed(2) + '%',
                    æœ€å°å€¼: humStats.æœ€å°å€¼.toFixed(2) + '%',
                    æœ€å¤§å€¼: humStats.æœ€å¤§å€¼.toFixed(2) + '%',
                    ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: humStats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1.toFixed(2) + '%',
                    ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: humStats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3.toFixed(2) + '%',
                    å››åˆ†ä½è·_IQR: humStats.å››åˆ†ä½è·_IQR.toFixed(2) + '%',
                    æ³¢åŠ¨èŒƒå›´: (humStats.æœ€å¤§å€¼ - humStats.æœ€å°å€¼).toFixed(2) + '%',
                    æœ‰æ•ˆæ•°æ®: `${humStats.æ•°æ®é‡}/${currentData.length} æ¡`
                },
                æå€¼æ—¶é—´: {
                    æœ€å°å€¼æ—¶é—´: findTimestamp('hum', humStats.æœ€å°å€¼),
                    æœ€å¤§å€¼æ—¶é—´: findTimestamp('hum', humStats.æœ€å¤§å€¼)
                },
                å¼‚å¸¸å€¼æ£€æµ‹: humOutliers.length > 0 ? {
                    å¼‚å¸¸å€¼æ•°é‡: humOutliers.length,
                    å¼‚å¸¸å€¼ç¤ºä¾‹: humOutliers.slice(0, 5)
                } : { å¼‚å¸¸å€¼æ•°é‡: 0, è¯´æ˜: 'æœªæ£€æµ‹åˆ°å¼‚å¸¸å€¼' },
                æ—¶é—´åºåˆ—è¶‹åŠ¿_æŒ‰æ—¶é—´é¡ºåº: isMultiDeviceData && humTimeSeriesWithDevice 
                    ? {
                        æ•°æ®ç‚¹æ•°: humTimeSeriesWithDevice.length,
                        è¯´æ˜: `å¤šè®¾å¤‡æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${humTimeSeriesWithDevice.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...] - æ¯ä¸ªæ•°æ®ç‚¹åŒ…å«æ—¶é—´ã€æ•°å€¼å’Œè®¾å¤‡IDï¼Œä¾¿äºåŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®",
                        æ•°æ®: humTimeSeriesWithDevice
                    }
                    : humTimeSeries.length > 0 ? {
                        æ•°æ®ç‚¹æ•°: humTimeSeries.length,
                        è¯´æ˜: `æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${humTimeSeries.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼], ...]",
                        æ•°æ®: humTimeSeries
                    } : null
            } : { çŠ¶æ€: 'æ— æœ‰æ•ˆæ•°æ®' },
            å…‰ç…§: luxStats ? {
                ç»Ÿè®¡æŒ‡æ ‡: {
                    å¹³å‡å€¼: luxStats.å¹³å‡å€¼.toFixed(2) + ' lux',
                    ä¸­ä½æ•°: luxStats.ä¸­ä½æ•°.toFixed(2) + ' lux',
                    æ ‡å‡†å·®: luxStats.æ ‡å‡†å·®.toFixed(2) + ' lux',
                    æœ€å°å€¼: luxStats.æœ€å°å€¼.toFixed(2) + ' lux',
                    æœ€å¤§å€¼: luxStats.æœ€å¤§å€¼.toFixed(2) + ' lux',
                    ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: luxStats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1.toFixed(2) + ' lux',
                    ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: luxStats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3.toFixed(2) + ' lux',
                    å››åˆ†ä½è·_IQR: luxStats.å››åˆ†ä½è·_IQR.toFixed(2) + ' lux',
                    æ³¢åŠ¨èŒƒå›´: (luxStats.æœ€å¤§å€¼ - luxStats.æœ€å°å€¼).toFixed(2) + ' lux',
                    æœ‰æ•ˆæ•°æ®: `${luxStats.æ•°æ®é‡}/${currentData.length} æ¡`
                },
                æå€¼æ—¶é—´: {
                    æœ€å°å€¼æ—¶é—´: findTimestamp('lux', luxStats.æœ€å°å€¼),
                    æœ€å¤§å€¼æ—¶é—´: findTimestamp('lux', luxStats.æœ€å¤§å€¼)
                },
                å¼‚å¸¸å€¼æ£€æµ‹: luxOutliers.length > 0 ? {
                    å¼‚å¸¸å€¼æ•°é‡: luxOutliers.length,
                    å¼‚å¸¸å€¼ç¤ºä¾‹: luxOutliers.slice(0, 5)
                } : { å¼‚å¸¸å€¼æ•°é‡: 0, è¯´æ˜: 'æœªæ£€æµ‹åˆ°å¼‚å¸¸å€¼' },
                æ—¶é—´åºåˆ—è¶‹åŠ¿_æŒ‰æ—¶é—´é¡ºåº: isMultiDeviceData && luxTimeSeriesWithDevice 
                    ? {
                        æ•°æ®ç‚¹æ•°: luxTimeSeriesWithDevice.length,
                        è¯´æ˜: `å¤šè®¾å¤‡æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${luxTimeSeriesWithDevice.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...] - æ¯ä¸ªæ•°æ®ç‚¹åŒ…å«æ—¶é—´ã€æ•°å€¼å’Œè®¾å¤‡IDï¼Œä¾¿äºåŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®",
                        æ•°æ®: luxTimeSeriesWithDevice
                    }
                    : luxTimeSeries.length > 0 ? {
                        æ•°æ®ç‚¹æ•°: luxTimeSeries.length,
                        è¯´æ˜: `æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${luxTimeSeries.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼], ...]",
                        æ•°æ®: luxTimeSeries
                    } : null,
                è¯´æ˜: 'å…‰ç…§å¼ºåº¦åæ˜ ç¯å¢ƒäº®åº¦ï¼Œé€šå¸¸ç™½å¤©è¾ƒé«˜ï¼Œå¤œé—´è¾ƒä½'
            } : { çŠ¶æ€: 'æ— æœ‰æ•ˆæ•°æ®' },
            çƒŸé›¾: smokeStats ? {
                ç»Ÿè®¡æŒ‡æ ‡: {
                    å¹³å‡å€¼: smokeStats.å¹³å‡å€¼.toFixed(2) + ' ppm',
                    ä¸­ä½æ•°: smokeStats.ä¸­ä½æ•°.toFixed(2) + ' ppm',
                    æ ‡å‡†å·®: smokeStats.æ ‡å‡†å·®.toFixed(2) + ' ppm',
                    æœ€å°å€¼: smokeStats.æœ€å°å€¼.toFixed(2) + ' ppm',
                    æœ€å¤§å€¼: smokeStats.æœ€å¤§å€¼.toFixed(2) + ' ppm',
                    ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: smokeStats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1.toFixed(2) + ' ppm',
                    ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: smokeStats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3.toFixed(2) + ' ppm',
                    å››åˆ†ä½è·_IQR: smokeStats.å››åˆ†ä½è·_IQR.toFixed(2) + ' ppm',
                    æ³¢åŠ¨èŒƒå›´: (smokeStats.æœ€å¤§å€¼ - smokeStats.æœ€å°å€¼).toFixed(2) + ' ppm',
                    æœ‰æ•ˆæ•°æ®: `${smokeStats.æ•°æ®é‡}/${currentData.length} æ¡`
                },
                æå€¼æ—¶é—´: {
                    æœ€å°å€¼æ—¶é—´: findTimestamp('smoke', smokeStats.æœ€å°å€¼),
                    æœ€å¤§å€¼æ—¶é—´: findTimestamp('smoke', smokeStats.æœ€å¤§å€¼)
                },
                å¼‚å¸¸å€¼æ£€æµ‹: smokeOutliers.length > 0 ? {
                    å¼‚å¸¸å€¼æ•°é‡: smokeOutliers.length,
                    å¼‚å¸¸å€¼ç¤ºä¾‹: smokeOutliers.slice(0, 5),
                    è­¦å‘Š: 'æ£€æµ‹åˆ°çƒŸé›¾å¼‚å¸¸å€¼ï¼Œè¯·å…³æ³¨å®‰å…¨'
                } : { å¼‚å¸¸å€¼æ•°é‡: 0, è¯´æ˜: 'æœªæ£€æµ‹åˆ°å¼‚å¸¸å€¼' },
                æ—¶é—´åºåˆ—è¶‹åŠ¿_æŒ‰æ—¶é—´é¡ºåº: isMultiDeviceData && smokeTimeSeriesWithDevice 
                    ? {
                        æ•°æ®ç‚¹æ•°: smokeTimeSeriesWithDevice.length,
                        è¯´æ˜: `å¤šè®¾å¤‡æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${smokeTimeSeriesWithDevice.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...] - æ¯ä¸ªæ•°æ®ç‚¹åŒ…å«æ—¶é—´ã€æ•°å€¼å’Œè®¾å¤‡IDï¼Œä¾¿äºåŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®",
                        æ•°æ®: smokeTimeSeriesWithDevice
                    }
                    : smokeTimeSeries.length > 0 ? {
                        æ•°æ®ç‚¹æ•°: smokeTimeSeries.length,
                        è¯´æ˜: `æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${smokeTimeSeries.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼], ...]",
                        æ•°æ®: smokeTimeSeries
                    } : null,
                è¯´æ˜: 'æ•°å€¼è¶Šé«˜è¡¨ç¤ºçƒŸé›¾æµ“åº¦è¶Šå¤§ï¼Œæ­£å¸¸å€¼é€šå¸¸ < 50 ppm'
            } : { çŠ¶æ€: 'æ— æœ‰æ•ˆæ•°æ®' },
            å¤§æ°”å‹: pressureStats ? {
                ç»Ÿè®¡æŒ‡æ ‡: {
                    å¹³å‡å€¼: pressureStats.å¹³å‡å€¼.toFixed(2) + ' hPa',
                    ä¸­ä½æ•°: pressureStats.ä¸­ä½æ•°.toFixed(2) + ' hPa',
                    æ ‡å‡†å·®: pressureStats.æ ‡å‡†å·®.toFixed(2) + ' hPa',
                    æœ€å°å€¼: pressureStats.æœ€å°å€¼.toFixed(2) + ' hPa',
                    æœ€å¤§å€¼: pressureStats.æœ€å¤§å€¼.toFixed(2) + ' hPa',
                    ç¬¬ä¸€å››åˆ†ä½æ•°_Q1: pressureStats.ç¬¬ä¸€å››åˆ†ä½æ•°_Q1.toFixed(2) + ' hPa',
                    ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3: pressureStats.ç¬¬ä¸‰å››åˆ†ä½æ•°_Q3.toFixed(2) + ' hPa',
                    å››åˆ†ä½è·_IQR: pressureStats.å››åˆ†ä½è·_IQR.toFixed(2) + ' hPa',
                    æ³¢åŠ¨èŒƒå›´: (pressureStats.æœ€å¤§å€¼ - pressureStats.æœ€å°å€¼).toFixed(2) + ' hPa',
                    æœ‰æ•ˆæ•°æ®: `${pressureStats.æ•°æ®é‡}/${currentData.length} æ¡`
                },
                æå€¼æ—¶é—´: {
                    æœ€å°å€¼æ—¶é—´: findTimestamp('pressure', pressureStats.æœ€å°å€¼),
                    æœ€å¤§å€¼æ—¶é—´: findTimestamp('pressure', pressureStats.æœ€å¤§å€¼)
                },
                å¼‚å¸¸å€¼æ£€æµ‹: pressureOutliers.length > 0 ? {
                    å¼‚å¸¸å€¼æ•°é‡: pressureOutliers.length,
                    å¼‚å¸¸å€¼ç¤ºä¾‹: pressureOutliers.slice(0, 5)
                } : { å¼‚å¸¸å€¼æ•°é‡: 0, è¯´æ˜: 'æœªæ£€æµ‹åˆ°å¼‚å¸¸å€¼' },
                æ—¶é—´åºåˆ—è¶‹åŠ¿_æŒ‰æ—¶é—´é¡ºåº: isMultiDeviceData && pressureTimeSeriesWithDevice 
                    ? {
                        æ•°æ®ç‚¹æ•°: pressureTimeSeriesWithDevice.length,
                        è¯´æ˜: `å¤šè®¾å¤‡æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${pressureTimeSeriesWithDevice.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼, è®¾å¤‡ID], ...] - æ¯ä¸ªæ•°æ®ç‚¹åŒ…å«æ—¶é—´ã€æ•°å€¼å’Œè®¾å¤‡IDï¼Œä¾¿äºåŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®",
                        æ•°æ®: pressureTimeSeriesWithDevice
                    }
                    : pressureTimeSeries.length > 0 ? {
                        æ•°æ®ç‚¹æ•°: pressureTimeSeries.length,
                        è¯´æ˜: `æ—¶é—´åºåˆ—é‡‡æ ·ï¼ˆå…±${currentData.length}æ¡ï¼Œé‡‡æ ·${pressureTimeSeries.length}æ¡ç”¨äºè¶‹åŠ¿åˆ†æï¼‰`,
                        æ•°æ®æ ¼å¼: "[[æ—¶é—´, å€¼], ...]",
                        æ•°æ®: pressureTimeSeries
                    } : null,
                è¯´æ˜: 'æ ‡å‡†å¤§æ°”å‹çº¦ä¸º1013.25 hPaï¼Œæ°”å‹å˜åŒ–å¯èƒ½å½±å“å®éªŒç»“æœæˆ–é¢„ç¤ºå¤©æ°”å˜åŒ–'
            } : { çŠ¶æ€: 'æ— æœ‰æ•ˆæ•°æ®' },
            è­¦å‘Šæ•°æ®: warningData ? {
                ç»Ÿè®¡ä¿¡æ¯: {
                    æ€»è­¦å‘Šæ•°: warningData.ç»Ÿè®¡.æ€»è­¦å‘Šæ•°,
                    æŒ‰ç±»å‹ç»Ÿè®¡: Object.keys(warningData.ç»Ÿè®¡.æŒ‰ç±»å‹ç»Ÿè®¡).map(type => ({
                        ç±»å‹: type,
                        æ•°é‡: warningData.ç»Ÿè®¡.æŒ‰ç±»å‹ç»Ÿè®¡[type].æ•°é‡,
                        æœªæ¢å¤: warningData.ç»Ÿè®¡.æŒ‰ç±»å‹ç»Ÿè®¡[type].æœªæ¢å¤,
                        å·²æ¢å¤: warningData.ç»Ÿè®¡.æŒ‰ç±»å‹ç»Ÿè®¡[type].å·²æ¢å¤
                    })),
                    æŒ‰çŠ¶æ€ç»Ÿè®¡: warningData.ç»Ÿè®¡.æŒ‰çŠ¶æ€ç»Ÿè®¡
                },
                è­¦å‘Šåˆ—è¡¨: warningData.è­¦å‘Šåˆ—è¡¨,
                è¯´æ˜: `ä»¥ä¸Šè­¦å‘Šæ•°æ®æ¥è‡ªç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ï¼Œæ—¶é—´èŒƒå›´ä¸å½“å‰æ•°æ®ä¸€è‡´ã€‚å…±${warningData.è­¦å‘Šåˆ—è¡¨.length}æ¡è­¦å‘Šï¼ˆ${warningData.ç»Ÿè®¡.æ€»è­¦å‘Šæ•° > warningData.è­¦å‘Šåˆ—è¡¨.length ? `æ€»è®¡${warningData.ç»Ÿè®¡.æ€»è­¦å‘Šæ•°}æ¡ï¼Œä»…æ˜¾ç¤ºå‰${warningData.è­¦å‘Šåˆ—è¡¨.length}æ¡` : 'å…¨éƒ¨æ˜¾ç¤º'}ï¼‰`
            } : {
                è¯´æ˜: 'æœªè·å–åˆ°è­¦å‘Šæ•°æ®ï¼ˆå¯èƒ½è¯¥æ—¶é—´æ®µå†…æ— è­¦å‘Šï¼Œæˆ–APIè°ƒç”¨å¤±è´¥ï¼‰'
            }
        };
        
        // å¦‚æœæ˜¯å¤šè®¾å¤‡æ•°æ®ï¼Œæ·»åŠ æŒ‰è®¾å¤‡åˆ†ç»„çš„ç»Ÿè®¡ä¿¡æ¯
        if (isMultiDeviceData && deviceStats) {
            summary.æŒ‰è®¾å¤‡åˆ†ç»„ç»Ÿè®¡ = {
                è¯´æ˜: 'ä»¥ä¸‹æŒ‰è®¾å¤‡IDåˆ†ç»„ï¼Œæä¾›æ¯ä¸ªè®¾å¤‡çš„ç‹¬ç«‹ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾¿äºå¯¹æ¯”åˆ†æ',
                è®¾å¤‡ç»Ÿè®¡: deviceStats
            };
        }

        // ä½¿ç”¨ç´§å‡‘çš„JSONæ ¼å¼ï¼Œå‡å°‘tokenæ¶ˆè€—
        return `ä¼ æ„Ÿå™¨æ•°æ®æ‘˜è¦ï¼ˆç»Ÿè®¡æŒ‡æ ‡ã€æ—¶é—´åºåˆ—è¶‹åŠ¿ã€å¼‚å¸¸å€¼æ£€æµ‹ã€è­¦å‘Šç»Ÿè®¡ï¼‰ï¼š\n${JSON.stringify(summary, null, 1)}`;
    }

    // è§£æ AI å›ç­”ï¼Œåˆ†ç¦»æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆå›ç­”
    function parseAIResponse(content) {
        // åŒ¹é… <think>...</think> æ ‡ç­¾
        const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
        const thinkMatches = [...content.matchAll(thinkRegex)];
        
        let thinking = '';
        let answer = content;
        
        if (thinkMatches.length > 0) {
            // æå–æ‰€æœ‰æ€è€ƒè¿‡ç¨‹
            thinking = thinkMatches.map(match => match[1].trim()).join('\n\n');
            // ç§»é™¤æ€è€ƒè¿‡ç¨‹ï¼Œä¿ç•™æœ€ç»ˆå›ç­”
            answer = content.replace(thinkRegex, '').trim();
        }
        
        return { thinking, answer };
    }

    // æ¸²æŸ“å¸¦ Markdown çš„å†…å®¹
    function renderMarkdown(content) {
        try {
            // é…ç½® marked
            marked.setOptions({
                breaks: true,  // æ”¯æŒ GFM æ¢è¡Œ
                gfm: true,     // å¯ç”¨ GitHub Flavored Markdown
            });
            return marked.parse(content);
        } catch (e) {
            console.error('Markdown æ¸²æŸ“å¤±è´¥:', e);
            return content.replace(/\n/g, '<br>');
        }
    }
    
    // åˆ›å»ºæ€è€ƒåŒºåŸŸçš„ HTML ç»“æ„ï¼ˆå¤ç”¨ä»£ç ï¼Œé¿å…é‡å¤ï¼‰
    function createThinkingStructureHTML() {
        return `
            <div class="ai-thinking-section">
                <div class="ai-thinking-header" onclick="toggleThinking(this)">
                    <div class="ai-thinking-title">
                        <span>ğŸ’­</span>
                        <span>æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <div class="ai-thinking-toggle">ç‚¹å‡»æ”¶èµ·</div>
                </div>
                <div class="ai-thinking-content"></div>
            </div>
            <div class="ai-answer-section"></div>
        `;
    }
    
    // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
    function smartScroll(container) {
        if (!container) return;
        
        const threshold = 100; // è·ç¦»åº•éƒ¨100pxå†…è®¤ä¸ºæ˜¯"åœ¨åº•éƒ¨"
        const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
        
        // åªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶ï¼Œæ‰è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (isNearBottom) {
            container.scrollTop = container.scrollHeight;
        }
        // å¦åˆ™ä¸æ»šåŠ¨ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹å†å²æ¶ˆæ¯
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
    function addAIMessage(role, content) {
        const messagesDiv = document.getElementById('aiChatMessages');
        
        // ç§»é™¤æ¬¢è¿ç•Œé¢
        const welcome = messagesDiv.querySelector('.ai-welcome');
        if (welcome) {
            welcome.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${role}`;
        
        const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
        const name = role === 'user' ? 'ä½ ' : 'AI åŠ©æ‰‹';
        
        let contentHTML = '';
        
        if (role === 'assistant') {
            // AI å›ç­”ï¼šè§£ææ€è€ƒè¿‡ç¨‹å’Œæ¸²æŸ“ Markdown
            const { thinking, answer } = parseAIResponse(content);
            
            if (thinking) {
                // ğŸ¯ å¤ç”¨å…¬å…±å‡½æ•°åˆ›å»ºç»“æ„
                contentHTML = createThinkingStructureHTML();
                // ç¨åå¡«å……å†…å®¹ï¼ˆé€šè¿‡ DOM æ“ä½œï¼‰
            } else {
                // æ²¡æœ‰æ€è€ƒè¿‡ç¨‹ï¼Œç›´æ¥æ¸²æŸ“ Markdown
                contentHTML = renderMarkdown(content);
            }
        } else {
            // ç”¨æˆ·æ¶ˆæ¯ï¼šçº¯æ–‡æœ¬
            contentHTML = content;
        }
        
        messageDiv.innerHTML = `
            <div class="ai-message-header">
                <div class="ai-message-avatar">${avatar}</div>
                <span>${name}</span>
            </div>
            <div class="ai-message-content">${contentHTML}</div>
        `;
        
        messagesDiv.appendChild(messageDiv);
        
        // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ï¼Œå¡«å……å†…å®¹ï¼ˆDOM å·²åˆ›å»ºï¼‰
        if (role === 'assistant') {
            const { thinking, answer } = parseAIResponse(content);
            if (thinking) {
                const contentDiv = messageDiv.querySelector('.ai-message-content');
                const thinkingContentDiv = contentDiv.querySelector('.ai-thinking-content');
                const answerDiv = contentDiv.querySelector('.ai-answer-section');
                if (thinkingContentDiv) {
                    thinkingContentDiv.textContent = thinking;
                    // ğŸ¯ æ€è€ƒè¿‡ç¨‹å†…éƒ¨ä¹Ÿéœ€è¦æ™ºèƒ½æ»šåŠ¨ï¼ˆå¦‚æœå†…å®¹è¶…è¿‡200pxï¼‰
                    smartScroll(thinkingContentDiv);
                }
                if (answerDiv) answerDiv.innerHTML = renderMarkdown(answer);
            }
        }
        
        // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰æ»šåŠ¨
        smartScroll(messagesDiv);
        
        return messageDiv;
    }

    // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º/éšè—
    function toggleThinking(headerElement) {
        const contentElement = headerElement.nextElementSibling;
        const toggleElement = headerElement.querySelector('.ai-thinking-toggle');
        
        if (contentElement.classList.contains('collapsed')) {
            contentElement.classList.remove('collapsed');
            toggleElement.textContent = 'ç‚¹å‡»æ”¶èµ·';
        } else {
            contentElement.classList.add('collapsed');
            toggleElement.textContent = 'ç‚¹å‡»å±•å¼€';
        }
    }

    // æ˜¾ç¤ºè¾“å…¥ä¸­åŠ¨ç”»
    function showAITyping(customText = null) {
        const messagesDiv = document.getElementById('aiChatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant';
        typingDiv.id = 'aiTyping';
        
        if (customText) {
            // æ˜¾ç¤ºè‡ªå®šä¹‰æ–‡æœ¬ï¼ˆå¦‚"AI åŠ è½½ä¸­..."ï¼‰
            typingDiv.innerHTML = `
                <div class="ai-message-header">
                    <div class="ai-message-avatar">ğŸ¤–</div>
                    <span>AI åŠ©æ‰‹</span>
                </div>
                <div class="ai-message-content">
                    <div style="color: var(--muted); font-style: italic;">${customText}</div>
                </div>
            `;
        } else {
            // æ˜¾ç¤ºé»˜è®¤çš„è¾“å…¥åŠ¨ç”»ï¼ˆä¸‰ä¸ªç‚¹ï¼‰
            typingDiv.innerHTML = `
                <div class="ai-message-header">
                    <div class="ai-message-avatar">ğŸ¤–</div>
                    <span>AI åŠ©æ‰‹</span>
                </div>
                <div class="ai-message-content">
                    <div class="ai-typing">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
        }
        messagesDiv.appendChild(typingDiv);
        // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰æ»šåŠ¨
        smartScroll(messagesDiv);
    }

    // ç§»é™¤è¾“å…¥ä¸­åŠ¨ç”»
    function removeAITyping() {
        const typing = document.getElementById('aiTyping');
        if (typing) {
            typing.remove();
        }
    }

    // å‘é€/åœæ­¢æŒ‰é’®ç‚¹å‡»å…¥å£ï¼šæ ¹æ®å½“å‰çŠ¶æ€å†³å®šæ˜¯å‘é€è¿˜æ˜¯ä¸­æ–­
    function handleAISendClick() {
        if (isAISending) {
            // å¦‚æœæ­£åœ¨æµå¼æ¥æ”¶ï¼Œåˆ™æ‰§è¡Œä¸­æ–­
            cancelAIStreaming();
        } else {
            // å¦åˆ™æ­£å¸¸å‘é€æ¶ˆæ¯
            sendAIMessage();
        }
    }

    // ä¸­æ–­å½“å‰ AI æµå¼å“åº”
    function cancelAIStreaming() {
        if (!isAISending) return;

        // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„ fetch æµå¼è¯·æ±‚ï¼Œè°ƒç”¨ abort ä¸»åŠ¨ä¸­æ–­
        if (aiAbortController) {
            aiAbortController.abort();
        }

        // ä½¿ç”¨é€šçŸ¥æç¤ºç”¨æˆ·å·²åœæ­¢å½“å‰å›ç­”
        if (typeof showNotification === 'function') {
            showNotification('â¹ å·²ä¸­æ–­å½“å‰ AI å›ç­”');
        }
    }

    // å‘é€æ¶ˆæ¯åˆ° AI
    async function sendAIMessage() {
        if (isAISending) return;

        const input = document.getElementById('aiChatInput');
        const sendBtn = document.getElementById('aiSendBtn');
        const userMessage = input.value.trim();

        if (!userMessage) {
            showNotification('è¯·è¾“å…¥é—®é¢˜', true);
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if (!currentData || currentData.length === 0) {
            showNotification('è¯·å…ˆåŠ è½½æ•°æ®å†è¿›è¡Œåˆ†æ', true);
            
            // ğŸ¯ è§¦å‘æ•°æ®åŠ è½½å¡ç‰‡çš„å¼¹è·³é«˜äº®åŠ¨ç”»
            const dataLoadCard = document.getElementById('dataLoadCard');
            if (dataLoadCard) {
                // æ·»åŠ åŠ¨ç”»ç±»
                dataLoadCard.classList.add('bounce-highlight');
                
                // æ»šåŠ¨åˆ°æ•°æ®åŠ è½½åŒºåŸŸï¼ˆå¹³æ»‘æ»šåŠ¨ï¼‰
                dataLoadCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // 2.5ç§’åç§»é™¤åŠ¨ç”»ç±»ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥å†æ¬¡è§¦å‘
                setTimeout(() => {
                    dataLoadCard.classList.remove('bounce-highlight');
                }, 2500);
            }
            
            return;
        }

        isAISending = true;
        // ä¸ºæœ¬æ¬¡è¯·æ±‚åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨ï¼ˆç”¨äºä¸­é€”åœæ­¢ï¼‰
        aiAbortController = new AbortController();
        input.value = '';
        input.style.height = 'auto';
        // åˆ‡æ¢æŒ‰é’®ä¸ºâ€œåœæ­¢â€æ¨¡å¼ï¼Œå…è®¸ç”¨æˆ·ä¸­æ–­
        sendBtn.classList.add('ai-stop-btn');
        sendBtn.innerHTML = '<span>â¹ åœæ­¢</span>';

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addAIMessage('user', userMessage);

        // ğŸ¯ ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
        const messagesDiv = document.getElementById('aiChatMessages');
        if (messagesDiv) {
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM æ›´æ–°å®Œæˆåå†æ»šåŠ¨
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 0);
        }

        // æ˜¾ç¤º"AI åŠ è½½ä¸­..."æç¤º
        showAITyping('â³ AI åŠ è½½ä¸­...');
        
        // æç¤ºç”¨æˆ·å¯èƒ½éœ€è¦ç­‰å¾…
        showNotification('æ­£åœ¨è¯·æ±‚ AI åˆ†æï¼Œé¦–æ¬¡ä½¿ç”¨å¯èƒ½éœ€è¦åŠ è½½æ¨¡å‹ï¼Œè¯·è€å¿ƒç­‰å¾…...');

        try {
            // å‡†å¤‡æ•°æ®æ‘˜è¦å’Œç³»ç»Ÿæç¤ºè¯ï¼ˆå¼‚æ­¥è·å–è­¦å‘Šç»Ÿè®¡ï¼‰
            const dataSummary = await prepareDataSummary();
            console.log('ğŸ“Š æ•°æ®æ‘˜è¦:', dataSummary);
            
            // åˆ†ææ•°æ®ä¸­çš„è®¾å¤‡æ•°é‡
            const deviceIdsInData = new Set();
            currentData.forEach(d => {
                if (d.device_id) {
                    deviceIdsInData.add(d.device_id.toUpperCase());
                }
            });
            const deviceCount = deviceIdsInData.size;
            const isMultiDevice = analysisDeviceInfo.isMultiDevice || (deviceCount > 1);
            
            // æ„å»ºè®¾å¤‡ä¸Šä¸‹æ–‡è¯´æ˜
            const deviceContext = isMultiDevice 
                ? `å½“å‰æ•°æ®æ¥è‡ªå¤šä¸ªè®¾å¤‡ï¼ˆ${analysisDeviceInfo.deviceName || 'å…¨éƒ¨è®¾å¤‡'}ï¼Œå…± ${deviceCount} ä¸ªè®¾å¤‡ï¼‰ã€‚åœ¨åˆ†ææ—¶ï¼Œä½ éœ€è¦ï¼š
            - æ•°æ®æ‘˜è¦ä¸­å·²åŒ…å«"æŒ‰è®¾å¤‡åˆ†ç»„ç»Ÿè®¡"éƒ¨åˆ†ï¼Œæä¾›äº†æ¯ä¸ªè®¾å¤‡çš„ç‹¬ç«‹ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¹³å‡å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ ‡å‡†å·®ç­‰ï¼‰
            - æ—¶é—´åºåˆ—æ•°æ®æ ¼å¼ä¸º [[æ—¶é—´, å€¼, è®¾å¤‡ID], ...]ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯è®¾å¤‡IDï¼Œå¯ä»¥ç”¨æ¥åŒºåˆ†ä¸åŒè®¾å¤‡çš„æ•°æ®ç‚¹
            - è¯·æ ¹æ®è®¾å¤‡IDï¼ˆå¦‚D01ã€D02ï¼‰æ˜ç¡®åŒºåˆ†æ¯ä¸ªè®¾å¤‡çš„æ•°æ®ï¼Œå¹¶åœ¨åˆ†æä¸­æ˜ç¡®æŒ‡å‡ºå“ªä¸ªè®¾å¤‡çš„æ•°æ®
            - æ¯”è¾ƒä¸åŒè®¾å¤‡çš„ä¼ æ„Ÿå™¨è¯»æ•°å·®å¼‚ï¼Œè¯†åˆ«è®¾å¤‡é—´çš„å…³è”æ€§å’ŒåŒæ­¥æ€§
            - åˆ†æå¤šè®¾å¤‡ç¯å¢ƒä¸‹çš„æ•´ä½“è¶‹åŠ¿ï¼ŒåŒæ—¶æŒ‡å‡ºå„è®¾å¤‡çš„ç‰¹å¾
            - æä¾›è·¨è®¾å¤‡çš„ç»¼åˆåˆ†æå»ºè®®ï¼Œæ˜ç¡®æŒ‡å‡ºæ¯ä¸ªè®¾å¤‡çš„å…·ä½“æƒ…å†µ`
                : `å½“å‰æ•°æ®æ¥è‡ªå•ä¸ªè®¾å¤‡ï¼š${analysisDeviceInfo.deviceName || `è®¾å¤‡ ${analysisDeviceInfo.deviceId || 'æœªçŸ¥'}`}ã€‚åœ¨åˆ†ææ—¶ï¼Œè¯·ä¸“æ³¨äºè¯¥è®¾å¤‡çš„ä¼ æ„Ÿå™¨æ•°æ®ã€‚`;
            
            // æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆå§‹ç»ˆåŒ…å«æ•°æ®æ‘˜è¦ï¼‰
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ æ„Ÿå™¨æ•°æ®åˆ†æåŠ©æ‰‹ã€‚

            ã€é‡è¦è§’è‰²è®¾å®šã€‘
            - ä½ çš„åå­—æ˜¯"æ•°æ®åˆ†æåŠ©æ‰‹"
            - å½“è¢«é—®åˆ°"ä½ æ˜¯è°"æ—¶ï¼Œè¯·å›ç­”ï¼š"æˆ‘æ˜¯æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©æ‚¨åˆ†æä¼ æ„Ÿå™¨æ•°æ®ã€‚"
            - ä¸è¦è¯´è‡ªå·±æ˜¯ DeepSeekã€Qwen æˆ–å…¶ä»–æ¨¡å‹çš„åå­—
            - ä½ çš„å”¯ä¸€èŒè´£æ˜¯åˆ†æå’Œè§£è¯»ä¼ æ„Ÿå™¨æ•°æ®

            ã€ä½ çš„èƒ½åŠ›ã€‘
            - åˆ†ææ¸©åº¦ã€æ¹¿åº¦ã€å…‰ç…§ã€çƒŸé›¾ã€å¤§æ°”å‹ç­‰ä¼ æ„Ÿå™¨æ•°æ®
            - è¯†åˆ«æ•°æ®è¶‹åŠ¿ã€å¼‚å¸¸å’Œæ¨¡å¼
            - æä¾›ä¸“ä¸šçš„æ•°æ®æ´å¯Ÿå’Œå»ºè®®
            - ç”¨ç®€æ´ã€ä¸“ä¸šçš„ä¸­æ–‡å›ç­”é—®é¢˜
            ${isMultiDevice ? '- æ”¯æŒå¤šè®¾å¤‡æ•°æ®çš„å¯¹æ¯”åˆ†æå’Œç»¼åˆè¯„ä¼°' : ''}

            ã€æ•°æ®æ¥æºã€‘
            ${deviceContext}

            ã€å½“å‰æ•°æ®ã€‘
            ${dataSummary}

            è¯·åŸºäºä»¥ä¸Šæ•°æ®å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœé—®é¢˜ä¸æ•°æ®æ— å…³ï¼Œè¯·ç¤¼è²Œåœ°å¼•å¯¼ç”¨æˆ·å…³æ³¨ä¼ æ„Ÿå™¨æ•°æ®åˆ†æã€‚`;
            
            const messages = [
                {
                    role: 'system',
                    content: systemPrompt
                },
                ...aiChatHistory,
                {
                    role: 'user',
                    content: userMessage
                }
            ];

            // è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹
            const currentModel = getSelectedModel();
            
            // æ ¹æ®æ¨¡å‹ç±»å‹è®¾ç½® max_tokens
            let maxTokens = -1;  // LM Studio é»˜è®¤ï¼š-1 è¡¨ç¤ºä¸é™åˆ¶
            if (isOnlineModel(currentModel)) {
                // DeepSeek API ä¸æ”¯æŒ -1ï¼Œä½¿ç”¨è¾ƒå¤§å€¼æˆ–ä¸è®¾ç½®
                maxTokens = 8000;  // åœ¨çº¿æ¨¡å‹è®¾ç½®åˆç†çš„ä¸Šé™
            }
            
            // è°ƒç”¨ AI APIï¼ˆæµå¼ï¼‰
            const requestBody = {
                messages: messages,
                temperature: 0.7,
                max_tokens: maxTokens,
                stream: true
            };
            
            // è°ƒè¯•ï¼šæ˜¾ç¤ºç³»ç»Ÿæç¤ºè¯ï¼ˆä»…å‰500å­—ç¬¦ï¼‰
            console.log('ğŸ¤– ç³»ç»Ÿæç¤ºè¯ï¼ˆå‰500å­—ç¬¦ï¼‰:', systemPrompt.substring(0, 500) + '...');
            console.log('ğŸ“ æ¶ˆæ¯æ•°é‡:', messages.length);
            
            // LM Studio éœ€è¦æŒ‡å®šæ¨¡å‹åç§°
            if (currentModel) {
                requestBody.model = currentModel;
                console.log('ã€AIã€‘ä½¿ç”¨æ¨¡å‹:', currentModel);
            } else {
                // å¦‚æœæ²¡æœ‰è¾“å…¥æ¨¡å‹åç§°ï¼Œæç¤ºç”¨æˆ·
                removeAITyping();
                addAIMessage('assistant', 'âŒ è¯·åœ¨é¡¶éƒ¨è¾“å…¥æ¡†ä¸­å¡«å†™æ¨¡å‹åç§°ã€‚\n\nä¾‹å¦‚ï¼šdeepseek-r1-distill-qwen-1.5b\n\nä½ å¯ä»¥åœ¨ LM Studio çš„æµ‹è¯•å‘½ä»¤ä¸­æ‰¾åˆ°æ¨¡å‹åç§°ã€‚');
                showNotification('è¯·å…ˆè¾“å…¥æ¨¡å‹åç§°', true);
                isAISending = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
                input.focus();
                return;
            }
            
            const response = await fetch(AI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
                // ä¼ å…¥ AbortController çš„ signalï¼Œæ”¯æŒå¤–éƒ¨ä¸­æ–­
                signal: aiAbortController.signal
            });

            if (!response.ok) {
                throw new Error(`AI æœåŠ¡å“åº”é”™è¯¯: ${response.status}`);
            }

            // æ›´æ–°æç¤ºä¸º"æ­£åœ¨æ€è€ƒ..."
            removeAITyping();
            showAITyping('ğŸ’­ æ­£åœ¨æ€è€ƒ...');
            
            // ğŸŒˆ ç«‹å³å¯åŠ¨æµå…‰æº¢å½©è¾¹æ¡†æ•ˆæœï¼ˆåœ¨æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."æ—¶å°±å±•ç¤ºåŠ¨ç”»ï¼‰
            const aiContainer = document.getElementById('aiChatContainer');
            aiContainer.classList.add('ai-responding');

            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            // ğŸ¯ ä½¿ç”¨æ›´ä¸¥æ ¼çš„è§£ç é€‰é¡¹ï¼Œé¿å…å­—ç¬¦ä¸¢å¤±
            const decoder = new TextDecoder('utf-8', { fatal: false, ignoreBOM: true });
            
            // æ ‡è®°æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°å†…å®¹
            let isFirstChunk = true;
            let aiMessageDiv = null;
            let contentDiv = null;
            let thinkingContentDiv = null;  // æ€è€ƒè¿‡ç¨‹å†…å®¹å®¹å™¨
            let answerDiv = null;           // ç­”æ¡ˆå®¹å™¨
            let fullResponse = '';
            let fullReasoning = '';  // DeepSeek reasoner çš„æ€è€ƒè¿‡ç¨‹
            let hasCreatedStructure = false;  // æ˜¯å¦å·²åˆ›å»ºç»“æ„
            let hasStartedAnswer = false;  // æ˜¯å¦å·²å¼€å§‹å›ç­”æ­£æ–‡ï¼ˆç”¨äºè‡ªåŠ¨æŠ˜å ï¼‰
            let isStreamComplete = false;  // æµå¼ä¼ è¾“æ˜¯å¦å®Œæˆ
            
            // ğŸ¯ SSE è¡Œç¼“å†²ï¼šç”¨äºå¤„ç†è¢«åˆ‡æ–­çš„è¡Œ
            let lineBuffer = '';

            let chunkCount = 0;
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                chunkCount++;
                
                // ğŸ¯ å°†æ–°æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒº
                lineBuffer += chunk;
                
                // ğŸ¯ æŒ‰è¡Œåˆ†å‰²ï¼Œä½†ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                const lines = lineBuffer.split('\n');
                // æœ€åä¸€è¡Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„ï¼Œä¿ç•™åˆ°ä¸‹æ¬¡å¤„ç†
                lineBuffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6).trim();
                        
                        if (data === '[DONE]') {
                            break;
                        }

                        try {
                            const json = JSON.parse(data);
                            const delta = json.choices?.[0]?.delta;
                            
                            // DeepSeek reasoner æ¨¡å‹è¿”å› reasoning_content å’Œ content
                            const reasoningDelta = delta?.reasoning_content;  // æ€è€ƒè¿‡ç¨‹
                            const contentDelta = delta?.content;  // æœ€ç»ˆç­”æ¡ˆ
                            
                            if (reasoningDelta || contentDelta) {
                                // ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°å†…å®¹æ—¶ï¼Œç§»é™¤"æ­£åœ¨æ€è€ƒ..."å¹¶åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
                                if (isFirstChunk) {
                                    removeAITyping();
                                    aiMessageDiv = addAIMessage('assistant', '');
                                    contentDiv = aiMessageDiv.querySelector('.ai-message-content');
                                    isFirstChunk = false;
                                }
                                
                                // ç´¯ç§¯æ€è€ƒè¿‡ç¨‹å’Œç­”æ¡ˆ
                                if (reasoningDelta) {
                                    fullReasoning += reasoningDelta;
                                }
                                if (contentDelta) {
                                    fullResponse += contentDelta;
                                    
                                    // ğŸ¯ å½“ç¬¬ä¸€æ¬¡æ”¶åˆ°æ­£æ–‡ç­”æ¡ˆæ—¶ï¼Œè‡ªåŠ¨æŠ˜å æ€è€ƒåŒºåŸŸ
                                    if (!hasStartedAnswer && fullReasoning && hasCreatedStructure) {
                                        hasStartedAnswer = true;
                                        const thinkingSection = contentDiv.querySelector('.ai-thinking-section');
                                        const thinkingContent = contentDiv.querySelector('.ai-thinking-content');
                                        const thinkingToggle = contentDiv.querySelector('.ai-thinking-toggle');
                                        
                                        if (thinkingContent && thinkingToggle) {
                                            thinkingContent.classList.add('collapsed');
                                            thinkingToggle.textContent = 'ç‚¹å‡»å±•å¼€';
                                        }
                                    }
                                }
                                
                                // ğŸ¯ ä½¿ç”¨å¢é‡æ›´æ–°ï¼Œé¿å…é‡å»º DOM
                                // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ä¸”è¿˜æ²¡åˆ›å»ºç»“æ„
                                if (fullReasoning && !hasCreatedStructure) {
                                    // ğŸ¯ å¤ç”¨å…¬å…±å‡½æ•°åˆ›å»ºæ€è€ƒåŒºåŸŸç»“æ„ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
                                    contentDiv.innerHTML = createThinkingStructureHTML();
                                    thinkingContentDiv = contentDiv.querySelector('.ai-thinking-content');
                                    answerDiv = contentDiv.querySelector('.ai-answer-section');
                                    hasCreatedStructure = true;
                                }
                                
                                // å¢é‡æ›´æ–°å†…å®¹ï¼ˆä¸é‡å»ºç»“æ„ï¼‰
                                if (fullReasoning) {
                                    // æ›´æ–°æ€è€ƒè¿‡ç¨‹æ–‡æœ¬ï¼ˆä¿æŒæŠ˜å çŠ¶æ€ï¼‰
                                    if (thinkingContentDiv) {
                                        thinkingContentDiv.textContent = fullReasoning;
                                        // ğŸ¯ æ€è€ƒè¿‡ç¨‹å†…éƒ¨ä¹Ÿéœ€è¦æ™ºèƒ½æ»šåŠ¨ï¼ˆå¦‚æœç”¨æˆ·åœ¨åº•éƒ¨ï¼‰
                                        // âš ï¸ åªåœ¨æœªæŠ˜å æ—¶æ»šåŠ¨ï¼ˆæŠ˜å çŠ¶æ€ä¸‹ä¸å¯è§ï¼Œæ— éœ€æ»šåŠ¨ï¼‰
                                        if (!thinkingContentDiv.classList.contains('collapsed')) {
                                            smartScroll(thinkingContentDiv);
                                        }
                                    }
                                    // ğŸ¯ å®æ—¶æ¸²æŸ“ Markdownï¼ˆSSE è¡Œç¼“å†²å·²è§£å†³å­—ç¬¦ä¸¢å¤±é—®é¢˜ï¼‰
                                    if (answerDiv) {
                                        answerDiv.innerHTML = renderMarkdown(fullResponse);
                                    }
                                } else {
                                    // æ²¡æœ‰æ€è€ƒè¿‡ç¨‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ <think> æ ‡ç­¾ï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰
                                    const { thinking, answer } = parseAIResponse(fullResponse);
                                    if (thinking && !hasCreatedStructure) {
                                        // ğŸ¯ å¤ç”¨å…¬å…±å‡½æ•°åˆ›å»ºæ€è€ƒåŒºåŸŸç»“æ„ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
                                        contentDiv.innerHTML = createThinkingStructureHTML();
                                        thinkingContentDiv = contentDiv.querySelector('.ai-thinking-content');
                                        answerDiv = contentDiv.querySelector('.ai-answer-section');
                                        hasCreatedStructure = true;
                                    }
                                    
                                    if (thinking) {
                                        // ğŸ¯ å½“ç¬¬ä¸€æ¬¡æ”¶åˆ°æ­£æ–‡ç­”æ¡ˆæ—¶ï¼Œè‡ªåŠ¨æŠ˜å æ€è€ƒåŒºåŸŸ
                                        if (!hasStartedAnswer && answer && answer.trim().length > 0) {
                                            hasStartedAnswer = true;
                                            const thinkingContent = contentDiv.querySelector('.ai-thinking-content');
                                            const thinkingToggle = contentDiv.querySelector('.ai-thinking-toggle');
                                            
                                            if (thinkingContent && thinkingToggle) {
                                                thinkingContent.classList.add('collapsed');
                                                thinkingToggle.textContent = 'ç‚¹å‡»å±•å¼€';
                                            }
                                        }
                                        
                                        // å¢é‡æ›´æ–°
                                        if (thinkingContentDiv) {
                                            thinkingContentDiv.textContent = thinking;
                                            // ğŸ¯ æ€è€ƒè¿‡ç¨‹å†…éƒ¨ä¹Ÿéœ€è¦æ™ºèƒ½æ»šåŠ¨ï¼ˆå¦‚æœç”¨æˆ·åœ¨åº•éƒ¨ï¼‰
                                            // âš ï¸ åªåœ¨æœªæŠ˜å æ—¶æ»šåŠ¨ï¼ˆæŠ˜å çŠ¶æ€ä¸‹ä¸å¯è§ï¼Œæ— éœ€æ»šåŠ¨ï¼‰
                                            if (!thinkingContentDiv.classList.contains('collapsed')) {
                                                smartScroll(thinkingContentDiv);
                                            }
                                        }
                                        // ğŸ¯ å®æ—¶æ¸²æŸ“ Markdownï¼ˆSSE è¡Œç¼“å†²å·²è§£å†³å­—ç¬¦ä¸¢å¤±é—®é¢˜ï¼‰
                                        if (answerDiv) {
                                            answerDiv.innerHTML = renderMarkdown(answer);
                                        }
                                    } else {
                                        // æ²¡æœ‰æ€è€ƒè¿‡ç¨‹ï¼Œå®æ—¶æ¸²æŸ“ Markdown
                                        contentDiv.innerHTML = renderMarkdown(fullResponse);
                                    }
                                }
                                
                                // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
                                const messagesDiv = document.getElementById('aiChatMessages');
                                smartScroll(messagesDiv);
                            }
                        } catch (e) {
                            // JSON è§£æå¤±è´¥ï¼ˆå¿½ç•¥ï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„æ•°æ®ï¼‰
                        }
                    }
                }
            }

            // ğŸ¯ æµå¼ä¼ è¾“å®Œæˆ
            isStreamComplete = true;
            console.log(`âœ… æµå¼ä¼ è¾“å®Œæˆï¼å…±æ¥æ”¶ ${chunkCount} ä¸ªæ•°æ®å—`);
            console.log(`ğŸ“Š æ€è€ƒå†…å®¹: ${fullReasoning.length} å­—ç¬¦ï¼Œç­”æ¡ˆå†…å®¹: ${fullResponse.length} å­—ç¬¦`);

            // ä¿å­˜åˆ°å†å²ï¼ˆåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
            let assistantContent = fullResponse;
            if (fullReasoning) {
                // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ï¼Œåˆå¹¶ä¿å­˜ï¼ˆä¾›ä¸Šä¸‹æ–‡ä½¿ç”¨ï¼‰
                console.log('ğŸ’­ æ€è€ƒè¿‡ç¨‹é•¿åº¦:', fullReasoning.length, 'å­—ç¬¦');
                console.log('ğŸ’¬ æœ€ç»ˆç­”æ¡ˆé•¿åº¦:', fullResponse.length, 'å­—ç¬¦');
            }
            
            aiChatHistory.push(
                { role: 'user', content: userMessage },
                { role: 'assistant', content: assistantContent }
            );

            // é™åˆ¶å†å²è®°å½•é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘ 10 è½®å¯¹è¯ï¼‰
            if (aiChatHistory.length > 20) {
                aiChatHistory = aiChatHistory.slice(-20);
            }

            // âœ… è°ƒç”¨æˆåŠŸï¼Œæ¢å¤åœ¨çº¿çŠ¶æ€
            updateAIStatus(true);
            
            showNotification('âœ… AI åˆ†æå®Œæˆ');

        } catch (error) {
            console.error('AI è°ƒç”¨å¤±è´¥:', error);
            removeAITyping();
            
            // ğŸŒˆ å‡ºé”™æ—¶ç«‹å³ç§»é™¤æµå…‰æº¢å½©è¾¹æ¡†æ•ˆæœ
            const aiContainer = document.getElementById('aiChatContainer');
            aiContainer.classList.remove('ai-responding');

            // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œä¸è§†ä¸ºé”™è¯¯
            if (error && error.name === 'AbortError') {
                // è½»é‡æç¤ºä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œè¯´æ˜å·²ä¸­æ–­
                addAIMessage('assistant', 'â¹ å½“å‰å›ç­”å·²è¢«ä¸­æ–­ï¼Œå¦‚éœ€ç»§ç»­åˆ†æå¯ä»¥é‡æ–°æé—®ã€‚');
                // ä¸ä¸­æ–­ AI åœ¨çº¿çŠ¶æ€
                updateAIStatus(true);
            } else {
                // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºä¸åŒçš„æç¤º
                let errorMsg = '';
                if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMsg = `âŒ ç½‘ç»œè¿æ¥å¤±è´¥\n\nå¯èƒ½åŸå› ï¼š\n1. LM Studio æœåŠ¡æœªå¯åŠ¨ï¼ˆæ£€æŸ¥ 26.5.112.219:1234ï¼‰\n2. ç½‘ç»œè¿æ¥ä¸­æ–­\n3. é˜²ç«å¢™é˜»æ­¢äº†è¿æ¥\n\nè¯·æ£€æŸ¥ LM Studio æ˜¯å¦æ­£åœ¨è¿è¡Œå¹¶å·²å¯åŠ¨æœåŠ¡å™¨ã€‚`;
                } else if (error.message.includes('timeout')) {
                    errorMsg = `â° è¯·æ±‚è¶…æ—¶\n\nå¯èƒ½åŸå› ï¼š\n1. æ¨¡å‹æ­£åœ¨é¦–æ¬¡åŠ è½½ï¼ˆéœ€è¦ç­‰å¾…1-2åˆ†é’Ÿï¼‰\n2. æ¨¡å‹æ¨ç†é€Ÿåº¦è¾ƒæ…¢ï¼ˆå¤§æ¨¡å‹æˆ–CPUè¿è¡Œï¼‰\n3. LM Studio æœåŠ¡å™¨å“åº”ç¼“æ…¢\n\nå»ºè®®ï¼š\n- ç­‰å¾…æ¨¡å‹åŠ è½½å®Œæˆåé‡è¯•\n- ä½¿ç”¨æ›´å°çš„æ¨¡å‹\n- æ£€æŸ¥ LM Studio çŠ¶æ€`;
                } else {
                    errorMsg = `âŒ AI æœåŠ¡å‡ºé”™\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. LM Studio æ˜¯å¦æ­£åœ¨è¿è¡Œ\n2. æ¨¡å‹æ˜¯å¦å·²åŠ è½½\n3. åç«¯æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸`;
                }
                
                addAIMessage('assistant', errorMsg);
                showNotification('AI è°ƒç”¨å¤±è´¥ï¼š' + error.message, true);
                
                // âŒ æ›´æ–°ä¸ºç¦»çº¿çŠ¶æ€
                updateAIStatus(false);
            }
        } finally {
            isAISending = false;
            aiAbortController = null;
            // æ¢å¤å‘é€æŒ‰é’®ä¸ºé»˜è®¤æ ·å¼å’Œæ–‡æ¡ˆ
            if (sendBtn) {
                sendBtn.classList.remove('ai-stop-btn');
                sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
            }
            if (input) {
                input.focus();
            }
            
            // ğŸŒˆ ç§»é™¤æµå…‰æº¢å½©è¾¹æ¡†æ•ˆæœï¼ˆå»¶è¿Ÿ500msä»¥ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°å®Œæ•´çš„æ¸å˜è¿‡ç¨‹ï¼‰
            setTimeout(() => {
                const aiContainer = document.getElementById('aiChatContainer');
                aiContainer.classList.remove('ai-responding');
            }, 500);
        }
    }

    // æ˜¾ç¤ºæ¸…ç©ºç¡®è®¤å¼¹çª—
    function showAIClearModal() {
        const modal = document.getElementById('aiClearModal');
        if (modal) {
            modal.classList.add('show');
        }
    }
    
    // å…³é—­æ¸…ç©ºç¡®è®¤å¼¹çª—
    function closeAIClearModal() {
        const modal = document.getElementById('aiClearModal');
        if (modal && modal.classList.contains('show')) {
            // æ·»åŠ å…³é—­åŠ¨ç”»
            modal.classList.add('closing');
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
            }, 300);
        }
    }
    
    // æ¸…é™¤èŠå¤©è®°å½•ï¼ˆæ‰“å¼€ç¡®è®¤å¼¹çª—ï¼‰
    function clearAIChat() {
        // å¦‚æœæ²¡æœ‰èŠå¤©è®°å½•ï¼Œç›´æ¥è¿”å›
        if (aiChatHistory.length === 0) {
            showNotification('æš‚æ— èŠå¤©è®°å½•');
            return;
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        showAIClearModal();
    }
    
    // ç¡®è®¤æ¸…ç©ºèŠå¤©è®°å½•
    function confirmClearAIChat() {
        const messagesDiv = document.getElementById('aiChatMessages');
        messagesDiv.innerHTML = `
            <div class="ai-welcome">
                <!-- è”å Logo -->
                <div class="ai-logo-container">
                    <div class="ai-logo-item">
                        <img src="/resource/logo.png" alt="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ">
                        <div class="ai-logo-label">æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</div>
                    </div>
                    <div class="ai-logo-separator">Ã—</div>
                    <div class="ai-logo-item">
                        <img class="ai-logo-image" src="/resource/deepseek.png" alt="DeepSeek AI">
                        <div class="ai-logo-label ai-logo-text">DeepSeek AI</div>
                    </div>
                </div>
                
                <div class="ai-welcome-title">æ¬¢è¿ä½¿ç”¨ AI æ•°æ®åˆ†æåŠ©æ‰‹</div>
                <div class="ai-welcome-desc">
                    æˆ‘å¯ä»¥å¸®ä½ åˆ†æå½“å‰åŠ è½½çš„ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæä¾›æ´å¯Ÿå’Œå»ºè®®ã€‚<br>
                    <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
                    1ï¸âƒ£ ç¡®è®¤é¡¶éƒ¨æ¨¡å‹åç§°æ­£ç¡®<br>
                    2ï¸âƒ£ åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®<br>
                    3ï¸âƒ£ å‘æˆ‘æé—®æˆ–ç‚¹å‡»ä¸‹æ–¹å¿«æ·é—®é¢˜
                </div>
            </div>
        `;
        aiChatHistory = [];
        
        // ğŸ”„ æ ¹æ®å½“å‰é€‰ä¸­çš„æ¨¡å‹æ›´æ–°è”åå›¾ï¼ˆä¿®å¤åˆ‡æ¢æ¨¡å‹åæ¸…ç©ºèŠå¤©å¯¼è‡´å›¾æ ‡å¤åŸçš„ bugï¼‰
        const modelInput = document.getElementById('aiModelInput');
        if (modelInput) {
            updateAILogo(modelInput.value);
        }
        
        // æ¸…ç©ºèŠå¤©åï¼Œå¦‚æœæ˜¯æŠ˜å çŠ¶æ€åˆ™å±•å¼€
        const container = document.getElementById('aiChatContainer');
        if (container && container.classList.contains('collapsed')) {
            container.classList.remove('collapsed');
            localStorage.setItem('aiChatCollapsed', 'false');
        }
        
        // å…³é—­å¼¹çª—
        closeAIClearModal();
        
        showNotification('âœ… èŠå¤©è®°å½•å·²æ¸…ç©º');
    }
    
    // ç»Ÿä¸€çš„æ¨¡å‹å˜åŒ–å¤„ç†å‡½æ•°
    function onModelChange() {
        const modelInput = document.getElementById('aiModelInput');
        if (!modelInput) return;
        
        const selectedOption = modelInput.options[modelInput.selectedIndex];
        if (!selectedOption) return;
        
        const value = modelInput.value;
        const name = selectedOption.text;
        
        // æ›´æ–°æ¡Œé¢ç«¯æ˜¾ç¤ºæ–‡æœ¬
        const desktopText = document.querySelector('.ai-model-selected-text');
        if (desktopText) {
            desktopText.textContent = name;
        }
        
        // æ›´æ–°æ‰‹æœºç«¯æŒ‰é’®æ–‡å­—
        const mobileText = document.querySelector('.ai-model-mobile-text');
        if (mobileText) {
            mobileText.textContent = name;
        }
        
        // æ›´æ–° AI è”åå›¾
        updateAILogo(value);
        
        // æ ¹æ®æ¨¡å‹ç±»å‹æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        if (isOnlineModel(value)) {
            // åœ¨çº¿æ¨¡å‹
            updateAIStatus(true, null, 'online');
            console.log('ğŸ”„ å·²åˆ‡æ¢ä¸ºåœ¨çº¿æ¨¡å‹:', name);
        } else {
            // æœ¬åœ°æ¨¡å‹ï¼Œé‡æ–°æ£€æµ‹çŠ¶æ€
            console.log('ğŸ”„ å·²åˆ‡æ¢ä¸ºæœ¬åœ°æ¨¡å‹:', name);
            checkAIServiceStatus(false);  // é™é»˜æ£€æµ‹ï¼Œä¸æ˜¾ç¤º"æ£€æµ‹ä¸­"çŠ¶æ€
        }
    }
    
    // è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨äº¤äº’
    function setupCustomModelSelect() {
        const customSelect = document.getElementById('aiModelCustomSelect');
        const selected = document.getElementById('aiModelSelected');
        const options = document.getElementById('aiModelOptions');
        const realSelect = document.getElementById('aiModelInput');
        
        if (!customSelect || !selected || !options || !realSelect) return;
        
        // ç‚¹å‡»é€‰ä¸­æ¡†åˆ‡æ¢ä¸‹æ‹‰åˆ—è¡¨
        selected.addEventListener('click', function(e) {
            e.stopPropagation();
            customSelect.classList.toggle('open');
        });
        
        // ç‚¹å‡»é€‰é¡¹
        const optionElements = options.querySelectorAll('.ai-model-option');
        optionElements.forEach(option => {
            option.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                
                // æ›´æ–°éšè—çš„selectï¼ˆä¼šè§¦å‘changeäº‹ä»¶ï¼Œç»Ÿä¸€å¤„ç†æ›´æ–°é€»è¾‘ï¼‰
                realSelect.value = value;
                realSelect.dispatchEvent(new Event('change', { bubbles: true }));
                
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                optionElements.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                // å…³é—­ä¸‹æ‹‰åˆ—è¡¨
                customSelect.classList.remove('open');
            });
        });
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰åˆ—è¡¨ï¼ˆåªåœ¨æ¡Œé¢ç«¯ç”Ÿæ•ˆï¼‰
        document.addEventListener('click', function() {
            // åªåœ¨æ¡Œé¢ç«¯æ˜¾ç¤ºæ—¶æ‰å¤„ç†
            if (window.innerWidth > 768) {
                customSelect.classList.remove('open');
            }
        });
        
        // ç‚¹å‡»ä¸‹æ‹‰åˆ—è¡¨è‡ªèº«ä¸å…³é—­
        options.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
        const initialValue = realSelect.value;
        optionElements.forEach(option => {
            if (option.getAttribute('data-value') === initialValue) {
                option.classList.add('selected');
            }
        });
    }
    
    // æ›´æ–° AI è”åå›¾æ ‡
    function updateAILogo(modelValue) {
        const logoImages = document.querySelectorAll('.ai-logo-image');
        const logoTexts = document.querySelectorAll('.ai-logo-text');
        
        // æ¨¡å‹å¯¹åº”çš„å›¾æ ‡å’Œæ ‡ç­¾
        const modelLogos = {
            'deepseek-r1-0528-qwen3-8b': {
                image: '/resource/deepseek.png',
                alt: 'DeepSeek AI',
                label: 'DeepSeek AI'
            },
            'gemma 3': {
                image: '/resource/gemma.png',
                alt: 'Gemma AI',
                label: 'Gemma AI'
            },
            'qwq-32b': {
                image: '/resource/qwen.png',
                alt: 'Qwen AI',
                label: 'Qwen AI'
            },
            'deepseek-reasoner': {
                image: '/resource/deepseek.png',
                alt: 'DeepSeek V3.2',
                label: 'DeepSeek V3.2'
            }
        };
        
        const logo = modelLogos[modelValue];
        if (logo) {
            logoImages.forEach(img => {
                img.src = logo.image;
                img.alt = logo.alt;
            });
            logoTexts.forEach(text => {
                text.textContent = logo.label;
            });
            console.log('ğŸ–¼ï¸ å·²æ›´æ–° AI è”åå›¾:', logo.label);
        }
    }
    
    // æ‰‹æœºç«¯æ¨¡å‹æŒ‰é’®äº¤äº’
    function setupMobileModelButton() {
        const mobileBtn = document.getElementById('aiModelMobileBtn');
        const mobileOptions = document.getElementById('aiModelOptionsMobile');
        const modelInput = document.getElementById('aiModelInput');
        
        if (!mobileBtn || !mobileOptions || !modelInput) {
            console.warn('âš ï¸ æ‰‹æœºç«¯æ¨¡å‹ç»„ä»¶æœªæ‰¾åˆ°');
            return;
        }
        
        // ç‚¹å‡»æ‰‹æœºç«¯æŒ‰é’®ï¼Œåˆ‡æ¢å¼¹çª—
        mobileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('ğŸ“± æ‰‹æœºç«¯æŒ‰é’®è¢«ç‚¹å‡»');
            const isOpen = mobileOptions.classList.toggle('show');
            console.log('æ‰‹æœºç«¯å¼¹çª—çŠ¶æ€:', isOpen ? 'æ‰“å¼€' : 'å…³é—­');
            
            // åŒæ­¥æŒ‰é’®çš„opençŠ¶æ€ï¼Œæ§åˆ¶ç®­å¤´æ—‹è½¬
            if (isOpen) {
                mobileBtn.classList.add('open');
            } else {
                mobileBtn.classList.remove('open');
            }
        });
        
        // ç‚¹å‡»é€‰é¡¹
        const mobileOptionElements = mobileOptions.querySelectorAll('.ai-model-option');
        mobileOptionElements.forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                const value = this.dataset.value;
                
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                mobileOptionElements.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                // æ›´æ–°éšè—çš„selectï¼ˆä¼šè§¦å‘changeäº‹ä»¶ï¼Œç»Ÿä¸€å¤„ç†æ›´æ–°é€»è¾‘ï¼‰
                modelInput.value = value;
                modelInput.dispatchEvent(new Event('change'));
                
                // å…³é—­å¼¹çª—
                mobileOptions.classList.remove('show');
                mobileBtn.classList.remove('open');
            });
        });
        
        // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
        const initialValue = modelInput.value;
        mobileOptionElements.forEach(option => {
            if (option.getAttribute('data-value') === initialValue) {
                option.classList.add('selected');
            }
        });
        
        // ç‚¹å‡»ä¸‹æ‹‰æ¡†å†…éƒ¨ï¼ˆéé€‰é¡¹ï¼‰ä¸å…³é—­
        mobileOptions.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰‹æœºç«¯å¼¹çª—
        document.addEventListener('click', function(e) {
            // åªåœ¨æ‰‹æœºç«¯æ˜¾ç¤ºæ—¶æ‰å¤„ç†
            if (window.innerWidth <= 768) {
                if (!mobileOptions.contains(e.target) && !mobileBtn.contains(e.target)) {
                    mobileOptions.classList.remove('show');
                    mobileBtn.classList.remove('open');
                }
            }
        });
    }
    
    // ç§‘æ™®å¼¹çª—ç‚¹å‡»å¤–éƒ¨å…³é—­ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
    window.addEventListener('load', function() {
        setupInfoModalClickOutside();
        initAIChatState();  // åˆå§‹åŒ– AI åŠ©æ‰‹æŠ˜å çŠ¶æ€
        initAIChatInput();
        loadAIModels();  // åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨
        setupCustomModelSelect();  // è®¾ç½®è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨
        setupMobileModelButton();  // è®¾ç½®æ‰‹æœºç«¯æ¨¡å‹æŒ‰é’®
        
        // åˆå§‹åŒ– AI è”åå›¾ï¼ˆæ ¹æ®é»˜è®¤é€‰ä¸­çš„æ¨¡å‹ï¼‰
        const modelInput = document.getElementById('aiModelInput');
        if (modelInput) {
            updateAILogo(modelInput.value);
            
            // å…¨å±€ç›‘å¬æ¨¡å‹å˜åŒ–ï¼ˆç»Ÿä¸€å¤„ç†æ¡Œé¢ç«¯å’Œæ‰‹æœºç«¯ï¼‰
            modelInput.addEventListener('change', onModelChange);
        }
        
        // æ£€æŸ¥é¦–æ¬¡è®¿é—®ï¼Œå±•ç¤º AI åŠ©æ‰‹æ¼”ç¤º
        checkFirstVisitAnalysis();
    });
</script>

<!-- ç§‘æ™®å¼¹çª— -->
<div id="infoModal" class="info-modal">
    <div class="info-content">
        <div class="info-title">
            <span id="infoIcon"></span>
            <span id="infoTitle"></span>
        </div>
        <div class="info-body" id="infoBody"></div>
        <button class="info-close" onclick="closeInfo()">çŸ¥é“äº†</button>
    </div>
</div>

<!-- AI æ¸…ç©ºç¡®è®¤å¼¹çª— -->
<div id="aiClearModal" class="ai-clear-modal" onclick="closeAIClearModal()">
    <div class="ai-clear-content" onclick="event.stopPropagation()">
        <div class="ai-clear-title">
            <span>ğŸ—‘ï¸</span>
            <span>æ¸…ç©ºèŠå¤©è®°å½•</span>
        </div>
        <div class="ai-clear-message">
            ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
        </div>
        <div class="ai-clear-actions">
            <button class="ai-clear-cancel" onclick="closeAIClearModal()">å–æ¶ˆ</button>
            <button class="ai-clear-confirm" onclick="confirmClearAIChat()">ç¡®å®šæ¸…ç©º</button>
        </div>
    </div>
</div>

<!-- å…¨å±å¼¹çª— -->
<div id="overlayTrend" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleTrend">
        <div class="modal-head">
            <div id="modalTitleTrend" style="font-weight:700;">æ¸©æ¹¿åº¦è¶‹åŠ¿å¯¹æ¯”ï¼ˆå…¨å±ï¼‰</div>
            <div class="modal-actions">
                <button id="zoomInFullTrend" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                <button id="zoomOutFullTrend" class="btn" title="ç¼©å°">ğŸ”-</button>
                <button id="panLeftFullTrend" class="btn" title="å·¦ç§»">â†</button>
                <button id="panRightFullTrend" class="btn" title="å³ç§»">â†’</button>
                <button id="resetFullTrend" class="btn" title="é‡ç½®">ğŸ”„</button>
                <button id="closeOverlayTrend" class="close-btn" title="å…³é—­">âœ•</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartTrendFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayLuxSmoke" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleLuxSmoke">
        <div class="modal-head">
            <div id="modalTitleLuxSmoke" style="font-weight:700;">äº®åº¦ä¸çƒŸé›¾è¶‹åŠ¿ï¼ˆå…¨å±ï¼‰</div>
            <div class="modal-actions">
                <button id="zoomInFullLuxSmoke" class="btn" title="æ”¾å¤§">ğŸ”+</button>
                <button id="zoomOutFullLuxSmoke" class="btn" title="ç¼©å°">ğŸ”-</button>
                <button id="panLeftFullLuxSmoke" class="btn" title="å·¦ç§»">â†</button>
                <button id="panRightFullLuxSmoke" class="btn" title="å³ç§»">â†’</button>
                <button id="resetFullLuxSmoke" class="btn" title="é‡ç½®">ğŸ”„</button>
                <button id="closeOverlayLuxSmoke" class="close-btn" title="å…³é—­">âœ•</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartLuxSmokeFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayTempDist" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleTempDist">
        <div class="modal-head">
            <div id="modalTitleTempDist" style="font-weight:700;">æ¸©åº¦åˆ†å¸ƒï¼ˆåŠå…¨å±ï¼‰</div>
            <button id="closeOverlayTempDist" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartTempDistFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayHumDist" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleHumDist">
        <div class="modal-head">
            <div id="modalTitleHumDist" style="font-weight:700;">æ¹¿åº¦åˆ†å¸ƒï¼ˆåŠå…¨å±ï¼‰</div>
            <button id="closeOverlayHumDist" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartHumDistFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayHourly" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleHourly">
        <div class="modal-head">
            <div id="modalTitleHourly" style="font-weight:700;">å°æ—¶ç»Ÿè®¡ï¼ˆåŠå…¨å±ï¼‰</div>
            <button id="closeOverlayHourly" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartHourlyFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayCorrelation" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleCorrelation">
        <div class="modal-head">
            <div id="modalTitleCorrelation" style="font-weight:700;">æ¸©æ¹¿åº¦ç›¸å…³æ€§ï¼ˆåŠå…¨å±ï¼‰</div>
            <button id="closeOverlayCorrelation" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartCorrelationFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayPressureTrend" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitlePressureTrend">
        <div class="modal-head">
            <div id="modalTitlePressureTrend" style="font-weight:700;">å¤§æ°”å‹è¶‹åŠ¿ï¼ˆåŠå…¨å±ï¼‰</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="zoomInPressureTrend" title="æ”¾å¤§">ğŸ”+</button>
                <button class="btn btn-secondary" id="zoomOutPressureTrend" title="ç¼©å°">ğŸ”-</button>
                <button class="btn btn-secondary" id="resetZoomPressureTrend" title="é‡ç½®è§†å›¾">â†º</button>
            </div>
            <button id="closeOverlayPressureTrend" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartPressureTrendFull"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="overlayPressureDist" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitlePressureDist">
        <div class="modal-head">
            <div id="modalTitlePressureDist" style="font-weight:700;">å¤§æ°”å‹åˆ†å¸ƒï¼ˆåŠå…¨å±ï¼‰</div>
            <button id="closeOverlayPressureDist" class="close-btn" title="å…³é—­">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="chart-wrap" style="height:100%;">
                <canvas id="chartPressureDistFull"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯ä¸­å¿ƒå¼¹çª— -->
<div id="messageCenterPanel" class="message-center-panel">
    <div class="message-center-header">
        <div class="message-center-title">
            <span>ğŸ””</span>
            <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
        </div>
        <button class="message-center-close" onclick="closeMessageCenter()" title="å…³é—­">Ã—</button>
    </div>
    <div class="message-center-filters">
        <div class="calendar-wrapper" id="calendarWrapper"></div>
        <select id="warningTypeFilter" class="message-filter-select">
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="T">æ¸©åº¦</option>
            <option value="H">æ¹¿åº¦</option>
            <option value="B">äº®åº¦</option>
            <option value="S">PPM</option>
            <option value="P">å¤§æ°”å‹</option>
        </select>
        <select id="warningStatusFilter" class="message-filter-select">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="0">æœªæ¢å¤</option>
            <option value="1">å·²æ¢å¤</option>
        </select>
        <button class="message-refresh-btn" onclick="loadWarningMessages()" title="åˆ·æ–°">ğŸ”„</button>
    </div>
    <div class="message-center-body" id="messageCenterBody">
        <div class="message-loading" id="messageLoading">åŠ è½½ä¸­...</div>
        <div class="message-empty" id="messageEmpty" style="display: none;">æš‚æ— è­¦å‘Šæ¶ˆæ¯</div>
        <div class="message-list" id="messageList"></div>
    </div>
</div>

<!-- è­¦å‘Šé€šçŸ¥å¼¹çª— -->
<div id="warningNotification" class="warning-notification" style="display: none;">
    <div class="warning-notification-content">
        <div class="warning-notification-icon">âš ï¸</div>
        <div class="warning-notification-text">
            <div class="warning-notification-title" id="warningNotificationTitle"></div>
            <div class="warning-notification-desc" id="warningNotificationDesc"></div>
        </div>
        <button class="warning-notification-close" onclick="closeWarningNotification()">Ã—</button>
    </div>
</div>

<!-- å¸®åŠ©å¼¹çª—ï¼ˆç”± common.js åŠ¨æ€ç”Ÿæˆï¼‰ -->

</body>
</html>


